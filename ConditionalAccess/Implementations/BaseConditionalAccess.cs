using AdapterControllers;
using AdapterControllers.CDVR;
using ApiObjects;
using ApiObjects.Billing;
using ApiObjects.CDNAdapter;
using ApiObjects.MediaIndexingObjects;
using ApiObjects.PlayCycle;
using ApiObjects.QueueObjects;
using ApiObjects.Response;
using ApiObjects.TimeShiftedTv;
using Billing;
using ConditionalAccess.Response;
using DAL;
using EpgBL;
using GroupsCacheManager;
using KLogMonitor;
using KlogMonitorHelper;
using Pricing;
using QueueWrapper;
using Recordings;
using ScheduledTasks;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Threading.Tasks;
using System.Xml;
using TVinciShared;
using Users;
using WS_API;
using WS_Billing;
using WS_Pricing;
using WS_Users;
using EventManager;
using NPVR;
using CachingProvider.LayeredCache;

namespace ConditionalAccess
{
    public abstract class BaseConditionalAccess
    {
        private static readonly KLogger log = new KLogger(MethodBase.GetCurrentMethod().DeclaringType.ToString());

        internal string m_sPurchaseMailTemplate;
        internal string m_sMailFromName;
        internal string m_sMailFromAdd;
        internal string m_sMailServer;
        internal string m_sMailServerUN;
        internal string m_sMailServerPass;
        internal string m_sPurchaseMailSubject;
        internal bool m_bIsInitialized;
        internal Int32 m_nGroupID;

        internal const string EPG_DATETIME_FORMAT = "dd/MM/yyyy HH:mm:ss";
        internal const long DEFAULT_RECONCILIATION_FREQUENCY_SECONDS = 7200;
        internal const string ILLEGAL_CONTENT_ID = "Illegal content ID";
        internal const string CONTENT_ID_WITH_A_RELATED_MEDIA = "Content ID with a related media";
        internal const string ROUTING_KEY_PROCESS_RENEW_SUBSCRIPTION = "PROCESS_RENEW_SUBSCRIPTION\\{0}";
        internal const string BILLING_CONNECTION_STRING = "BILLING_CONNECTION";
        internal const string ROUTING_KEY_RECORDINGS_CLEANUP = "PROCESS_RECORDINGS_CLEANUP";
        internal const double RECORDING_CLEANUP_INTERVAL_SEC = 86400;
        internal const double HANDLE_RECORDINGS_LIFETIME_INTERVAL_SEC = 3600;
        internal const string RECORDINGS_LIFETIME_ROUTING_KEY = "PROCESS_RECORDINGS_LIFETIME";
        internal const double HANDLE_RECORDINGS_SCHEDULED_TASKS_INTERVAL_SEC = 60;
        internal const string RECORDING_TASKS_ROUTING_KEY = "PROCESS_RECORDING_SCHEDULED_TASKS";
        internal const string ROUTING_KEY_MODIFIED_RECORDING = "PROCESS_MODIFIED_RECORDING\\{0}";
        internal const string ROUTING_KEY_SERIES_RECORDING_TASK = "PROCESS_SERIES_RECORDING_TASK\\{0}";
        internal const double MAX_SERVER_TIME_DIF = 5;

        //errors
        internal const string CONFLICTED_PARAMS = "Conflicted params";
        internal const string NO_ADAPTER_TO_INSERT = "No adapter to insert";
        internal const string NO_ADAPTER_TO_UPDATE = "No adapter to update";
        internal const string NAME_REQUIRED = "Name must have a value";
        internal const string ADAPTER_SHARED_SECRET_REQUIRED = "Shared secret must have a value";
        internal const string EXTERNAL_IDENTIFIER_REQUIRED = "External identifier must have a value";
        internal const string ERROR_EXT_ID_ALREADY_IN_USE = "External identifier must be unique";
        internal const string ADAPTER_ID_REQUIRED = "Adapter identifier is required";
        internal const string ADAPTER_NOT_EXIST = "Adapter not exist";
        internal const string ADAPTER_URL_REQUIRED = "Adapter url must have a value";
        internal const string ADAPTER_ALIAS_REQUIRED = "Adapter Alias must have a value";
        internal const string ERROR_ALIAS_ALREADY_IN_USE = "Adapter Alias must be unique";
        internal const string ERROR_SUBSCRIPTION_NOT_EXSITS = "Subscription \\{0} not exists";
        internal const string ERROR_SUBSCRIPTION_NOT_RENEWABLE = "Subscription \\{0} not renewable";
        internal const string ERROR_SUBSCRIPTION_ALREADY_PURCHASED = "Subscription \\{0} already purchased";

        protected const string FILE_CDN_DATA_LAYERED_CACHE_CONFIG_NAME = "GetFileCdnData";

        public const string PRICE = "pri";
        public const string CURRENCY = "cu";
        public const string USER_IP = "up";
        public const string COUPON_CODE = "cc";
        public const string DEVICE_NAME = "ldn";
        public const string DUMMY = "dummy";
        public const string HISTORY = "history";
        public const string RECURRING_NUMBER = "recurringnumber";

        protected const int PAYMENT_GATEWAY = 1000;

        #region Abstract methods
        protected abstract BillingResponse HandleBaseRenewMPPBillingCharge(string sSiteGuid, double dPrice,
            string sCurrency, string sUserIP, string sCustomData, int nPaymentNumber, int nRecPeriods, string sExtraParams,
            int nBillingMethod, long lPurchaseID, eBillingProvider bp);

        protected abstract bool HandleMPPRenewalBillingSuccess(string sSiteGUID, string sSubscriptionCode, DateTime dtCurrentEndDate,
            bool bIsPurchasedWithPreviewModule, long lPurchaseID, string sCurrency, double dPrice, int nPaymentNumber,
            string sBillingTransactionID, int nUsageModuleMaxVLC, bool bIsMPPRecurringInfinitely, int nNumOfRecPeriods);

        protected internal abstract BillingResponse HandleCCChargeUser(string sWSUsername, string sWSPassword, string sSiteGuid,
            double dPrice, string sCurrency, string sUserIP, string sCustomData, int nPaymentNumber, int nNumOfPayments,
            string sExtraParams, string sPaymentMethodID, string sEncryptedCVV, bool bIsDummy, bool bIsEntitledToPreviewModule,
            ref module bm);

        protected abstract bool UpdatePurchaseIDInBilling(string sWSUsername, string sWSPassword,
          long purchaseID, long billingRefTransactionID, ref module wsBillingService);

        protected abstract bool HandleChargeUserForSubscriptionBillingSuccess(string sWSUsername, string sWSPassword, string sSiteGUID, int domianID, Subscription theSub,
            double dPrice, string sCurrency, string sCouponCode, string sUserIP, string sCountryCd, string sLanguageCode,
            string sDeviceName, BillingResponse br, bool bIsEntitledToPreviewModule, string sSubscriptionCode, string sCustomData,
            bool bIsRecurring, ref long lBillingTransactionID, ref long lPurchaseID, bool isDummy, ref module wsBillingService);

        protected abstract bool HandleChargeUserForCollectionBillingSuccess(string sWSUsername, string sWSPassword, string sSiteGUID, int domianID, Collection theCol,
            double dPrice, string sCurrency, string sCouponCode, string sUserIP, string sCountryCd, string sLanguageCode,
            string sDeviceName, BillingResponse br, string sCollectionCode,
            string sCustomData, ref long lBillingTransactionID, ref long lPurchaseID, ref module wsBillingService);

        protected internal abstract bool HandleChargeUserForMediaFileBillingSuccess(string sWSUsername, string sWSPassword, string sSiteGUID, int domianID, Subscription relevantSub,
            double dPrice, string sCurrency, string sCouponCode, string sUserIP, string sCountryCd, string sLanguageCode,
            string sDeviceName, BillingResponse br, string sCustomData, PPVModule thePPVModule,
            long lMediaFileID, ref long lBillingTransactionID, ref long lPurchaseID, bool isDummy, ref module wsBillingService,
            string billingGuid = null, DateTime? startDate = null, DateTime? endDate = null);

        protected internal abstract bool HandlePPVBillingSuccess(ref TransactionResponse response, string siteGUID, long houseHoldID, Subscription relevantSub, double price, string currency,
                                                        string coupon, string userIP, string country, string deviceName, long billingTransactionId, string customData,
                                                        PPVModule thePPVModule, int productID, int contentID, string billingGuid, DateTime entitlementDate, ref long purchaseID);

        protected internal abstract bool HandleSubscriptionBillingSuccess(ref TransactionResponse response, string siteGUID, long houseHoldID, Subscription subscription, double price, string currency, string coupon,
                                                                 string userIP, string country, string deviceName, long billingTransactionId, string customData,
                                                                 int productID, string billingGuid, bool isEntitledToPreviewModule, bool isRecurring, DateTime? entitlementDate,
                                                                 ref long purchaseID, ref DateTime? subscriptionEndDate, SubscriptionPurchaseStatus subscriptionPurchaseStatus);

        protected internal abstract bool HandleCollectionBillingSuccess(ref TransactionResponse response, string siteGUID, long houseHoldID, Collection collection, double price, string currency, string coupon,
                                                              string userIP, string country, string deviceName, long billingTransactionId, string customData, int productID,
                                                              string billingGuid, bool isEntitledToPreviewModule, DateTime entitlementDate, ref long purchaseID);


        /*
         * This method was created in order to solve a bug in the flow of ChargeUserForMediaFile in Cinepolis.
         * 1. Cinepolis does not dummy charge their user. All transactions are recorded in their billing gateway,
         *    including transactions for the price of zero.
         * 2. However, since it is not a dummy charge (dummy charge is when you skip the step of contacting the billing gateway)
         *    the flow in the mentioned method did not reach the step where it contacts the billing gateway.
         * 3. This patch resolves this situation without changing any billing logic related to different customers.
         */
        protected bool RecalculateDummyIndicatorForChargeMediaFile(bool bDummy, PriceReason reason, bool bIsCouponUsedAndValid)
        {
            return (bIsCouponUsedAndValid && reason == PriceReason.Free) || bDummy;
        }

        ///// <summary>
        ///// Get Licensed Link
        ///// </summary>
        //protected abstract string GetLicensedLink(string sBasicLink, string sUserIP, string sRefferer);
        /// <summary>
        /// Get Error Licensed Link
        /// </summary>
        protected abstract string GetErrorLicensedLink(string sBasicLink);
        /// <summary>
        /// Activate Campaign
        /// </summary>
        public abstract bool ActivateCampaign(int campaignID, CampaignActionInfo cai);

        public abstract CampaignActionInfo ActivateCampaignWithInfo(int campaignID, CampaignActionInfo cai);

        /// <summary>
        /// Get Licensed Link
        /// </summary>
        protected abstract string GetLicensedLink(int nStreamingCompany, Dictionary<string, string> dParams);
        #endregion

        protected virtual string GetPPVCodeForGetItemsPrices(string ppvObjectCode, string ppvObjectVirtualName)
        {
            return ppvObjectCode;
        }

        protected BaseConditionalAccess() { }

        protected BaseConditionalAccess(Int32 nGroupID)
            : this(nGroupID, string.Empty)
        {

        }

        protected BaseConditionalAccess(Int32 nGroupID, string connKey)
        {
            m_nGroupID = nGroupID;
            m_bIsInitialized = false;
        }

        /// <summary>
        /// Initialize
        /// </summary>
        private void InitializePurchaseMailTemplate(string connectionKey)
        {
            if (m_sPurchaseMailTemplate == null)
                m_sPurchaseMailTemplate = string.Empty;

            string key = string.Format("{0}_InitializeBaseConditionalAccess_{1}", eWSModules.CONDITIONALACCESS.ToString(), m_nGroupID);
            BaseConditionalAccess bCas;
            bool bRes = ConditionalAccessCache.GetItem<BaseConditionalAccess>(key, out bCas);
            if (!bRes || bCas == null)
            {
                lock (m_sPurchaseMailTemplate)
                {
                    ODBCWrapper.DataSetSelectQuery selectQuery = new ODBCWrapper.DataSetSelectQuery();
                    if (!string.IsNullOrEmpty(connectionKey))
                    {
                        selectQuery.SetConnectionKey(connectionKey);
                    }
                    selectQuery.SetCachedSec(0);
                    selectQuery += "select * from groups_parameters with (nolock) where status=1 and is_active=1 and ";
                    selectQuery += " group_id " + TVinciShared.PageUtils.GetFullChildGroupsStr(m_nGroupID, "MAIN_CONNECTION_STRING");
                    selectQuery += " order by id desc";
                    if (selectQuery.Execute("query", true) != null)
                    {
                        Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                        if (nCount > 0)
                        {
                            DataRow dr = selectQuery.Table("query").DefaultView[0].Row;
                            m_sPurchaseMailTemplate = ODBCWrapper.Utils.GetSafeStr(dr, "PURCHASE_MAIL");
                            m_sPurchaseMailSubject = ODBCWrapper.Utils.GetSafeStr(dr, "PURCHASE_MAIL_SUBJECT");
                            m_sMailFromName = ODBCWrapper.Utils.GetSafeStr(dr, "MAIL_FROM_NAME");
                            m_sMailFromAdd = ODBCWrapper.Utils.GetSafeStr(dr, "MAIL_FROM_ADD");
                            m_sMailServer = ODBCWrapper.Utils.GetSafeStr(dr, "MAIL_SERVER");
                            m_sMailServerUN = ODBCWrapper.Utils.GetSafeStr(dr, "MAIL_USER_NAME");
                            m_sMailServerPass = ODBCWrapper.Utils.GetSafeStr(dr, "MAIL_PASSWORD");
                            ConditionalAccessCache.AddItem(key, this);
                        }
                    }
                    selectQuery.Finish();
                    selectQuery = null;
                    m_bIsInitialized = true;
                }
            }
            else
            {
                m_sPurchaseMailTemplate = bCas.m_sPurchaseMailTemplate;
                m_sPurchaseMailSubject = bCas.m_sPurchaseMailSubject;
                m_sMailFromName = bCas.m_sMailFromName;
                m_sMailFromAdd = bCas.m_sMailFromAdd;
                m_sMailServer = bCas.m_sMailServer;
                m_sMailServerUN = bCas.m_sMailServerUN;
                m_sMailServerPass = bCas.m_sMailServerPass;
            }
        }

        protected string GetLogFilename()
        {
            return String.Concat("BaseConditionalAccess_", m_nGroupID);
        }

        private double CalcPriceAfterTax(double catalogPrice, double tax, ref double taxDisc)
        {
            double retVal = 0;
            retVal = Math.Round(catalogPrice / ((100 + tax) / 100), 2);
            taxDisc = Math.Round(catalogPrice - retVal, 2);
            return retVal;
        }
        /// <summary>
        /// Get Purchase Mail Text
        /// </summary>
        protected internal PurchaseMailRequest GetPurchaseMailRequest(ref string sEmail, string sUserGUID, string sItemName,
            string sPaymentMethod, string sDateOfPurchase, string sRecNumner, double dPrice, string sCurrency, Int32 nGroupID)
        {
            InitializePurchaseMailTemplate(string.Empty);
            PurchaseMailRequest retVal = new PurchaseMailRequest();
            string sFirstName = string.Empty;
            string sLastName = string.Empty;
            using (UsersService u = new UsersService())
            {
                string sWSUserName = string.Empty;
                string sWSPass = string.Empty;

                Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sUserGUID, string.Empty);
                if (uObj.m_RespStatus == ResponseStatus.OK)
                {
                    if (uObj.m_user != null)
                    {
                        sEmail = uObj.m_user.m_oBasicData.m_sEmail;
                        if (nGroupID == 109 || nGroupID == 110 || nGroupID == 111 || nGroupID == 112 || nGroupID == 113 || nGroupID == 114)
                        {
                            if (uObj.m_user.m_oDynamicData != null && uObj.m_user.m_oDynamicData.m_sUserData != null)
                            {
                                foreach (UserDynamicDataContainer dynamicData in uObj.m_user.m_oDynamicData.m_sUserData)
                                {
                                    if (dynamicData != null && dynamicData.m_sDataType.Equals("NickName"))
                                    {
                                        sFirstName = dynamicData.m_sValue;
                                        break;
                                    }
                                }
                            }

                        }
                        else
                        {
                            sFirstName = uObj.m_user.m_oBasicData.m_sFirstName;
                        }
                        sLastName = uObj.m_user.m_oBasicData.m_sLastName;
                    }
                }
                double tax = 0;
                double taxDisc = 0;
                ODBCWrapper.DataSetSelectQuery selectQuery = null;
                try
                {
                    selectQuery = new ODBCWrapper.DataSetSelectQuery();
                    selectQuery.SetConnectionKey("billing_connection");
                    selectQuery += " select tax_value from groups_parameters with (nolock) where ";
                    selectQuery += ODBCWrapper.Parameter.NEW_PARAM("group_id", "=", m_nGroupID);
                    if (selectQuery.Execute("query", true) != null)
                    {
                        int count = selectQuery.Table("query").DefaultView.Count;
                        if (count > 0)
                        {
                            object taxObj = selectQuery.Table("query").DefaultView[0].Row["tax_value"];
                            if (taxObj != System.DBNull.Value && taxObj != null)
                            {
                                tax = double.Parse(taxObj.ToString());
                            }
                        }
                    }
                }
                finally
                {
                    if (selectQuery != null)
                    {
                        selectQuery.Finish();
                    }
                }
                double taxTotalDIsc = CalcPriceAfterTax(dPrice, tax, ref taxDisc);
                retVal.m_eMailType = eMailTemplateType.Purchase;
                retVal.m_sFirstName = sFirstName;
                retVal.m_sItemName = sItemName;
                retVal.m_sLastName = sLastName;
                retVal.m_sPaymentMethod = sPaymentMethod;
                retVal.m_sPrice = string.Format("{0:0.##}", dPrice) + " " + sCurrency;
                retVal.m_sPurchaseDate = sDateOfPurchase;
                retVal.m_sSenderFrom = m_sMailFromAdd;
                retVal.m_sSenderName = m_sMailFromName;
                retVal.m_sSubject = m_sPurchaseMailSubject;
                retVal.m_sTemplateName = m_sPurchaseMailTemplate;
                retVal.m_sSenderTo = sEmail;
                retVal.m_sTaxVal = tax.ToString();
                retVal.m_sTaxSubtotal = taxTotalDIsc.ToString();
                retVal.m_sTaxAmount = taxDisc.ToString();
            }

            return retVal;
        }

        /// <summary>
        /// Get Main Lanuage
        /// </summary>
        static protected Int32 GetMainLang(ref string sMainLang, ref string sMainLangCode, Int32 nGroupID)
        {
            Int32 nLangID = 0;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            try
            {
                selectQuery = new ODBCWrapper.DataSetSelectQuery();
                selectQuery += "select l.NAME,l.CODE3,l.id from groups g with (nolock), lu_languages l with (nolock) where l.id=g.language_id and  ";
                selectQuery.SetConnectionKey("MAIN_CONNECTION_STRING");
                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("g.id", "=", nGroupID);
                if (selectQuery.Execute("query", true) != null)
                {
                    Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                    if (nCount > 0)
                    {
                        sMainLang = selectQuery.Table("query").DefaultView[0].Row["NAME"].ToString();
                        sMainLangCode = selectQuery.Table("query").DefaultView[0].Row["CODE3"].ToString();
                        nLangID = int.Parse(selectQuery.Table("query").DefaultView[0].Row["ID"].ToString());
                    }
                }
            }
            finally
            {
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
            }
            return nLangID;
        }

        /// <summary>
        /// Write To User Log
        /// </summary>
        protected internal void WriteToUserLog(string sSiteGUID, string sMessage)
        {
            UsersService u = null;
            try
            {
                u = new UsersService();
                string sWSUserName = string.Empty;
                string sWSPass = string.Empty;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);

                if (!string.IsNullOrEmpty(sWSUserName))
                {
                    u.WriteLog(sWSUserName, sWSPass, sSiteGUID, sMessage, "Conditional access module");
                }
            }
            catch (Exception ex)
            {
                log.Error("WriteToUserLog - " + string.Format("Failed to write to user log. Site Guid: {0} , Msg: {1} , Exception msg: {2} , Stack trace : {3}", sSiteGUID, sMessage, ex.Message, ex.StackTrace), ex);
            }
            finally
            {
                if (u != null)
                {
                    u.Dispose();
                }
            }

        }
        /// <summary>
        /// Get Date STR By Group
        /// When we finish the localization feature - remove this! 
        /// </summary>
        protected internal virtual string GetDateSTRByGroup(DateTime dt, int groupID)
        {
            string retVal = dt.ToString("MM/dd/yyyy HH:mm:ss");
            if (groupID == 109 || groupID == 110 || groupID == 111)
            {
                retVal = dt.ToString("dd/MM/yyyy HH:mm:ss");
            }
            if (groupID == 112 || groupID == 113 || groupID == 114)
            {
                retVal = String.Format("{0} GMT", dt.ToString("dd-MMM-yyyy HH:mm:ss"));
            }
            return retVal;

        }

        protected virtual BillingResponse HandleCellularChargeUser(string sWSUsername, string sWSPassword, string sSiteGuid, double dPrice, string sCurrency, string sUserIP, string sCustomData,
                                                                                 int nPaymentNumber, int nNumOfPayments, string sExtraParams, bool bIsDummy, bool bIsEntitledToPreviewModule,
                                                                                 ref module bm)
        {
            if (!bIsDummy && !bIsEntitledToPreviewModule)
            {

                //Cellular_ChargeUser
                return bm.Cellular_ChargeUser(sWSUsername, sWSPassword, sSiteGuid, dPrice, sCurrency, sUserIP, sCustomData, 1, 1, sExtraParams);

            }
            else
            {
                return bm.CC_DummyChargeUser(sWSUsername, sWSPassword, sSiteGuid, dPrice, sCurrency, sUserIP, sCustomData, 1, 1, sExtraParams);

            }
        }


        /// <summary>
        /// Credit Card Charge User For PrePaid
        /// </summary>
        public virtual BillingResponse CC_ChargeUserForPrePaid(string sSiteGUID, double dPrice, string sCurrency,
           string sPrePaidModuleCode, string sCouponCode, string sUserIP, string sExtraParameters,
           string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bDummy)
        {
            return CC_BaseChargeUserForPrePaid(sSiteGUID, dPrice, sCurrency, sPrePaidModuleCode,
                sCouponCode, sUserIP, sExtraParameters,
                sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, bDummy);


        }
        /// <summary>
        /// Credit Card Charge User For Pre Paid
        /// </summary>
        protected BillingResponse CC_BaseChargeUserForPrePaid(string sSiteGUID, double dPrice, string sCurrency,
            string sPrePaidModuleCode, string sCouponCode, string sUserIP, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bDummy)
        {
            BillingResponse ret = new BillingResponse();
            ret.m_oStatus = BillingResponseStatus.UnKnown;
            ret.m_sRecieptCode = string.Empty;
            ret.m_sStatusDescription = string.Empty;
            UsersService u = null;
            mdoule m = null;
            module bm = null;
            API apiWs = null;
            ODBCWrapper.InsertQuery insertQuery = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;

            try
            {
                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_sRecieptCode = string.Empty;
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                }
                else
                {
                    u = new UsersService();
                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                    }
                    else
                    {
                        if (uObj.m_user != null && uObj.m_user.m_eSuspendState == DomainSuspentionStatus.Suspended)
                        {
                            ret.m_oStatus = BillingResponseStatus.UserSuspended;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "User suspended";
                            WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC):" + sPrePaidModuleCode + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }

                        if (!string.IsNullOrEmpty(sCouponCode) && !Utils.IsCouponValid(m_nGroupID, sCouponCode))
                        {
                            ret.m_oStatus = BillingResponseStatus.Fail;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "Coupon not valid";
                            WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC):" + sPrePaidModuleCode + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }

                        sWSUserName = string.Empty;
                        sWSPass = string.Empty;

                        m = new mdoule();
                        PrePaidModule thePrePaidModule = null;

                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        thePrePaidModule = m.GetPrePaidModuleData(sWSUserName, sWSPass, int.Parse(sPrePaidModuleCode), sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                        if (thePrePaidModule == null)
                        {
                            ret.m_oStatus = BillingResponseStatus.UnKnownPPVModule;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "This PrePaid Module does not exist ";
                            WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC): " + sPrePaidModuleCode.ToString() + " error returned: " + ret.m_sStatusDescription);
                        }
                        else
                        {
                            PriceReason theReason = PriceReason.UnKnown;

                            if (thePrePaidModule != null)
                            {
                                Price p = Utils.GetPrePaidFinalPrice(m_nGroupID, sPrePaidModuleCode, sSiteGUID, ref theReason, ref thePrePaidModule, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty, sCouponCode);
                                if (theReason == PriceReason.ForPurchase && p.m_dPrice > 0 || bDummy == true)
                                {
                                    if (bDummy || (p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency))
                                    {
                                        string sCustomData = string.Empty;
                                        if (p.m_dPrice != 0 || bDummy)
                                        {
                                            bm = new module();
                                            sWSUserName = string.Empty;
                                            sWSPass = string.Empty;
                                            Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                                            if (string.IsNullOrEmpty(sCountryCd) && !string.IsNullOrEmpty(sUserIP))
                                            {
                                                sCountryCd = Utils.GetIP2CountryName(m_nGroupID, sUserIP);
                                            }

                                            //Create the Custom Data
                                            sCustomData = GetCustomDataForPrePaid(thePrePaidModule, null, sPrePaidModuleCode, string.Empty, sSiteGUID, dPrice, sCurrency, sCouponCode, sUserIP,
                                                sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                                            log.Debug("CustomData - " + sCustomData);

                                            //customdata id
                                            if (!bDummy)
                                                ret = bm.CC_ChargeUser(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sUserIP, sCustomData, 1, 1, sExtraParameters, string.Empty, string.Empty);
                                            else
                                                ret = bm.CC_DummyChargeUser(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sUserIP, sCustomData, 1, 1, sExtraParameters);
                                        }
                                        if (ret.m_oStatus == BillingResponseStatus.Success)
                                        {
                                            HandleCouponUses(null, string.Empty, sSiteGUID, p.m_dPrice, sCurrency, 0, sCouponCode, sUserIP,
                                                sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, true, thePrePaidModule.m_ObjectCode, 0);

                                            insertQuery = new ODBCWrapper.InsertQuery("pre_paid_purchases");
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("pre_paid_module_id", "=", int.Parse(sPrePaidModuleCode));
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("PRICE", "=", dPrice);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("CURRENCY_CODE", "=", sCurrency);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("total_amount", "=", thePrePaidModule.m_CreditValue.m_oPrise.m_dPrice);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("amount_used", "=", 0);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("CUSTOM_DATA", "=", sCustomData);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("BILLING_TRANSACTION_ID", "=", int.Parse(ret.m_sRecieptCode));
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("COUNTRY_CODE", "=", sCountryCd);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("LANGUAGE_CODE", "=", sLANGUAGE_CODE);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DEVICE_NAME", "=", sDEVICE_NAME);
                                            if (thePrePaidModule != null &&
                                                thePrePaidModule.m_UsageModule != null)
                                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", thePrePaidModule.m_UsageModule.m_nMaxNumberOfViews);
                                            else
                                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", 0);

                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);
                                            if (thePrePaidModule != null &&
                                                thePrePaidModule.m_UsageModule != null)
                                            {
                                                DateTime d = Utils.GetEndDateTime(DateTime.UtcNow, thePrePaidModule.m_UsageModule.m_tsMaxUsageModuleLifeCycle);
                                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("END_DATE", "=", d);
                                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("START_DATE", "=", DateTime.UtcNow);
                                            }

                                            insertQuery.Execute();
                                            WriteToUserLog(sSiteGUID, "Pre Paid Module ID: " + sPrePaidModuleCode + " Purchased(CC): " + dPrice.ToString() + sCurrency);
                                            Int32 nPurchaseID = 0;
                                            selectQuery = new ODBCWrapper.DataSetSelectQuery();
                                            selectQuery += " select id from pre_paid_purchases with (nolock) where ";
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                                            selectQuery += "and";
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("pre_paid_module_id", "=", int.Parse(sPrePaidModuleCode));
                                            selectQuery += "and";
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                                            selectQuery += "and";
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("PRICE", "=", dPrice);
                                            selectQuery += "and";
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("CURRENCY_CODE", "=", sCurrency);
                                            selectQuery += "and";
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("total_amount", "=", thePrePaidModule.m_CreditValue.m_oPrise.m_dPrice);
                                            selectQuery += "and";
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("amount_used", "=", 0);
                                            selectQuery += "and";
                                            if (thePrePaidModule != null &&
                                                thePrePaidModule.m_UsageModule != null)
                                                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", thePrePaidModule.m_UsageModule.m_nMaxNumberOfViews);
                                            else
                                                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", 0);
                                            selectQuery += "and";
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                                            selectQuery += "and";
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);
                                            selectQuery += "order by id desc";
                                            if (selectQuery.Execute("query", true) != null)
                                            {
                                                Int32 nCount1 = selectQuery.Table("query").DefaultView.Count;
                                                if (nCount1 > 0)
                                                    nPurchaseID = int.Parse(selectQuery.Table("query").DefaultView[0].Row["id"].ToString());
                                            }

                                            //Update PrePaidUses
                                            UserPrePaidContainer uppc = GetUserPrePaidStatus(sSiteGUID, sCurrency);

                                            InsertPPUsesRecord(nPurchaseID, int.Parse(sPrePaidModuleCode), BillingItemsType.PrePaid, sSiteGUID, sCurrency, int.Parse(sPrePaidModuleCode),
                                                nPurchaseID, thePrePaidModule.m_CreditValue.m_oPrise.m_dPrice, (uppc.m_nTotalAmount - uppc.m_nAmountUsed),
                                                sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                                            //Should update the PURCHASE_ID
                                            string sReciept = ret.m_sRecieptCode;
                                            if (sReciept != "")
                                            {
                                                Int32 nID = int.Parse(sReciept);
                                                updateQuery = new ODBCWrapper.UpdateQuery("billing_transactions");
                                                updateQuery.SetConnectionKey("MAIN_CONNECTION_STRING");
                                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("PURCHASE_ID", "=", nPurchaseID);
                                                updateQuery += "where";
                                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nID);
                                                updateQuery.Execute();

                                                try
                                                {
                                                    //send purchase mail
                                                    string sEmail = string.Empty;
                                                    string sPaymentMethod = "Credit Card";
                                                    string sDateOfPurchase = GetDateSTRByGroup(DateTime.UtcNow, m_nGroupID);

                                                    if (!bDummy)
                                                    {
                                                        if (bm == null)
                                                        {
                                                            bm = new module();
                                                        }
                                                        sWSUserName = string.Empty;
                                                        sWSPass = string.Empty;
                                                        Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                                                        string sDigits = bm.CC_GetUserCCDigits(sWSUserName, sWSPass, sSiteGUID);
                                                        sPaymentMethod += " (************" + sDigits + ")";
                                                    }
                                                    else
                                                        sPaymentMethod = "Gift";
                                                    PurchaseMailRequest sMailReq = GetPurchaseMailRequest(ref sEmail, sSiteGUID, thePrePaidModule.m_Title, sPaymentMethod, sDateOfPurchase, sReciept, dPrice, sCurrency, m_nGroupID);
                                                    apiWs = new API();
                                                    string sAPIWSUserName = string.Empty;
                                                    string sAPIWSPass = string.Empty;
                                                    Utils.GetWSCredentials(m_nGroupID, eWSModules.API, ref sWSUserName, ref sWSPass);
                                                    apiWs.SendMailTemplate(sAPIWSUserName, sWSPass, sMailReq);

                                                }
                                                catch (Exception ex)
                                                {
                                                    #region Logging
                                                    StringBuilder pmErr = new StringBuilder("Failed to send purchase mail. At CC_ChargeUserForPrePaid. ");
                                                    pmErr.Append(String.Concat(" Site Guid: ", sSiteGUID));
                                                    pmErr.Append(String.Concat(" PP Module Code: ", sPrePaidModuleCode));
                                                    pmErr.Append(String.Concat(" Ex Msg: ", ex.Message));
                                                    pmErr.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                                                    pmErr.Append(String.Concat(" Stack Trace: ", ex.StackTrace));
                                                    log.Debug("Send purchase mail - " + pmErr.ToString(), ex);
                                                    #endregion
                                                }
                                            }
                                            else
                                            {
                                                WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC): " + sPrePaidModuleCode + " error returned: " + ret.m_sStatusDescription);
                                            }
                                        }
                                        else
                                        {
                                            WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC): " + sPrePaidModuleCode + " error returned: " + ret.m_sStatusDescription);
                                        }
                                    }
                                    else
                                    {
                                        ret.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                        ret.m_sRecieptCode = string.Empty;
                                        ret.m_sStatusDescription = "The price of the request is not the actual price";
                                        WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC): " + sPrePaidModuleCode + " error returned: " + ret.m_sStatusDescription);
                                    }
                                }
                                else
                                {
                                    if (theReason == PriceReason.PPVPurchased)
                                    {
                                        ret.m_oStatus = BillingResponseStatus.Fail;
                                        ret.m_sRecieptCode = string.Empty;
                                        ret.m_sStatusDescription = "The pre paid module is already purchased";
                                        WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC): " + sPrePaidModuleCode + " error returned: " + ret.m_sStatusDescription);
                                    }
                                    else if (theReason == PriceReason.Free)
                                    {
                                        ret.m_oStatus = BillingResponseStatus.Fail;
                                        ret.m_sRecieptCode = string.Empty;
                                        ret.m_sStatusDescription = "The pre paid module is free";
                                        WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC): " + sPrePaidModuleCode + " error returned: " + ret.m_sStatusDescription);
                                    }
                                    else if (theReason == PriceReason.ForPurchaseSubscriptionOnly)
                                    {
                                        ret.m_oStatus = BillingResponseStatus.Fail;
                                        ret.m_sRecieptCode = string.Empty;
                                        ret.m_sStatusDescription = "The pre paid module is for purchase with subscription only";
                                        WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC): " + sPrePaidModuleCode + " error returned: " + ret.m_sStatusDescription);
                                    }
                                    else if (theReason == PriceReason.SubscriptionPurchased)
                                    {
                                        ret.m_oStatus = BillingResponseStatus.Fail;
                                        ret.m_sRecieptCode = string.Empty;
                                        ret.m_sStatusDescription = "The pre paid module is already purchased (subscription)";
                                        WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC): " + sPrePaidModuleCode + " error returned: " + ret.m_sStatusDescription);
                                    }
                                }
                            }
                            else
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The ppv module is unknown";
                                WriteToUserLog(sSiteGUID, "While trying to purchase pre paid module(CC): " + sPrePaidModuleCode + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at CC_BaseChargeUserForPrePaid. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" Curr Cd: ", sCurrency));
                sb.Append(String.Concat(" PP Cd: ", sPrePaidModuleCode));
                sb.Append(String.Concat(" Coupon Cd: ", sCouponCode));
                sb.Append(String.Concat(" IP: ", sUserIP));
                sb.Append(String.Concat(" Device Name: ", sDEVICE_NAME));
                sb.Append(String.Concat(" Dummy: ", bDummy.ToString().ToLower()));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (m != null)
                {
                    m.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
                if (apiWs != null)
                {
                    apiWs.Dispose();
                }
                if (insertQuery != null)
                {
                    insertQuery.Finish();
                }
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }

                #endregion
            }
            return ret;
        }

        /// <summary>
        /// InApp Charge User For Media File
        /// </summary>
        protected BillingResponse InApp_BaseChargeUserForMediaFile(string sSiteGUID, double dPrice, string sCurrency,
            Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sUserIP, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sRecieptCode)
        {
            InAppBillingResponse InAppRes = new InAppBillingResponse();
            InAppRes.m_oBillingResponse = new BillingResponse();
            InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.UnKnown;
            InAppRes.m_oBillingResponse.m_sRecieptCode = string.Empty;
            InAppRes.m_oBillingResponse.m_sStatusDescription = string.Empty;
            UsersService u = null;
            mdoule m = null;
            module bm = null;
            ODBCWrapper.InsertQuery insertQuery = null;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            try
            {
                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.UnKnownUser;
                    InAppRes.m_oBillingResponse.m_sRecieptCode = string.Empty;
                    InAppRes.m_oBillingResponse.m_sStatusDescription = "Cant charge an unknown user";
                    return InAppRes.m_oBillingResponse;
                }
                else
                {
                    u = new UsersService();
                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    //get user data
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        //return UnKnownUser 
                        InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.UnKnownUser;
                        InAppRes.m_oBillingResponse.m_sRecieptCode = string.Empty;
                        InAppRes.m_oBillingResponse.m_sStatusDescription = "Cant charge an unknown user";
                        return InAppRes.m_oBillingResponse;
                    }
                    else if (uObj != null && uObj.m_user != null && uObj.m_user.m_eSuspendState == DomainSuspentionStatus.Suspended)
                    {
                        InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.UserSuspended;
                        InAppRes.m_oBillingResponse.m_sRecieptCode = string.Empty;
                        InAppRes.m_oBillingResponse.m_sStatusDescription = "Cannot charge a suspended user";
                        WriteToUserLog(sSiteGUID, "while trying to purchase media file id(InApp): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                        return InAppRes.m_oBillingResponse;
                    }
                    else
                    {
                        long domainId = uObj.m_user.m_domianID;
                        sWSUserName = string.Empty;
                        sWSPass = string.Empty;

                        m = new WS_Pricing.mdoule();
                        if (string.IsNullOrEmpty(sPPVModuleCode))
                        {
                            InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                            InAppRes.m_oBillingResponse.m_sRecieptCode = string.Empty;
                            InAppRes.m_oBillingResponse.m_sStatusDescription = "Charge must have ppv module code";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(InApp): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            return InAppRes.m_oBillingResponse;
                        }

                        // check if ppvModule related to mediaFile 
                        long ppvModuleCode = 0;
                        long.TryParse(sPPVModuleCode, out ppvModuleCode);

                        PPVModule thePPVModule = m.ValidatePPVModuleForMediaFile(sWSUserName, sWSPass, nMediaFileID, ppvModuleCode);
                        if (thePPVModule == null || thePPVModule.m_oUsageModule == null)
                        {
                            InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                            InAppRes.m_oBillingResponse.m_sRecieptCode = string.Empty;
                            InAppRes.m_oBillingResponse.m_sStatusDescription = "The ppv module is unknown";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(InApp): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            return InAppRes.m_oBillingResponse;
                        }
                        else if (thePPVModule.m_sObjectCode != ppvModuleCode.ToString())
                        {
                            InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.UnKnownPPVModule;
                            InAppRes.m_oBillingResponse.m_sRecieptCode = string.Empty;
                            InAppRes.m_oBillingResponse.m_sStatusDescription = "This PPVModule does not belong to item";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(InApp): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            return InAppRes.m_oBillingResponse;
                        }
                        PriceReason theReason = PriceReason.UnKnown;

                        Subscription relevantSub = null;
                        Collection relevantCol = null;
                        PrePaidModule relevantPP = null;

                        Price p = Utils.GetMediaFileFinalPriceForNonGetItemsPrices(nMediaFileID, thePPVModule, sSiteGUID, sCouponCode, m_nGroupID, ref theReason, ref relevantSub, ref relevantCol, ref relevantPP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        if (theReason == PriceReason.ForPurchase || (theReason == PriceReason.SubscriptionPurchased && p.m_dPrice > 0))
                        {
                            if (p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency)
                            {
                                string sCustomData = "";
                                if (p.m_dPrice != 0)
                                {
                                    #region Init Tvinci Billing Webservice
                                    bm = new module();
                                    sWSUserName = string.Empty;
                                    sWSPass = string.Empty;
                                    Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                                    #endregion

                                    if (string.IsNullOrEmpty(sCountryCd) && !string.IsNullOrEmpty(sUserIP))
                                    {
                                        sCountryCd = Utils.GetIP2CountryName(m_nGroupID, sUserIP);
                                    }

                                    //Create the Custom Data
                                    sCustomData = GetCustomData(relevantSub, thePPVModule, null, sSiteGUID, dPrice, sCurrency,
                                        nMediaFileID, nMediaID, sPPVModuleCode, string.Empty, sCouponCode, sUserIP,
                                        sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                                    log.Debug("CustomData - " + sCustomData);

                                    //customdata id
                                    InAppRes = bm.InApp_ChargeUser(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sUserIP, sCustomData, 1, 1, sRecieptCode);
                                }

                                if (InAppRes.m_oBillingResponse.m_oStatus == BillingResponseStatus.Success)
                                {
                                    Int32 nReciptCode = 0;
                                    if (!string.IsNullOrEmpty(InAppRes.m_oBillingResponse.m_sRecieptCode))
                                    {
                                        nReciptCode = int.Parse(InAppRes.m_oBillingResponse.m_sRecieptCode);
                                    }

                                    HandleCouponUses(relevantSub, string.Empty, sSiteGUID, p.m_dPrice, sCurrency, nMediaFileID, sCouponCode, sUserIP,
                                        sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, true, 0, 0);

                                    DateTime endDate = Utils.GetEndDateTime(DateTime.UtcNow, thePPVModule.m_oUsageModule.m_tsMaxUsageModuleLifeCycle);
                                    long purchaseID = ConditionalAccessDAL.Insert_NewPPVPurchase(m_nGroupID, nMediaFileID, sSiteGUID, dPrice, sCurrency,
                                                                                                 thePPVModule.m_oUsageModule != null ? thePPVModule.m_oUsageModule.m_nMaxNumberOfViews : 0, sCustomData,
                                                                                                 relevantSub != null ? relevantSub.m_sObjectCode : string.Empty, nReciptCode, DateTime.UtcNow, endDate,
                                                                                                 DateTime.UtcNow, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, domainId);

                                    //Should update the PURCHASE_ID

                                    string sReciept = InAppRes.m_oBillingResponse.m_sRecieptCode;
                                    if (sReciept != "")
                                    {
                                        Int32 nID = int.Parse(sReciept);
                                        updateQuery = new ODBCWrapper.UpdateQuery("billing_transactions");
                                        updateQuery.SetConnectionKey("MAIN_CONNECTION_STRING");
                                        updateQuery += ODBCWrapper.Parameter.NEW_PARAM("PURCHASE_ID", "=", purchaseID);
                                        updateQuery += "where";
                                        updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nID);
                                        updateQuery.Execute();


                                        // # Event trigger: Purchase via Apple IAP (old engine) occurred, 
                                        // Event data: username/ID, subscription details, is-free-trial, start and end-date
                                        Dictionary<string, object> eventRecordData = new Dictionary<string, object>()
                                            {
                                                {"MediaFileId", nMediaFileID},
                                                {"SiteGUID", sSiteGUID},
                                                {"PurchaseId", purchaseID},
                                                {"CustomData", sCustomData},
                                                {"BillingTransactionID", sReciept},
                                                {"PPVModuleCode", sPPVModuleCode},
                                                {"CouponCode", sCouponCode},
                                            };

                                        if (!this.EnqueueEventRecord(NotifiedAction.ChargedMediaFile, eventRecordData))
                                        {
                                            log.ErrorFormat("Error while enqueue media file purchase record: mediaFile = {0}" +
                                            "siteGuid = {1}", nMediaFileID, sSiteGUID);
                                        }
                                    }
                                    else
                                    {
                                        WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                                    }
                                }
                            }
                            else
                            {
                                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                InAppRes.m_oBillingResponse.m_sRecieptCode = "";
                                InAppRes.m_oBillingResponse.m_sStatusDescription = "The price of the request is not the actual price";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(InAPP): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.PPVPurchased)
                            {
                                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                                InAppRes.m_oBillingResponse.m_sRecieptCode = "";
                                InAppRes.m_oBillingResponse.m_sStatusDescription = "The media file is already purchased";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(InApp): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            }
                            else if (theReason == PriceReason.Free)
                            {
                                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                                InAppRes.m_oBillingResponse.m_sRecieptCode = "";
                                InAppRes.m_oBillingResponse.m_sStatusDescription = "The media file is free";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(InApp): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            }
                            else if (theReason == PriceReason.ForPurchaseSubscriptionOnly)
                            {
                                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                                InAppRes.m_oBillingResponse.m_sRecieptCode = "";
                                InAppRes.m_oBillingResponse.m_sStatusDescription = "The media file is for purchase with subscription only";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(InApp): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            }
                            else if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                                InAppRes.m_oBillingResponse.m_sRecieptCode = "";
                                InAppRes.m_oBillingResponse.m_sStatusDescription = "The media file is already purchased (subscription)";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(InApp): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            }
                            else if (theReason == PriceReason.NotForPurchase)
                            {
                                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                                InAppRes.m_oBillingResponse.m_sRecieptCode = string.Empty;
                                InAppRes.m_oBillingResponse.m_sStatusDescription = "The media file is not valid for purchased";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(InApp): " + nMediaFileID.ToString() + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at InApp_BaseChargeUserForMediaFile. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" MF ID: ", nMediaFileID));
                sb.Append(String.Concat(" M ID: ", nMediaID));
                sb.Append(String.Concat(" PPV M C: ", sPPVModuleCode));
                sb.Append(String.Concat(" Coupon: ", sCouponCode));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (m != null)
                {
                    m.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
                if (insertQuery != null)
                {
                    insertQuery.Finish();
                }
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
                #endregion
            }
            return InAppRes.m_oBillingResponse;
        }



        protected internal DateTime CalcSubscriptionEndDate(Subscription sub, bool bIsEntitledToPreviewModule, DateTime dtToInitializeWith)
        {
            DateTime res = dtToInitializeWith;
            if (sub != null)
            {
                if (bIsEntitledToPreviewModule && sub.m_oPreviewModule != null && sub.m_oPreviewModule.m_tsFullLifeCycle > 0)
                {
                    // calc end date according to preview module life cycle
                    res = Utils.GetEndDateTime(res, sub.m_oPreviewModule.m_tsFullLifeCycle);
                }
                else
                {
                    if (sub.m_oSubscriptionUsageModule != null)
                    {
                        // calc end date as before.
                        res = Utils.GetEndDateTime(res, sub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle);
                    }
                }
            }

            return res;
        }

        protected DateTime CalcCollectionEndDate(Collection col, DateTime dtToInitializeWith)
        {
            DateTime res = dtToInitializeWith;
            if (col != null)
            {
                if (col.m_oCollectionUsageModule != null)
                {
                    // calc end date as before.
                    res = Utils.GetEndDateTime(res, col.m_oCollectionUsageModule.m_tsMaxUsageModuleLifeCycle);
                }
            }
            return res;
        }

        /// <summary>
        /// In App Charge User For Subscription
        /// </summary>
        protected BillingResponse InApp_BaseChargeUserForSubscription(string sSiteGUID, double dPrice, string sCurrency, string sProductCode, string sUserIP, string sExtraParams,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string ReceiptData)
        {
            InAppBillingResponse InAppRes = new InAppBillingResponse();
            InAppRes.m_oBillingResponse = new BillingResponse();

            UsersService u = null;
            module bm = null;
            ODBCWrapper.DataSetSelectQuery selectExistQuery = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            ODBCWrapper.InsertQuery insertQuery = null;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            ODBCWrapper.UpdateQuery updateQuery1 = null;

            try
            {
                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.UnKnownUser;
                    InAppRes.m_oBillingResponse.m_sRecieptCode = string.Empty;
                    InAppRes.m_oBillingResponse.m_sStatusDescription = "Cant charge an unknown user";
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.UnKnownUser;
                        InAppRes.m_oBillingResponse.m_sRecieptCode = string.Empty;
                        InAppRes.m_oBillingResponse.m_sStatusDescription = "Cant charge an unknown user";
                    }
                    else
                    {
                        int domainId = uObj.m_user.m_domianID;
                        PriceReason theReason = PriceReason.UnKnown;
                        Subscription theSub = Utils.GetSubscriptionBytProductCode(m_nGroupID, sProductCode, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, false);
                        string sSubscriptionCode = theSub.m_SubscriptionCode;

                        Price p = Utils.GetSubscriptionFinalPrice(m_nGroupID, sSubscriptionCode, sSiteGUID, string.Empty, ref theReason,
                            ref theSub, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                        if (theReason == PriceReason.ForPurchase)
                        {
                            if (p != null && dPrice > 0)
                            {
                                string sCustomData = string.Empty;
                                dPrice = p.m_dPrice;
                                sCurrency = p.m_oCurrency.m_sCurrencyCD3;

                                bool bIsRecurring = theSub.m_bIsRecurring;
                                Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;

                                if (string.IsNullOrEmpty(sCountryCd) && !string.IsNullOrEmpty(sUserIP))
                                {
                                    sCountryCd = Utils.GetIP2CountryName(m_nGroupID, sUserIP);
                                }
                                //Create the Custom Data
                                sCustomData = GetCustomDataForSubscription(theSub, null, sSubscriptionCode, string.Empty, sSiteGUID, dPrice, sCurrency,
                                    string.Empty, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                                log.Debug("CustomData - " + sCustomData);

                                if (p.m_dPrice != 0)
                                {
                                    bm = new module();
                                    sWSUserName = string.Empty;
                                    sWSPass = string.Empty;
                                    Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                                    InAppRes = bm.InApp_ChargeUser(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sUserIP, sCustomData, 1, nRecPeriods, ReceiptData);
                                }

                                if (InAppRes.m_oBillingResponse.m_oStatus == BillingResponseStatus.Success)
                                {
                                    try
                                    {
                                        long nReciptCode = 0;
                                        if (!string.IsNullOrEmpty(InAppRes.m_oBillingResponse.m_sRecieptCode))
                                        {
                                            nReciptCode = long.Parse(InAppRes.m_oBillingResponse.m_sRecieptCode);
                                        }
                                        Int32 nRet = 0;
                                        selectExistQuery = new ODBCWrapper.DataSetSelectQuery();
                                        selectExistQuery += " select id from subscriptions_purchases with (nolock) where ";
                                        selectExistQuery += ODBCWrapper.Parameter.NEW_PARAM("BILLING_TRANSACTION_ID", "=", nReciptCode);
                                        selectExistQuery += "AND";
                                        selectExistQuery += ODBCWrapper.Parameter.NEW_PARAM("group_id", "=", m_nGroupID);
                                        selectExistQuery += "AND";
                                        selectExistQuery += ODBCWrapper.Parameter.NEW_PARAM("site_user_guid", "=", sSiteGUID);

                                        if (selectExistQuery.Execute("query", true) != null)
                                        {
                                            Int32 nCount = selectExistQuery.Table("query").DefaultView.Count;
                                            if (nCount > 0)
                                                nRet = int.Parse(selectExistQuery.Table("query").DefaultView[0].Row["ID"].ToString());
                                        }

                                        if (nRet == 0)
                                        {
                                            HandleCouponUses(theSub, string.Empty, sSiteGUID, dPrice, sCurrency, 0, string.Empty, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, true, 0, 0);

                                            updateQuery = new ODBCWrapper.UpdateQuery("subscriptions_purchases");
                                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_RECURRING_STATUS", "=", 0);
                                            updateQuery += " where ";
                                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                                            updateQuery += " and ";
                                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubscriptionCode);
                                            updateQuery += " and ";
                                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                                            updateQuery += " and ";
                                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("DOMAIN_ID", "=", domainId);
                                            updateQuery.Execute();

                                            DateTime dt1970 = new DateTime(1970, 1, 1);

                                            // by default add 6 hours to end date, so that renewer scheduler will work appropiately 
                                            bool shouldAddTimeToEndDate = true;

                                            DateTime startDate = DateTime.MinValue;
                                            DateTime endDate = DateTime.MinValue;

                                            // First try with iOs 6
                                            if (InAppRes.m_oInAppReceipt.iOSVersion == "6")
                                            {
                                                #region iOs 6

                                                // If we have only one latest receipt info (in iOS 6, it should be)
                                                if (InAppRes.m_oInAppReceipt.latest_receipt_info != null &&
                                                    InAppRes.m_oInAppReceipt.latest_receipt_info.Count == 1)
                                                {
                                                    iTunesReceipt latestReceiptInfo = InAppRes.m_oInAppReceipt.latest_receipt_info.First();

                                                    // Use expires_date (which is in MS in iOs 6) and purchase_date_ms to find start/end dates
                                                    if (!string.IsNullOrEmpty(latestReceiptInfo.expires_date) &&
                                                        !string.IsNullOrEmpty(latestReceiptInfo.purchase_date_ms))
                                                    {
                                                        double startMS = double.Parse(latestReceiptInfo.purchase_date_ms);
                                                        double endMS = double.Parse(latestReceiptInfo.expires_date);

                                                        startDate = dt1970.AddMilliseconds(startMS);
                                                        endDate = dt1970.AddMilliseconds(endMS);
                                                    }
                                                }

                                                // If we couldn't find the dates with latest receipt info,
                                                // Use receipt
                                                if (startDate == DateTime.MinValue || endDate == DateTime.MinValue)
                                                {
                                                    double startMS = double.Parse(InAppRes.m_oInAppReceipt.receipt.purchase_date_ms);
                                                    double endMS = double.Parse(InAppRes.m_oInAppReceipt.receipt.expires_date);

                                                    startDate = dt1970.AddMilliseconds(startMS);
                                                    endDate = dt1970.AddMilliseconds(endMS);
                                                }

                                                #endregion
                                            }
                                            // Then try with iOS 7
                                            else if (InAppRes.m_oInAppReceipt.iOSVersion == "7")
                                            {
                                                #region iOs 7
                                                if (InAppRes.m_oInAppReceipt.latest_receipt_info != null && InAppRes.m_oInAppReceipt.latest_receipt_info.Count > 0)
                                                {
                                                    double startMS = 0;
                                                    double endMS = 0;

                                                    // Run on all latest receipts and find the one that matches the date and the product id
                                                    foreach (var lastReceipt in InAppRes.m_oInAppReceipt.latest_receipt_info)
                                                    {
                                                        // If the product code matches
                                                        if (lastReceipt.product_id == sProductCode)
                                                        {
                                                            double currentStartMS;
                                                            double currentEndMS;

                                                            // Find the maximum start date
                                                            double.TryParse(lastReceipt.purchase_date_ms, out currentStartMS);
                                                            double.TryParse(lastReceipt.expires_date_ms, out currentEndMS);

                                                            if (currentStartMS > startMS)
                                                            {
                                                                startMS = currentStartMS;
                                                                endMS = currentEndMS;
                                                            }
                                                        }
                                                    }

                                                    // If we found a receipt with the matching product code and good purchase date
                                                    if (startMS > 0)
                                                    {
                                                        startDate = dt1970.AddMilliseconds(startMS);

                                                        if (endMS > 0)
                                                        {
                                                            endDate = dt1970.AddMilliseconds(endMS);
                                                        }
                                                        else
                                                        {
                                                            if (theSub != null && theSub.m_oSubscriptionUsageModule != null &&
                                                                theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle > 0)
                                                            {
                                                                // Set end date according to subscription's usage module full life cycle
                                                                // This data is in MINUTES
                                                                endDate = Utils.GetEndDateTime(startDate, theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle);

                                                                shouldAddTimeToEndDate = false;
                                                            }
                                                        }
                                                    }
                                                }

                                                // If we don't have a start or end date, check receipt
                                                if (startDate == DateTime.MinValue &&
                                                    endDate == DateTime.MinValue)
                                                {
                                                    if (InAppRes.m_oInAppReceipt.receipt != null)
                                                    {
                                                        double startMS;
                                                        double endMS;

                                                        double.TryParse(InAppRes.m_oInAppReceipt.receipt.purchase_date_ms, out startMS);
                                                        double.TryParse(InAppRes.m_oInAppReceipt.receipt.expires_date_ms, out endMS);

                                                        // If we found a receipt with the matching product code and good purchase date
                                                        if (startMS > 0)
                                                        {
                                                            startDate = dt1970.AddMilliseconds(startMS);

                                                            if (endMS > 0)
                                                            {
                                                                endDate = dt1970.AddMilliseconds(endMS);
                                                            }
                                                            else
                                                            {
                                                                if (theSub != null && theSub.m_oSubscriptionUsageModule != null &&
                                                                    theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle > 0)
                                                                {
                                                                    // Set end date according to subscription's usage module full life cycle
                                                                    // This data is in MINUTES
                                                                    endDate = Utils.GetEndDateTime(startDate, theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle);

                                                                    shouldAddTimeToEndDate = false;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                // If we don't have a start or end date, check in_app
                                                if (startDate == DateTime.MinValue &&
                                                    endDate == DateTime.MinValue)
                                                {
                                                    if (InAppRes.m_oInAppReceipt.in_app != null && InAppRes.m_oInAppReceipt.in_app.Count > 0)
                                                    {
                                                        double startMS = 0;
                                                        double endMS = 0;

                                                        // Run on all latest receipts and find the one that matches the date and the product id
                                                        foreach (var lastReceipt in InAppRes.m_oInAppReceipt.in_app)
                                                        {
                                                            // If the product code matches
                                                            if (lastReceipt.product_id == sProductCode)
                                                            {
                                                                // Find the maximum start date
                                                                double currentStartMS = double.Parse(lastReceipt.purchase_date_ms);
                                                                double currentEndMS;

                                                                if (currentStartMS > startMS)
                                                                {
                                                                    startMS = currentStartMS;

                                                                    // End date is optional here, so try parse it
                                                                    if (!string.IsNullOrEmpty(lastReceipt.expires_date_ms) &&
                                                                        double.TryParse(lastReceipt.expires_date_ms, out currentEndMS))
                                                                    {
                                                                        endMS = currentEndMS;
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        // If we found a receipt with the matching product code and good purchase date
                                                        if (startMS > 0)
                                                        {
                                                            startDate = dt1970.AddMilliseconds(startMS);
                                                            endDate = dt1970.AddMilliseconds(endMS);
                                                        }

                                                        // If we don't have an end date
                                                        if (endDate == DateTime.MinValue || endDate == dt1970)
                                                        {
                                                            if (theSub != null && theSub.m_oSubscriptionUsageModule != null &&
                                                                theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle > 0)
                                                            {
                                                                // Set end date according to subscription's usage module full life cycle
                                                                // This data is in MINUTES
                                                                endDate = Utils.GetEndDateTime(startDate, theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle);

                                                                shouldAddTimeToEndDate = false;
                                                            }
                                                            else
                                                            {
                                                                endDate = dt1970;
                                                            }
                                                        }
                                                    }
                                                }

                                                #endregion
                                            }

                                            #region Set start date and end date

                                            // If we don't have a start or end date
                                            if (startDate == DateTime.MinValue ||
                                                endDate == DateTime.MinValue)
                                            {
                                                InAppRes.m_oBillingResponse.m_sStatusDescription = "Something went wrong with start and end date";

                                                startDate = dt1970;
                                                endDate = dt1970;
                                            }

                                            if (shouldAddTimeToEndDate)
                                            {
                                                endDate = endDate.AddHours(6);
                                            }

                                            if (startDate > DateTime.UtcNow)
                                            {
                                                startDate = DateTime.UtcNow;
                                            }

                                            #endregion

                                            long nPurchaseID = ConditionalAccessDAL.Insert_NewMPPPurchase(m_nGroupID, sSubscriptionCode, sSiteGUID, dPrice, sCurrency, sCustomData, sCountryCd, sLANGUAGE_CODE,
                                                                                                            sDEVICE_NAME, theSub.m_oUsageModule != null ? theSub.m_oUsageModule.m_nMaxNumberOfViews : 0,
                                                                                                            theSub.m_oUsageModule != null ? theSub.m_oUsageModule.m_tsViewLifeCycle : 0, bIsRecurring,
                                                                                                            nReciptCode, theSub.m_oPreviewModule != null ? theSub.m_oPreviewModule.m_nID : 0, startDate, endDate,
                                                                                                            DateTime.UtcNow, string.Empty, domainId);

                                            if (nReciptCode > 0)
                                            {
                                                updateQuery1 = new ODBCWrapper.UpdateQuery("billing_transactions");
                                                updateQuery1.SetConnectionKey("MAIN_CONNECTION_STRING");
                                                updateQuery1 += ODBCWrapper.Parameter.NEW_PARAM("PURCHASE_ID", "=", nPurchaseID);
                                                updateQuery1 += "where";
                                                updateQuery1 += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nReciptCode);
                                                updateQuery1.Execute();
                                            }

                                            // # Event trigger: Purchase via Apple IAP (old engine) occurred, 
                                            // Event data: username/ID, subscription details, is-free-trial, start and end-date
                                            Dictionary<string, object> eventRecordData = new Dictionary<string, object>()
                                            {
                                                {"SubscriptionCode", sSubscriptionCode},
                                                {"SiteGUID", sSiteGUID},
                                                {"StartDate", startDate},
                                                {"EndDate", endDate},
                                                {"PurchaseId", nPurchaseID},
                                                {"CustomData", sCustomData},
                                                {"BillingTransactionID", nReciptCode},
                                                {"Price", dPrice},
                                                {"CouponCode", string.Empty},
                                            };

                                            if (!this.EnqueueEventRecord(NotifiedAction.ChargedSubscription, eventRecordData))
                                            {
                                                log.ErrorFormat("Error while enqueue subscription purchase record: subCode = {0}" +
                                                "siteGuid = {1}", sSubscriptionCode, sSiteGUID);
                                            }
                                        }

                                    }
                                    catch (Exception ex)
                                    {
                                        #region Logging
                                        StringBuilder sb = new StringBuilder("Exception at InApp_BaseChargeUserForSubscription. ");
                                        sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                                        sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                                        sb.Append(String.Concat(" Price: ", dPrice));
                                        sb.Append(String.Concat(" Product Cd: ", sProductCode));
                                        sb.Append(String.Concat(" Curr Cd: ", sCurrency));
                                        sb.Append(String.Concat(" IP: ", sUserIP));
                                        sb.Append(String.Concat(" Device Name: ", sDEVICE_NAME));
                                        sb.Append(String.Concat(" this is: ", this.GetType().Name));
                                        sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                                        sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                                        log.Error("Exception - " + sb.ToString(), ex);
                                        #endregion

                                        InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                                        InAppRes.m_oBillingResponse.m_sStatusDescription = "Failed saving subscription purchase";
                                    }
                                }
                                else
                                {
                                    InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                                    InAppRes.m_oBillingResponse.m_sRecieptCode = "";
                                    InAppRes.m_oBillingResponse.m_sStatusDescription = InAppRes.m_oBillingResponse.m_sStatusDescription;
                                    WriteToUserLog(sSiteGUID, "while trying to purchase subscription(InApp): " + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                                }
                            }
                            else
                            {
                                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                InAppRes.m_oBillingResponse.m_sRecieptCode = "";
                                InAppRes.m_oBillingResponse.m_sStatusDescription = "The price of the request is not the actual price";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(InApp): " + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.Free)
                            {
                                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                                InAppRes.m_oBillingResponse.m_sRecieptCode = "";
                                InAppRes.m_oBillingResponse.m_sStatusDescription = "The subscription is free";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(InApp): " + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            }
                            if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                                InAppRes.m_oBillingResponse.m_sRecieptCode = "";
                                InAppRes.m_oBillingResponse.m_sStatusDescription = "The subscription is already purchased";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(InApp): " + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            }
                            if (theReason == PriceReason.UnKnown)
                            {
                                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                                InAppRes.m_oBillingResponse.m_sRecieptCode = "";
                                InAppRes.m_oBillingResponse.m_sStatusDescription = "Error Unkown";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(InApp): " + " error returned: " + InAppRes.m_oBillingResponse.m_sStatusDescription);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at InApp_BaseChargeUserForSubscription. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" Product Cd: ", sProductCode));
                sb.Append(String.Concat(" Curr Cd: ", sCurrency));
                sb.Append(String.Concat(" IP: ", sUserIP));
                sb.Append(String.Concat(" Device Name: ", sDEVICE_NAME));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion

                InAppRes.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                InAppRes.m_oBillingResponse.m_sStatusDescription = "Internal error";

            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
                if (selectExistQuery != null)
                {
                    selectExistQuery.Finish();
                }
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
                if (insertQuery != null)
                {
                    insertQuery.Finish();
                }
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
                if (updateQuery1 != null)
                {
                    updateQuery1.Finish();
                }
                #endregion
            }
            return InAppRes.m_oBillingResponse;
        }

        /// <summary>
        /// In App Charge User For Subscription
        /// </summary>
        public virtual BillingResponse InApp_ChargeUserForSubscription(string sSiteGUID, double dPrice, string sCurrency, string sProductCode, string sUserIP, string sExtraParams,
           string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string ReceiptData)
        {
            return InApp_BaseChargeUserForSubscription(sSiteGUID, dPrice, sCurrency, sProductCode, sUserIP, sExtraParams, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, ReceiptData);
        }
        /// <summary>
        /// Renew Cacled Subscription
        /// </summary>
        public bool RenewCacledSubscription(string sSiteGUID, string sSubscriptionCode, Int32 nSubscriptionPurchaseID)
        {
            bool bRet = false;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            ODBCWrapper.InsertQuery insertQuery = null;
            try
            {
                PriceReason theReason = PriceReason.UnKnown;
                Subscription theSub = null;
                Price p = Utils.GetSubscriptionFinalPrice(m_nGroupID, sSubscriptionCode, sSiteGUID, string.Empty, ref theReason, ref theSub, string.Empty, string.Empty, string.Empty);
                bool bIsRecurring = false;
                if (theSub != null && theSub.m_oUsageModule != null)
                    bIsRecurring = theSub.m_bIsRecurring;
                if (bIsRecurring)
                {
                    selectQuery = new ODBCWrapper.DataSetSelectQuery();
                    selectQuery += "select * from subscriptions_purchases with (nolock) where IS_ACTIVE=1 and STATUS=1 and RECURRING_RUNTIME_STATUS=0 and ";
                    selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubscriptionCode);
                    selectQuery += "and";
                    selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                    selectQuery += "and";
                    selectQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nSubscriptionPurchaseID);
                    if (m_nGroupID != 0)
                    {
                        selectQuery += "and";
                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("group_id", "=", m_nGroupID);
                    }
                    if (selectQuery.Execute("query", true) != null)
                    {
                        Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                        if (nCount > 0)
                        {
                            Int32 nID = int.Parse(selectQuery.Table("query").DefaultView[0].Row["ID"].ToString());
                            updateQuery = new ODBCWrapper.UpdateQuery("subscriptions_purchases");
                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_RECURRING_STATUS", "=", 1);
                            updateQuery += " where ";
                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nID);
                            updateQuery.Execute();
                            bRet = true;

                            //Insert renew subscription row
                            insertQuery = new ODBCWrapper.InsertQuery("subscriptions_status_changes");
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubscriptionCode);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("NEW_RENEWABLE_STATUS", "=", 1);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("COUNTRY_CODE", "=", "");
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("LANGUAGE_CODE", "=", "");
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DEVICE_NAME", "=", "");
                            insertQuery.Execute();


                            //Write to users log
                            WriteToUserLog(sSiteGUID, "Subscription: " + sSubscriptionCode.ToString() + " renew activated");
                        }
                    }

                }
            }
            finally
            {
                #region Disposing
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
                if (insertQuery != null)
                {
                    insertQuery.Finish();
                }
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
                #endregion
            }
            return bRet;
        }

        /// <summary>
        /// Cancel a household service subscription at the next renewal. The subscription stays valid till the next renewal.
        /// </summary>
        /// <param name="sSiteGUID"></param>
        /// <param name="sSubscriptionCode"></param>
        /// <param name="nSubscriptionPurchaseID"></param>
        /// <returns></returns>
        public virtual bool CancelSubscription(string sSiteGUID, string sSubscriptionCode, Int32 nSubscriptionPurchaseID)
        {
            bool bRet = false;
            Subscription theSub = null;
            try
            {
                long domainId = 0;
                Utils.ValidateUser(m_nGroupID, sSiteGUID, ref domainId);

                string sWSUserName = string.Empty;
                string sWSPass = string.Empty;
                using (mdoule m = new WS_Pricing.mdoule())
                {
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                    theSub = m.GetSubscriptionData(sWSUserName, sWSPass, sSubscriptionCode, string.Empty, string.Empty, string.Empty, false);
                }

                if (theSub != null && theSub.m_oUsageModule != null && theSub.m_oSubscriptionPriceCode != null && theSub.m_bIsRecurring)
                {
                    DataTable dt = ConditionalAccessDAL.GetSubscriptionPurchaseID(nSubscriptionPurchaseID);
                    if (dt != null && dt.Rows != null && dt.Rows.Count > 0)
                    {
                        Int32 nID = ODBCWrapper.Utils.GetIntSafeVal(dt.Rows[0]["ID"]);

                        bRet = ConditionalAccessDAL.CancelSubscription(nID, m_nGroupID, sSiteGUID, sSubscriptionCode) > 0;
                        if (bRet)
                        {
                            WriteToUserLog(sSiteGUID,
                                String.Concat("Sub ID: ", sSubscriptionCode, " with Purchase ID: ", nSubscriptionPurchaseID, " has been canceled."));
                            if (!LayeredCache.Instance.SetInvalidationKey(LayeredCacheKeys.GetCancelSubscriptionInvalidationKey(domainId)))
                            {
                                log.ErrorFormat("Failed to set invalidation key on CancelSubscription for domainId = {0}");
                            }
                        }
                        else
                        {
                            #region Logging
                            StringBuilder sb = new StringBuilder("CancelSubscription. Probably failed to cancel subscription against DB. ");
                            sb.Append(String.Concat("Site Guid: ", sSiteGUID));
                            sb.Append(String.Concat(" Sub Code: ", sSubscriptionCode));
                            sb.Append(String.Concat(" Sub Purchase ID: ", nSubscriptionPurchaseID));

                            log.Error("Error - " + sb.ToString());
                            #endregion
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at CancelSubscriptionRenewal. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Sub Code: ", sSubscriptionCode));
                sb.Append(String.Concat(" Sub Purchase ID: ", nSubscriptionPurchaseID));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            return bRet;
        }
        /// <summary>
        /// Cancel a household service subscription at the next renewal. The subscription stays valid till the next renewal.
        /// </summary>
        /// <param name="p_nDomainId"></param>
        /// <param name="p_sSubscriptionCode"></param>
        /// <returns></returns>
        public virtual ApiObjects.Response.Status CancelSubscriptionRenewal(int p_nDomainId, string p_sSubscriptionCode)
        {
            ApiObjects.Response.Status oResult = new ApiObjects.Response.Status();
            bool bResult = false;

            try
            {
                // Get domain info - both for validation and for getting users in domain
                Domain oDomain = Utils.GetDomainInfo(p_nDomainId, this.m_nGroupID);

                // Check if the domain is OK
                if (oDomain == null)
                {
                    oResult.Code = (int)eResponseStatus.DomainNotExists;
                    oResult.Message = "Domain doesn't exist";
                    log.Error("Domain doesn't exist");
                }
                else
                {
                    if (oDomain.m_DomainStatus != DomainStatus.OK &&
                        oDomain.m_DomainStatus != DomainStatus.DomainCreatedWithoutNPVRAccount)
                    {
                        if (oDomain.m_DomainStatus == DomainStatus.DomainSuspended)
                        {
                            oResult.Code = (int)eResponseStatus.DomainSuspended;
                            oResult.Message = "Domain suspended";
                        }
                        else
                        {
                            oResult.Code = (int)eResponseStatus.DomainNotExists;
                            oResult.Message = "Domain doesn't exist";
                        }
                        log.Error("Domain status: " + oDomain.m_DomainStatus.ToString());
                    }
                    else
                    {
                        int[] arrUsers = oDomain.m_UsersIDs.ToArray();

                        DataRow drUserPurchase = GetSubscriptionPurchaseRow(p_sSubscriptionCode, arrUsers, p_nDomainId);

                        // If all of the users didn't purchase this subscription
                        if (drUserPurchase == null)
                        {
                            oResult.Code = (int)eResponseStatus.InvalidPurchase;
                            oResult.Message = "Subscription is not permitted for this domain";
                        }
                        else
                        {
                            int nPurchaseID = ODBCWrapper.Utils.ExtractInteger(drUserPurchase, "ID");
                            int nIsRecurringStatus = ODBCWrapper.Utils.ExtractInteger(drUserPurchase, "IS_RECURRING_STATUS");
                            string sPurchasingSiteGuid = ODBCWrapper.Utils.ExtractValue<string>(drUserPurchase, "SITE_USER_GUID");

                            // If the subscription is not recurring already
                            if (nIsRecurringStatus != 1)
                            {
                                oResult.Code = (int)eResponseStatus.SubscriptionNotRenewable;
                                oResult.Message = "Subscription already does not renew";
                            }
                            else
                            {
                                // Try to cancel subscription
                                bResult = ConditionalAccessDAL.CancelSubscription(nPurchaseID, m_nGroupID, sPurchasingSiteGuid, p_sSubscriptionCode, (int)SubscriptionPurchaseStatus.Cancel) > 0;

                                if (bResult)
                                {
                                    // site guid of purchasing user
                                    WriteToUserLog(sPurchasingSiteGuid,
                                        String.Concat("Sub ID: ", p_sSubscriptionCode, " with Purchase ID: ",
                                        ODBCWrapper.Utils.ExtractInteger(drUserPurchase, "ID"), " has been canceled."));

                                    oResult.Code = (int)eResponseStatus.OK;
                                    oResult.Message = "Subscription renewal cancelled";

                                    DateTime dtServiceEndDate = ODBCWrapper.Utils.ExtractDateTime(drUserPurchase, "END_DATE");

                                    // Fire event that action occurred
                                    Dictionary<string, object> dicData = new Dictionary<string, object>()
                                    {
                                        {"DomainId", p_nDomainId},
                                        {"ServiceID", p_sSubscriptionCode},
                                        {"ServiceEndDate", dtServiceEndDate}
                                    };

                                    EnqueueEventRecord(NotifiedAction.CancelDomainSubscriptionRenewal, dicData);
                                }
                                else
                                {
                                    #region Logging
                                    StringBuilder sb = new StringBuilder("CancelSubscriptionRenewal. Probably failed to cancel subscription on DB. ");
                                    sb.Append(String.Concat("Domain Id: ", p_nDomainId));
                                    sb.Append(String.Concat(" Sub Code: ", p_sSubscriptionCode));

                                    log.Error("Error - " + sb.ToString());
                                    #endregion

                                    oResult.Code = (int)eResponseStatus.Error;
                                    oResult.Message = "Error while cancelling";
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at CancelSubscriptionRenewal. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Domain Id: ", p_nDomainId));
                sb.Append(String.Concat(" Sub Code: ", p_sSubscriptionCode));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion

                oResult.Code = (int)eResponseStatus.Error;
                oResult.Message = "Unexpected error occurred";
            }

            return oResult;
        }

        /// <summary>
        /// Tells whether the users purchased this subscription or not.
        /// Also gets the user permitted subscriptions' purchases
        /// </summary>
        /// <param name="subscriptionCode"></param>
        /// <param name="arrUsers"></param>
        /// <returns></returns>
        private bool IsSubscriptionPermittedForUsers(string subscriptionCode, int[] arrUsers, out DataTable dataTableUserPurchases)
        {
            bool bResult = false;
            int domainID = 0;

            // Get domainID from one of the users
            if (arrUsers.Length > 0)
            {
                UserResponseObject user = Utils.GetExistUser(arrUsers.First().ToString(), m_nGroupID);
                if (user != null && user.m_RespStatus == ResponseStatus.OK && user.m_user != null)
                {
                    domainID = user.m_user.m_domianID;
                }
            }

            dataTableUserPurchases = ConditionalAccessDAL.Get_UsersPermittedSubscriptions(arrUsers.ToList(), false, domainID);

            // If there is at least one valid subscription
            if (dataTableUserPurchases != null && dataTableUserPurchases.Rows != null && dataTableUserPurchases.Rows.Count > 0)
            {
                // Run on all purchases until a match is found
                foreach (DataRow drUserPurchase in dataTableUserPurchases.Rows)
                {
                    // If this it the subscription we are looking for
                    if (subscriptionCode == ODBCWrapper.Utils.ExtractString(drUserPurchase, "SUBSCRIPTION_CODE"))
                    {
                        object oCancellationDate = drUserPurchase["CANCELLATION_DATE"];

                        // Check if the subscription is not cancelled
                        if ((oCancellationDate == null) || (oCancellationDate == DBNull.Value))
                        {
                            bResult = true;
                            break;
                        }
                    }
                }
            }

            return (bResult);
        }

        /// <summary>
        /// Gets the subscription purchase row of the given subscription by any of the given users
        /// </summary>
        /// <param name="p_sSubscriptionCode"></param>
        /// <param name="p_arrUsers"></param>
        /// <returns></returns>
        private DataRow GetSubscriptionPurchaseRow(string p_sSubscriptionCode, int[] p_arrUsers, int domainID = 0)
        {
            DataRow drUserPurchase = null;
            DataTable dtUsersPurchases = ConditionalAccessDAL.Get_UsersSubscriptionPurchases(p_arrUsers.ToList(), p_sSubscriptionCode, domainID);

            // If there is at least one valid purchase
            if (dtUsersPurchases != null && dtUsersPurchases.Rows != null && dtUsersPurchases.Rows.Count > 0)
            {
                drUserPurchase = dtUsersPurchases.Rows[0];
            }

            return (drUserPurchase);
        }

        /// <summary>
        /// Update Subscription
        /// </summary>
        public virtual bool UpdateSubscriptionDate(string sSiteGUID, string sSubscriptionCode, Int32 nSubscriptionPurchaseID, Int32 dAdditionInDays, bool bRenewable)
        {
            bool bRet = false;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            try
            {
                PriceReason theReason = PriceReason.UnKnown;
                Subscription theSub = null;
                Price p = Utils.GetSubscriptionFinalPrice(m_nGroupID, sSubscriptionCode, sSiteGUID, string.Empty, ref theReason, ref theSub, "", "", "");
                bool bIsRecurring = false;
                if (theSub != null && theSub.m_oUsageModule != null)
                    bIsRecurring = theSub.m_bIsRecurring;

                selectQuery = new ODBCWrapper.DataSetSelectQuery();
                selectQuery += "select * from subscriptions_purchases with (nolock) where IS_ACTIVE=1 and STATUS=1 and RECURRING_RUNTIME_STATUS=0 and ";
                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubscriptionCode);
                selectQuery += "and";
                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                if (m_nGroupID != 0)
                {
                    selectQuery += "and";
                    selectQuery += ODBCWrapper.Parameter.NEW_PARAM("group_id", "=", m_nGroupID);
                }
                selectQuery += "and";
                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nSubscriptionPurchaseID);
                if (selectQuery.Execute("query", true) != null)
                {
                    Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                    for (int i = 0; i < nCount; i++)
                    {
                        Int32 nID = int.Parse(selectQuery.Table("query").DefaultView[i].Row["ID"].ToString());
                        Int32 nCurrentRecurring = int.Parse(selectQuery.Table("query").DefaultView[i].Row["IS_RECURRING_STATUS"].ToString());
                        DateTime dCurrentEndDate = (DateTime)(selectQuery.Table("query").DefaultView[i].Row["END_DATE"]);
                        DateTime dEndDate = dCurrentEndDate.AddDays(dAdditionInDays);
                        if (dAdditionInDays == -111111)
                            dEndDate = DateTime.UtcNow;
                        if (dAdditionInDays == 30)
                            dEndDate = dCurrentEndDate.AddMonths(1);
                        updateQuery = new ODBCWrapper.UpdateQuery("subscriptions_purchases");
                        if (bIsRecurring == true && bRenewable == true)
                            RenewCacledSubscription(sSiteGUID, sSubscriptionCode, nSubscriptionPurchaseID);
                        if (bIsRecurring == true && bRenewable == false)
                            CancelSubscription(sSiteGUID, sSubscriptionCode, nSubscriptionPurchaseID);
                        updateQuery += ODBCWrapper.Parameter.NEW_PARAM("END_DATE", "=", dEndDate);
                        updateQuery += " where ";
                        updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nID);
                        updateQuery.Execute();
                        bRet = true;
                        WriteToUserLog(sSiteGUID, "Subscription: " + sSubscriptionCode.ToString() + "End date changed(" + dCurrentEndDate.ToString("MM/dd/yyyy HH:mm") + "-->" + dEndDate.ToString("MM/dd/yyyy HH:mm") + ")");
                        //Write to users log
                    }
                }
            }
            finally
            {
                #region Disposing
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
                #endregion
            }
            return bRet;
        }
        /// <summary>
        /// Credit Card Renew Subscription
        /// </summary>
        public BillingResponse CC_BaseRenewSubscription(string sSiteGUID, double dPrice, string sCurrency,
            string sSubscriptionCode, string sUserIP, string sExtraParams, Int32 nPurchaseID, Int32 nPaymentNumber,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            string sCouponCode = string.Empty;
            BillingResponse ret = new BillingResponse();
            UsersService u = null;
            mdoule m = null;
            module bm = null;
            ODBCWrapper.DirectQuery directQuery = null;
            ODBCWrapper.DirectQuery directQuery1 = null;
            ODBCWrapper.DirectQuery directQuery2 = null;
            ODBCWrapper.DirectQuery directQuery3 = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            try
            {
                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_sRecieptCode = string.Empty;
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);

                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                        WriteToUserLog(sSiteGUID, "Subscription auto renewal: " + sSubscriptionCode.ToString() + " error returned: " + ret.m_sStatusDescription);
                    }
                    else
                    {
                        m = new WS_Pricing.mdoule();
                        Subscription theSub = null;

                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        theSub = m.GetSubscriptionData(sWSUserName, sWSPass, sSubscriptionCode, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, false);

                        if (theSub != null && theSub.m_nNumberOfRecPeriods != 0 && theSub.m_nNumberOfRecPeriods <= nPaymentNumber)
                        {
                            directQuery = new ODBCWrapper.DirectQuery();
                            directQuery.SetConnectionKey("CA_CONNECTION_STRING");
                            directQuery += "update subscriptions_purchases set ";
                            directQuery += "IS_RECURRING_STATUS = 0 ";
                            directQuery += " where ";
                            directQuery += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                            directQuery.Execute();

                        }
                        else if (theSub != null)
                        {
                            string sCustomData = string.Empty;
                            if (dPrice != 0)
                            {
                                bm = new module();
                                sWSUserName = string.Empty;
                                sWSPass = string.Empty;
                                Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                                bool bIsRecurring = theSub.m_bIsRecurring;

                                Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;

                                sCustomData = "<customdata type=\"sp\">";
                                if (String.IsNullOrEmpty(sCountryCd) == false)
                                    sCustomData += "<lcc>" + sCountryCd + "</lcc>";
                                if (String.IsNullOrEmpty(sLANGUAGE_CODE) == false)
                                    sCustomData += "<llc>" + sLANGUAGE_CODE + "</llc>";
                                if (String.IsNullOrEmpty(sDEVICE_NAME) == false)
                                    sCustomData += "<ldn>" + sDEVICE_NAME + "</ldn>";
                                sCustomData += "<mnou>";
                                if (theSub != null && theSub.m_oUsageModule != null)
                                    sCustomData += theSub.m_oUsageModule.m_nMaxNumberOfViews.ToString();
                                sCustomData += "</mnou>";
                                sCustomData += "<u id=\"" + sSiteGUID + "\"/>";
                                sCustomData += "<s>" + sSubscriptionCode + "</s>";
                                sCustomData += "<cc>" + sCouponCode + "</cc>";
                                sCustomData += "<p ir=\"" + bIsRecurring.ToString().ToLower() + "\" n=\"" + nPaymentNumber.ToString() + "\" o=\"" + nRecPeriods.ToString() + "\"/>";
                                sCustomData += "<vlcs>";
                                if (theSub != null && theSub.m_oUsageModule != null)
                                    sCustomData += theSub.m_oUsageModule.m_tsViewLifeCycle.ToString();
                                sCustomData += "</vlcs>";
                                sCustomData += "<mumlc>";
                                if (theSub != null && theSub.m_oSubscriptionUsageModule != null)
                                    sCustomData += theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle.ToString();
                                sCustomData += "</mumlc>";
                                sCustomData += "<ppvm>";
                                sCustomData += "</ppvm>";
                                sCustomData += "<pc>";
                                if (theSub != null && theSub.m_oSubscriptionPriceCode != null)
                                    sCustomData += theSub.m_oSubscriptionPriceCode.m_sCode;
                                sCustomData += "</pc>";
                                sCustomData += "<pri>";
                                sCustomData += dPrice.ToString();
                                sCustomData += "</pri>";
                                sCustomData += "<cu>";
                                sCustomData += sCurrency;
                                sCustomData += "</cu>";

                                sCustomData += "</customdata>";
                                ret = bm.CC_ChargeUser(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sUserIP, sCustomData, nPaymentNumber, nRecPeriods, sExtraParams, string.Empty, string.Empty);
                            }
                        }
                        if (ret.m_oStatus == BillingResponseStatus.Success)
                        {
                            Int32 nMaxVLC = theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle;
                            WriteToUserLog(sSiteGUID, "Subscription auto renewal: " + sSubscriptionCode.ToString() + " renewed" + dPrice.ToString() + sCurrency);
                            DateTime d = (DateTime)(ODBCWrapper.Utils.GetTableSingleVal("subscriptions_purchases", "end_date", nPurchaseID, "CA_CONNECTION_STRING"));
                            DateTime dNext = Utils.GetEndDateTime(d, nMaxVLC);
                            directQuery1 = new ODBCWrapper.DirectQuery();
                            directQuery1.SetConnectionKey("CA_CONNECTION_STRING");
                            directQuery1 += "update subscriptions_purchases set ";
                            directQuery1 += ODBCWrapper.Parameter.NEW_PARAM("end_date", "=", dNext);
                            directQuery1 += ",";
                            directQuery1 += ODBCWrapper.Parameter.NEW_PARAM("num_of_uses", "=", 0);
                            directQuery1 += " where ";
                            directQuery1 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                            directQuery1.Execute();

                            string sReciept = ret.m_sRecieptCode;
                            if (sReciept.Length > 0)
                            {
                                Int32 nID = int.Parse(sReciept);
                                updateQuery = new ODBCWrapper.UpdateQuery("billing_transactions");
                                updateQuery.SetConnectionKey("MAIN_CONNECTION_STRING");
                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("PURCHASE_ID", "=", nPurchaseID);
                                updateQuery += "where";
                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nID);
                                updateQuery.Execute();
                            }
                        }
                        else
                        {
                            WriteToUserLog(sSiteGUID, "Subscription auto renewal: " + sSubscriptionCode.ToString() + " error returned: " + ret.m_sStatusDescription);

                            if (ret.m_oStatus != BillingResponseStatus.ExternalError)
                            {
                                if (ret.m_oStatus == BillingResponseStatus.ExpiredCard)
                                {
                                    directQuery3 = new ODBCWrapper.DirectQuery();
                                    directQuery3.SetConnectionKey("CA_CONNECTION_STRING");
                                    directQuery3 += "update subscriptions_purchases set ";
                                    directQuery3 += "FAIL_COUNT = 10 ";
                                    directQuery3 += " where ";
                                    directQuery3 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                                    directQuery3.Execute();

                                }
                                directQuery2 = new ODBCWrapper.DirectQuery();
                                directQuery2.SetConnectionKey("CA_CONNECTION_STRING");
                                directQuery2 += "update subscriptions_purchases set ";
                                directQuery2 += "FAIL_COUNT = FAIL_COUNT + 1 ";
                                directQuery2 += " where ";
                                directQuery2 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                                directQuery2.Execute();



                            }
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at CC_BaseRenewSubscription.");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" Currency: ", sCurrency));
                sb.Append(String.Concat(" Sub Code: ", sSubscriptionCode));
                sb.Append(String.Concat(" User IP: ", sUserIP));
                sb.Append(String.Concat(" Extra Params: ", sExtraParams));
                sb.Append(String.Concat(" Purchase ID: ", nPurchaseID));
                sb.Append(String.Concat(" Payment num: ", nPaymentNumber));
                sb.Append(String.Concat(" Country Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Code: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" Device Nm: ", sDEVICE_NAME));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (m != null)
                {
                    m.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
                if (directQuery != null)
                {
                    directQuery.Finish();
                }
                if (directQuery1 != null)
                {
                    directQuery1.Finish();
                }
                if (directQuery2 != null)
                {
                    directQuery2.Finish();
                }
                if (directQuery3 != null)
                {
                    directQuery3.Finish();
                }
                #endregion
            }
            return ret;
        }

        /// <summary>
        /// In App Renew Subscription
        /// </summary>
        public virtual InAppBillingResponse InApp_RenewSubscription(string sSiteGUID, double dPrice, string sCurrency,
           string sSubscriptionCode, Int32 nPurchaseID, int nBillingMethod, Int32 nPaymentNumber,
           string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, int nInAppTransactionID)
        {
            log.Debug("Renew Fail - " + sSiteGUID + " " + sSubscriptionCode);
            string sCouponCode = string.Empty;
            InAppBillingResponse ret = new InAppBillingResponse(); // new ConditionalAccess.InAppBillingResponse();
            UsersService u = null;
            mdoule m = null;
            ODBCWrapper.DirectQuery directQuery = null;
            module bm = null;
            ODBCWrapper.DirectQuery directQuery1 = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            ODBCWrapper.DirectQuery directQuery2 = null;
            ODBCWrapper.DirectQuery directQuery3 = null;
            string sCustomData = string.Empty;

            try
            {
                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    #region terminate if site guid id empty
                    ret.m_oBillingResponse.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_oBillingResponse.m_sRecieptCode = "";
                    ret.m_oBillingResponse.m_sStatusDescription = "Cant charge an unknown user";
                    ret.m_oInAppReceipt = null;
                    #endregion
                }
                else
                {
                    #region Init useres web service
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    #endregion

                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        #region terminate if ResponseStatus NOT Ok.
                        ret.m_oBillingResponse = new BillingResponse();
                        ret.m_oBillingResponse.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_oBillingResponse.m_sRecieptCode = "";
                        ret.m_oBillingResponse.m_sStatusDescription = "Cant charge an unknown user";
                        ret.m_oInAppReceipt = null;
                        WriteToUserLog(sSiteGUID, "Subscription auto renewal: " + sSubscriptionCode.ToString() + " error returned: " + ret.m_oBillingResponse.m_sStatusDescription);
                        #endregion
                    }
                    else
                    {
                        #region Init Tvinci Pricing web service
                        m = new mdoule();
                        #endregion

                        Subscription theSub = null;

                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        theSub = m.GetSubscriptionData(sWSUserName, sWSPass, sSubscriptionCode, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, false);

                        if (theSub != null && theSub.m_nNumberOfRecPeriods != 0 && theSub.m_nNumberOfRecPeriods <= nPaymentNumber)
                        {
                            #region Update subscription purchasesto is recurring status = 0
                            directQuery = new ODBCWrapper.DirectQuery();
                            directQuery.SetConnectionKey("CA_CONNECTION_STRING");
                            directQuery += "update subscriptions_purchases set ";
                            directQuery += "IS_RECURRING_STATUS = 0 ";
                            directQuery += " where ";
                            directQuery += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                            directQuery.Execute();
                            #endregion
                        }
                        else if (theSub != null && theSub.m_oSubscriptionUsageModule != null)
                        {
                            if (dPrice != 0)
                            {
                                #region Init Billing web service
                                bm = new module();
                                sWSUserName = string.Empty;
                                sWSPass = string.Empty;
                                Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                                #endregion

                                bool bIsRecurring = theSub.m_bIsRecurring;

                                Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;

                                #region Create Custom Data
                                sCustomData = "<customdata type=\"sp\">";
                                if (String.IsNullOrEmpty(sCountryCd) == false)
                                    sCustomData += "<lcc>" + sCountryCd + "</lcc>";
                                if (String.IsNullOrEmpty(sLANGUAGE_CODE) == false)
                                    sCustomData += "<llc>" + sLANGUAGE_CODE + "</llc>";
                                if (String.IsNullOrEmpty(sDEVICE_NAME) == false)
                                    sCustomData += "<ldn>" + sDEVICE_NAME + "</ldn>";
                                sCustomData += "<mnou>";
                                if (theSub != null && theSub.m_oUsageModule != null)
                                    sCustomData += theSub.m_oUsageModule.m_nMaxNumberOfViews.ToString();
                                sCustomData += "</mnou>";
                                sCustomData += "<u id=\"" + sSiteGUID + "\"/>";
                                sCustomData += "<s>" + sSubscriptionCode + "</s>";
                                sCustomData += "<cc>" + sCouponCode + "</cc>";
                                sCustomData += "<p ir=\"" + bIsRecurring.ToString().ToLower() + "\" n=\"" + nPaymentNumber.ToString() + "\" o=\"" + nRecPeriods.ToString() + "\"/>";
                                sCustomData += "<vlcs>";
                                if (theSub != null && theSub.m_oUsageModule != null)
                                    sCustomData += theSub.m_oUsageModule.m_tsViewLifeCycle.ToString();
                                sCustomData += "</vlcs>";
                                sCustomData += "<mumlc>";
                                if (theSub != null && theSub.m_oSubscriptionUsageModule != null)
                                    sCustomData += theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle.ToString();
                                sCustomData += "</mumlc>";
                                sCustomData += "<ppvm>";
                                sCustomData += "</ppvm>";
                                sCustomData += "<pc>";
                                if (theSub != null && theSub.m_oSubscriptionPriceCode != null)
                                    sCustomData += theSub.m_oSubscriptionPriceCode.m_sCode;
                                sCustomData += "</pc>";
                                sCustomData += "<pri>";
                                sCustomData += dPrice.ToString();
                                sCustomData += "</pri>";
                                sCustomData += "<cu>";
                                sCustomData += sCurrency;
                                sCustomData += "</cu>";

                                sCustomData += "</customdata>";
                                #endregion

                                ret = bm.InApp_ReneweInAppPurchase(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sCustomData, nPaymentNumber, nRecPeriods, nInAppTransactionID);
                            }
                        }

                        if (ret.m_oBillingResponse.m_oStatus == BillingResponseStatus.Success && theSub != null && theSub.m_oSubscriptionUsageModule != null)
                        {
                            Int32 nMaxVLC = theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle;
                            WriteToUserLog(sSiteGUID, "Subscription InApp renewal: " + sSubscriptionCode.ToString() + " renewed" + dPrice.ToString() + sCurrency);

                            DateTime dt1970 = new DateTime(1970, 1, 1);
                            DateTime endDate = DateTime.MinValue;
                            InAppReceipt receipt = ret.m_oInAppReceipt;

                            // First try with iOs 6
                            if (receipt.iOSVersion == "6")
                            {
                                #region iOs 6

                                // If we have only one latest receipt info (in iOS 6, it should be)
                                if (receipt.latest_receipt_info != null &&
                                    receipt.latest_receipt_info.Count == 1)
                                {
                                    iTunesReceipt latestReceiptInfo = receipt.latest_receipt_info[0];

                                    // Use expires_date (which is in MS in iOs 6) and purchase_date_ms to find start/end dates
                                    if (!string.IsNullOrEmpty(latestReceiptInfo.expires_date) &&
                                        !string.IsNullOrEmpty(latestReceiptInfo.purchase_date_ms))
                                    {
                                        double endMS = double.Parse(latestReceiptInfo.expires_date);

                                        endDate = dt1970.AddMilliseconds(endMS);
                                    }
                                }

                                // If we couldn't find the dates with "latest receipt info",
                                // Use receipt
                                if (endDate == DateTime.MinValue)
                                {
                                    double endMS = double.Parse(receipt.receipt.expires_date);

                                    endDate = dt1970.AddMilliseconds(endMS);
                                }

                                #endregion
                            }
                            // Then try with iOS 7
                            else if (receipt.iOSVersion == "7")
                            {
                                #region iOS 7

                                if (receipt.latest_receipt_info != null)
                                {
                                    double endMS = 0;

                                    // Run on all latest receipts and find the one that matches the date and the product id
                                    foreach (var lastReceipt in receipt.latest_receipt_info)
                                    {
                                        // If the product code matches
                                        if (lastReceipt.product_id == theSub.m_ProductCode)
                                        {
                                            // Find the maximum start date
                                            double currentEndMS = double.Parse(lastReceipt.expires_date_ms);

                                            if (currentEndMS > endMS)
                                            {
                                                endMS = currentEndMS;
                                            }
                                        }
                                    }

                                    // If we found a receipt with the matching product code and good end date
                                    if (endMS > 0)
                                    {
                                        endDate = dt1970.AddMilliseconds(endMS);
                                    }
                                }

                                #endregion
                            }

                            // Check if there was a problem
                            if (endDate == DateTime.MinValue)
                            {
                                ret.m_oBillingResponse.m_sStatusDescription = "Something went wrong with the end date";
                            }

                            #region update subscription purchases
                            directQuery1 = new ODBCWrapper.DirectQuery();
                            directQuery1.SetConnectionKey("CA_CONNECTION_STRING");
                            directQuery1 += "update subscriptions_purchases set ";
                            directQuery1 += ODBCWrapper.Parameter.NEW_PARAM("end_date", "=", endDate.AddHours(6));
                            directQuery1 += ",";
                            directQuery1 += ODBCWrapper.Parameter.NEW_PARAM("num_of_uses", "=", 0);
                            directQuery1 += " where ";
                            directQuery1 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                            directQuery1.Execute();
                            #endregion

                            string sReciept = ret.m_oBillingResponse.m_sRecieptCode;

                            if (!string.IsNullOrEmpty(sReciept))
                            {
                                Int32 nID = int.Parse(sReciept);
                                updateQuery = new ODBCWrapper.UpdateQuery("billing_transactions");
                                updateQuery.SetConnectionKey("MAIN_CONNECTION_STRING");
                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("PURCHASE_ID", "=", nPurchaseID);
                                updateQuery += "where";
                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nID);
                                updateQuery.Execute();
                            }

                            // # Event trigger: Subscription renewal for Apple IAP (old engine) or Google IAP (new), 
                            // Event data: username/ID, subscription details, start and end-date, action - user canceled, 
                            // free-trial converted to paid subscription, paid subscription was renewed
                            Dictionary<string, object> eventRecordData = new Dictionary<string, object>()
                                {
                                    {"BillingTransactionID", sReciept},
                                    {"SiteGUID", sSiteGUID},
                                    {"PaymentNumber", nPaymentNumber},
                                    {"CustomData", sCustomData},
                                    {"Price", dPrice},
                                    {"PurchaseID", nPurchaseID},
                                    {"SubscriptionCode", sSubscriptionCode}
                                };

                            if (!this.EnqueueEventRecord(NotifiedAction.ChargedSubscriptionRenewal, eventRecordData))
                            {
                                log.ErrorFormat("Error while enqueue subscription purchase record: subCode = {0}" +
                                "siteGuid = {1}", sSubscriptionCode, sSiteGUID);
                            }

                            long domainId = 0;
                            Utils.ValidateUser(m_nGroupID, sSiteGUID, ref domainId);

                            string invalidationKey = LayeredCacheKeys.GetRenewInvalidationKey(domainId);
                            if (!LayeredCache.Instance.SetInvalidationKey(invalidationKey))
                            {
                                log.ErrorFormat("Failed to set invalidation key on InApp_RenewSubscription key = {0}", invalidationKey);
                            }
                        }
                        else
                        {
                            WriteToUserLog(sSiteGUID, "Subscription auto renewal: " + sSubscriptionCode.ToString() + " error returned: " + ret.m_oBillingResponse.m_sStatusDescription);

                            if (ret.m_oBillingResponse.m_oStatus != BillingResponseStatus.ExternalError)
                            {
                                if (ret.m_oBillingResponse.m_oStatus == BillingResponseStatus.ExpiredCard)
                                {
                                    #region Update subscription purchases to fail count = 10
                                    directQuery2 = new ODBCWrapper.DirectQuery();
                                    directQuery2.SetConnectionKey("CA_CONNECTION_STRING");
                                    directQuery2 += "update subscriptions_purchases set ";
                                    directQuery2 += "FAIL_COUNT = 10 ";
                                    directQuery2 += " where ";
                                    directQuery2 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                                    directQuery2.Execute();
                                    #endregion
                                }

                                #region Increase subscription purchase fail count
                                directQuery3 = new ODBCWrapper.DirectQuery();
                                directQuery3.SetConnectionKey("CA_CONNECTION_STRING");
                                directQuery3 += "update subscriptions_purchases set ";
                                directQuery3 += "FAIL_COUNT = FAIL_COUNT + 1 ";
                                directQuery3 += " where ";
                                directQuery3 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                                directQuery3.Execute();
                                #endregion
                            }
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at InApp_RenewSubscription.");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" Currency: ", sCurrency));
                sb.Append(String.Concat(" Sub Code: ", sSubscriptionCode));
                sb.Append(String.Concat(" Purchase ID: ", nPurchaseID));
                sb.Append(String.Concat(" Billing Method: ", nBillingMethod));
                sb.Append(String.Concat(" Payment Num: ", nPaymentNumber));
                sb.Append(String.Concat(" Country Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Cd: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" Device Name: ", sDEVICE_NAME));
                sb.Append(String.Concat(" InApp Trans ID: ", nInAppTransactionID));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);

                #endregion

                ret.m_oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                ret.m_oBillingResponse.m_sStatusDescription = "Internal error";
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (m != null)
                {
                    m.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
                if (directQuery != null)
                {
                    directQuery.Finish();
                }
                if (directQuery1 != null)
                {
                    directQuery1.Finish();
                }
                if (directQuery2 != null)
                {
                    directQuery2.Finish();
                }
                if (directQuery3 != null)
                {
                    directQuery3.Finish();
                }
                #endregion
            }
            return ret;
        }

        /*
            * returns true if user exists. false otherwise. throws exception if cannot deliver all data required for renewal
            * 
        */
        protected bool GetBaseRenewMultiUsageSubscriptionData(string sSiteGUID, string sSubscriptionCode, string sUserIP,
           Int32 nPurchaseID, Int32 nPaymentNumber, int nTotalPaymentsNumber, string sCountryCd, string sLANGUAGE_CODE,
           string sDEVICE_NAME, int nNumOfPayments, bool bIsPurchasedWithPreviewModule, DateTime dtCurrentEndDate,
           ref double dPrice, ref string sCustomData, ref string sCurrency, ref int nRecPeriods,
           ref bool bIsMPPRecurringInfinitely, ref int nMaxVLCOfSelectedUsageModule)
        {
            string sCouponCode = string.Empty;
            UserResponseObject ExistUser = Utils.GetExistUser(sSiteGUID, m_nGroupID);

            if (ExistUser != null && ExistUser.m_RespStatus == ResponseStatus.OK)
            {
                mdoule m = null;
                try
                {
                    DateTime dtCorruptedEndDate = new DateTime(2000, 1, 1);
                    if (dtCorruptedEndDate.Equals(dtCurrentEndDate))
                        throw new Exception("End date extracted from subscriptions purchases is corrupted");

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                    m = new mdoule();
                    Subscription theSub = null;

                    theSub = m.GetSubscriptionData(sWSUserName, sWSPass, sSubscriptionCode, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, false);
                    GetMultiSubscriptionUsageModule(sSiteGUID, sUserIP, nPurchaseID, nPaymentNumber, nTotalPaymentsNumber, nNumOfPayments, bIsPurchasedWithPreviewModule,
                        ref dPrice, ref sCustomData, ref sCurrency, ref nRecPeriods, ref bIsMPPRecurringInfinitely, ref nMaxVLCOfSelectedUsageModule,
                        ref sCouponCode, theSub);
                }
                catch (Exception ex)
                {
                    log.Error(string.Empty, ex);
                }
                finally
                {
                    if (m != null)
                    {
                        m.Dispose();
                        m = null;
                    }
                }
            }
            else
            {
                return false;
            }

            return true;
        }

        protected internal void GetMultiSubscriptionUsageModule(string siteguid, string userIp, Int32 purchaseId, Int32 paymentNumber, int totalPaymentsNumber,
                int numOfPayments, bool isPurchasedWithPreviewModule, ref double priceValue, ref string customData, ref string sCurrency, ref int nRecPeriods,
                ref bool isMPPRecurringInfinitely, ref int maxVLCOfSelectedUsageModule, ref string couponCode, Subscription subscription)
        {
            if (subscription == null)
            {
                throw new Exception("Subscription returned from pricing module is null");
            }
            else
            {
                UsageModule AppUsageModule = GetAppropriateMultiSubscriptionUsageModule(subscription, paymentNumber, purchaseId, totalPaymentsNumber,
                                                                                                      numOfPayments, isPurchasedWithPreviewModule);
                priceValue = 0;
                Currency oCurrency = null;
                sCurrency = "n/a";

                if (AppUsageModule != null)
                {
                    // price data and discount code data
                    string wsUserName = string.Empty;
                    string waPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref wsUserName, ref waPass);
                    using (mdoule priceModule = new mdoule())
                    {
                        try
                        {
                            PriceCode p = priceModule.GetPriceCodeData(wsUserName, waPass, AppUsageModule.m_pricing_id.ToString(), string.Empty, string.Empty, string.Empty);
                            DiscountModule externalDisount = priceModule.GetDiscountCodeData(wsUserName, waPass, AppUsageModule.m_ext_discount_id.ToString());

                            if (externalDisount != null)
                            {
                                Price price = Utils.GetPriceAfterDiscount(p.m_oPrise, externalDisount, 1);
                                priceValue = price.m_dPrice;
                                oCurrency = price.m_oCurrency;
                                sCurrency = price.m_oCurrency.m_sCurrencyCD3;
                            }
                            else
                            {
                                priceValue = p.m_oPrise.m_dPrice;
                                oCurrency = p.m_oPrise.m_oCurrency;
                                sCurrency = p.m_oPrise.m_oCurrency.m_sCurrencyCD3;
                            }

                            HandleRecurringCoupon(purchaseId, subscription, totalPaymentsNumber, oCurrency, isPurchasedWithPreviewModule, ref priceValue, ref couponCode);
                            nRecPeriods = subscription.m_nNumberOfRecPeriods;
                            isMPPRecurringInfinitely = subscription.m_bIsInfiniteRecurring;
                            maxVLCOfSelectedUsageModule = AppUsageModule.m_tsMaxUsageModuleLifeCycle;

                            customData = GetCustomDataForMPPRenewal(subscription, AppUsageModule, p, subscription.m_SubscriptionCode,
                                siteguid, priceValue, sCurrency, couponCode, userIp, string.Empty, string.Empty, string.Empty);
                        }
                        catch (Exception ex)
                        {
                            log.Error(string.Empty, ex);
                        }
                    }
                }
                else
                {
                    throw new Exception("Usage Module returned from GetAppropriateUsageModule is null");
                }
            }
        }


        /// <summary>
        /// Direct debit Renew Subscription
        /// </summary>
        /// <param name="sSiteGUID"></param>
        /// <param name="sSubscriptionCode"></param>
        /// <param name="sUserIP"></param>
        /// <param name="sExtraParams"></param>
        /// <param name="nPurchaseID"></param>
        /// <param name="nBillingMethod"></param>
        /// <param name="nPaymentNumber"></param>
        /// <param name="nTotalPaymentsNumber"></param>
        /// <param name="sCountryCd"></param>
        /// <param name="sLANGUAGE_CODE"></param>
        /// <param name="sDEVICE_NAME"></param>
        /// <param name="nNumOfPayments"></param>
        /// <param name="bIsPurchasedWithPreviewModule"></param>
        /// <param name="dtCurrentEndDate"></param>
        /// <param name="eBillingProvider"></param>
        /// <returns></returns>
        public virtual BillingResponse DD_BaseRenewMultiUsageSubscription(string sSiteGUID, string sSubscriptionCode, string sUserIP, string sExtraParams,
            Int32 nPurchaseID, int nBillingMethod, Int32 nPaymentNumber, int nTotalPaymentsNumber, string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME,
            int nNumOfPayments, bool bIsPurchasedWithPreviewModule, DateTime dtCurrentEndDate, eBillingProvider eBillingProvider)
        {
            BillingResponse oBillingResponse = new BillingResponse();
            oBillingResponse.m_oStatus = BillingResponseStatus.UnKnown;

            try
            {
                double dPrice = 0.0;
                string sCustomData = string.Empty;
                string sCurrency = string.Empty;
                int nRecPeriods = 0;
                bool bIsMPPRecurringInfinitely = false;
                int nMaxVLCOfSelectedUsageModule = 0;

                if (GetBaseRenewMultiUsageSubscriptionData(sSiteGUID, sSubscriptionCode, sUserIP, nPurchaseID, nPaymentNumber,
                    nTotalPaymentsNumber, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, nNumOfPayments, bIsPurchasedWithPreviewModule,
                    dtCurrentEndDate, ref dPrice, ref sCustomData, ref sCurrency, ref nRecPeriods, ref bIsMPPRecurringInfinitely,
                    ref nMaxVLCOfSelectedUsageModule))
                {
                    oBillingResponse = HandleBaseRenewMPPBillingCharge(sSiteGUID, dPrice, sCurrency, sUserIP, sCustomData, nPaymentNumber,
                        nRecPeriods, sExtraParams, nBillingMethod, nPurchaseID, eBillingProvider);

                    if (oBillingResponse.m_oStatus == BillingResponseStatus.Success)
                    {
                        // Enqueue notification for PS so they will know a sub was renewed

                        var dicData = new Dictionary<string, object>()
                        {
                            {"BillingTransactionID", oBillingResponse.m_sRecieptCode},
                            {"SiteGUID", sSiteGUID},
                            {"PaymentNumber", nPaymentNumber},
                            {"TotalPaymentsNumber", nTotalPaymentsNumber},
                            {"CustomData", sCustomData},
                            {"Price", dPrice},
                            {"PurchaseID", nPurchaseID},
                            {"SubscriptionCode", sSubscriptionCode}
                        };

                        this.EnqueueEventRecord(NotifiedAction.ChargedSubscriptionRenewal, dicData);

                        HandleMPPRenewalBillingSuccess(sSiteGUID, sSubscriptionCode, dtCurrentEndDate, bIsPurchasedWithPreviewModule,
                           nPurchaseID, sCurrency, dPrice, nPaymentNumber, oBillingResponse.m_sRecieptCode, nMaxVLCOfSelectedUsageModule,
                           bIsMPPRecurringInfinitely, nRecPeriods);

                        long domainId = 0;
                        Utils.ValidateUser(m_nGroupID, sSiteGUID, ref domainId);

                        string invalidationKey = LayeredCacheKeys.GetRenewInvalidationKey(domainId);
                        if (!LayeredCache.Instance.SetInvalidationKey(invalidationKey))
                        {
                            log.ErrorFormat("Failed to set invalidation key on DD_BaseRenewMultiUsageSubscription key = {0}", invalidationKey);
                        }

                    }
                    else
                    {
                        HandleMPPRenewalBillingFail(sSiteGUID, sSubscriptionCode, nPurchaseID, oBillingResponse, sCustomData);
                    }
                }
                else
                {
                    // user does not exist. update fail count to max so we won't try again to renew this mpp
                    // return unknown user
                    HandleMPPRenewalUserDoesNotExist(sSiteGUID, nPurchaseID, ref oBillingResponse);
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder(String.Concat("Exception. Exception msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Sub Code: ", sSubscriptionCode));
                sb.Append(String.Concat(" User IP: ", sUserIP));
                sb.Append(String.Concat(" Purchase ID: ", nPurchaseID));
                sb.Append(String.Concat(" Extra Params: ", sExtraParams));
                sb.Append(String.Concat(" Billing Method: ", nBillingMethod));
                sb.Append(String.Concat(" Payment Number: ", nPaymentNumber));
                sb.Append(String.Concat(" Total payments number: ", nTotalPaymentsNumber));
                sb.Append(String.Concat(" Country Code: ", sCountryCd));
                sb.Append(String.Concat(" Language Code: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" Device name: ", sDEVICE_NAME));
                sb.Append(String.Concat(" Num of payments: ", nNumOfPayments));
                sb.Append(String.Concat(" Purchased with preview module: ", bIsPurchasedWithPreviewModule.ToString().ToLower()));
                sb.Append(String.Concat(" BaseConditionalAccess is: ", this.GetType().ToString()));
                sb.Append(String.Concat(" Stack trace: ", ex.StackTrace));
                log.Debug("DD_BaseRenewMultiUsageSubscription - " + sb.ToString(), ex);
                WriteToUserLog(sSiteGUID, string.Format("MPP Renewal. Exception thrown. Msg: {0}", ex.Message));
                #endregion

                // increment fail count
                ConditionalAccessDAL.Update_MPPFailCountByPurchaseID(nPurchaseID, true, 0, "CA_CONNECTION_STRING");

                // set billing response
                oBillingResponse.m_oStatus = BillingResponseStatus.Fail;
                oBillingResponse.m_sRecieptCode = string.Empty;
                oBillingResponse.m_sStatusDescription = ex.Message;
            }

            return oBillingResponse;
        }


        protected void HandleMPPRenewalBillingFail(string sSiteGUID, string sSubscriptionCode, long lPurchaseID,
         BillingResponse br, string sCustomData)
        {

            log.Debug("Fail - " + string.Format("Fail count for user: {0} . Sub Code: {1} , Purchase ID: {2} , Response status: {3} , Response status desc: {4} , Custom Data: {5}", sSiteGUID, sSubscriptionCode, lPurchaseID, br.m_oStatus.ToString(), br.m_sStatusDescription, sCustomData));
            WriteToUserLog(sSiteGUID, string.Format("MPP auto renewal: {0} , error returned: {1} , status returned: {2}", sSubscriptionCode.ToString(), br.m_sStatusDescription, br.m_oStatus.ToString()));

            if (br.m_oStatus != BillingResponseStatus.ExternalError)
            {

                if (br.m_oStatus == BillingResponseStatus.ExpiredCard || br.m_oStatus == BillingResponseStatus.CellularPermissionsError)
                {
                    // card is expired. there is no point to continue trying renewing the mpp for this user.
                    // hence, we set the fail count to maximum.
                    ConditionalAccessDAL.Update_MPPFailCountByPurchaseID(lPurchaseID, false, Utils.GetGroupFAILCOUNT(m_nGroupID, "CA_CONNECTION_STRING"), "CA_CONNECTION_STRING");
                }
                else
                {
                    // failed to renew. increase fail count by one.
                    ConditionalAccessDAL.Update_MPPFailCountByPurchaseID(lPurchaseID, true, 0, "CA_CONNECTION_STRING");
                }
            }
        }

        protected void HandleMPPRenewalUserDoesNotExist(string sSiteGUID, long lPurchaseID, ref BillingResponse res)
        {
            log.Debug("Fail - " + string.Format("User ID: {0} does not exist. Purchase ID: {1}", sSiteGUID, lPurchaseID));

            // user does not exist. there is no point to continue trying renewing the mpp.
            // hence, we set the fail count to maximum
            ConditionalAccessDAL.Update_MPPFailCountByPurchaseID(lPurchaseID, false, Utils.GetGroupFAILCOUNT(m_nGroupID, "CA_CONNECTION_STRING"), "CA_CONNECTION_STRING");

            res.m_oStatus = BillingResponseStatus.UnKnownUser;
            res.m_sStatusDescription = "User does not exist";
            res.m_sRecieptCode = string.Empty;
        }

        /// <summary>
        /// Direct Deipt Renew Subscription
        /// </summary>
        public BillingResponse DD_BaseRenewSubscription(string sSiteGUID, double dPrice, string sCurrency,
           string sSubscriptionCode, string sUserIP, string sExtraParams, Int32 nPurchaseID, int nBillingMethod, Int32 nPaymentNumber,
           string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            string sCouponCode = string.Empty;
            BillingResponse ret = new BillingResponse();
            UsersService u = null;
            ODBCWrapper.DirectQuery directQuery1 = null;
            mdoule m = null;
            ODBCWrapper.DirectQuery directQuery2 = null;
            ODBCWrapper.DirectQuery directQuery3 = null;
            module bm = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            ODBCWrapper.DirectQuery directQuery4 = null;
            ODBCWrapper.DirectQuery directQuery5 = null;
            try
            {
                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    #region terminate if site guid id empty
                    ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_sRecieptCode = string.Empty;
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                    #endregion
                }
                else
                {
                    #region Init useres web service
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    #endregion

                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        #region terminate if ResponseStatus NOT Ok.
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                        WriteToUserLog(sSiteGUID, "Subscription auto renewal: " + sSubscriptionCode.ToString() + " error returned: " + ret.m_sStatusDescription);

                        //Increase subscription purchase fail count
                        directQuery1 = new ODBCWrapper.DirectQuery();
                        directQuery1.SetConnectionKey("CA_CONNECTION_STRING");
                        directQuery1 += "update subscriptions_purchases set ";
                        directQuery1 += "FAIL_COUNT = FAIL_COUNT + 1 ";
                        directQuery1 += " where ";
                        directQuery1 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                        directQuery1.Execute();

                        #endregion
                    }
                    else
                    {
                        #region Init Tvinci Pricing web service
                        m = new mdoule();
                        #endregion

                        Subscription theSub = null;

                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        theSub = m.GetSubscriptionData(sWSUserName, sWSPass, sSubscriptionCode, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, false);

                        if (theSub != null && theSub.m_nNumberOfRecPeriods != 0 && theSub.m_nNumberOfRecPeriods < nPaymentNumber)
                        {
                            #region Update subscription purchase to is recurring status = 0
                            directQuery2 = new ODBCWrapper.DirectQuery();
                            directQuery2.SetConnectionKey("CA_CONNECTION_STRING");
                            directQuery2 += "update subscriptions_purchases set ";
                            directQuery2 += "IS_RECURRING_STATUS = 0 ";
                            directQuery2 += " where ";
                            directQuery2 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                            directQuery2.Execute();
                            #endregion

                        }
                        else if (theSub != null && theSub.m_oSubscriptionUsageModule != null)
                        {
                            string sCustomData = string.Empty;
                            if (dPrice != 0)
                            {
                                bm = new module();
                                sWSUserName = string.Empty;
                                sWSPass = string.Empty;
                                Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                                bool bIsRecurring = theSub.m_bIsRecurring;
                                Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;

                                #region Create Custom Data
                                sCustomData = "<customdata type=\"sp\">";
                                if (String.IsNullOrEmpty(sCountryCd) == false)
                                    sCustomData += "<lcc>" + sCountryCd + "</lcc>";
                                if (String.IsNullOrEmpty(sLANGUAGE_CODE) == false)
                                    sCustomData += "<llc>" + sLANGUAGE_CODE + "</llc>";
                                if (String.IsNullOrEmpty(sDEVICE_NAME) == false)
                                    sCustomData += "<ldn>" + sDEVICE_NAME + "</ldn>";
                                sCustomData += "<mnou>";

                                if (theSub != null && theSub.m_oUsageModule != null)
                                    sCustomData += theSub.m_oUsageModule.m_nMaxNumberOfViews.ToString();


                                sCustomData += "</mnou>";
                                sCustomData += "<u id=\"" + sSiteGUID + "\"/>";
                                sCustomData += "<s>" + sSubscriptionCode + "</s>";
                                sCustomData += "<cc>" + sCouponCode + "</cc>";
                                sCustomData += "<p ir=\"" + bIsRecurring.ToString().ToLower() + "\" n=\"" + nPaymentNumber.ToString() + "\" o=\"" + nRecPeriods.ToString() + "\"/>";
                                sCustomData += "<vlcs>";


                                if (theSub != null && theSub.m_oUsageModule != null)
                                    sCustomData += theSub.m_oUsageModule.m_tsViewLifeCycle.ToString();

                                sCustomData += "</vlcs>";
                                sCustomData += "<mumlc>";

                                if (theSub != null && theSub.m_oSubscriptionUsageModule != null)
                                    sCustomData += theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle.ToString();

                                sCustomData += "</mumlc>";
                                sCustomData += "<ppvm>";
                                sCustomData += "</ppvm>";
                                sCustomData += "<pc>";
                                if (theSub != null && theSub.m_oSubscriptionPriceCode != null)
                                    sCustomData += theSub.m_oSubscriptionPriceCode.m_sCode;


                                sCustomData += "</pc>";
                                sCustomData += "<pri>";
                                sCustomData += dPrice.ToString();
                                sCustomData += "</pri>";
                                sCustomData += "<cu>";
                                sCustomData += sCurrency;
                                sCustomData += "</cu>";

                                sCustomData += "</customdata>";
                                #endregion

                                //customdata id
                                ret = bm.DD_ChargeUser(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sUserIP, sCustomData, nPaymentNumber, nRecPeriods, nPurchaseID.ToString(), nBillingMethod);

                            }
                        }
                        if (ret.m_oStatus == BillingResponseStatus.Success && theSub != null && theSub.m_oSubscriptionUsageModule != null)
                        {
                            Int32 nMaxVLC = theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle;
                            WriteToUserLog(sSiteGUID, "Subscription auto renewal: " + sSubscriptionCode.ToString() + " renewed" + dPrice.ToString() + sCurrency);
                            DateTime d = (DateTime)(ODBCWrapper.Utils.GetTableSingleVal("subscriptions_purchases", "end_date", nPurchaseID, "CA_CONNECTION_STRING"));
                            DateTime dNext = Utils.GetEndDateTime(d, nMaxVLC);
                            #region update subscriptions_purchases end date
                            directQuery3 = new ODBCWrapper.DirectQuery();
                            directQuery3.SetConnectionKey("CA_CONNECTION_STRING");
                            directQuery3 += "update subscriptions_purchases set ";
                            directQuery3 += ODBCWrapper.Parameter.NEW_PARAM("end_date", "=", dNext);
                            directQuery3 += ",";
                            directQuery3 += ODBCWrapper.Parameter.NEW_PARAM("num_of_uses", "=", 0);
                            directQuery3 += " where ";
                            directQuery3 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                            directQuery3.Execute();
                            #endregion

                            if (!string.IsNullOrEmpty(ret.m_sRecieptCode))
                            {
                                Int32 nID = int.Parse(ret.m_sRecieptCode);

                                #region Update billing transactions with PurchaseID
                                updateQuery = new ODBCWrapper.UpdateQuery("billing_transactions");
                                updateQuery.SetConnectionKey("MAIN_CONNECTION_STRING");
                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("PURCHASE_ID", "=", nPurchaseID);
                                updateQuery += "where";
                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nID);
                                updateQuery.Execute();
                                #endregion
                            }
                        }
                        else
                        {

                            WriteToUserLog(sSiteGUID, "Subscription auto renewal: " + sSubscriptionCode.ToString() + " error returned: " + ret.m_sStatusDescription);

                            if (ret.m_oStatus != BillingResponseStatus.ExternalError)
                            {
                                if (ret.m_oStatus == BillingResponseStatus.ExpiredCard)
                                {
                                    #region Update subscription purchases to fail count = 10
                                    directQuery4 = new ODBCWrapper.DirectQuery();
                                    directQuery4.SetConnectionKey("CA_CONNECTION_STRING");
                                    directQuery4 += "update subscriptions_purchases set ";
                                    directQuery4 += "FAIL_COUNT = 10 ";
                                    directQuery4 += " where ";
                                    directQuery4 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                                    directQuery4.Execute();
                                    #endregion
                                }

                                #region Increase subscription purchase fail count
                                directQuery5 = new ODBCWrapper.DirectQuery();
                                directQuery5.SetConnectionKey("CA_CONNECTION_STRING");
                                directQuery5 += "update subscriptions_purchases set ";
                                directQuery5 += "FAIL_COUNT = FAIL_COUNT + 1 ";
                                directQuery5 += " where ";
                                directQuery5 += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                                directQuery5.Execute();
                                #endregion
                            }
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at DD_BaseRenewSubscription. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" Curr: ", sCurrency));
                sb.Append(String.Concat(" Sub Code: ", sSubscriptionCode));
                sb.Append(String.Concat(" User IP: ", sUserIP));
                sb.Append(String.Concat(" Xtra Prms: ", sExtraParams));
                sb.Append(String.Concat(" Prchs ID: ", nPurchaseID));
                sb.Append(String.Concat(" BM ID: ", nBillingMethod));
                sb.Append(String.Concat(" Payment num: ", nPaymentNumber));
                sb.Append(String.Concat(" Cntry Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Cd: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" Device Nm: ", sDEVICE_NAME));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (m != null)
                {
                    m.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
                if (directQuery1 != null)
                {
                    directQuery1.Finish();
                }
                if (directQuery2 != null)
                {
                    directQuery2.Finish();
                }
                if (directQuery3 != null)
                {
                    directQuery3.Finish();
                }
                if (directQuery4 != null)
                {
                    directQuery4.Finish();
                }
                if (directQuery5 != null)
                {
                    directQuery5.Finish();
                }
                #endregion
            }
            return ret;
        }

        private UsageModule GetAppropriateMultiSubscriptionUsageModule(Subscription thesub, int nPaymentNumber, int nPurchaseID, int nTotalNumOfPayments, int nNumOfPayments, bool bIsPurchasedWithPreviewModule)
        {
            UsageModule u = null;
            object oSub_StartDate = ODBCWrapper.Utils.GetTableSingleVal("subscriptions_purchases", "START_DATE", nPurchaseID, "CA_CONNECTION_STRING");
            object oSub_EndDate = ODBCWrapper.Utils.GetTableSingleVal("subscriptions_purchases", "END_DATE", nPurchaseID, "CA_CONNECTION_STRING");

            DateTime dt_statdate = Convert.ToDateTime(oSub_StartDate.ToString());
            DateTime sub_enddate = Convert.ToDateTime(oSub_EndDate.ToString());
            DateTime tempsub_enddate = Convert.ToDateTime(oSub_EndDate.ToString());
            if (thesub.m_nNumberOfRecPeriods != 0)
            {
                int npm = nPaymentNumber % thesub.m_nNumberOfRecPeriods;
                if (npm != 0)
                {
                    nPaymentNumber = npm;
                }
                else
                {
                    nPaymentNumber = thesub.m_nNumberOfRecPeriods;
                }

            }
            if (thesub.m_MultiSubscriptionUsageModule != null)
            {
                UsageModule[] uList = thesub.m_MultiSubscriptionUsageModule;
                int totalperiod = 0;
                for (int i = 0; i < thesub.m_MultiSubscriptionUsageModule.Length; i++)
                {
                    int umtotal = uList[i].m_tsViewLifeCycle * (uList[i].m_num_of_rec_periods + 1);
                    tempsub_enddate = tempsub_enddate.AddMinutes(umtotal);

                    totalperiod += uList[i].m_num_of_rec_periods + 1;
                    if (/*i == 0 && uList[i].m_is_renew == 0*/ IsSkipOnFirstUsageModule(i, uList[i].m_is_renew == 1, nTotalNumOfPayments, nNumOfPayments, bIsPurchasedWithPreviewModule))
                    {
                        /*
                         * 1. The renewer runs only after the user purchases an mpp.
                         * 2. Hence, if the first usage module is not renewable and it has already been used because it was chosen when the user purchased the mpp
                         * 3. This resolves the following bug:
                         *      a. MPP contains two usage modules
                         *      b. First usage module is not renewable
                         *      c. Second usage modules is renewable
                         *      d. Before the fix, when the renewer first launched, it grabbed the first usage module instead of the second one.
                         * 
                         */
                        continue;
                    }
                    if (uList[i].m_is_renew == 1 && uList[i].m_num_of_rec_periods == 0)
                    {
                        u = thesub.m_MultiSubscriptionUsageModule[i];
                        break;
                    }
                    else if (nPaymentNumber <= totalperiod)
                    {
                        if (sub_enddate < tempsub_enddate)
                        {
                            u = thesub.m_MultiSubscriptionUsageModule[i];
                            break;
                        }
                    }

                }
                if (u == null)
                {
                    totalperiod = 0;
                    for (int i = 0; i < thesub.m_MultiSubscriptionUsageModule.Length; i++)
                    {
                        totalperiod += uList[i].m_num_of_rec_periods + 1;
                        if (uList[i].m_is_renew == 1 && uList[i].m_num_of_rec_periods == 0)
                        {
                            u = thesub.m_MultiSubscriptionUsageModule[i];
                            break;
                        }
                        else if (nPaymentNumber <= totalperiod)
                        {

                            u = thesub.m_MultiSubscriptionUsageModule[i];
                            break;
                        }


                    }
                }
            }
            if (u == null)
            {
                string strLog = string.Format("could not find Appropriate Multi usage module for Subscription ID : {0}", thesub.m_SubscriptionCode);
                log.Debug("Get Appropriate Multi Subscription Usage Module Fail - " + strLog);
            }
            return u;
        }


        public BillingResponse CC_BaseMultiRenewSubscription(string sSiteGUID, double dPrice, string sCurrency,
           string sSubscriptionCode, string sUserIP, string sExtraParams, Int32 nPurchaseID, int nBillingMethod, Int32 nPaymentNumber,
           string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            //write loge
            log.Debug("CC Base Multi usage module renew subscription - " + sSiteGUID + " " + sSubscriptionCode);
            //create billing response resault object 
            BillingResponse ret = new BillingResponse();
            UsersService u = null;
            mdoule m = null;
            ODBCWrapper.DirectQuery directQuery = null;
            try
            {
                #region Init useres web service
                u = new UsersService();

                string sWSUserName = string.Empty;
                string sWSPass = string.Empty;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                #endregion

                #region Check Exist User Guid ,terminate if site guid id empty or response status dose not OK.
                if (string.IsNullOrEmpty(sSiteGUID))
                {

                    ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_sRecieptCode = "";
                    ret.m_sStatusDescription = "Cant charge an unknown user";

                }
                else
                {


                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        #region terminate if ResponseStatus NOT Ok.
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = "";
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                        WriteToUserLog(sSiteGUID, "Subscription auto renewal: " + sSubscriptionCode.ToString() + " error returned: " + ret.m_sStatusDescription);
                        #endregion
                    }
                }
                #endregion

                #region Init Tvinci Pricing web service
                m = new mdoule();
                #endregion

                Subscription theSub = null;

                Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                theSub = m.GetSubscriptionData(sWSUserName, sWSPass, sSubscriptionCode, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, false);
                if (theSub != null && theSub.m_nNumberOfRecPeriods != 0 && theSub.m_nNumberOfRecPeriods <= nPaymentNumber)
                {
                    #region Update subscription purchase to is recurring status = 0
                    directQuery = new ODBCWrapper.DirectQuery();
                    directQuery.SetConnectionKey("CA_CONNECTION_STRING");
                    directQuery += "update subscriptions_purchases set ";
                    directQuery += "IS_RECURRING_STATUS = 0 ";
                    directQuery += " where ";
                    directQuery += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                    directQuery.Execute();
                    #endregion
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at CC_BaseMultiRenewSubscription. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" Curr: ", sCurrency));
                sb.Append(String.Concat(" Sub Cd: ", sSubscriptionCode));
                sb.Append(String.Concat(" User IP: ", sUserIP));
                sb.Append(String.Concat(" Extra Params: ", sExtraParams));
                sb.Append(String.Concat(" Purchase ID: ", nPurchaseID));
                sb.Append(String.Concat(" BM: ", nBillingMethod));
                sb.Append(String.Concat(" Payment num: ", nPaymentNumber));
                sb.Append(String.Concat(" Cntry Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Cd: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" Device Name: ", sDEVICE_NAME));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));

                log.Error("Exception- " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (m != null)
                {
                    m.Dispose();
                }
                if (directQuery != null)
                {
                    directQuery.Finish();
                }
                #endregion
            }
            return ret;
        }
        /// <summary>
        /// Checks if there is recurring coupon definition on the subscription and if yes 
        /// activate the discount of the coupon on the price and return the updated price and the coupon code. 
        /// </summary> 
        private void HandleRecurringCoupon(int nPurchaseID, Subscription theSub, int nTotalPaymentsNumber, Currency oCurrency, bool bIsPurchasedWithPreviewModule, ref double dPrice, ref string retCouponCode)
        {
            try
            {
                if (theSub.m_oCouponsGroup != null && theSub.m_oCouponsGroup.m_oDiscountCode != null)
                {
                    if (theSub.m_oCouponsGroup.couponGroupType != CouponGroupType.GiftCard &&
                        IsCouponStillRedeemable(bIsPurchasedWithPreviewModule, theSub.m_oCouponsGroup.m_nMaxRecurringUsesCountForCoupon, nTotalPaymentsNumber))
                    {
                        string sCouponCode = Utils.GetSubscriptiopnPurchaseCoupon(nPurchaseID);
                        if (!string.IsNullOrEmpty(sCouponCode))
                        {
                            Price priceBeforeCouponDiscount = new Price();
                            priceBeforeCouponDiscount.m_dPrice = dPrice;
                            priceBeforeCouponDiscount.m_oCurrency = oCurrency;
                            Price priceResult = Utils.GetPriceAfterDiscount(priceBeforeCouponDiscount, theSub.m_oCouponsGroup.m_oDiscountCode, 0);
                            dPrice = priceResult.m_dPrice;
                            retCouponCode = sCouponCode;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                log.Error("HandleRecurringCoupon error - , PurchaseID: " + nPurchaseID.ToString() + ",Exception:" + ex.ToString(), ex);
            }
        }



        protected bool isDevicePlayValid(string sSiteGUID, string sDEVICE_NAME, ref Domain userDomain)
        {
            if (Utils.IsAnonymousUser(sSiteGUID))
                return true;

            UsersService u = null;
            WS_Domains.module domainsWS = null;
            bool isDeviceRecognized = false;
            try
            {
                string sWSUserName = string.Empty;
                string sWSPass = string.Empty;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                u = new UsersService();
                UserResponseObject userRepObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                if (userRepObj != null && userRepObj.m_user != null && userRepObj.m_RespStatus == ResponseStatus.OK)
                {
                    int domainID = userRepObj.m_user.m_domianID;
                    if (domainID != 0)
                    {
                        domainsWS = new WS_Domains.module();
                        Utils.GetWSCredentials(m_nGroupID, eWSModules.DOMAINS, ref sWSUserName, ref sWSPass);
                        var res = domainsWS.GetDomainInfo(sWSUserName, sWSPass, domainID);
                        if (res != null)
                        {
                            userDomain = res.Domain;
                        }
                        if (userDomain != null)
                        {
                            DeviceContainer[] deviceContainers = userDomain.m_deviceFamilies.ToArray();
                            if (deviceContainers != null && deviceContainers.Length > 0)
                            {
                                List<int> familyIDs = new List<int>();
                                for (int i = 0; i < deviceContainers.Length; i++)
                                {
                                    DeviceContainer container = deviceContainers[i];

                                    if (container != null)
                                    {
                                        if (!familyIDs.Contains(container.m_deviceFamilyID))
                                        {
                                            familyIDs.Add(container.m_deviceFamilyID);
                                        }

                                        if (container.DeviceInstances != null && container.DeviceInstances.Count > 0)
                                        {
                                            for (int j = 0; j < container.DeviceInstances.Count; j++)
                                            {
                                                Device device = container.DeviceInstances[j];
                                                if (string.Compare(device.m_deviceUDID.Trim(), sDEVICE_NAME.Trim()) == 0)
                                                {
                                                    isDeviceRecognized = true;
                                                    break;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            familyIDs.Add(container.m_deviceFamilyID);
                                        }

                                        if (container.DeviceInstances != null && container.DeviceInstances.Count > 0)
                                        {
                                            for (int j = 0; j < container.DeviceInstances.Count; j++)
                                            {
                                                Device device = container.DeviceInstances[j];
                                                if (string.Compare(device.m_deviceUDID.Trim(), sDEVICE_NAME.Trim()) == 0)
                                                {
                                                    isDeviceRecognized = true;
                                                    break;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //Patch!!
                                            if (container.m_deviceFamilyID == 5 && (string.IsNullOrEmpty(sDEVICE_NAME) || sDEVICE_NAME.ToLower().Equals("web site")))
                                            {
                                                isDeviceRecognized = true;
                                            }
                                        }
                                        if (isDeviceRecognized)
                                        {
                                            break;
                                        }

                                    }
                                }
                                if (!familyIDs.Contains(5) && string.IsNullOrEmpty(sDEVICE_NAME) || (familyIDs.Contains(5) && familyIDs.Count == 0) || (!familyIDs.Contains(5) && sDEVICE_NAME.ToLower().Equals("web site")))
                                {
                                    isDeviceRecognized = true;
                                }
                            }

                        }
                    }
                    else
                    {
                        // No Domain - No device check!!
                        isDeviceRecognized = true;
                    }
                }
            }
            finally
            {
                if (u != null)
                {
                    u.Dispose();
                }
                if (domainsWS != null)
                {
                    domainsWS.Dispose();
                }
            }
            return isDeviceRecognized;
        }



        public virtual LicensedLinkResponse GetEPGLink(string sProgramId, DateTime dStartTime, int format, string sSiteGUID, Int32 nMediaFileID, string sBasicLink, string sUserIP, string sRefferer, string sCOUNTRY_CODE, string sLANGUAGE_CODE, string sDEVICE_NAME, string sCouponCode)
        {
            return new LicensedLinkResponse();
        }

        /// <summary>
        /// Get Licensed Link
        /// </summary>
        public virtual string GetLicensedLink(string sSiteGUID, Int32 nMediaFileID, string sBasicLink, string sUserIP, string sRefferer, string sCOUNTRY_CODE, string sLANGUAGE_CODE, string sDEVICE_NAME, string couponCode)
        {
            LicensedLinkResponse llr = GetLicensedLinks(sSiteGUID, nMediaFileID, sBasicLink, sUserIP, sRefferer, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, couponCode);

            return llr.mainUrl;
        }

        /// <summary>
        /// Get Licensed Link With Media File CoGuid
        /// </summary>
        public virtual string GetLicensedLinkWithMediaFileCoGuid(string sSiteGUID, string sMediaFileCoGuid, string sBasicLink, string sUserIP, string sRefferer, string sCOUNTRY_CODE, string sLANGUAGE_CODE, string sDEVICE_NAME, string couponCode)
        {

            int mediaFileID = 0;
            if (Int32.TryParse(sMediaFileCoGuid, out mediaFileID) && mediaFileID > 0)
            {
                LicensedLinkResponse llr = GetLicensedLinks(sSiteGUID, mediaFileID, sBasicLink, sUserIP, sRefferer, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, couponCode);
                return llr.mainUrl;
            }

            return GetErrorLicensedLink(sBasicLink);
        }

        private string GetCountryCodeForHandlePlayUses(string userIP, string countryCode)
        {
            string res = countryCode;
            if (!string.IsNullOrEmpty(userIP) && string.IsNullOrEmpty(countryCode))
                res = Utils.GetIP2CountryName(m_nGroupID, userIP);

            return res;
        }

        /// <summary>
        /// Handle Play Uses
        /// </summary>
        //protected void HandlePlayUses(MediaFileItemPricesContainer price, string sSiteGUID, Int32 nMediaFileID, string sUserIP, string sCOUNTRY_CODE, string sLANGUAGE_CODE, string sDEVICE_NAME,
        //                                string couponCode, long domainId)
        //{
        //    sCOUNTRY_CODE = GetCountryCodeForHandlePlayUses(sUserIP, sCOUNTRY_CODE);

        //    int nReleventCollectionID = ExtractRelevantCollectionID(price);

        //    HandleCouponUses(price.m_oItemPrices[0].m_relevantSub, price.m_oItemPrices[0].m_sPPVModuleCode, sSiteGUID,
        //    price.m_oItemPrices[0].m_oPrice.m_dPrice, price.m_oItemPrices[0].m_oPrice.m_oCurrency.m_sCurrencyCD3,
        //    nMediaFileID, couponCode, sUserIP,
        //    sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, false, 0, nReleventCollectionID);

        //    Int32 nRelPP = ExtractRelevantPrePaidID(price);

        //    int domainID = 0;
        //    List<int> lUsersIds = Utils.GetAllUsersInDomainBySiteGUIDIncludeDeleted(sSiteGUID, m_nGroupID, ref domainID);

        //    if (IsPurchasedAsPurePPV(price))
        //    {
        //        string sPPVMCd = price.m_oItemPrices[0].m_sPPVModuleCode;

        //        Int32 nIsCreditDownloaded = PPV_DoesCreditNeedToDownloaded(sPPVMCd, null, null, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, lUsersIds, GetRelatedMediaFiles(price, nMediaFileID), domainId, nMediaFileID);
        //        if (TVinciShared.WS_Utils.GetTcmBoolValue("ShouldUseLicenseLinkCache") && domainId > 0)
        //        {
        //            CachedEntitlementResults cachedEntitlementResults = Utils.GetCachedEntitlementResults(domainId, nMediaFileID);
        //            if (cachedEntitlementResults != null)
        //            {
        //                cachedEntitlementResults.EntitlementStartDate = GetStartDate(price);
        //                cachedEntitlementResults.EntitlementEndDate = GetEndDate(price);
        //                if (!Utils.InsertOrSetCachedEntitlementResults(domainId, nMediaFileID, cachedEntitlementResults))
        //                {
        //                    log.DebugFormat("Failed to insert cachedEntitlementResults, domainId: {0}, mediaFileId: {1}", domainID, nMediaFileID);
        //                }
        //            }
        //        }
        //        if (ConditionalAccessDAL.Insert_NewPPVUse(m_nGroupID, nMediaFileID, price.m_oItemPrices[0].m_sPPVModuleCode,
        //            sSiteGUID, nIsCreditDownloaded > 0, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, nRelPP, nReleventCollectionID) < 1)
        //        {
        //            // failed to insert ppv use.
        //            throw new Exception(GetPPVUseInsertionFailureExMsg(nMediaFileID, price.m_oItemPrices[0].m_sPPVModuleCode, sSiteGUID,
        //                nIsCreditDownloaded > 0, nRelPP, nReleventCollectionID));
        //        }


        //        long nPPVID = 0;
        //        string sRelSub = string.Empty;
        //        if (nIsCreditDownloaded == 1)
        //        {
        //            //sRelSub - the subscription that caused the price to be lower

        //            nPPVID = GetActivePPVPurchaseID(price.m_oItemPrices[0].m_lPurchasedMediaFileID > 0 ? new List<int>(1) { price.m_oItemPrices[0].m_lPurchasedMediaFileID } : new List<int>(1) { nMediaFileID }, ref sRelSub, lUsersIds, domainID);
        //            if (nPPVID == 0 && !string.IsNullOrEmpty(couponCode))
        //            {
        //                nPPVID = InsertPPVPurchases(sSiteGUID, nMediaFileID, price.m_oItemPrices[0].m_oPrice.m_dPrice,
        //                    price.m_oItemPrices[0].m_oPrice.m_oCurrency.m_sCurrencyCD3, sRelSub, 0, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, sPPVMCd,
        //                    couponCode, sUserIP, domainID);
        //            }

        //            UpdatePPVPurchases(nPPVID, price.m_oItemPrices[0].m_sPPVModuleCode, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME);
        //        }
        //    }
        //    else
        //    {
        //        string purchasingSiteGuid = GetPurchasingSiteGuid(price, sSiteGUID);
        //        if (IsPurchasedAsPartOfSub(price))
        //        {
        //            // PPV purchased as part of Subscription

        //            Int32 nIsCreditDownloaded = Utils.Bundle_DoesCreditNeedToDownloaded(price.m_oItemPrices[0].m_relevantSub.m_sObjectCode, lUsersIds, GetRelatedMediaFiles(price, nMediaFileID), m_nGroupID, eBundleType.SUBSCRIPTION) ? 1 : 0;

        //            if (ConditionalAccessDAL.Insert_NewSubscriptionUse(m_nGroupID, price.m_oItemPrices[0].m_relevantSub.m_sObjectCode, nMediaFileID,
        //                sSiteGUID, nIsCreditDownloaded > 0, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, nRelPP) < 1)
        //            {
        //                // failed to insert subscription use
        //                throw new Exception(GetSubUseInsertionFailureExMsg(price.m_oItemPrices[0].m_relevantSub.m_sObjectCode, nMediaFileID, sSiteGUID,
        //                    nIsCreditDownloaded > 0, nRelPP));
        //            }

        //            //subscriptions_purchases
        //            if (nIsCreditDownloaded == 1)
        //            {
        //                if (!ConditionalAccessDAL.Update_SubPurchaseNumOfUses(m_nGroupID, purchasingSiteGuid,
        //                    price.m_oItemPrices[0].m_relevantSub.m_sObjectCode))
        //                {
        //                    // failed to update num of uses in subscriptions_purchases.
        //                    #region Logging
        //                    StringBuilder sb = new StringBuilder("Failed to update num of uses in subscriptions_purchases table. ");
        //                    sb.Append(String.Concat("Sub Cd: ", price.m_oItemPrices[0].m_relevantSub.m_sObjectCode));
        //                    sb.Append(String.Concat(" Site Guid: ", purchasingSiteGuid));
        //                    sb.Append(String.Concat(" Group ID: ", m_nGroupID));
        //                    sb.Append(String.Concat(" MF ID: ", nMediaFileID));

        //                    log.Debug("CriticalError - " + sb.ToString());
        //                    #endregion

        //                }
        //            }

        //            string modifiedPPVModuleCode = GetPPVModuleCodeForPPVUses(price.m_oItemPrices[0].m_relevantSub.m_sObjectCode, eTransactionType.Subscription);

        //            Int32 nIsCreditDownloaded1 = PPV_DoesCreditNeedToDownloaded(modifiedPPVModuleCode, price.m_oItemPrices[0].m_relevantSub, null, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, lUsersIds, GetRelatedMediaFiles(price, nMediaFileID), domainId, nMediaFileID);
        //            if (ConditionalAccessDAL.Insert_NewPPVUse(m_nGroupID, nMediaFileID, modifiedPPVModuleCode,
        //                sSiteGUID, nIsCreditDownloaded1 > 0, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, nRelPP, nReleventCollectionID) < 1)
        //            {
        //                // failed to insert ppv use
        //                throw new Exception(GetPPVUseInsertionFailureExMsg(nMediaFileID, modifiedPPVModuleCode, sSiteGUID,
        //                    nIsCreditDownloaded1 > 0, nRelPP, nReleventCollectionID));
        //            }

        //            long nPPVID = 0;
        //            if (nIsCreditDownloaded1 == 1)
        //            {
        //                string sRelSub = string.Empty;
        //                nPPVID = GetActivePPVPurchaseID(price.m_oItemPrices[0].m_lPurchasedMediaFileID > 0 ? new List<int>(1) { price.m_oItemPrices[0].m_lPurchasedMediaFileID } : new List<int>(1) { nMediaFileID }, ref sRelSub, lUsersIds, domainID);

        //                if (nPPVID == 0 && !string.IsNullOrEmpty(couponCode))
        //                {
        //                    nPPVID = InsertPPVPurchases(sSiteGUID, nMediaFileID, price.m_oItemPrices[0].m_oPrice.m_dPrice,
        //                        price.m_oItemPrices[0].m_oPrice.m_oCurrency.m_sCurrencyCD3, sRelSub, 0, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME,
        //                        price.m_oItemPrices[0].m_sPPVModuleCode, couponCode, sUserIP, domainID);
        //                }

        //                UpdatePPVPurchases(nPPVID, price.m_oItemPrices[0].m_sPPVModuleCode, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME);
        //            }
        //        }
        //        else
        //        {
        //            // PPV purchased as part of Collection

        //            Int32 nIsCreditDownloaded = Utils.Bundle_DoesCreditNeedToDownloaded(price.m_oItemPrices[0].m_relevantCol.m_sObjectCode, lUsersIds, GetRelatedMediaFiles(price, nMediaFileID), m_nGroupID, eBundleType.COLLECTION) ? 1 : 0;

        //            //collections_uses

        //            if (ConditionalAccessDAL.Insert_NewCollectionUse(m_nGroupID, price.m_oItemPrices[0].m_relevantCol.m_sObjectCode, nMediaFileID,
        //                sSiteGUID, nIsCreditDownloaded > 0, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME) < 1)
        //            {
        //                // failed to insert values in collections_uses
        //                // throw here an exception
        //                throw new Exception(GetColUseInsertionFailureMsg(price.m_oItemPrices[0].m_relevantCol.m_sObjectCode, nMediaFileID,
        //                    sSiteGUID, nIsCreditDownloaded > 0, nRelPP));

        //            }
        //            if (nIsCreditDownloaded == 1)
        //            {
        //                if (!ConditionalAccessDAL.Update_ColPurchaseNumOfUses(price.m_oItemPrices[0].m_relevantCol.m_sObjectCode, purchasingSiteGuid, m_nGroupID))
        //                {
        //                    // failed to update num of uses in collections_purchases. logging
        //                    #region Logging
        //                    StringBuilder sb = new StringBuilder("Failed to increment num of uses in collections_purchases. ");
        //                    sb.Append(String.Concat(" Col Code: ", price.m_oItemPrices[0].m_relevantCol.m_sObjectCode));
        //                    sb.Append(String.Concat(" Group ID: ", m_nGroupID));
        //                    sb.Append(String.Concat(" Site Guid: ", purchasingSiteGuid));

        //                    log.Error("CriticalError - " + sb.ToString());
        //                    #endregion
        //                }
        //            }

        //            string modifiedPPVModuleCode = GetPPVModuleCodeForPPVUses(price.m_oItemPrices[0].m_relevantCol.m_sObjectCode, eTransactionType.Collection);

        //            Int32 nIsCreditDownloaded1 = PPV_DoesCreditNeedToDownloaded(modifiedPPVModuleCode, null, price.m_oItemPrices[0].m_relevantCol, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, lUsersIds, GetRelatedMediaFiles(price, nMediaFileID), domainId, nMediaFileID);

        //            if (ConditionalAccessDAL.Insert_NewPPVUse(m_nGroupID, nMediaFileID, modifiedPPVModuleCode, sSiteGUID, nIsCreditDownloaded1 > 0,
        //                sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME, nRelPP, nReleventCollectionID) < 1)
        //            {
        //                // failed to insert ppv use
        //                throw new Exception(GetPPVUseInsertionFailureExMsg(nMediaFileID, modifiedPPVModuleCode, sSiteGUID, nIsCreditDownloaded1 > 0,
        //                    nRelPP, nReleventCollectionID));
        //            }

        //            long nPPVID = 0;
        //            if (nIsCreditDownloaded1 == 1)
        //            {
        //                string sRelCol = string.Empty;
        //                nPPVID = GetActivePPVPurchaseID(price.m_oItemPrices[0].m_lPurchasedMediaFileID > 0 ? new List<int>(1) { price.m_oItemPrices[0].m_lPurchasedMediaFileID } : new List<int>(1) { nMediaFileID }, ref sRelCol, lUsersIds, domainID);

        //                if (nPPVID == 0 && !string.IsNullOrEmpty(couponCode))
        //                {
        //                    nPPVID = InsertPPVPurchases(sSiteGUID, nMediaFileID, price.m_oItemPrices[0].m_oPrice.m_dPrice,
        //                        price.m_oItemPrices[0].m_oPrice.m_oCurrency.m_sCurrencyCD3, sRelCol, 0, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME,
        //                        price.m_oItemPrices[0].m_sPPVModuleCode, couponCode, sUserIP, domainID);
        //                }

        //                UpdatePPVPurchases(nPPVID, price.m_oItemPrices[0].m_sPPVModuleCode, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME);
        //            }
        //        }
        //    }
        //}

        /// <summary>
        /// Get Active Collection Purchase ID
        /// </summary>
        protected Int32 GetActiveCollectionPurchaseID(string sColCd, string sSiteGUID)
        {
            Int32 nRet = 0;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            try
            {
                selectQuery = new ODBCWrapper.DataSetSelectQuery();
                selectQuery += "select ID from collections_purchases with (nolock) where is_active=1 and status=1 and ";
                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                selectQuery += " and (MAX_NUM_OF_USES>=NUM_OF_USES OR MAX_NUM_OF_USES=0) and START_DATE<getdate() and (end_date is null or end_date>getdate()) and ";
                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("COLLECTION_CODE", "=", sColCd);
                selectQuery += " and ";
                selectQuery += " group_id " + TVinciShared.PageUtils.GetFullChildGroupsStr(m_nGroupID, "MAIN_CONNECTION_STRING");
                if (selectQuery.Execute("query", true) != null)
                {
                    Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                    if (nCount > 0)
                        nRet = int.Parse(selectQuery.Table("query").DefaultView[0].Row["ID"].ToString());
                }
            }
            finally
            {
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
            }
            return nRet;
        }

        /// <summary>
        /// Built Refference String 
        /// </summary>
        protected string BuiltRefferenceString(Int32 nMediaFileID, string sSubscriptionCode, string sPPVCode,
            string sPriceCode, double dPrice, string sCurrency)
        {
            string sRet = "";
            if (nMediaFileID != 0)
                sRet += "mf:" + nMediaFileID.ToString() + " ";
            if (sSubscriptionCode != "")
                sRet += "sub:" + sSubscriptionCode + " ";
            if (sPPVCode != "")
                sRet += "ppvcode:" + sPPVCode + " ";
            if (sPriceCode != "")
                sRet += "pricecode:" + sPriceCode + " ";
            sRet += "price:" + dPrice.ToString() + " ";
            sRet += "currency:" + sCurrency + " ";
            return sRet;
        }
        /// <summary>
        /// SMS Charge User For Media File 
        /// </summary>
        public virtual BillingResponse SMS_ChargeUserForMediaFile(string sSiteGUID, string sCellPhone, double dPrice, string sCurrency, Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            module bm = null;
            UsersService u = null;
            mdoule m = null;

            BillingResponse ret = new BillingResponse();
            try
            {
                if (sCellPhone.Trim() == "")
                {
                    ret.m_oStatus = BillingResponseStatus.Fail;
                    ret.m_sRecieptCode = "";
                    ret.m_sStatusDescription = "Problematic Cell Phone: " + sCellPhone;
                    WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                    return ret;
                }
                else if (sSiteGUID == "")
                {
                    ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_sRecieptCode = "";
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                    return ret;
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);

                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = "";
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                        return ret;
                    }
                    else if (uObj != null && uObj.m_user != null && uObj.m_user.m_eSuspendState == DomainSuspentionStatus.Suspended)
                    {
                        ret.m_oStatus = BillingResponseStatus.UserSuspended;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cannot charge a suspended user";
                        WriteToUserLog(sSiteGUID, "while trying to purchase  media file id(SMS): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                        return ret;
                    }
                    else
                    {
                        sWSUserName = string.Empty;
                        sWSPass = string.Empty;

                        m = new mdoule();
                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        if (string.IsNullOrEmpty(sPPVModuleCode))
                        {
                            ret.m_oStatus = BillingResponseStatus.Fail;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "Charge must have ppv module code";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }

                        // chack if ppvModule related to mediaFile 
                        long ppvModuleCode = 0;
                        long.TryParse(sPPVModuleCode, out ppvModuleCode);

                        PPVModule thePPVModule = m.ValidatePPVModuleForMediaFile(sWSUserName, sWSPass, nMediaFileID, ppvModuleCode);
                        if (thePPVModule == null)
                        {
                            ret.m_oStatus = BillingResponseStatus.Fail;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "The ppv module is unknown";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }
                        else if (thePPVModule.m_sObjectCode != ppvModuleCode.ToString() && !string.IsNullOrEmpty(sPPVModuleCode))
                        {
                            ret.m_oStatus = BillingResponseStatus.UnKnownPPVModule;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "This PPVModule does not belong to item";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }

                        PriceReason theReason = PriceReason.UnKnown;
                        Subscription relevantSub = null;
                        Collection relevantCol = null;
                        PrePaidModule relevantPP = null;


                        Price p = Utils.GetMediaFileFinalPriceForNonGetItemsPrices(nMediaFileID, thePPVModule, sSiteGUID, sCouponCode, m_nGroupID, ref theReason, ref relevantSub, ref relevantCol, ref relevantPP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        if (theReason == PriceReason.ForPurchase)
                        {
                            if (p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency)
                            {
                                bm = new module();
                                sWSUserName = string.Empty;
                                sWSPass = string.Empty;
                                Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                                string sPPVModule = "";
                                if (thePPVModule != null)
                                    sPPVModule = thePPVModule.m_sObjectCode;

                                //Create the Custom Data
                                string sCustomData = GetCustomData(relevantSub, thePPVModule, null, sSiteGUID, dPrice, sCurrency,
                                    nMediaFileID, nMediaID, sPPVModuleCode, string.Empty, sCouponCode, string.Empty,
                                    sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                                log.Debug("SMS CustomData - " + sCustomData);

                                if (relevantSub != null)
                                {
                                    ret = bm.SMS_SendCode(sWSUserName, sWSPass, sSiteGUID, sCellPhone, sCustomData, sExtraParameters);
                                    WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): SMS code sent to: " + sCellPhone);
                                }
                                else
                                {
                                    ret = bm.SMS_SendCode(sWSUserName, sWSPass, sSiteGUID, sCellPhone, sCustomData, sExtraParameters);
                                    WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): SMS code sent to: " + sCellPhone);
                                }
                            }
                            else
                            {
                                ret.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "Mismatch in price or currency";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.PPVPurchased)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The media file is already purchased";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                            if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The media file is contained in a purchased subscription";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                            if (theReason == PriceReason.Free)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The media file is free";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                            if (theReason == PriceReason.ForPurchaseSubscriptionOnly)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The media file is for purchase with subscription only";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                            else if (theReason == PriceReason.NotForPurchase)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The media file is not valid for purchased";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                    }
                    return ret;
                }
            }
            catch (Exception ex)
            {
                log.Error("exception - " + ex.Message + "||" + ex.StackTrace, ex);
                ret.m_oStatus = BillingResponseStatus.Fail;
                ret.m_sRecieptCode = "";
                ret.m_sStatusDescription = ex.Message + "||" + ex.StackTrace;
                return ret;
            }
            finally
            {
                if (u != null)
                {
                    u.Dispose();
                }
                if (m != null)
                {
                    m.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
            }
        }

        /// <summary>
        /// SMS Charge User For Subscription
        /// </summary>
        public virtual BillingResponse SMS_ChargeUserForSubscription(string sSiteGUID, string sCellPhone, double dPrice, string sCurrency, string sSubscriptionCode, string sCouponCode, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            BillingResponse ret = new BillingResponse();
            UsersService u = null;
            module bm = null;
            try
            {
                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_sRecieptCode = "";
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = "";
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                    }
                    else if (uObj != null && uObj.m_user != null && uObj.m_user.m_eSuspendState == DomainSuspentionStatus.Suspended)
                    {
                        ret.m_oStatus = BillingResponseStatus.UserSuspended;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cannot charge a suspended user";
                        WriteToUserLog(sSiteGUID, "while trying to purchase subscription(SMS): " + sSubscriptionCode + " error returned: " + ret.m_sStatusDescription);
                    }
                    else
                    {
                        PriceReason theReason = PriceReason.UnKnown;
                        Subscription theSub = null;
                        Price p = Utils.GetSubscriptionFinalPrice(m_nGroupID, sSubscriptionCode, sSiteGUID, sCouponCode, ref theReason, ref theSub, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        if (theReason == PriceReason.ForPurchase)
                        {
                            if (p != null && p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency)
                            {
                                if (p.m_dPrice != 0)
                                {
                                    bm = new module();
                                    sWSUserName = string.Empty;
                                    sWSPass = string.Empty;
                                    Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                                    if (theSub != null)
                                    {
                                        bool bIsRecurring = theSub.m_bIsRecurring;
                                        Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;

                                        string sCustomData = GetCustomDataForSubscription(theSub, null, sSubscriptionCode, string.Empty, sSiteGUID, dPrice, sCurrency,
                                        sCouponCode, string.Empty, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                                        log.Debug("SMS CustomData - " + sCustomData);

                                        ret = bm.SMS_SendCode(sWSUserName, sWSPass, sSiteGUID, sCellPhone, sCustomData, sExtraParameters);
                                        WriteToUserLog(sSiteGUID, "While trying to purchase subscription(SMS): " + sSubscriptionCode + " SMS code sent to: " + sCellPhone);
                                    }
                                }
                            }
                            else
                            {
                                ret.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The price of the request is not the actual price";
                                WriteToUserLog(sSiteGUID, "While trying to purchase subscription(SMS): " + sSubscriptionCode + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The subscription is already purchased";
                                WriteToUserLog(sSiteGUID, "While trying to purchase subscription(SMS): " + sSubscriptionCode + " error returned: " + ret.m_sStatusDescription);
                            }
                            if (theReason == PriceReason.Free)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The subscription is free";
                                WriteToUserLog(sSiteGUID, "While trying to purchase subscription(SMS): " + sSubscriptionCode + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                    }

                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at SMS_ChargeUserForSubscription. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Cell Phone: ", sCellPhone));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" Curr: ", sCurrency));
                sb.Append(String.Concat(" Sub Code: ", sSubscriptionCode));
                sb.Append(String.Concat(" Cpn Cd: ", sCouponCode));
                sb.Append(String.Concat(" Extra Params: ", sExtraParameters));
                sb.Append(String.Concat(" Cntry Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Cd: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" Device Name: ", sDEVICE_NAME));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
                #endregion
            }
            return ret;
        }
        /// <summary>
        /// Get User CA Sub Status
        /// </summary>
        protected virtual bool GetUserCASubStatus(string sSiteGUID, ref UserCAStatus oUserCAStatus)
        {
            return false;
        }
        /// <summary>
        /// Get User CA Status
        /// </summary>
        public virtual UserCAStatus GetUserCAStatus(string sSiteGUID)
        {
            if (sSiteGUID == "" || sSiteGUID == "0")
                return UserCAStatus.Annonymus;

            ODBCWrapper.DataSetSelectQuery selectQuery1 = null;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            try
            {
                UserCAStatus subStatus = UserCAStatus.NeverPurchased;
                bool subFound = GetUserCASubStatus(sSiteGUID, ref subStatus);
                if (subFound)
                {
                    return subStatus;
                }

                PermittedMediaContainer[] ppvItems = GetUserPermittedItems(sSiteGUID);
                if (ppvItems != null)
                {
                    if (ppvItems.Length > 0)
                        return UserCAStatus.CurrentPPV;
                }

                Int32 nPastSub = 0;
                selectQuery1 = new ODBCWrapper.DataSetSelectQuery();
                selectQuery1 += "select count(*) as co from subscriptions_purchases with (nolock) where is_active=1 and status=1 and ";
                selectQuery1 += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                if (selectQuery1.Execute("query", true) != null)
                {
                    Int32 nCount = selectQuery1.Table("query").DefaultView.Count;
                    if (nCount > 0)
                    {
                        nPastSub = int.Parse(selectQuery1.Table("query").DefaultView[0].Row["co"].ToString());
                    }
                }

                if (nPastSub > 0)
                    return UserCAStatus.ExSub;

                Int32 nPastPPV = 0;
                selectQuery = new ODBCWrapper.DataSetSelectQuery();
                selectQuery += "select count(*) as co from ppv_purchases with (nolock) where is_active=1 and status=1 and ";
                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                if (selectQuery.Execute("query", true) != null)
                {
                    Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                    if (nCount > 0)
                    {
                        nPastPPV = int.Parse(selectQuery.Table("query").DefaultView[0].Row["co"].ToString());
                    }
                }

                if (nPastPPV > 0)
                    return UserCAStatus.ExPPV;
            }
            finally
            {
                if (selectQuery1 != null)
                {
                    selectQuery1.Finish();
                }
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
            }
            return UserCAStatus.NeverPurchased;
        }
        /// <summary>
        /// Get Billing Trans Method
        /// </summary>
        private PaymentMethod GetBillingTransMethod(int billingTransID, string billingGuid)
        {
            PaymentMethod retVal = PaymentMethod.Unknown;

            if (billingTransID <= 0 && string.IsNullOrEmpty(billingGuid))
            {
                return retVal;
            }

            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            try
            {
                selectQuery = new ODBCWrapper.DataSetSelectQuery();
                selectQuery.SetConnectionKey("MAIN_CONNECTION_STRING");
                selectQuery += " select BILLING_METHOD from billing_transactions with (nolock) where status=1 and";
                if (billingTransID > 0)
                {
                    selectQuery += ODBCWrapper.Parameter.NEW_PARAM("id", "=", billingTransID);
                }
                else
                {
                    selectQuery += ODBCWrapper.Parameter.NEW_PARAM("billing_guid", "=", billingGuid);
                }
                if (selectQuery.Execute("query", true) != null)
                {
                    int count = selectQuery.Table("query").DefaultView.Count;
                    if (count > 0)
                    {
                        if (selectQuery.Table("query").DefaultView[0].Row["BILLING_METHOD"] != System.DBNull.Value && selectQuery.Table("query").DefaultView[0].Row["BILLING_METHOD"] != null)
                        {
                            int billingInt = int.Parse(selectQuery.Table("query").DefaultView[0].Row["BILLING_METHOD"].ToString());
                            if (billingInt > 0)
                            {
                                if (Enum.IsDefined(typeof(PaymentMethod), ((PaymentMethod)billingInt).ToString()))
                                    retVal = (PaymentMethod)billingInt;
                            }
                        }
                    }
                    else if (count == 0)
                    {
                        retVal = PaymentMethod.Gift;
                    }
                }
            }
            finally
            {
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
            }
            return retVal;
        }
        /// <summary>
        /// Get Domains Users
        /// </summary>
        private List<int> GetDomainsUsers(int nDomainID)
        {
            using (WS_Domains.module bm = new WS_Domains.module())
            {
                string sWSUserName = string.Empty;
                string sWSPass = string.Empty;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.DOMAINS, ref sWSUserName, ref sWSPass);
                List<string> usersList = bm.GetDomainUserList(sWSUserName, sWSPass, nDomainID);
                List<int> intUsersList = new List<int>();

                if (usersList != null && usersList.Count != 0)
                {
                    foreach (string str in usersList)
                    {
                        intUsersList.Add(int.Parse(str));
                    }
                }

                return intUsersList;
            }
        }
        /// <summary>
        /// Get Domain Permitted Items
        /// </summary>
        public virtual PermittedMediaContainer[] GetDomainPermittedItems(int nDomainID)
        {
            List<int> intUsersList = GetDomainsUsers(nDomainID);

            return GetUserPermittedItems(intUsersList, false, 0, nDomainID);
        }
        /// <summary>
        /// Get Domain Permitted Subscriptions
        /// </summary>
        public virtual PermittedSubscriptionContainer[] GetDomainPermittedSubscriptions(int nDomainID)
        {
            List<int> intUsersList = GetDomainsUsers(nDomainID);

            return GetUserPermittedSubscriptions(intUsersList, false, 0, nDomainID);
        }
        /// <summary>
        /// Get Domain Permitted Collections
        /// </summary>
        public virtual PermittedCollectionContainer[] GetDomainPermittedCollections(int nDomainID)
        {
            List<int> intUsersList = GetDomainsUsers(nDomainID);

            return GetUserPermittedCollections(intUsersList, false, 0, nDomainID);
        }
        /// <summary>
        /// Get User Permitted Items
        /// </summary>
        public virtual PermittedMediaContainer[] GetUserPermittedItems(string sSiteGUID)
        {
            int nSiteGuid = 0;
            PermittedMediaContainer[] res = null;
            if (!string.IsNullOrEmpty(sSiteGUID) && Int32.TryParse(sSiteGUID, out nSiteGuid) && nSiteGuid > 0)
            {
                res = GetUserPermittedItems(new List<int>(1) { nSiteGuid }, false, 0);
            }
            else
            {
                StringBuilder sb = new StringBuilder("GetUserPermittedItems. SiteGUID is in incorrect format. ");
                sb.Append(String.Concat("Group ID: ", m_nGroupID));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));

                log.Error("Error - " + sb.ToString());

                res = null;
            }

            return res;
        }
        /// <summary>
        /// Get User Permitted Items
        /// </summary>
        public virtual PermittedMediaContainer[] GetUserPermittedItems(List<int> lUsersIDs, bool isExpired, int numOfItems, int domainID = 0, bool shouldCheckByDomain = true)
        {
            PermittedMediaContainer[] ret = { };
            Int32[] nMediaFilesIDs = null;
            Hashtable h = new Hashtable();
            try
            {
                // Get domainID from one of the users
                if (shouldCheckByDomain && domainID == 0 && lUsersIDs.Count > 0)
                {
                    UserResponseObject user = Utils.GetExistUser(lUsersIDs.First().ToString(), m_nGroupID);
                    if (user != null && user.m_RespStatus == ResponseStatus.OK && user.m_user != null)
                    {
                        domainID = user.m_user.m_domianID;
                    }
                }
                DataTable allPPVModules = ConditionalAccessDAL.Get_All_Users_PPV_modules(lUsersIDs, isExpired, domainID);

                if (allPPVModules != null)
                {
                    Int32 nCount = allPPVModules.Rows.Count;
                    if (numOfItems == 0)
                    {
                        numOfItems = nCount;
                    }
                    else if (numOfItems != 0 && numOfItems < nCount)
                    {
                        nCount = numOfItems;
                    }
                    if (nCount > 0)
                        ret = new PermittedMediaContainer[nCount];

                    nMediaFilesIDs = new int[nCount];
                    int i = 0;

                    UsageModule oUsageModule = null;
                    foreach (DataRow dataRow in allPPVModules.Rows)
                    {
                        Int32 nMediaFileID = ODBCWrapper.Utils.GetIntSafeVal(dataRow["MEDIA_FILE_ID"]);
                        Int32 nMaxUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow["MAX_NUM_OF_USES"]);
                        Int32 nCurrentUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow["NUM_OF_USES"]);

                        int billingTransID = ODBCWrapper.Utils.GetIntSafeVal(dataRow["billing_transaction_id"]);
                        DateTime dEnd = new DateTime(2099, 1, 1);
                        if (dataRow["END_DATE"] != null && dataRow["END_DATE"] != DBNull.Value)
                            dEnd = (DateTime)(dataRow["END_DATE"]);

                        // get last view date
                        DateTime dLastViewDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow["LAST_VIEW_DATE"]);

                        DateTime dCurrent = DateTime.UtcNow;
                        if (dataRow["cDate"] != null && dataRow["cDate"] != DBNull.Value)
                            dCurrent = (DateTime)(dataRow["cDate"]);

                        DateTime dCreateDate = DateTime.UtcNow;
                        if (dataRow["START_DATE"] != null && dataRow["START_DATE"] != DBNull.Value)
                            dCreateDate = (DateTime)(dataRow["START_DATE"]);

                        string billingGuid = ODBCWrapper.Utils.GetSafeStr(dataRow, "BILLING_GUID");
                        PaymentMethod payMet = GetBillingTransMethod(billingTransID, billingGuid);

                        string sDeviceUDID = ODBCWrapper.Utils.GetSafeStr(dataRow["device_name"]);

                        nMediaFilesIDs[i] = nMediaFileID;


                        string sPPVCode = ODBCWrapper.Utils.GetSafeStr(dataRow, "ppv");

                        bool bCancellationWindow = false;
                        int nWaiver = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "WAIVER");

                        if (nWaiver == 0 && dLastViewDate < dCreateDate) // user didn't waiver yet and didn't use the PPV yet
                        {
                            IsCancellationWindow(ref oUsageModule, sPPVCode, dCreateDate, ref bCancellationWindow, eTransactionType.PPV);
                        }

                        long purchaseId = ODBCWrapper.Utils.GetLongSafeVal(dataRow, "ID");

                        PermittedMediaContainer p = new PermittedMediaContainer();
                        p.Initialize(0, nMediaFileID, nMaxUses, nCurrentUses, dEnd, dCurrent, dLastViewDate, dCreateDate, payMet, sDeviceUDID, sPPVCode, purchaseId, bCancellationWindow);
                        h[nMediaFileID] = p;
                        ++i;
                    }
                }

                MeidaMaper[] mapper = Utils.GetMediaMapper(m_nGroupID, nMediaFilesIDs);
                if (mapper == null)
                {
                    return ret;
                }
                Int32 nCo = mapper.Length;
                if (nCo > 0)
                    ret = new PermittedMediaContainer[nCo];
                for (int i = 0; i < nCo; i++)
                {
                    Int32 nMediaFileID = mapper[i].m_nMediaFileID;
                    if (h.Contains(nMediaFileID) == true)
                    {
                        ((PermittedMediaContainer)(h[nMediaFileID])).m_nMediaID = mapper[i].m_nMediaID;
                        ret[i] = (PermittedMediaContainer)(h[nMediaFileID]);
                    }
                }
            }
            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at GetUserPermittedItems.");
                sb.Append(String.Concat(" Group ID: ", m_nGroupID));
                sb.Append(String.Concat(" User IDs: ", lUsersIDs == null ? "null" : lUsersIDs.Aggregate<int, string>(string.Empty, (res, next) => (String.Concat(res, ":", next)))));
                sb.Append(String.Concat(" isExpired: ", isExpired.ToString().ToLower()));
                sb.Append(String.Concat(" numOfItems: ", numOfItems));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Exception msg: ", ex.Message));
                sb.Append(String.Concat(" Stack trace: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                return null;
            }
            return ret;

        }

        /// <summary>
        /// Get User Permitted Items
        /// </summary>
        public virtual Entitlements GetUsersEntitlementPPVItems(List<int> lUsersIDs, bool isExpired, int domainID = 0, bool shouldCheckByDomain = true, int pageSize = 500, int pageIndex = 0, EntitlementOrderBy orderBy = EntitlementOrderBy.PurchaseDateAsc)
        {
            Entitlements entitlementsResponse = new Entitlements();
            List<int> mediaFileIds = new List<int>();
            try
            {
                // Get domainID from one of the users
                if (shouldCheckByDomain && domainID == 0 && lUsersIDs.Count > 0)
                {
                    UserResponseObject user = Utils.GetExistUser(lUsersIDs.First().ToString(), m_nGroupID);
                    if (user != null && user.m_RespStatus == ResponseStatus.OK && user.m_user != null)
                    {
                        domainID = user.m_user.m_domianID;
                    }
                }

                DataTable allPPVModules = ConditionalAccessDAL.Get_All_Users_PPV_modules(lUsersIDs, isExpired, domainID, (int)orderBy);
                if (allPPVModules == null || allPPVModules.Rows == null || allPPVModules.Rows.Count == 0)
                {
                    entitlementsResponse.status = new ApiObjects.Response.Status((int)eResponseStatus.OK, "no permitted items");
                    return entitlementsResponse;
                }

                //Get Iteration Rows according page size and index
                IEnumerable<DataRow> iterationRows = GetIterationRows(pageSize, pageIndex, allPPVModules);

                Entitlement entitlement = null;
                foreach (DataRow dr in iterationRows)
                {
                    entitlement = CreatePPVEntitelment(dr);
                    if (entitlement != null)
                    {
                        if (!mediaFileIds.Contains(entitlement.mediaFileID))
                        {
                            mediaFileIds.Add(entitlement.mediaFileID);
                        }
                        entitlementsResponse.entitelments.Add(entitlement);
                    }
                }

                MeidaMaper[] mapper = Utils.GetMediaMapper(m_nGroupID, mediaFileIds.ToArray());


                foreach (Entitlement entitlementRes in entitlementsResponse.entitelments)
                {
                    int mediaID = mapper.Where(x => x.m_nMediaFileID == entitlementRes.mediaFileID).FirstOrDefault().m_nMediaID;
                    entitlementRes.mediaID = mediaID;
                }

                entitlementsResponse.status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
            }
            catch (Exception ex)
            {
                log.Error("Exception at GetUserPermittedItems. {0} - ", ex);
                entitlementsResponse.status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }
            return entitlementsResponse;
        }

        private static IEnumerable<DataRow> GetIterationRows(int pageSize, int pageIndex, DataTable usersPermittedItems)
        {
            IEnumerable<DataRow> iterationRows = null;
            List<DataRow> filteredRows = null;

            if (pageIndex > 0 && pageSize > 0)
            {
                int takeTop = pageIndex * pageSize;
                Int64 maxTransactionID = (from row in usersPermittedItems.AsEnumerable().Take(takeTop)
                                          select row.Field<Int64>("ID")).ToList().Min();
                filteredRows = (from row in usersPermittedItems.AsEnumerable()
                                where (Int64)row["ID"] < maxTransactionID
                                select row).Take(pageSize).ToList();
            }

            if (filteredRows != null)
            {
                iterationRows = filteredRows;
            }
            else if (pageSize > -1)
            {
                iterationRows = usersPermittedItems.AsEnumerable().Take(pageSize);
            }
            else
            {
                iterationRows = usersPermittedItems.AsEnumerable();
            }
            return iterationRows;
        }

        private Entitlement CreatePPVEntitelment(DataRow dataRow)
        {
            UsageModule oUsageModule = null;
            Entitlement entitlement = new Entitlement();

            entitlement.type = eTransactionType.PPV;
            entitlement.entitlementId = ODBCWrapper.Utils.GetSafeStr(dataRow, "ppv");
            entitlement.currentUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "NUM_OF_USES");

            entitlement.endDate = new DateTime(2099, 1, 1);
            if (dataRow["END_DATE"] != null && dataRow["END_DATE"] != DBNull.Value)
                entitlement.endDate = (DateTime)(dataRow["END_DATE"]);

            entitlement.currentDate = DateTime.UtcNow;
            if (dataRow["cDate"] != null && dataRow["cDate"] != DBNull.Value)
                entitlement.currentDate = (DateTime)(dataRow["cDate"]);

            entitlement.lastViewDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow["LAST_VIEW_DATE"]);

            entitlement.purchaseDate = DateTime.UtcNow;
            if (dataRow["START_DATE"] != null && dataRow["START_DATE"] != DBNull.Value)
                entitlement.purchaseDate = (DateTime)(dataRow["START_DATE"]);

            entitlement.purchaseID = (int)ODBCWrapper.Utils.GetLongSafeVal(dataRow, "ID");
            entitlement.paymentMethod = GetBillingTransMethod(ODBCWrapper.Utils.GetIntSafeVal(dataRow, "billing_transaction_id"), ODBCWrapper.Utils.GetSafeStr(dataRow, "BILLING_GUID"));
            entitlement.deviceUDID = ODBCWrapper.Utils.GetSafeStr(dataRow, "device_name");
            if (!string.IsNullOrEmpty(entitlement.deviceUDID))
            {
                entitlement.deviceName = GetDeviceName(entitlement.deviceUDID);
            }

            if (ODBCWrapper.Utils.GetIntSafeVal(dataRow, "WAIVER") == 0 &&
                entitlement.lastViewDate < entitlement.purchaseDate)// user didn't waiver yet and didn't use the PPV yet
            {
                bool cancellationWindow = false;
                IsCancellationWindow(ref oUsageModule, entitlement.entitlementId, entitlement.purchaseDate, ref cancellationWindow, eTransactionType.PPV);
                entitlement.cancelWindow = cancellationWindow;
            }

            entitlement.maxUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "MAX_NUM_OF_USES");
            entitlement.mediaFileID = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "MEDIA_FILE_ID");
            entitlement.mediaID = 0;

            return entitlement;

        }

        private static string GetDeviceName(string deviceUDID)
        {
            string deviceName = string.Empty;

            ODBCWrapper.DataSetSelectQuery selectQuery = new ODBCWrapper.DataSetSelectQuery();
            selectQuery += " select name from devices where ";
            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("device_id", "=", deviceUDID);
            selectQuery.SetConnectionKey("users_connection");
            if (selectQuery.Execute("query", true) != null)
            {
                Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                if (nCount > 0)
                    deviceName = selectQuery.Table("query").DefaultView[0].Row["name"].ToString();
            }
            selectQuery.Finish();
            selectQuery = null;

            return deviceName;
        }

        /// <summary>
        /// Get User Permitted Subscriptions
        /// </summary>
        public virtual PermittedSubscriptionContainer[] GetUserPermittedSubscriptions(string sSiteGUID)
        {
            PermittedSubscriptionContainer[] response = null;
            int userId, domainID = 0;
            DomainSuspentionStatus userSuspendStatus = DomainSuspentionStatus.OK;
            if (int.TryParse(sSiteGUID, out userId) && Utils.IsUserValid(sSiteGUID, m_nGroupID, ref domainID, ref userSuspendStatus))
            {
                response = GetUserPermittedSubscriptions(new List<int>() { int.Parse(sSiteGUID) }, false, 0, domainID);
            }

            return response;
        }
        /// <summary>
        /// Get User Permitted Collections
        /// </summary>
        public virtual PermittedCollectionContainer[] GetUserPermittedCollections(string sSiteGUID)
        {
            return GetUserPermittedCollections(new List<int>() { int.Parse(sSiteGUID) }, false, 0);
        }
        /// <summary>
        /// Get User Permitted Collections
        /// </summary>
        public virtual PermittedCollectionContainer[] GetUserPermittedCollections(List<int> lUsersIDs, bool isExpired, int numOfItems, int domainID = 0, bool shouldCheckByDomain = true)
        {
            PermittedCollectionContainer[] ret = null;
            try
            {
                // Get domainID from one of the users
                if (shouldCheckByDomain && domainID == 0 && lUsersIDs.Count > 0)
                {
                    UserResponseObject user = Utils.GetExistUser(lUsersIDs.First().ToString(), m_nGroupID);
                    if (user != null && user.m_RespStatus == ResponseStatus.OK && user.m_user != null)
                    {
                        domainID = user.m_user.m_domianID;
                    }
                }

                DataTable allCollectionsPurchases = ConditionalAccessDAL.Get_UsersPermittedCollections(lUsersIDs, isExpired, domainID);

                if (allCollectionsPurchases != null)
                {
                    Int32 nCount = allCollectionsPurchases.Rows.Count;
                    ret = new PermittedCollectionContainer[nCount];

                    if (numOfItems == 0)
                    {
                        numOfItems = nCount;
                    }
                    else if (numOfItems != 0 && numOfItems < nCount)
                    {
                        nCount = numOfItems;
                    }
                    int i = 0;
                    UsageModule oUsageModule = null;
                    foreach (DataRow dataRow in allCollectionsPurchases.Rows)
                    {
                        //take care of numOfItem< nCount 
                        if (numOfItems <= i)
                        {
                            break;
                        }
                        string sCollectionCode = ODBCWrapper.Utils.GetSafeStr(dataRow["COLLECTION_CODE"]);
                        Int32 nMaxUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow["MAX_NUM_OF_USES"]);
                        Int32 nCurrentUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow["NUM_OF_USES"]);
                        int billingTransID = ODBCWrapper.Utils.GetIntSafeVal(dataRow["billing_transaction_id"]);

                        DateTime dEnd = ODBCWrapper.Utils.GetDateSafeVal(dataRow["END_DATE"]);
                        DateTime dCurrent = ODBCWrapper.Utils.GetDateSafeVal(dataRow["cDate"]);
                        DateTime dCreateDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow["CREATE_DATE"]);
                        DateTime dLastViewDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow["LAST_VIEW_DATE"]);

                        if (isExpired && nMaxUses != 0 && nCurrentUses >= nMaxUses)
                        {
                            dEnd = dLastViewDate;
                        }

                        Int32 nID = ODBCWrapper.Utils.GetIntSafeVal(dataRow["ID"]);
                        string billingGuid = ODBCWrapper.Utils.GetSafeStr(dataRow, "BILLING_GUID");
                        PaymentMethod payMet = GetBillingTransMethod(billingTransID, billingGuid);

                        string sDeviceUDID = ODBCWrapper.Utils.GetSafeStr(dataRow["device_name"]);

                        bool bCancellationWindow = false;
                        int nWaiver = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "WAIVER");
                        if (nWaiver == 0 && dLastViewDate < dCreateDate) // user didn't waiver yet and didn't use the collection yet
                        {
                            IsCancellationWindow(ref oUsageModule, sCollectionCode, dCreateDate, ref bCancellationWindow, eTransactionType.Collection);
                        }

                        PermittedCollectionContainer pcc = new PermittedCollectionContainer();
                        pcc.Initialize(sCollectionCode, dEnd, dCurrent, dLastViewDate, dCreateDate, nID, payMet, sDeviceUDID, bCancellationWindow);
                        ret[i] = pcc;
                        ++i;
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at GetUserPermittedCollections. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                if (lUsersIDs != null && lUsersIDs.Count > 0)
                {
                    sb.Append(" User IDs: ");
                    for (int i = 0; i < lUsersIDs.Count; i++)
                    {
                        sb.Append(String.Concat(" ", lUsersIDs[i], " "));
                    }
                }
                else
                {
                    sb.Append(" No users. ");
                }
                sb.Append(String.Concat(" IsExpired: ", isExpired.ToString().ToLower()));
                sb.Append(String.Concat(" NumOfItems: ", numOfItems));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion

                ret = null;
            }
            return ret;
        }

        private void IsCancellationWindow(ref UsageModule oUsageModule, string sAssetCode, DateTime dCreateDate, ref bool bCancellationWindow, eTransactionType transaction)
        {
            //get the right usage module for each ppv
            using (mdoule m = new mdoule())
            {
                string sWSUserName = string.Empty;
                string sWSPass = string.Empty;

                string transactionName = Enum.GetName(typeof(eTransactionType), transaction);

                Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                eTransactionType enumPricing = (eTransactionType)Enum.Parse(typeof(eTransactionType), transactionName);
                oUsageModule = m.GetUsageModule(sWSUserName, sWSPass, sAssetCode, enumPricing);

                if (oUsageModule != null)
                {
                    if (oUsageModule.m_bWaiver) // if this usage module need to be waiver - check the date
                    {
                        DateTime waiverDate = Utils.GetEndDateTime(dCreateDate, oUsageModule.m_nWaiverPeriod); // dCreateDate = ppv purchase date
                        if (DateTime.UtcNow <= waiverDate)
                        {
                            bCancellationWindow = true;
                        }
                    }
                }
            }
        }
        /// <summary>
        /// Get User Permitted Subscriptions
        /// </summary>
        public virtual PermittedSubscriptionContainer[] GetUserPermittedSubscriptions(List<int> usersIdList, bool isExpired, int numOfItems, int domainID = 0, bool shouldCheckByDomain = true)
        {
            PermittedSubscriptionContainer[] ret = null;
            try
            {
                // Get domainID from one of the users
                if (shouldCheckByDomain && domainID == 0 && usersIdList.Count > 0)
                {
                    UserResponseObject user = Utils.GetExistUser(usersIdList.First().ToString(), m_nGroupID);
                    if (user != null && user.m_RespStatus == ResponseStatus.OK && user.m_user != null)
                    {
                        domainID = user.m_user.m_domianID;
                    }
                }

                DataTable allSubscriptionsPurchases = ConditionalAccessDAL.Get_UsersPermittedSubscriptions(usersIdList, isExpired, domainID);

                if (allSubscriptionsPurchases != null)
                {
                    Int32 nCount = allSubscriptionsPurchases.Rows.Count;
                    ret = new PermittedSubscriptionContainer[nCount];

                    if (numOfItems == 0)
                    {
                        numOfItems = nCount;
                    }
                    else if (numOfItems != 0 && numOfItems < nCount)
                    {
                        nCount = numOfItems;
                    }
                    int i = 0;
                   
                    UsageModule oUsageModule = null;

                    foreach (DataRow dataRow in allSubscriptionsPurchases.Rows)
                    {
                        //take care of numOfItem< nCount 
                        if (numOfItems <= i)
                        {
                            break;
                        }
                        DateTime dNextRenewalDate = DateTime.MaxValue;
                        bool isRecurringStatus = false;
                        bool isSubRenewable = false;
                        int purchaseID = ODBCWrapper.Utils.GetIntSafeVal(dataRow["ID"]);
                        string subscriptionCode = ODBCWrapper.Utils.GetSafeStr(dataRow["SUBSCRIPTION_CODE"]);

                        Int32 maxUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow["MAX_NUM_OF_USES"]);
                        Int32 currentUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow["NUM_OF_USES"]);
                        int billingTransId = ODBCWrapper.Utils.GetIntSafeVal(dataRow["billing_transaction_id"]);

                        DateTime endDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow["END_DATE"]);
                        DateTime dCurrent = ODBCWrapper.Utils.GetDateSafeVal(dataRow["cDate"]);
                        DateTime createDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow["START_DATE"]);
                        DateTime lastViewDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow["LAST_VIEW_DATE"]);
                        int gracePeriodMinutes = ODBCWrapper.Utils.GetIntSafeVal(dataRow["GRACE_PERIOD_MINUTES"]);

                        // check whether subscription is in its grace period
                        bool isInGracePeriod = false;
                        if (!isExpired && endDate < DateTime.UtcNow)
                        {
                            endDate = endDate.AddMinutes(gracePeriodMinutes);
                            isInGracePeriod = true;
                        }


                        Int32 nIsRecurringStatus = ODBCWrapper.Utils.GetIntSafeVal(dataRow["IS_RECURRING_STATUS"]);
                        if (nIsRecurringStatus == 1)
                        {
                            isRecurringStatus = true;
                            dNextRenewalDate = endDate;
                        }

                        if (isExpired && maxUses != 0 && currentUses >= maxUses)
                        {
                            endDate = lastViewDate;
                        }

                        Int32 nIsSubRenewable = ODBCWrapper.Utils.GetIntSafeVal(dataRow["IS_RECURRING"]);
                        if (nIsSubRenewable == 1)
                            isSubRenewable = true;

                        Int32 nID = ODBCWrapper.Utils.GetIntSafeVal(dataRow["ID"]);
                        string billingGuid = ODBCWrapper.Utils.GetSafeStr(dataRow, "BILLING_GUID");
                        PaymentMethod payMet = GetBillingTransMethod(billingTransId, billingGuid);

                        string sDeviceUDID = ODBCWrapper.Utils.GetSafeStr(dataRow["device_name"]);

                        bool bCancellationWindow = false;
                        int nWaiver = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "WAIVER");
                        if (nWaiver == 0 && lastViewDate < createDate) // user didn't waiver yet and didn't use the sub yet
                        {
                            IsCancellationWindow(ref oUsageModule, subscriptionCode, createDate, ref bCancellationWindow, eTransactionType.Subscription);
                        }

                        //TODO liat  add the details pf payment
                        PermittedSubscriptionContainer p = new PermittedSubscriptionContainer();
                        p.Initialize(subscriptionCode, maxUses, currentUses, endDate, dCurrent, lastViewDate, createDate, dNextRenewalDate, isRecurringStatus, isSubRenewable,
                            nID, payMet, sDeviceUDID, bCancellationWindow, isInGracePeriod);
                        ret[i] = p;
                        ++i;
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at GetUserPermittedSubscriptions. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                if (usersIdList != null && usersIdList.Count > 0)
                {
                    sb.Append(" User IDs: ");
                    for (int i = 0; i < usersIdList.Count; i++)
                    {
                        sb.Append(String.Concat(" ", usersIdList[i], " "));
                    }
                }
                else
                {
                    sb.Append(String.Concat(" No users. "));
                }
                sb.Append(String.Concat(" IsExpired: ", isExpired));
                sb.Append(String.Concat(" NumOfItems: ", numOfItems));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion

                ret = null;
            }
            return ret;
        }

        private Entitlements GetUsersEntitlementSubscriptionsItems(List<int> userIds, bool isExpired, int domainID, bool shouldCheckByDomain, int pageSize, int pageIndex, EntitlementOrderBy orderBy)
        {
            Entitlements entitlementsResponse = new Entitlements();

            try
            {
                // Get domainID from one of the users
                if (shouldCheckByDomain && domainID == 0 && userIds.Count > 0)
                {
                    UserResponseObject user = Utils.GetExistUser(userIds.First().ToString(), m_nGroupID);
                    if (user != null && user.m_RespStatus == ResponseStatus.OK && user.m_user != null)
                    {
                        domainID = user.m_user.m_domianID;
                    }
                }

                DataTable allSubscriptionsPurchases = ConditionalAccessDAL.Get_UsersPermittedSubscriptions(userIds, isExpired, domainID, (int)orderBy);

                if (allSubscriptionsPurchases == null || allSubscriptionsPurchases.Rows == null || allSubscriptionsPurchases.Rows.Count == 0)
                {
                    entitlementsResponse.status = new ApiObjects.Response.Status((int)eResponseStatus.OK, "no permitted items");
                    return entitlementsResponse;
                }

                //Get Iteration Rows according page size and index
                IEnumerable<DataRow> iterationRows = GetIterationRows(pageSize, pageIndex, allSubscriptionsPurchases);
                
                // get all builingGuid from subscription 
                List<string>  billingGuids = (from row in allSubscriptionsPurchases.AsEnumerable()
                                              where row.Field<int>("IS_RECURRING_STATUS") == 1
                                              select row.Field<string>("BILLING_GUID")).ToList(); // only renewable subscriptions 
                List<PaymentDetails> renewPaymentDetails = null;
                if (billingGuids != null && billingGuids.Count > 0)
                {
                    // call billing service to get all transaction payment details
                    string sWSUserName = "";
                    string sWSPass = "";
                    module bm = new module();
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                    renewPaymentDetails = bm.GetPaymentDetails(sWSUserName, sWSPass, billingGuids);
                }            

                Entitlement entitlement = null;
                foreach (DataRow dr in iterationRows)
                {
                    entitlement = CreateSubscriptionEntitelment(dr, isExpired, renewPaymentDetails);
                    if (entitlement != null)
                    {
                        entitlementsResponse.entitelments.Add(entitlement);
                    }
                }

                entitlementsResponse.status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
            }
            catch (Exception ex)
            {
                log.Error("Exception at GetUserPermittedSubscriptions. {0} - ", ex);
                entitlementsResponse.status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }
            return entitlementsResponse;
        }

        private Entitlement CreateSubscriptionEntitelment(DataRow dataRow, bool isExpired, List<PaymentDetails> renewPaymentDetails)
        {
            UsageModule oUsageModule = null;
            Entitlement entitlement = new Entitlement();
            PaymentDetails paymentDetails = null;

            entitlement.type = eTransactionType.Subscription;
            entitlement.entitlementId = ODBCWrapper.Utils.GetSafeStr(dataRow, "SUBSCRIPTION_CODE");
            entitlement.currentUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "NUM_OF_USES");
            entitlement.maxUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "MAX_NUM_OF_USES");

            DateTime endDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow, "END_DATE");
            entitlement.purchaseDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow, "START_DATE");
            entitlement.lastViewDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow, "LAST_VIEW_DATE");

            // check whether subscription is in its grace period
            int gracePeriodMinutes = ODBCWrapper.Utils.GetIntSafeVal(dataRow["GRACE_PERIOD_MINUTES"]);
            entitlement.IsInGracePeriod = false;
            if (!isExpired && endDate < DateTime.UtcNow)
            {
                endDate = endDate.AddMinutes(gracePeriodMinutes);
                entitlement.IsInGracePeriod = true;
            }

            string billingGuid = ODBCWrapper.Utils.GetSafeStr(dataRow, "BILLING_GUID");

            entitlement.recurringStatus = false;
            entitlement.nextRenewalDate = DateTime.MaxValue;
            if (ODBCWrapper.Utils.GetIntSafeVal(dataRow, "IS_RECURRING_STATUS") == 1)
            {
                entitlement.recurringStatus = true;
                entitlement.nextRenewalDate = endDate;

                // get renew payment details 
                if (renewPaymentDetails != null)
                {
                    paymentDetails = renewPaymentDetails.Where(x=>x.BillingGuid == billingGuid).FirstOrDefault();
                    if (paymentDetails != null)
                    {
                        entitlement.paymentGatewayId = paymentDetails.PaymentGatewayId;
                        entitlement.paymentMethodId = paymentDetails.PaymentMethodId;
                    }
                }
            }

            if (isExpired && entitlement.maxUses != 0 && entitlement.currentUses >= entitlement.maxUses)
            {
                endDate = entitlement.lastViewDate;
            }
            
            entitlement.isRenewable = false;
            if (ODBCWrapper.Utils.GetIntSafeVal(dataRow["IS_RECURRING"]) == 1)
            {
                entitlement.isRenewable = true;
            }

            entitlement.endDate = endDate;
            entitlement.currentDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow, "cDate");

            if (ODBCWrapper.Utils.GetIntSafeVal(dataRow, "WAIVER") == 0 &&
               entitlement.lastViewDate < entitlement.purchaseDate)// user didn't waiver yet and didn't use the PPV yet
            {
                bool cancellationWindow = false;
                IsCancellationWindow(ref oUsageModule, entitlement.entitlementId, entitlement.purchaseDate, ref cancellationWindow, eTransactionType.Subscription);
                entitlement.cancelWindow = cancellationWindow;
            }

            entitlement.purchaseID = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "ID");
            entitlement.paymentMethod = GetBillingTransMethod(ODBCWrapper.Utils.GetIntSafeVal(dataRow, "billing_transaction_id"), billingGuid);
            entitlement.deviceUDID = ODBCWrapper.Utils.GetSafeStr(dataRow, "device_name");
            entitlement.deviceName = string.Empty;
            if (!string.IsNullOrEmpty(entitlement.deviceUDID))
            {
                entitlement.deviceName = GetDeviceName(entitlement.deviceUDID);
            }

            entitlement.mediaFileID = 0;
            return entitlement;
        }

        /// <summary>
        /// Split Refference
        /// </summary>
        protected void SplitRefference(string sRefference, ref Int32 nMediaFileID, ref string sSubscriptionCode, ref string sPPVCode)
        {
            string[] spliter = { " " };
            string[] splited = sRefference.Split(spliter, StringSplitOptions.RemoveEmptyEntries);
            for (int i = 0; i < splited.Length; i++)
            {
                string sHeader = splited[i];
                if (sHeader.StartsWith("mf:"))
                    nMediaFileID = int.Parse(sHeader.Substring(3));
                if (sHeader.StartsWith("sub:"))
                    sSubscriptionCode = sHeader.Substring(4);
                if (sHeader.StartsWith("ppvcode:"))
                    sPPVCode = sHeader.Substring(8);
            }
        }
        /// <summary>
        /// SMS Check Code For Media File
        /// </summary>
        public virtual BillingResponse SMS_CheckCodeForMediaFile(string sSiteGUID, string sCellPhone, string sSMSCode, Int32 nMediaFileID,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {

            BillingResponse ret = null;
            string sWSUserName = "";
            string sWSPass = "";
            module bm = null;
            mdoule m = null;
            ODBCWrapper.InsertQuery insertQuery = null;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            try
            {
                bm = new module();

                Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                string sRefference = BuiltRefferenceString(nMediaFileID, "", "", "", 0, "");
                ret = bm.SMS_CheckCode(sWSUserName, sWSPass, sSiteGUID, sCellPhone, sSMSCode, sRefference);
                if (ret.m_sRecieptCode != "")
                {
                    if (ret.m_oStatus == BillingResponseStatus.Success)
                    {
                        string sSubCode = "";
                        string sPPVCode = "";
                        SplitRefference(ret.m_sStatusDescription, ref nMediaFileID, ref sSubCode, ref sPPVCode);
                        sWSUserName = "";
                        sWSPass = "";

                        m = new mdoule();
                        PPVModule thePPVModule = null;

                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        thePPVModule = m.GetPPVModuleData(sWSUserName, sWSPass, sPPVCode, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                        insertQuery = new ODBCWrapper.InsertQuery("ppv_purchases");
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubCode);
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MEDIA_FILE_ID", "=", nMediaFileID);
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                        DomainSuspentionStatus suspendStatus = DomainSuspentionStatus.OK;
                        int domainId = 0;
                        if (Utils.IsUserValid(sSiteGUID, m_nGroupID, ref domainId, ref suspendStatus) && suspendStatus == DomainSuspentionStatus.OK)
                        {
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DOMAIN_ID", "=", domainId);
                        }
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("PRICE", "=", thePPVModule.m_oPriceCode.m_oPrise.m_dPrice);
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("CURRENCY_CD", "=", thePPVModule.m_oPriceCode.m_oPrise.m_oCurrency.m_sCurrencyCD3);
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("NUM_OF_USES", "=", 0);
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("CUSTOMDATA", "=", "");
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("COUNTRY_CODE", "=", sCountryCd);
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("LANGUAGE_CODE", "=", sLANGUAGE_CODE);
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DEVICE_NAME", "=", sDEVICE_NAME);
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("BILLING_TRANSACTION_ID", "=", int.Parse(ret.m_sRecieptCode));
                        if (thePPVModule != null &&
                            thePPVModule.m_oUsageModule != null)
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", thePPVModule.m_oUsageModule.m_nMaxNumberOfViews);
                        else
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", 0);

                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);
                        if (thePPVModule != null &&
                            thePPVModule.m_oUsageModule != null)
                        {
                            DateTime d = Utils.GetEndDateTime(DateTime.UtcNow, thePPVModule.m_oUsageModule.m_tsMaxUsageModuleLifeCycle);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("END_DATE", "=", d);

                        }

                        insertQuery.Execute();

                        WriteToUserLog(sSiteGUID, "Media file(SMS):" + nMediaFileID.ToString() + " purchased");
                        Int32 nPurchaseID = 0;
                        selectQuery = new ODBCWrapper.DataSetSelectQuery();
                        selectQuery += "select id from ppv_purchases where ";

                        selectQuery += " group_id " + TVinciShared.PageUtils.GetFullChildGroupsStr(m_nGroupID, "MAIN_CONNECTION_STRING");
                        selectQuery += "and";
                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubCode);
                        selectQuery += "and";
                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("MEDIA_FILE_ID", "=", nMediaFileID);
                        selectQuery += "and";
                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                        selectQuery += "and";
                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("PRICE", "=", thePPVModule.m_oPriceCode.m_oPrise.m_dPrice);
                        selectQuery += "and";
                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("CURRENCY_CD", "=", thePPVModule.m_oPriceCode.m_oPrise.m_oCurrency.m_sCurrencyCD3);
                        selectQuery += "and";
                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("NUM_OF_USES", "=", 0);
                        selectQuery += "and";
                        if (thePPVModule != null &&
                            thePPVModule.m_oUsageModule != null)
                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", thePPVModule.m_oUsageModule.m_nMaxNumberOfViews);
                        else
                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", 0);
                        selectQuery += "and";
                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                        selectQuery += "and";
                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);
                        selectQuery += "order by id desc";
                        if (selectQuery.Execute("query", true) != null)
                        {
                            Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                            if (nCount > 0)
                                nPurchaseID = int.Parse(selectQuery.Table("query").DefaultView[0].Row["id"].ToString());
                        }

                        //Should update the PURCHASE_ID

                        string sReciept = ret.m_sRecieptCode;
                        if (sReciept != "")
                        {
                            Int32 nID = int.Parse(sReciept);
                            updateQuery = new ODBCWrapper.UpdateQuery("billing_transactions");
                            updateQuery.SetConnectionKey("MAIN_CONNECTION_STRING");
                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("PURCHASE_ID", "=", nPurchaseID);
                            updateQuery += "where";
                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nID);
                            updateQuery.Execute();

                        }

                    }
                    else
                    {
                        if (ret.m_sStatusDescription != "SMS was not sent yet")
                        {
                            ret.m_oStatus = BillingResponseStatus.Success;
                            ret.m_sStatusDescription = "Allready purchased";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(SMS): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at SMS_CheckCodeForMediaFile. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" CP: ", sCellPhone));
                sb.Append(String.Concat(" SMS Code: ", sSMSCode));
                sb.Append(String.Concat(" MF ID: ", nMediaFileID));
                sb.Append(String.Concat(" Cntry Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Cd: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" D Name: ", sDEVICE_NAME));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                #region Disposing
                if (bm != null)
                {
                    bm.Dispose();
                }
                if (m != null)
                {
                    m.Dispose();
                }
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
                if (insertQuery != null)
                {
                    insertQuery.Finish();
                }
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
                #endregion
            }
            return ret;
        }
        /// <summary>
        /// SMS Check Code For Subscription
        /// </summary>
        public virtual BillingResponse SMS_CheckCodeForSubscription(string sSiteGUID, string sCellPhone, string sSMSCode, string sSubscription,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            BillingResponse ret = null;

            string sWSUserName = string.Empty;
            string sWSPass = string.Empty;
            module bm = null;
            mdoule m = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            ODBCWrapper.InsertQuery insertQuery = null;
            try
            {
                m = new mdoule();
                Subscription theSub = null;

                Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                theSub = m.GetSubscriptionData(sWSUserName, sWSPass, sSubscription, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, false);

                if (theSub != null)
                {
                    bm = new module();
                    sWSUserName = string.Empty;
                    sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                    string sRefference = BuiltRefferenceString(0, sSubscription, "", theSub.m_oPriceCode.m_sCode, theSub.m_oPriceCode.m_oPrise.m_dPrice, theSub.m_oPriceCode.m_oPrise.m_oCurrency.m_sCurrencyCD3);
                    ret = bm.SMS_CheckCode(sWSUserName, sWSPass, sSiteGUID, sCellPhone, sSMSCode, sRefference);
                    if (ret.m_sRecieptCode != "")
                    {
                        if (ret.m_oStatus == BillingResponseStatus.Success)
                        {
                            string sSubCode = "";
                            string sPPVCode = "";
                            Int32 nMediaFileID = 0;
                            SplitRefference(ret.m_sStatusDescription, ref nMediaFileID, ref sSubCode, ref sPPVCode);
                            updateQuery = new ODBCWrapper.UpdateQuery("subscriptions_purchases");
                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_RECURRING_STATUS", "=", 0);
                            updateQuery += " where ";
                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                            updateQuery += " and ";
                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubscription);
                            updateQuery += " and ";
                            updateQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                            updateQuery.Execute();


                            insertQuery = new ODBCWrapper.InsertQuery("subscriptions_purchases");
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubscription);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                            DomainSuspentionStatus suspendStatus = DomainSuspentionStatus.OK;
                            int domainId = 0;
                            if (Utils.IsUserValid(sSiteGUID, m_nGroupID, ref domainId, ref suspendStatus) && suspendStatus == DomainSuspentionStatus.OK)
                            {
                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DOMAIN_ID", "=", domainId);
                            }
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("CUSTOMDATA", "=", "");
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("NUM_OF_USES", "=", 0);
                            if (theSub != null &&
                                theSub.m_oUsageModule != null)
                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", theSub.m_oUsageModule.m_nMaxNumberOfViews);
                            else
                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", 0);

                            if (theSub != null &&
                                theSub.m_oUsageModule != null)
                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("VIEW_LIFE_CYCLE_SECS", "=", theSub.m_oUsageModule.m_tsViewLifeCycle);
                            else
                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("VIEW_LIFE_CYCLE_SECS", "=", 0);

                            bool bIsRecurring = false;
                            if (theSub != null && theSub.m_oUsageModule != null)
                                bIsRecurring = theSub.m_bIsRecurring;

                            if (bIsRecurring == true)
                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_RECURRING_STATUS", "=", 1);
                            else
                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_RECURRING_STATUS", "=", 0);
                            if (ret.m_sRecieptCode != "")
                            {
                                try
                                {
                                    insertQuery += ODBCWrapper.Parameter.NEW_PARAM("BILLING_TRANSACTION_ID", "=", int.Parse(ret.m_sRecieptCode));
                                }
                                catch { }
                            }
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("COUNTRY_CODE", "=", sCountryCd);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("LANGUAGE_CODE", "=", sLANGUAGE_CODE);
                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DEVICE_NAME", "=", sDEVICE_NAME);
                            if (theSub != null &&
                                theSub.m_oSubscriptionUsageModule != null)
                            {
                                DateTime d = Utils.GetEndDateTime(DateTime.UtcNow, theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle);
                                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("END_DATE", "=", d);

                            }

                            insertQuery.Execute();

                            WriteToUserLog(sSiteGUID, "Subscription(SMS):" + sSubCode + " purchased");
                        }
                        else
                        {
                            ret.m_oStatus = BillingResponseStatus.Success;
                            ret.m_sStatusDescription = "Allready purchased";
                            WriteToUserLog(sSiteGUID, "While trying to purchase subscription(SMS): " + sSubscription + " error returned: " + ret.m_sStatusDescription);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at SMS_CheckCodeForSubscription. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" CP: ", sCellPhone));
                sb.Append(String.Concat(" SMS: ", sSMSCode));
                sb.Append(String.Concat(" Sub: ", sSubscription));
                sb.Append(String.Concat(" Cntry Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Cd: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" D Nm: ", sDEVICE_NAME));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                #region Disposing
                if (m != null)
                {
                    m.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
                if (insertQuery != null)
                {
                    insertQuery.Finish();
                }
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
                #endregion
            }
            return ret;
        }


        /// <summary>
        /// Credit Card Charge User For Media File
        /// </summary>
        public virtual BillingResponse Cellular_ChargeUserForMediaFile(string sSiteGUID, double dPrice, string sCurrency, Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sUserIP, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bDummy)
        {
            return Cellular_BaseChargeUserForMediaFile(sSiteGUID, dPrice, sCurrency, nMediaFileID, nMediaID, sPPVModuleCode, sCouponCode, sUserIP, sExtraParameters, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, bDummy);
        }


        /// <summary>
        /// Credit Card Charge User For Media File
        /// </summary>
        public virtual BillingResponse CC_ChargeUserForMediaFile(string sSiteGUID, double dPrice, string sCurrency, Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode,
            string sCouponCode, string sUserIP, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bDummy, string sPaymentMethodID, string sEncryptedCVV)
        {
            return CC_BaseChargeUserForMediaFile(sSiteGUID, dPrice, sCurrency, nMediaFileID, nMediaID, sPPVModuleCode, sCouponCode, sUserIP, sExtraParameters,
                sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, bDummy, sPaymentMethodID, sEncryptedCVV);
        }
        protected BillingResponse CC_BaseChargeUserForMediaFile(string sSiteGUID, double dPrice, string sCurrency,
           Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sUserIP, string sExtraParameters,
           string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bDummy, string sPaymentMethodID, string sEncryptedCVV)
        {
            BillingResponse oResponse = new BillingResponse();
            oResponse.m_oStatus = BillingResponseStatus.UnKnown;
            oResponse.m_sRecieptCode = string.Empty;
            oResponse.m_sStatusDescription = string.Empty;

            UsersService wsUsersService = null;
            mdoule wsPricingService = null;
            module wsBillingService = null;

            try
            {
                log.Debug("CC_BaseChargeUserForMediaFile - " + string.Format("Entering CC_BaseChargeUserForMediaFile try block. Site Guid: {0} , Media File ID: {1} , Media ID: {2} , PPV Module Code: {3} , Coupon code: {4} , User IP: {5} , Payment Method: {6} , Dummy: {7}", sSiteGUID, nMediaFileID, nMediaID, sPPVModuleCode, sCouponCode, sUserIP, sPaymentMethodID, bDummy.ToString().ToLower()));
                if (!bDummy && string.IsNullOrEmpty(sPPVModuleCode))
                {
                    oResponse.m_oStatus = BillingResponseStatus.Fail;
                    oResponse.m_sRecieptCode = string.Empty;
                    oResponse.m_sStatusDescription = "Charge must have ppv module code";
                    WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                    return oResponse;
                }

                long lSiteGuid = 0;
                if (sSiteGUID.Length == 0 || !Int64.TryParse(sSiteGUID, out lSiteGuid) || lSiteGuid == 0)
                {
                    oResponse.m_oStatus = BillingResponseStatus.UnKnownUser;
                    oResponse.m_sRecieptCode = string.Empty;
                    oResponse.m_sStatusDescription = "Cant charge an unknown user";
                    return oResponse;
                }
                else
                {
                    wsUsersService = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = wsUsersService.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        oResponse.m_oStatus = BillingResponseStatus.UnKnownUser;
                        oResponse.m_sRecieptCode = string.Empty;
                        oResponse.m_sStatusDescription = "Cant charge an unknown user";
                        return oResponse;
                    }
                    else if (uObj != null && uObj.m_user != null && uObj.m_user.m_eSuspendState == DomainSuspentionStatus.Suspended)
                    {
                        oResponse.m_oStatus = BillingResponseStatus.UserSuspended;
                        oResponse.m_sRecieptCode = string.Empty;
                        oResponse.m_sStatusDescription = "Cannot charge a suspended user";
                        WriteToUserLog(sSiteGUID, "while trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                        return oResponse;
                    }
                    else
                    {
                        bool bIsCouponValid = false;
                        bIsCouponValid = Utils.IsCouponValid(m_nGroupID, sCouponCode);
                        if (!string.IsNullOrEmpty(sCouponCode) && !bIsCouponValid)
                        {
                            oResponse.m_oStatus = BillingResponseStatus.Fail;
                            oResponse.m_sRecieptCode = string.Empty;
                            oResponse.m_sStatusDescription = "Coupon not valid";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                            return oResponse;
                        }

                        sWSUserName = string.Empty;
                        sWSPass = string.Empty;

                        wsPricingService = new mdoule();
                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        if (!bDummy && string.IsNullOrEmpty(sPPVModuleCode))
                        {
                            oResponse.m_oStatus = BillingResponseStatus.Fail;
                            oResponse.m_sRecieptCode = string.Empty;
                            oResponse.m_sStatusDescription = "Charge must have ppv module code";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                            return oResponse;
                        }

                        // chack if ppvModule related to mediaFile 
                        long ppvModuleCode = 0;
                        long.TryParse(sPPVModuleCode, out ppvModuleCode);

                        PPVModule thePPVModule = wsPricingService.ValidatePPVModuleForMediaFile(sWSUserName, sWSPass, nMediaFileID, ppvModuleCode);

                        if (thePPVModule == null)
                        {
                            oResponse.m_oStatus = BillingResponseStatus.Fail;
                            oResponse.m_sRecieptCode = string.Empty;
                            oResponse.m_sStatusDescription = "The ppv module is unknown";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                            return oResponse;
                        }

                        if (!bDummy && !thePPVModule.m_sObjectCode.Equals(sPPVModuleCode))
                        {
                            oResponse.m_oStatus = BillingResponseStatus.UnKnownPPVModule;
                            oResponse.m_sRecieptCode = string.Empty;
                            oResponse.m_sStatusDescription = "This PPVModule does not belong to item";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                            return oResponse;
                        }

                        if (bDummy)
                        {
                            sPPVModuleCode = thePPVModule.m_sObjectCode;
                            dPrice = thePPVModule.m_oPriceCode.m_oPrise.m_dPrice;
                            sCurrency = thePPVModule.m_oPriceCode.m_oPrise.m_oCurrency.m_sCurrencyCD3;
                            if (!IsTakePriceFromMediaFileFinalPrice(bDummy))
                            { // Cinepolis patch
                                dPrice = 0d;
                            }
                        }

                        PriceReason ePriceReason = PriceReason.UnKnown;

                        Subscription relevantSub = null;
                        Collection relevantCol = null;
                        PrePaidModule relevantPP = null;

                        Price oPrice = Utils.GetMediaFileFinalPriceForNonGetItemsPrices(nMediaFileID, thePPVModule, sSiteGUID, sCouponCode, m_nGroupID, ref ePriceReason, ref relevantSub, ref relevantCol, ref relevantPP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        bDummy = RecalculateDummyIndicatorForChargeMediaFile(bDummy, ePriceReason, bIsCouponValid);
                        if ((ePriceReason == PriceReason.ForPurchase || (ePriceReason == PriceReason.SubscriptionPurchased && oPrice.m_dPrice > 0) || bDummy) && ePriceReason != PriceReason.NotForPurchase)
                        {
                            if (bDummy || (oPrice.m_dPrice == dPrice && oPrice.m_oCurrency.m_sCurrencyCD3 == sCurrency))
                            {
                                string sCustomData = string.Empty;
                                sWSUserName = string.Empty;
                                sWSPass = string.Empty;

                                InitializeBillingModule(ref wsBillingService, ref sWSUserName, ref sWSPass);
                                if (string.IsNullOrEmpty(sCountryCd) && !string.IsNullOrEmpty(sUserIP))
                                {
                                    sCountryCd = Utils.GetIP2CountryName(m_nGroupID, sUserIP);
                                }
                                //Create the Custom Data
                                sCustomData = GetCustomData(relevantSub, thePPVModule, null, sSiteGUID, dPrice, sCurrency,
                                    nMediaFileID, nMediaID, sPPVModuleCode, string.Empty, sCouponCode, sUserIP,
                                    sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                                log.Debug("CustomData - " + sCustomData);


                                oResponse = HandleCCChargeUser(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sUserIP, sCustomData,
                                    1, 1, sExtraParameters, sPaymentMethodID, sEncryptedCVV, bDummy, false, ref wsBillingService);
                                if (oResponse.m_oStatus == BillingResponseStatus.Success)
                                {
                                    long lBillingTransactionID = 0;
                                    long lPurchaseID = 0;
                                    HandleChargeUserForMediaFileBillingSuccess(sWSUserName, sWSPass, sSiteGUID, uObj.m_user.m_domianID, relevantSub, dPrice, sCurrency,
                                        sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, oResponse, sCustomData,
                                        thePPVModule, nMediaFileID, ref lBillingTransactionID, ref lPurchaseID, bDummy, ref wsBillingService);

                                    // Enqueue notification for PS so they know a media file was charged
                                    var dicData = new Dictionary<string, object>()
                                            {
                                                {"MediaFileID", nMediaFileID},
                                                {"BillingTransactionID", lBillingTransactionID},
                                                {"PPVModuleCode", sPPVModuleCode},
                                                {"SiteGUID", sSiteGUID},
                                                {"CouponCode", sCouponCode},
                                                {"CustomData", sCustomData},
                                                {"PurchaseID", lPurchaseID}
                                            };

                                    this.EnqueueEventRecord(NotifiedAction.ChargedMediaFile, dicData);
                                }
                                else
                                {
                                    WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                                }
                            }
                            else
                            {
                                oResponse.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                oResponse.m_sRecieptCode = string.Empty;
                                oResponse.m_sStatusDescription = "The price of the request is not the actual price";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                            }
                        }
                        else
                        {
                            if (ePriceReason == PriceReason.PPVPurchased)
                            {
                                oResponse.m_oStatus = BillingResponseStatus.Fail;
                                oResponse.m_sRecieptCode = string.Empty;
                                oResponse.m_sStatusDescription = "The media file is already purchased";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                            }
                            else if (ePriceReason == PriceReason.Free)
                            {
                                oResponse.m_oStatus = BillingResponseStatus.Fail;
                                oResponse.m_sRecieptCode = string.Empty;
                                oResponse.m_sStatusDescription = "The media file is free";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                            }
                            else if (ePriceReason == PriceReason.ForPurchaseSubscriptionOnly)
                            {
                                oResponse.m_oStatus = BillingResponseStatus.Fail;
                                oResponse.m_sRecieptCode = string.Empty;
                                oResponse.m_sStatusDescription = "The media file is for purchase with subscription only";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                            }
                            else if (ePriceReason == PriceReason.SubscriptionPurchased)
                            {
                                oResponse.m_oStatus = BillingResponseStatus.Fail;
                                oResponse.m_sRecieptCode = string.Empty;
                                oResponse.m_sStatusDescription = "The media file is already purchased (subscription)";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                            }
                            else if (ePriceReason == PriceReason.NotForPurchase)
                            {
                                oResponse.m_oStatus = BillingResponseStatus.Fail;
                                oResponse.m_sRecieptCode = string.Empty;
                                oResponse.m_sStatusDescription = "The media file is not valid for purchased";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + oResponse.m_sStatusDescription);
                            }

                        }

                        if (oResponse.m_oStatus == BillingResponseStatus.Success)
                        {
                            string invalidationKey = LayeredCacheKeys.GetPurchaseInvalidationKey(uObj.m_user.m_domianID);
                            if (!LayeredCache.Instance.SetInvalidationKey(invalidationKey))
                            {
                                log.ErrorFormat("Failed to set invalidation key on CC_BaseChargeUserForMediaFile key = {0}", invalidationKey);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at CC_BaseChargeUserForMediaFile. ");
                sb.Append(String.Concat("Exception msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Media File ID: ", nMediaFileID));
                sb.Append(String.Concat(" Media ID: ", nMediaID));
                sb.Append(String.Concat(" Coupon Code: ", sCouponCode));
                sb.Append(String.Concat(" User IP: ", sUserIP));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Stack trace: ", ex.StackTrace));
                log.Debug("CC_BaseChargeUserForMediaFile - " + sb.ToString(), ex);
                WriteToUserLog(sSiteGUID, string.Format("Exception at CC_BaseChargeUserForMediaFile. Media File ID: {0} , Media ID: {1} , Coupon Code: {2}", nMediaFileID, nMediaID, sCouponCode));
                #endregion
            }
            finally
            {
                #region Disposing
                if (wsUsersService != null)
                {
                    wsUsersService.Dispose();
                }
                if (wsPricingService != null)
                {
                    wsPricingService.Dispose();
                }
                if (wsBillingService != null)
                {
                    wsBillingService.Dispose();
                }
                #endregion
            }
            return oResponse;
        }


        /// <summary>
        /// InApp Charge User For Media File
        /// </summary>
        public virtual BillingResponse CC_ChargeUserForMediaFile(string sSiteGUID, double dPrice, string sCurrency, Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sUserIP, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sRecieptCode)
        {
            return InApp_BaseChargeUserForMediaFile(sSiteGUID, dPrice, sCurrency, nMediaFileID, nMediaID, sPPVModuleCode, sCouponCode, sUserIP, sExtraParameters, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, sRecieptCode);
        }
        /// <summary>
        /// Get PPV CustomData ID
        /// </summary>


        public virtual int GetPPVCustomDataID(string sSiteGUID, double dPrice, string sCurrency,
            Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sCampaignCode, string sPaymentMethod, string sUserIP,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            return GetPPVCustomDataID(sSiteGUID, dPrice, sCurrency,
            nMediaFileID, nMediaID, sPPVModuleCode, sCouponCode, sCampaignCode, sPaymentMethod, sUserIP,
            sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty);
        }

        public virtual int GetPPVCustomDataID(string sSiteGUID, double dPrice, string sCurrency,
            Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sCampaignCode, string sPaymentMethod, string sUserIP,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sOverrideEndDate)
        {
            int retVal = 0;
            UsersService u = null;
            mdoule m = null;

            try
            {
                log.Debug("GetPPVCustomDataID - " + GetGetCustomDataLogMsg("PPV", sSiteGUID, dPrice, nMediaFileID, nMediaID, sPPVModuleCode, sCouponCode, sPaymentMethod, sUserIP, string.Empty));
                u = new UsersService();

                string sWSUserName = string.Empty;
                string sWSPass = string.Empty;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                if (uObj.m_RespStatus != ResponseStatus.OK)
                {
                    retVal = 0;
                }
                else
                {
                    sWSUserName = string.Empty;
                    sWSPass = string.Empty;

                    m = new mdoule();
                    Int32[] nMediaFiles = { nMediaFileID };
                    MediaFilePPVModule[] oModules = null;

                    Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                    oModules = m.GetPPVModuleListForMediaFiles(sWSUserName, sWSPass, nMediaFiles, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                    Int32 nCount = 0;
                    if (oModules[0].m_oPPVModules != null)
                        nCount = oModules[0].m_oPPVModules.Length;
                    bool bOK = false;
                    for (int i = 0; i < nCount; i++)
                    {
                        if (oModules[0].m_oPPVModules[i].m_sObjectCode == sPPVModuleCode)
                            bOK = true;
                    }
                    if (bOK == false)
                    {
                        retVal = 0;
                    }
                    else
                    {
                        PriceReason theReason = PriceReason.UnKnown;
                        Subscription relevantSub = null;
                        Collection relevantCol = null;
                        PrePaidModule relevantPP = null;
                        Campaign relevantCamp = null;
                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        PPVModule thePPVModule = m.GetPPVModuleData(sWSUserName, sWSPass, sPPVModuleCode, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        if (!string.IsNullOrEmpty(sCampaignCode))
                        {
                            int nCampaignCode = int.Parse(sCampaignCode);
                            relevantCamp = m.GetCampaignData(sWSUserName, sWSPass, nCampaignCode);
                        }
                        if (thePPVModule != null)
                        {
                            Price p = Utils.GetMediaFileFinalPriceForNonGetItemsPrices(nMediaFileID, thePPVModule, sSiteGUID, sCouponCode, m_nGroupID, ref theReason, ref relevantSub, ref relevantCol, ref relevantPP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                            if (theReason == PriceReason.ForPurchase || (theReason == PriceReason.SubscriptionPurchased && p.m_dPrice > 0))
                            {
                                if (p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency && p.m_dPrice > 0)
                                {
                                    string sCustomData = GetCustomData(relevantSub, thePPVModule, relevantCamp, sSiteGUID, dPrice, sCurrency, nMediaFileID, nMediaID, sPPVModuleCode, sCampaignCode, sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, sOverrideEndDate);
                                    retVal = Utils.AddCustomData(sCustomData);
                                }
                            }
                        }
                    }
                } // end big else
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder(String.Concat("Exception. Msg: ", ex.Message));
                sb.Append(String.Concat(" ,Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" ,Price: ", dPrice));
                sb.Append(String.Concat(" ,Currency: ", sCurrency));
                sb.Append(String.Concat(" ,Media file ID: ", nMediaFileID));
                sb.Append(String.Concat(" ,Media ID: ", nMediaID));
                sb.Append(String.Concat(" ,PPV Module code: ", sPPVModuleCode));
                sb.Append(String.Concat(" ,Coupon code: ", sCouponCode));
                sb.Append(String.Concat(" ,Campaign code: ", sCampaignCode));
                sb.Append(String.Concat(" ,Payment method: ", sPaymentMethod));
                sb.Append(String.Concat(" ,Country code: ", sCountryCd));
                sb.Append(String.Concat(" ,User IP: ", sUserIP));
                sb.Append(String.Concat(" ,Language code: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" ,Device name: ", sDEVICE_NAME));
                sb.Append(String.Concat(" ,Override end date: ", sOverrideEndDate));
                sb.Append(String.Concat(" ,BaseConditionalAccess is: ", this.GetType().Name));
                sb.Append(String.Concat(" ,Stack trace: ", ex.StackTrace));
                log.Debug("GetPPVCustomDataID - " + sb.ToString());
                #endregion
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                    u = null;
                }
                if (m != null)
                {
                    m.Dispose();
                    m = null;
                }
                #endregion
            }

            return retVal;
        }

        protected string GetGetCustomDataLogMsg(string sBusinessModuleName, string sSiteGUID, double dPrice, Int32 nMediaFileID,
            Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sPaymentMethod, string sUserIP, string sPreviewModuleID)
        {
            StringBuilder sb = new StringBuilder(string.Format("Entering GetCustomData{0} try block: ", sBusinessModuleName));
            sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
            sb.Append(String.Concat(" Price: ", dPrice));
            sb.Append(String.Concat(" Media File ID: ", nMediaFileID));
            sb.Append(String.Concat(" Media ID: ", nMediaID));
            sb.Append(String.Concat(" PPV Module Code: ", sPPVModuleCode));
            sb.Append(String.Concat(" Coupon Code: ", sCouponCode));
            sb.Append(String.Concat(" Payment Method: ", sPaymentMethod));
            sb.Append(String.Concat(" User IP: ", sUserIP));
            sb.Append(String.Concat(" Preview Module ID: ", sPreviewModuleID));
            sb.Append(String.Concat(" BaseConditionalAccess is:", this.GetType().Name));
            return sb.ToString();
        }
        /// <summary>
        /// Get PrePaid Custom DataID
        /// </summary>
        public virtual int GetPrePaidCustomDataID(string sSiteGUID, double dPrice,
            string sCurrency, string sPrePaidCode, string sCouponCode, string sPaymentMethod, string sUserIP,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            return GetPrePaidCustomDataID(sSiteGUID, dPrice,
            sCurrency, sPrePaidCode, sCouponCode, sPaymentMethod, sUserIP,
            sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty);
        }

        public virtual int GetPrePaidCustomDataID(string sSiteGUID, double dPrice,
            string sCurrency, string sPrePaidCode, string sCouponCode, string sPaymentMethod, string sUserIP,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sOverrideEnddate)
        {
            int retVal = 0;
            UsersService u = null;
            try
            {
                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    retVal = 0;
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        retVal = 0;
                    }
                    else
                    {
                        PriceReason theReason = PriceReason.UnKnown;
                        PrePaidModule thePrePaid = null;
                        Price p = Utils.GetPrePaidFinalPrice(m_nGroupID, sPrePaidCode, sSiteGUID, ref theReason, ref thePrePaid, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, "pricing_connection", sCouponCode);
                        if (theReason == PriceReason.ForPurchase)
                        {
                            if (p != null && p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency)
                            {
                                if (p.m_dPrice != 0)
                                {
                                    string sCustomData = GetCustomDataForPrePaid(thePrePaid, null, sPrePaidCode, string.Empty, sSiteGUID, dPrice, sCurrency, sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, sOverrideEnddate);


                                    retVal = Utils.AddCustomData(sCustomData);
                                }
                            }
                            else
                            {
                                retVal = 0;
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.Free)
                            {
                                retVal = 0;
                            }
                            if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                retVal = 0;
                            }
                        }
                    }
                } // end else
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at GetPrePaidCustomDataID. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" Currency: ", sCurrency));
                sb.Append(String.Concat(" PP Cd: ", sPrePaidCode));
                sb.Append(String.Concat(" Cpn Cd: ", sCouponCode));
                sb.Append(String.Concat(" PM: ", sPaymentMethod));
                sb.Append(String.Concat(" User IP: ", sUserIP));
                sb.Append(String.Concat(" Cntry Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Cd: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" D Nm: ", sDEVICE_NAME));
                sb.Append(String.Concat(" Override ED: ", sOverrideEnddate));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                if (u != null)
                {
                    u.Dispose();
                }
            }
            return retVal;
        }
        /// <summary>
        /// Get Subscription Custom Data ID
        /// </summary>
        public virtual int GetSubscriptionCustomDataID(string sSiteGUID, double dPrice,
    string sCurrency, string sSubscriptionCode, string sCampaignCode, string sCouponCode, string sPaymentMethod, string sUserIP,
    string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            return GetBundleCustomDataID(sSiteGUID, dPrice,
            sCurrency, sSubscriptionCode, sCampaignCode, sCouponCode, sPaymentMethod, sUserIP,
            sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty, string.Empty, eBundleType.SUBSCRIPTION);
        }

        /// <summary>
        /// Get Subscription Custom Data ID
        /// </summary>
        public virtual int GetCollectionCustomDataID(string sSiteGUID, double dPrice,
    string sCurrency, string sSubscriptionCode, string sCampaignCode, string sCouponCode, string sPaymentMethod, string sUserIP,
    string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            return GetBundleCustomDataID(sSiteGUID, dPrice,
            sCurrency, sSubscriptionCode, sCampaignCode, sCouponCode, sPaymentMethod, sUserIP,
            sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty, string.Empty, eBundleType.COLLECTION);
        }

        public virtual int GetBundleCustomDataID(string sSiteGUID, double dPrice,
            string sCurrency, string sBundleCode, string sCampaignCode, string sCouponCode, string sPaymentMethod, string sUserIP,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sOverrideEnddate, string sPreviewModuleID, eBundleType bundleType)
        {
            int retVal = 0;
            long lSiteGuid = 0;
            if (sSiteGUID.Length == 0 || !Int64.TryParse(sSiteGUID, out lSiteGuid) || lSiteGuid == 0)
            {
                retVal = 0;
            }
            else
            {
                UsersService u = null;
                mdoule m = null;
                try
                {
                    log.Debug("GetBundleCustomDataID - " + GetGetCustomDataLogMsg("Bundle", sSiteGUID, dPrice, 0, 0, sBundleCode, sCouponCode, sPaymentMethod, sUserIP, sPreviewModuleID));
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        retVal = 0;
                    }
                    else
                    {

                        PriceReason theReason = PriceReason.UnKnown;
                        PPVModule theBundle = null;
                        Campaign relevantCamp = null;
                        Price price = null;

                        switch (bundleType)
                        {
                            case eBundleType.SUBSCRIPTION:
                                {
                                    Subscription theSub = null;
                                    price = Utils.GetSubscriptionFinalPrice(m_nGroupID, sBundleCode, sSiteGUID, sCouponCode, ref theReason, ref theSub, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                                    theBundle = theSub;
                                    break;
                                }
                            case eBundleType.COLLECTION:
                                {
                                    Collection theCol = null;
                                    price = Utils.GetCollectionFinalPrice(m_nGroupID, sBundleCode, sSiteGUID, sCouponCode, ref theReason, ref theCol, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, "");
                                    theBundle = theCol;
                                    break;
                                }
                        }


                        if (theReason == PriceReason.ForPurchase || theReason == PriceReason.EntitledToPreviewModule)
                        {
                            if (price != null && price.m_dPrice == dPrice && price.m_oCurrency.m_sCurrencyCD3 == sCurrency)
                            {
                                if (price.m_dPrice != 0 || (theReason == PriceReason.EntitledToPreviewModule && IsPreviewModuleInGroupIDCostsZero()))
                                {

                                    sWSUserName = string.Empty;
                                    sWSPass = string.Empty;

                                    m = new mdoule();
                                    Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);

                                    if (!string.IsNullOrEmpty(sCampaignCode))
                                    {
                                        int nCampaignCode = int.Parse(sCampaignCode);
                                        relevantCamp = m.GetCampaignData(sWSUserName, sWSPass, nCampaignCode);
                                    }

                                    string sCustomData = string.Empty;

                                    switch (bundleType)
                                    {
                                        case eBundleType.SUBSCRIPTION:
                                            {
                                                sCustomData = GetCustomDataForSubscription(theBundle as Subscription, relevantCamp, sBundleCode, sCampaignCode, sSiteGUID, dPrice, sCurrency, sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, sOverrideEnddate, sPreviewModuleID, theReason == PriceReason.EntitledToPreviewModule);
                                                break;
                                            }
                                        case eBundleType.COLLECTION:
                                            {
                                                sCustomData = GetCustomDataForCollection(theBundle as Collection, sBundleCode, sSiteGUID, dPrice, sCurrency, sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, sOverrideEnddate);
                                                break;
                                            }
                                    }
                                    retVal = Utils.AddCustomData(sCustomData);
                                }
                            }
                            else
                            {
                                retVal = 0;
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.Free)
                            {
                                retVal = 0;
                            }
                            if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                retVal = 0;
                            }
                            if (theReason == PriceReason.CollectionPurchased)
                            {
                                retVal = 0;
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    #region Logging
                    StringBuilder sb = new StringBuilder(String.Concat("Exception msg: ", ex.Message));
                    sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                    sb.Append(String.Concat(" Price: ", dPrice));
                    sb.Append(String.Concat(" Currency: ", sCurrency));
                    sb.Append(String.Concat(" Bundle Code: ", sBundleCode));
                    sb.Append(String.Concat(" Campaign Code: ", sCampaignCode));
                    sb.Append(String.Concat(" Coupon Code: ", sCouponCode));
                    sb.Append(String.Concat(" Payment Method: ", sPaymentMethod));
                    sb.Append(String.Concat(" User IP: ", sUserIP));
                    sb.Append(String.Concat(" Country Code: ", sCountryCd));
                    sb.Append(String.Concat(" Language Code: ", sLANGUAGE_CODE));
                    sb.Append(String.Concat(" Device Name: ", sDEVICE_NAME));
                    sb.Append(String.Concat(" Override End Date: ", sOverrideEnddate));
                    sb.Append(String.Concat(" Preview Module ID: ", sPreviewModuleID));
                    sb.Append(String.Concat(" BaseConditionalAccess is: ", this.GetType().ToString()));
                    sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));
                    log.Debug("GetBundleCustomDataID - " + sb.ToString());
                    #endregion
                    retVal = 0;

                }
                finally
                {
                    #region Disposing
                    if (u != null)
                    {
                        u.Dispose();
                        u = null;
                    }
                    if (m != null)
                    {
                        m.Dispose();
                        m = null;
                    }
                    #endregion
                }
            }
            return retVal;
        }

        /// <summary>
        /// PU Get PPV Popup Payment Method URL
        /// </summary>
        public virtual BillingResponse PU_GetPPVPopupPaymentMethodURL(string sSiteGUID, double dPrice, string sCurrency,
            Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sPaymentMethod, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            BillingResponse ret = new BillingResponse();
            ret.m_oStatus = BillingResponseStatus.UnKnown;
            ret.m_sRecieptCode = string.Empty;
            ret.m_sStatusDescription = string.Empty;
            UsersService u = null;
            mdoule m = null;
            module bm = null;
            try
            {
                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_sRecieptCode = string.Empty;
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);

                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                    }
                    else
                    {

                        sWSUserName = string.Empty;
                        sWSPass = string.Empty;

                        m = new mdoule();

                        Int32[] nMediaFiles = { nMediaFileID };
                        MediaFilePPVModule[] oModules = null;

                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        oModules = m.GetPPVModuleListForMediaFiles(sWSUserName, sWSPass, nMediaFiles, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        Int32 nCount = 0;
                        if (oModules[0].m_oPPVModules != null)
                            nCount = oModules[0].m_oPPVModules.Length;
                        bool bOK = false;
                        for (int i = 0; i < nCount; i++)
                        {
                            if (oModules[0].m_oPPVModules[i].m_sObjectCode == sPPVModuleCode)
                                bOK = true;
                        }
                        if (!bOK)
                        {
                            ret.m_oStatus = BillingResponseStatus.UnKnownPPVModule;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "This PPVModule does not belong to item";
                        }
                        else
                        {
                            PriceReason theReason = PriceReason.UnKnown;
                            Subscription relevantSub = null;
                            Collection relevantCol = null;
                            PrePaidModule relevantPP = null;

                            Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                            PPVModule thePPVModule = m.GetPPVModuleData(sWSUserName, sWSPass, sPPVModuleCode, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                            if (thePPVModule != null)
                            {
                                Price p = Utils.GetMediaFileFinalPriceForNonGetItemsPrices(nMediaFileID, thePPVModule, sSiteGUID, sCouponCode, m_nGroupID, ref theReason, ref relevantSub, ref relevantCol, ref relevantPP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                                if (theReason == PriceReason.ForPurchase || (theReason == PriceReason.SubscriptionPurchased && p.m_dPrice > 0))
                                {
                                    if (p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency)
                                    {
                                        if (p.m_dPrice != 0)
                                        {
                                            bm = new module();
                                            sWSUserName = string.Empty;
                                            sWSPass = string.Empty;
                                            Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);
                                            string sCustomData = "<customdata type=\"pp\">";
                                            if (String.IsNullOrEmpty(sCountryCd) == false)
                                                sCustomData += "<lcc>" + sCountryCd + "</lcc>";
                                            if (String.IsNullOrEmpty(sLANGUAGE_CODE) == false)
                                                sCustomData += "<llc>" + sLANGUAGE_CODE + "</llc>";
                                            if (String.IsNullOrEmpty(sDEVICE_NAME) == false)
                                                sCustomData += "<ldn>" + sDEVICE_NAME + "</ldn>";
                                            sCustomData += "<rs>";
                                            if (relevantSub != null)
                                                sCustomData += relevantSub.m_sObjectCode;
                                            sCustomData += "</rs>";
                                            sCustomData += "<mnou>";
                                            if (thePPVModule != null && thePPVModule.m_oUsageModule != null)
                                                sCustomData += thePPVModule.m_oUsageModule.m_nMaxNumberOfViews.ToString();
                                            sCustomData += "</mnou>";
                                            sCustomData += "<mumlc>";
                                            if (thePPVModule != null && thePPVModule.m_oUsageModule != null)
                                                sCustomData += thePPVModule.m_oUsageModule.m_tsMaxUsageModuleLifeCycle.ToString();
                                            sCustomData += "</mumlc>";
                                            sCustomData += "<u id=\"" + sSiteGUID + "\"/>";
                                            sCustomData += "<mf>";
                                            sCustomData += nMediaFileID.ToString();
                                            sCustomData += "</mf>";
                                            sCustomData += "<m>";
                                            sCustomData += nMediaID.ToString();
                                            sCustomData += "</m>";
                                            sCustomData += "<ppvm>";
                                            sCustomData += sPPVModuleCode;
                                            sCustomData += "</ppvm>";
                                            sCustomData += "<cc>";
                                            sCustomData += sCouponCode;
                                            sCustomData += "</cc>";
                                            sCustomData += "<p ir=\"false\" n=\"1\" o=\"1\"/>";
                                            sCustomData += "<pc>";
                                            if (thePPVModule != null && thePPVModule.m_oPriceCode != null)
                                                sCustomData += thePPVModule.m_oPriceCode.m_sCode;
                                            sCustomData += "</pc>";
                                            sCustomData += "<pri>";
                                            sCustomData += dPrice.ToString();
                                            sCustomData += "</pri>";
                                            sCustomData += "<cu>";
                                            sCustomData += sCurrency;
                                            sCustomData += "</cu>";
                                            sCustomData += "</customdata>";
                                            string sExtraParams = "email=";
                                            if (uObj.m_user.m_oBasicData.m_sEmail != "")
                                                sExtraParams += uObj.m_user.m_oBasicData.m_sEmail;
                                            else
                                                sExtraParams += "empty@empty.com";
                                            sExtraParams += "&address1=";
                                            if (uObj.m_user.m_oBasicData.m_sAddress != "")
                                                sExtraParams += uObj.m_user.m_oBasicData.m_sAddress;
                                            else
                                                sExtraParams += "Empty address";
                                            sExtraParams += "&city=";
                                            if (uObj.m_user.m_oBasicData.m_sCity != "")
                                                sExtraParams += uObj.m_user.m_oBasicData.m_sCity;
                                            else
                                                sExtraParams += "Empty city";
                                            sExtraParams += "&country=";
                                            if (uObj.m_user.m_oBasicData.m_Country != null && uObj.m_user.m_oBasicData.m_Country.m_sCountryName != "")
                                                //sExtraParams += uObj.m_user.m_oBasicData.m_Country.m_sCountryName;
                                                sExtraParams += uObj.m_user.m_oBasicData.m_Country.m_sCountryCode;
                                            else
                                                sExtraParams += "Empty country";
                                            sExtraParams += "&phone1=";
                                            if (uObj.m_user.m_oBasicData.m_sPhone != "")
                                                sExtraParams += uObj.m_user.m_oBasicData.m_sPhone;
                                            else
                                                sExtraParams += "0000000";
                                            if (!sExtraParameters.StartsWith("&"))
                                                sExtraParameters = "&" + sExtraParameters;
                                            sExtraParams += sExtraParameters;

                                            //customdata id
                                            ret.m_sRecieptCode = bm.CC_GetPopupURL(sWSUserName, sWSPass, dPrice, sCurrency, "PPV Item", sCustomData, sPaymentMethod, sExtraParams);
                                            ret.m_oStatus = BillingResponseStatus.Success;
                                            ret.m_sStatusDescription = "PopUp URL";
                                        }
                                    }
                                    else
                                    {
                                        ret.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                        ret.m_sRecieptCode = string.Empty;
                                        ret.m_sStatusDescription = "The price of the request is not the actual price";
                                    }
                                }
                                else
                                {
                                    if (theReason == PriceReason.PPVPurchased)
                                    {
                                        ret.m_oStatus = BillingResponseStatus.Fail;
                                        ret.m_sRecieptCode = "";
                                        ret.m_sStatusDescription = "The media file is already purchased";
                                    }
                                    else if (theReason == PriceReason.Free)
                                    {
                                        ret.m_oStatus = BillingResponseStatus.Fail;
                                        ret.m_sRecieptCode = "";
                                        ret.m_sStatusDescription = "The media file is free";
                                    }
                                    else if (theReason == PriceReason.ForPurchaseSubscriptionOnly)
                                    {
                                        ret.m_oStatus = BillingResponseStatus.Fail;
                                        ret.m_sRecieptCode = "";
                                        ret.m_sStatusDescription = "The media file is for purchase with subscription only";
                                    }
                                    else if (theReason == PriceReason.SubscriptionPurchased)
                                    {
                                        ret.m_oStatus = BillingResponseStatus.Fail;
                                        ret.m_sRecieptCode = "";
                                        ret.m_sStatusDescription = "The media file is already purchased (subscription)";
                                    }
                                }
                            }
                            else
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The ppv module is unknown";
                            }
                        }
                    } // end inner else
                } // end else
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at PU_GetPPVPopupPaymentMethodURL. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" MF ID: ", nMediaFileID));
                sb.Append(String.Concat(" M ID: ", nMediaID));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + ex.StackTrace, ex);
                #endregion
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
                if (m != null)
                {
                    m.Dispose();
                }
                #endregion
            }
            return ret;
        }
        /// <summary>
        /// PU Get Subscription Popup Payment Method URL
        /// </summary>
        public virtual BillingResponse PU_GetSubscriptionPopupPaymentMethodURL(string sSiteGUID, double dPrice,
            string sCurrency, string sSubscriptionCode, string sCouponCode, string sPaymentMethod, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            BillingResponse ret = new BillingResponse();
            if (sSiteGUID == "")
            {
                ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                ret.m_sRecieptCode = "";
                ret.m_sStatusDescription = "Cant charge an unknown user";
            }
            else
            {
                using (UsersService u = new UsersService())
                {

                    string sWSUserName = "";
                    string sWSPass = "";
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = "";
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                    }
                    else
                    {
                        PriceReason theReason = PriceReason.UnKnown;
                        Subscription theSub = null;
                        Price p = Utils.GetSubscriptionFinalPrice(m_nGroupID, sSubscriptionCode, sSiteGUID, sCouponCode, ref theReason, ref theSub, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        if (theReason == PriceReason.ForPurchase)
                        {
                            if (p != null && p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency)
                            {
                                if (p.m_dPrice != 0)
                                {
                                    using (module bm = new module())
                                    {
                                        sWSUserName = "";
                                        sWSPass = "";
                                        Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUserName, ref sWSPass);

                                        bool bIsRecurring = theSub.m_bIsRecurring;
                                        Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;

                                        string sCustomData = "<customdata type=\"sp\">";
                                        if (String.IsNullOrEmpty(sCountryCd) == false)
                                            sCustomData += "<lcc>" + sCountryCd + "</lcc>";
                                        if (String.IsNullOrEmpty(sLANGUAGE_CODE) == false)
                                            sCustomData += "<llc>" + sLANGUAGE_CODE + "</llc>";
                                        if (String.IsNullOrEmpty(sDEVICE_NAME) == false)
                                            sCustomData += "<ldn>" + sDEVICE_NAME + "</ldn>";
                                        sCustomData += "<mnou>";
                                        if (theSub != null && theSub.m_oUsageModule != null)
                                            sCustomData += theSub.m_oUsageModule.m_nMaxNumberOfViews.ToString();
                                        sCustomData += "</mnou>";
                                        sCustomData += "<u id=\"" + sSiteGUID + "\"/>";
                                        sCustomData += "<s>" + sSubscriptionCode + "</s>";
                                        sCustomData += "<cc>" + sCouponCode + "</cc>";
                                        sCustomData += "<p ir=\"" + bIsRecurring.ToString().ToLower() + "\" n=\"1\" o=\"" + nRecPeriods.ToString() + "\"/>";
                                        sCustomData += "<vlcs>";
                                        if (theSub != null && theSub.m_oUsageModule != null)
                                            sCustomData += theSub.m_oUsageModule.m_tsViewLifeCycle.ToString();
                                        sCustomData += "</vlcs>";
                                        sCustomData += "<mumlc>";
                                        if (theSub != null && theSub.m_oSubscriptionUsageModule != null)
                                            sCustomData += theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle.ToString();
                                        sCustomData += "</mumlc>";
                                        sCustomData += "<ppvm>";
                                        sCustomData += "";
                                        sCustomData += "</ppvm>";
                                        sCustomData += "<pc>";
                                        if (theSub != null && theSub.m_oSubscriptionPriceCode != null)
                                            sCustomData += theSub.m_oSubscriptionPriceCode.m_sCode;
                                        sCustomData += "</pc>";
                                        sCustomData += "<pri>";
                                        sCustomData += dPrice.ToString();
                                        sCustomData += "</pri>";
                                        sCustomData += "<cu>";
                                        sCustomData += sCurrency;
                                        sCustomData += "</cu>";

                                        sCustomData += "</customdata>";
                                        string sExtraParams = "email=";
                                        if (uObj.m_user.m_oBasicData.m_sEmail != "")
                                            sExtraParams += uObj.m_user.m_oBasicData.m_sEmail;
                                        else
                                            sExtraParams += "empty@empty.com";
                                        sExtraParams += "&address1=";
                                        if (uObj.m_user.m_oBasicData.m_sAddress != "")
                                            sExtraParams += uObj.m_user.m_oBasicData.m_sAddress;
                                        else
                                            sExtraParams += "Empty address";
                                        sExtraParams += "&city=";
                                        if (uObj.m_user.m_oBasicData.m_sCity != "")
                                            sExtraParams += uObj.m_user.m_oBasicData.m_sCity;
                                        else
                                            sExtraParams += "Empty city";
                                        sExtraParams += "&country=";
                                        if (uObj.m_user.m_oBasicData.m_Country != null && uObj.m_user.m_oBasicData.m_Country.m_sCountryName != "")
                                            //sExtraParams += uObj.m_user.m_oBasicData.m_Country.m_sCountryName;
                                            sExtraParams += uObj.m_user.m_oBasicData.m_Country.m_sCountryCode;
                                        else
                                            sExtraParams += "Empty country";
                                        sExtraParams += "&phone1=";
                                        if (uObj.m_user.m_oBasicData.m_sPhone != "")
                                            sExtraParams += uObj.m_user.m_oBasicData.m_sPhone;
                                        else
                                            sExtraParams += "0000000";
                                        if (sExtraParameters.StartsWith("&") == false)
                                            sExtraParameters = "&" + sExtraParameters;
                                        sExtraParams += sExtraParameters;
                                        ret.m_sRecieptCode = bm.CC_GetPopupURL(sWSUserName, sWSPass, dPrice, sCurrency, "Subscription", sCustomData, sPaymentMethod, sExtraParams);
                                        ret.m_oStatus = BillingResponseStatus.Success;
                                        ret.m_sStatusDescription = "PopUp URL";
                                    }
                                } // end if price is not zero
                            }
                            else
                            {
                                ret.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The price of the request is not the actual price";
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.Free)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The subscription is free";
                            }
                            if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = "";
                                ret.m_sStatusDescription = "The subscription is already purchased";
                            }
                        }
                    }
                }
            }
            return ret;
        }
        /// <summary>
        /// Credit Card Charge User For Subscription
        /// </summary>
        public virtual BillingResponse Cellular_ChargeUserForSubscription(string sSiteGUID, double dPrice, string sCurrency, string sSubscriptionCode, string sCouponCode, string sUserIP, string sExtraParams,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bDummy)
        {
            return Cellular_BaseChargeUserForSubscription(sSiteGUID, dPrice, sCurrency, sSubscriptionCode, sCouponCode, sUserIP, sExtraParams, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, bDummy);
        }

        /// <summary>
        /// Credit Card Charge User For Bundle
        /// </summary>
        public virtual BillingResponse CC_ChargeUserForBundle(string sSiteGUID, double dPrice, string sCurrency, string sBundleCode, string sCouponCode, string sUserIP, string sExtraParams,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bDummy, string sPaymentMethodID, string sEncryptedCVV, eBundleType bundleType)
        {
            return CC_BaseChargeUserForBundle(sSiteGUID, dPrice, sCurrency, sBundleCode, sCouponCode, sUserIP, sExtraParams, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, bDummy, sPaymentMethodID, sEncryptedCVV, bundleType);
        }

        protected virtual double InitializePriceForBundlePurchase(double inputPrice, bool isDummy)
        {
            return inputPrice;
        }

        protected BillingResponse CC_BaseChargeUserForBundle
           (string sSiteGUID, double dPrice, string sCurrency, string sBundleCode, string sCouponCode, string sUserIP, string sExtraParams,
           string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bDummy, string sPaymentMethodID, string sEncryptedCVV, eBundleType bundleType)
        {
            BillingResponse ret = new BillingResponse();
            ret.m_oStatus = BillingResponseStatus.UnKnown;
            ret.m_sRecieptCode = string.Empty;
            ret.m_sStatusDescription = string.Empty;

            module bm = null;
            UsersService u = null;

            try
            {
                log.Debug("CC_BaseChargeUserForBundle - " + string.Format("Entering CC_BaseChargeUserForBundle try block. Site Guid: {0} , Bundle Code: {1} , Coupon Code: {2} , User IP: {3} , Payment Method: {4} , Dummy: {5}", sSiteGUID, sBundleCode, sCouponCode, sUserIP, sPaymentMethodID, bDummy.ToString().ToLower()));
                long lSiteGuid = 0;
                if (sSiteGUID.Length == 0 || !Int64.TryParse(sSiteGUID, out lSiteGuid) || lSiteGuid == 0)
                {
                    ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_sRecieptCode = string.Empty;
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);

                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                    }
                    else if (uObj != null && uObj.m_user != null && uObj.m_user.m_eSuspendState == DomainSuspentionStatus.Suspended)
                    {
                        ret.m_oStatus = BillingResponseStatus.UserSuspended;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cannot charge a suspended user";
                        WriteToUserLog(sSiteGUID, "while trying to purchase Bundle(CC): " + sBundleCode + " error returned: " + ret.m_sStatusDescription);
                    }
                    else
                    {
                        dPrice = InitializePriceForBundlePurchase(dPrice, bDummy);
                        if (!string.IsNullOrEmpty(sCouponCode) && !Utils.IsCouponValid(m_nGroupID, sCouponCode))
                        {
                            ret.m_oStatus = BillingResponseStatus.Fail;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "Coupon not valid";
                            WriteToUserLog(sSiteGUID, "While trying to purchase Bundle(CC): " + sBundleCode + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }

                        PriceReason theReason = PriceReason.UnKnown;
                        Price p = null;
                        PPVModule theBundle = null;

                        switch (bundleType)
                        {
                            case eBundleType.SUBSCRIPTION:
                                {
                                    Subscription theSub = null;
                                    p = Utils.GetSubscriptionFinalPrice(m_nGroupID, sBundleCode, sSiteGUID, sCouponCode, ref theReason, ref theSub, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                                    theBundle = theSub;
                                    break;
                                }
                            case eBundleType.COLLECTION:
                                {
                                    Collection theCol = null;
                                    p = Utils.GetCollectionFinalPrice(m_nGroupID, sBundleCode, sSiteGUID, sCouponCode, ref theReason, ref theCol, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty);
                                    theBundle = theCol;
                                    break;
                                }
                            default:
                                break;
                        }

                        if (IsTakePriceFromBundleFinalPrice(bDummy, p))
                        {
                            dPrice = p.m_dPrice;
                            sCurrency = p.m_oCurrency.m_sCurrencyCD3;
                        }
                        bool bIsEntitledToPreviewModule = theReason == PriceReason.EntitledToPreviewModule;

                        if (theReason == PriceReason.ForPurchase || bIsEntitledToPreviewModule)
                        {
                            if (bDummy || (p != null && p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency))
                            {
                                if (string.IsNullOrEmpty(sCountryCd) && !string.IsNullOrEmpty(sUserIP))
                                {
                                    sCountryCd = Utils.GetIP2CountryName(m_nGroupID, sUserIP);
                                }

                                switch (bundleType)
                                {
                                    case eBundleType.SUBSCRIPTION:
                                        {
                                            sWSUserName = string.Empty;
                                            sWSPass = string.Empty;

                                            InitializeBillingModule(ref bm, ref sWSUserName, ref sWSPass);

                                            ret = ExecuteCCSubscriprionPurchaseFlow(theBundle as Subscription, sBundleCode, sSiteGUID, uObj.m_user.m_domianID, dPrice, sCurrency, sCouponCode,
                                                                        sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, bIsEntitledToPreviewModule, bDummy, sExtraParams,
                                                                        sPaymentMethodID, sEncryptedCVV, p, ref bm, sWSUserName, sWSPass);
                                            break;
                                        }
                                    case eBundleType.COLLECTION:
                                        {
                                            ret = ExecuteCCCollectionPurchaseFlow(theBundle as Collection, sBundleCode, sSiteGUID, uObj.m_user.m_domianID, dPrice, sCurrency, sCouponCode,
                                                                        sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, bIsEntitledToPreviewModule, bDummy, sExtraParams,
                                                                        sPaymentMethodID, sEncryptedCVV, p, ref bm);

                                            break;
                                        }
                                    default:
                                        break;
                                }

                            }
                            else
                            {
                                ret.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The price of the request is not the actual price";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(CC): " + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                        else
                        {
                            // If we reached this else section, there can be only 3 correct price reasons - free or already purchased.
                            // Everything else should be noted as an error of GetSubscription/CollectionFinalPrice

                            string collectionOrSubscription = bundleType == eBundleType.SUBSCRIPTION ? "subscription" : "collection";
                            ret.m_oStatus = BillingResponseStatus.Fail;
                            ret.m_sRecieptCode = string.Empty;

                            switch (theReason)
                            {
                                case PriceReason.Free:
                                    {
                                        ret.m_sStatusDescription = string.Format("The {0} is free", collectionOrSubscription);
                                        WriteToUserLog(sSiteGUID, "while trying to purchase " + collectionOrSubscription + "(CC): " + " error returned: " + ret.m_sStatusDescription);

                                        break;
                                    }
                                case PriceReason.SubscriptionPurchased:
                                case PriceReason.CollectionPurchased:
                                    {
                                        ret.m_sStatusDescription = string.Format("The {0} is already purchased", collectionOrSubscription);
                                        WriteToUserLog(sSiteGUID, "while trying to purchase " + collectionOrSubscription + "(CC): " + " error returned: " + ret.m_sStatusDescription);
                                        break;
                                    }
                                default:
                                    {
                                        log.Debug("ChargeUserForBundle" +
                                            string.Format("Flow of CC_BaseChargeUserForBundle went wrong. Get{0}FinalPrice returned " +
                                            "price reason = {1} for site guid = {2} and bundle id = {3}",
                                            collectionOrSubscription, theReason, sSiteGUID, sBundleCode));
                                        break;
                                    }
                            }
                        }
                        if (ret.m_oStatus == BillingResponseStatus.Success)
                        {
                            string invalidationKey = LayeredCacheKeys.GetPurchaseInvalidationKey(uObj.m_user.m_domianID);
                            if (!LayeredCache.Instance.SetInvalidationKey(invalidationKey))
                            {
                                log.ErrorFormat("Failed to set invalidation key on CC_BaseChargeUserForBundle key = {0}", invalidationKey);
                            }
                        }
                    }
                } // end else siteguid == ""
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder(String.Concat("Exception msg: ", ex.Message));
                sb.Append(String.Concat(", Stack trace: ", ex.StackTrace));
                sb.Append(String.Concat(", Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(", Price: ", dPrice));
                sb.Append(String.Concat(", Currency: ", sCurrency));
                sb.Append(String.Concat(", Subscription Code: ", sBundleCode));
                sb.Append(String.Concat(", Coupon Code: ", sCouponCode));
                sb.Append(String.Concat(", User IP: ", sUserIP));
                sb.Append(String.Concat(", Extra Params: ", sExtraParams));
                sb.Append(String.Concat(", Country Code: ", sCountryCd));
                sb.Append(String.Concat(", Language Code: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(", Device Name: ", sDEVICE_NAME));
                sb.Append(String.Concat(", Dummy: ", bDummy.ToString().ToLower()));
                log.Error("CC_BaseChargeUserForSubscription - " + sb.ToString(), ex);
                WriteToUserLog(sSiteGUID, string.Format("While trying to purchase subscription id: {0} , Exception occurred.", sBundleCode));
                #endregion
                long lBillingID = 0;
                if (ret.m_oStatus != BillingResponseStatus.Success || ret.m_sRecieptCode.Length == 0 || !Int64.TryParse(ret.m_sRecieptCode, out lBillingID) || lBillingID == 0)
                {
                    ret.m_oStatus = BillingResponseStatus.UnKnown;
                    ret.m_sStatusDescription = "Undefined";
                    ret.m_sRecieptCode = string.Empty;
                }
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (bm != null)
                {
                    bm.Dispose();
                }
                #endregion
            }

            return ret;
        }

        protected virtual bool IsTakePriceFromBundleFinalPrice(bool isDummy, Price p)
        {
            return isDummy && p != null;
        }

        protected virtual bool IsTakePriceFromMediaFileFinalPrice(bool isDummy)
        {
            return true;
        }

        private BillingResponse ExecuteCCSubscriprionPurchaseFlow(Subscription theSub, string sBundleCode, string sSiteGUID, int domianID, double dPrice,
                                    string sCurrency, string sCouponCode, string sUserIP, string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME,
                                    bool bIsEntitledToPreviewModule, bool bDummy, string sExtraParams, string sPaymentMethodID, string sEncryptedCVV, Price p,
                                    ref module bm, string sBillingUsername, string sBillingPassword)
        {
            string sCustomData = string.Empty;
            BillingResponse ret = new BillingResponse()
            {
                m_oStatus = BillingResponseStatus.UnKnown
            };

            //Create the Custom Data
            sCustomData = GetCustomDataForSubscription(theSub, null, sBundleCode, string.Empty, sSiteGUID, dPrice, sCurrency,
                sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty, bIsEntitledToPreviewModule ? theSub.m_oPreviewModule.m_nID + "" : string.Empty, bIsEntitledToPreviewModule);

            log.Debug("CustomData - " + string.Format("Subscription custom data created. Site Guid: {0} , User IP: {1} , Custom data: {2}", sSiteGUID, sUserIP, sCustomData));

            bool bIsRecurring = theSub.m_bIsRecurring;
            Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;

            if (p.m_dPrice != 0 || bDummy || (p.m_dPrice == 0 && (bIsEntitledToPreviewModule || !string.IsNullOrEmpty(sCouponCode))))
            {
                ret = HandleCCChargeUser(sBillingUsername, sBillingPassword, sSiteGUID, dPrice, sCurrency, sUserIP,
                    sCustomData, 1, nRecPeriods, sExtraParams, sPaymentMethodID, sEncryptedCVV,
                    bDummy, bIsEntitledToPreviewModule, ref bm);
            }

            if (ret.m_oStatus == BillingResponseStatus.Success)
            {
                long lBillingTransactionID = 0;
                long lPurchaseID = 0;

                HandleChargeUserForSubscriptionBillingSuccess(sBillingUsername, sBillingPassword, sSiteGUID, domianID, theSub, dPrice, sCurrency, sCouponCode,
                    sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, ret, bIsEntitledToPreviewModule, sBundleCode, sCustomData,
                    bIsRecurring, ref lBillingTransactionID, ref lPurchaseID, bDummy, ref bm);

                // Update domain DLM with new DLM from subscription or if no DLM in new subscription, with last domain DLM
                if (theSub.m_nDomainLimitationModule != 0)
                {
                    UpdateDLM(domianID, theSub.m_nDomainLimitationModule);
                }

                // Enqueue notification for PS so they know a collection was charged
                var dicData = new Dictionary<string, object>()
                    {
                        {"SubscriptionCode", sBundleCode},
                        {"BillingTransactionID", lBillingTransactionID},
                        {"SiteGUID", sSiteGUID},
                        {"PurchaseID", lPurchaseID},
                        {"CouponCode", sCouponCode},
                        {"CustomData", sCustomData}
                    };

                var isEnqueSuccessful = this.EnqueueEventRecord(NotifiedAction.ChargedSubscription, dicData);
            }
            else
            {
                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(CC): " + sBundleCode + " error returned: " + ret.m_sStatusDescription);
            }

            return ret;
        }

        private BillingResponse ExecuteCCCollectionPurchaseFlow(Collection theCol, string sBundleCode, string sSiteGUID, int domainID, double dPrice,
                                    string sCurrency, string sCouponCode, string sUserIP, string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME,
                                    bool bIsEntitledToPreviewModule, bool bDummy, string sExtraParams, string sPaymentMethodID, string sEncryptedCVV, Price p,
                                    ref module bm)
        {
            string sCustomData = string.Empty;
            BillingResponse ret = null;

            //Create the Custom Data
            sCustomData = GetCustomDataForCollection(theCol, sBundleCode, sSiteGUID, dPrice, sCurrency,
                sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty);

            log.Debug("CustomData - " + string.Format("Collection custom data created. Site Guid: {0} , User IP: {1} , Custom data: {2}", sSiteGUID, sUserIP, sCustomData));

            string sWSUserName = string.Empty;
            string sWSPass = string.Empty;

            if (p.m_dPrice != 0 || bDummy)
            {
                InitializeBillingModule(ref bm, ref sWSUserName, ref sWSPass);

                ret = HandleCCChargeUser(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sUserIP,
                    sCustomData, 1, 1, sExtraParams, sPaymentMethodID, sEncryptedCVV,
                    bDummy, bIsEntitledToPreviewModule, ref bm);
            }
            if ((p.m_dPrice == 0 && !string.IsNullOrEmpty(sCouponCode)) || bIsEntitledToPreviewModule)
            {
                ret.m_oStatus = BillingResponseStatus.Success;
            }
            if (ret.m_oStatus == BillingResponseStatus.Success)
            {
                long lBillingTransactionID = 0;
                long lPurchaseID = 0;

                HandleChargeUserForCollectionBillingSuccess(sWSUserName, sWSPass, sSiteGUID, domainID, theCol, dPrice, sCurrency, sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE,
                    sDEVICE_NAME, ret, sBundleCode, sCustomData, ref lBillingTransactionID, ref lPurchaseID, ref bm);

                // Enqueue notification for PS so they know a collection was charged
                var dicData = new Dictionary<string, object>()
                                            {
                                                {"CollectionCode", sBundleCode},
                                                {"BillingTransactionID", lBillingTransactionID},
                                                {"SiteGUID", sSiteGUID},
                                                {"PurchaseID", lPurchaseID},
                                                {"CouponCode", sCouponCode},
                                                {"CustomData", sCustomData}
                                            };

                this.EnqueueEventRecord(NotifiedAction.ChargedCollection, dicData);

            }
            else
            {
                WriteToUserLog(sSiteGUID, "while trying to purchase collection(CC): " + sBundleCode + " error returned: " + ret.m_sStatusDescription);
            }

            return ret;
        }

        /// <summary>
        /// Get Subscriptions Prices 
        /// </summary>
        public virtual SubscriptionsPricesContainer[] GetSubscriptionsPrices(string[] sSubscriptions, string sUserGUID, string sCouponCode,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sIP = null)
        {
            SubscriptionsPricesContainer[] ret = null;
            try
            {
                if (sSubscriptions != null && sSubscriptions.Length > 0)
                {
                    List<SubscriptionsPricesContainer> resp = new List<SubscriptionsPricesContainer>();

                    for (int i = 0; i < sSubscriptions.Length; i++)
                    {
                        string sSubCode = sSubscriptions[i];
                        PriceReason theReason = PriceReason.UnKnown;
                        Subscription s = null;
                        Price p = null;
                        if (string.IsNullOrEmpty(sIP))
                        {
                            p = Utils.GetSubscriptionFinalPrice(m_nGroupID, sSubCode, sUserGUID, sCouponCode, ref theReason, ref s, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        }
                        else
                        {
                            p = Utils.GetSubscriptionFinalPrice(m_nGroupID, sSubCode, sUserGUID, sCouponCode, ref theReason, ref s, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty, sIP);
                        }

                        if (p != null)
                        {
                            SubscriptionsPricesContainer cont = new SubscriptionsPricesContainer();
                            cont.Initialize(sSubCode, p, theReason);
                            resp.Add(cont);
                        }
                    }

                    ret = resp.ToArray();
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at GetSubscriptionsPrices. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sUserGUID));
                sb.Append(String.Concat(" Cpn Cd: ", sCouponCode));
                sb.Append(String.Concat(" Cntry Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Cd: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" D Nm: ", sDEVICE_NAME));
                sb.Append(String.Concat(" sIP: ", sIP != null ? sIP : "null"));
                if (sSubscriptions != null && sSubscriptions.Length > 0)
                {
                    sb.Append("Subs: ");
                    for (int i = 0; i < sSubscriptions.Length; i++)
                    {
                        sb.Append(String.Concat(sSubscriptions[i], "; "));
                    }
                }
                else
                {
                    sb.Append("Subs are null or empty.");
                }
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            return ret;
        }

        /// <summary>
        /// Get Collections Prices 
        /// </summary>
        public virtual CollectionsPricesContainer[] GetCollectionsPrices(string[] sCollections, string sUserGUID, string sCouponCode,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            CollectionsPricesContainer[] ret = null;
            try
            {
                if (sCollections != null && sCollections.Length > 0)
                {
                    ret = new CollectionsPricesContainer[sCollections.Length];

                    for (int i = 0; i < sCollections.Length; i++)
                    {
                        string sColCode = sCollections[i];
                        PriceReason theReason = PriceReason.UnKnown;
                        Collection collection = null;
                        Price price = null;

                        price = Utils.GetCollectionFinalPrice(m_nGroupID, sColCode, sUserGUID, sCouponCode, ref theReason, ref collection, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty);

                        CollectionsPricesContainer cont = new CollectionsPricesContainer();
                        cont.Initialize(sColCode, price, theReason);
                        ret[i] = cont;
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at GetCollectionsPrices. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sUserGUID));
                sb.Append(String.Concat(" Cpn Cd: ", sCouponCode));
                sb.Append(String.Concat(" Cntry Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Cd: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" D Nm: ", sDEVICE_NAME));
                if (sCollections != null && sCollections.Length > 0)
                {
                    sb.Append("Colls: ");
                    for (int i = 0; i < sCollections.Length; i++)
                    {
                        sb.Append(String.Concat(sCollections[i], "; "));
                    }
                }
                else
                {
                    sb.Append("Colls are null or empty.");
                }
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            return ret;
        }

        /// <summary>
        /// 
        /// </summary>
        public virtual PrePaidPricesContainer[] GetPrePaidPrices(string[] sPrePaids, string sUserGUID, string sCouponCode,
         string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            PrePaidPricesContainer[] ret = null;
            try
            {
                if (sPrePaids != null && sPrePaids.Length > 0)
                {
                    ret = new PrePaidPricesContainer[sPrePaids.Length];

                    for (int i = 0; i < sPrePaids.Length; i++)
                    {
                        string sPrePaidCode = sPrePaids[i];
                        PriceReason theReason = PriceReason.UnKnown;
                        PrePaidModule prePaidMod = null;
                        Price p = Utils.GetPrePaidFinalPrice(m_nGroupID, sPrePaidCode, sUserGUID, ref theReason, ref prePaidMod, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty, sCouponCode);
                        PrePaidPricesContainer cont = new PrePaidPricesContainer();
                        cont.Initialize(sPrePaidCode, p, theReason);
                        ret[i] = cont;
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at GetPrePaidPrices. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sUserGUID));
                sb.Append(String.Concat(" Cpn Cd: ", sCouponCode));
                sb.Append(String.Concat(" Cntry Cd: ", sCountryCd));
                sb.Append(String.Concat(" Lng Cd: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(" D Nm: ", sDEVICE_NAME));
                if (sPrePaids != null && sPrePaids.Length > 0)
                {
                    sb.Append("Colls: ");
                    for (int i = 0; i < sPrePaids.Length; i++)
                    {
                        sb.Append(String.Concat(sPrePaids[i], "; "));
                    }
                }
                else
                {
                    sb.Append("Colls are null or empty.");
                }
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            return ret;
        }
        public virtual MediaFileItemPricesContainer[] GetItemsPrices(Int32[] nMediaFiles, string sUserGUID, string sCouponCode, bool bOnlyLowest,
           string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            return GetItemsPrices(nMediaFiles, sUserGUID, sCouponCode, bOnlyLowest, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, "");
        }

        /// <summary>
        /// Get Items Prices
        /// </summary>
        public virtual MediaFileItemPricesContainer[] GetItemsPrices(Int32[] nMediaFiles, string sUserGUID, string sCouponCode, bool bOnlyLowest,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sClientIP)
        {
            string sFirstDeviceNameFound = string.Empty;
            mdoule objPricingModule = null;
            MediaFileItemPricesContainer[] ret = null;
            string sPricingUsername = string.Empty;
            string sPricingPassword = string.Empty;
            string sAPIUsername = string.Empty;
            string sAPIPassword = string.Empty;
            string wsUsersUsername = string.Empty;
            string wsUsersPassword = string.Empty;
            bool bCancellationWindow = false;
            try
            {
                MediaFilePPVContainer[] oModules = null;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.API, ref sAPIUsername, ref sAPIPassword);
                Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sPricingUsername, ref sPricingPassword);
                Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref wsUsersUsername, ref wsUsersPassword);

                // get details about files + media (validity about files)    
                Dictionary<int, string> mediaFilesProductCode = new Dictionary<int, string>();
                Dictionary<int, MediaFileStatus> validMediaFiles = Utils.ValidateMediaFiles(nMediaFiles, ref mediaFilesProductCode, m_nGroupID);

                //return - MediaAdObject is NotFiniteNumberException validMediaFiles for purchase                    
                List<MediaFileItemPricesContainer> tempRet = new List<MediaFileItemPricesContainer>();
                MediaFileItemPricesContainer tempItemPricesContainer = null;

                List<int> notForPurchaseFiles = validMediaFiles.Where(x => x.Value == MediaFileStatus.NotForPurchase).Select(x => x.Key).ToList();
                nMediaFiles = validMediaFiles.Where(x => x.Value != MediaFileStatus.NotForPurchase).Select(x => x.Key).ToArray();

                foreach (int mf in notForPurchaseFiles)
                {
                    tempItemPricesContainer = new MediaFileItemPricesContainer();
                    tempItemPricesContainer.m_nMediaFileID = mf;
                    tempItemPricesContainer.m_oItemPrices = new ItemPriceContainer[1];
                    tempItemPricesContainer.m_oItemPrices[0] = new ItemPriceContainer();
                    tempItemPricesContainer.m_oItemPrices[0].m_PriceReason = PriceReason.NotForPurchase;
                    tempItemPricesContainer.m_sProductCode = string.Empty;
                    tempRet.Add(tempItemPricesContainer);
                }
                if (nMediaFiles.Count() == 0) // all file not for purchase - return
                {
                    ret = tempRet.ToArray();
                    return ret;
                }

                InitializePricingModule(ref objPricingModule);
                oModules = objPricingModule.GetPPVModuleListForMediaFilesWithExpiry(sPricingUsername, sPricingPassword, nMediaFiles, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                if (oModules != null && oModules.Length > 0)
                {
                    ret = new MediaFileItemPricesContainer[oModules.Length];
                    MeidaMaper[] mapper = null;
                    int domainID = 0;
                    List<int> allUsersInDomain = Utils.GetAllUsersDomainBySiteGUID(sUserGUID, m_nGroupID, ref domainID);
                    DomainSuspentionStatus userSuspendStatus = DomainSuspentionStatus.OK;
                    DomainEntitlements domainEntitlements = null;

                    // check if user is valid
                    if (Utils.IsUserValid(sUserGUID, m_nGroupID, ref domainID, ref userSuspendStatus) && userSuspendStatus == DomainSuspentionStatus.OK)
                    {
                        // create mapper
                        mapper = Utils.GetMediaMapper(m_nGroupID, nMediaFiles, sAPIUsername, sAPIPassword);
                        // Get all user entitlements
                        if (!Utils.TryGetDomainEntitlementsFromCache(m_nGroupID, domainID, mapper, ref domainEntitlements))
                        {
                            log.ErrorFormat("Utils.GetUserEntitlements, groupId: {0}, domainId: {1}", m_nGroupID, domainID);
                        }
                    }
                    // set sUserGUID to empty for Utils.GetMediaFileFinalPrice logic
                    else
                    {
                        sUserGUID = string.Empty;
                    }

                    // set max amount of concurrent tasks
                    int maxDegreeOfParallelism = TVinciShared.WS_Utils.GetTcmIntValue("MaxDegreeOfParallelism");
                    if (maxDegreeOfParallelism == 0)
                    {
                        maxDegreeOfParallelism = 5;
                    }
                    ParallelOptions options = new ParallelOptions() { MaxDegreeOfParallelism = maxDegreeOfParallelism };

                    ContextData contextData = new ContextData();
                    // loop on all files
                    Parallel.For(0, oModules.Length, options, i =>
                    {
                        contextData.Load();
                        Int32 nMediaFileID = oModules[i].m_nMediaFileID;
                        int mediaID = 0;
                        //get mediaID
                        if (mapper != null)
                        {
                            mediaID = Utils.ExtractMediaIDOutOfMediaMapper(mapper, nMediaFileID);
                        }
                        PPVModuleWithExpiry[] ppvModules = oModules[i].m_oPPVModules;
                        MediaFileItemPricesContainer mf = new MediaFileItemPricesContainer();
                        int nMediaFileTypeID = Utils.GetMediaFileTypeID(m_nGroupID, nMediaFileID, sAPIUsername, sAPIPassword);

                        if (ppvModules != null && ppvModules.Length > 0)
                        {
                            List<ItemPriceContainer> itemPriceCont = new List<ItemPriceContainer>();

                            Int32 nLowestIndex = 0;
                            double dLowest = -1;
                            Price pLowest = null;
                            PriceReason theLowestReason = PriceReason.UnKnown;
                            Subscription relevantLowestSub = null;
                            Collection relevantLowestCol = null;
                            PrePaidModule relevantLowestPrePaid = null;
                            string sProductCode = string.Empty;
                            bool tempCancellationWindow = false;
                            string lowestPurchasedBySiteGuid = string.Empty;
                            int lowestPurchasedAsMediaFileID = 0;
                            List<int> lowestRelatedMediaFileIDs = new List<int>();
                            DateTime? dtLowestStartDate = null;
                            DateTime? dtLowestEndDate = null;
                            bool isUserSuspended = false;

                            for (int j = 0; j < ppvModules.Length; j++)
                            {
                                string sPPVCode = GetPPVCodeForGetItemsPrices(ppvModules[j].PPVModule.m_sObjectCode, ppvModules[j].PPVModule.m_sObjectVirtualName);

                                PriceReason theReason = PriceReason.UnKnown;
                                Subscription relevantSub = null;
                                Collection relevantCol = null;
                                PrePaidModule relevantPrePaid = null;
                                string purchasedBySiteGuid = string.Empty;
                                int purchasedAsMediaFileID = 0;
                                List<int> relatedMediaFileIDs = new List<int>();
                                DateTime? dtEntitlementStartDate = null;
                                DateTime? dtEntitlementEndDate = null;
                                DateTime? dtDiscountEndDate = null;

                                Price p = Utils.GetMediaFileFinalPrice(nMediaFileID, validMediaFiles[nMediaFileID], ppvModules[j].PPVModule, sUserGUID, sCouponCode, m_nGroupID,
                                    ppvModules[j].IsValidForPurchase, ref theReason, ref relevantSub, ref relevantCol, ref relevantPrePaid, ref sFirstDeviceNameFound, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME,
                                    sClientIP, null, allUsersInDomain, nMediaFileTypeID, sAPIUsername, sAPIPassword, sPricingUsername, sPricingPassword, ref bCancellationWindow, ref purchasedBySiteGuid,
                                    ref purchasedAsMediaFileID, ref relatedMediaFileIDs, ref dtEntitlementStartDate, ref dtEntitlementEndDate, ref dtDiscountEndDate, domainID, domainEntitlements, mediaID, userSuspendStatus, false);

                                sProductCode = mediaFilesProductCode[nMediaFileID];

                                var tempItemPriceContainer = new ItemPriceContainer();
                                tempItemPriceContainer.Initialize(p, ppvModules[j].PPVModule.m_oPriceCode.m_oPrise, sPPVCode, ppvModules[j].PPVModule.m_sDescription,
                                    theReason, relevantSub, relevantCol, ppvModules[j].PPVModule.m_bSubscriptionOnly, relevantPrePaid,
                                    sFirstDeviceNameFound, bCancellationWindow, purchasedBySiteGuid, purchasedAsMediaFileID, relatedMediaFileIDs, ppvModules[j].PPVModule.m_Product_Code, dtEntitlementStartDate,
                                    dtEntitlementEndDate, dtDiscountEndDate);

                                if (theReason == PriceReason.UserSuspended)
                                {
                                    isUserSuspended = true;

                                    if (!bOnlyLowest)
                                    {
                                        itemPriceCont.Add(tempItemPriceContainer);
                                    }
                                    else
                                    {
                                        if (j == 0)//insert only the first ppvModule (when the user is suspended we cannot compare prices)
                                        {
                                            itemPriceCont.Insert(0, tempItemPriceContainer);
                                        }
                                    }
                                }
                                else //user is not suspended
                                {
                                    bool isValidForPurchase = ppvModules[j].IsValidForPurchase;
                                    if (isValidForPurchase || (!isValidForPurchase && theReason == PriceReason.PPVPurchased))
                                    {
                                        if (!bOnlyLowest)
                                        {
                                            itemPriceCont.Add(tempItemPriceContainer);
                                        }
                                        else
                                        {
                                            if (p != null && (p.m_dPrice < dLowest || j == 0))
                                            {
                                                #region insert lowest price parameters
                                                nLowestIndex = j;
                                                dLowest = p.m_dPrice;
                                                pLowest = p;
                                                theLowestReason = theReason;
                                                relevantLowestSub = relevantSub;
                                                relevantLowestCol = relevantCol;
                                                relevantLowestPrePaid = relevantPrePaid;
                                                tempCancellationWindow = bCancellationWindow;
                                                lowestPurchasedBySiteGuid = purchasedBySiteGuid;
                                                lowestPurchasedAsMediaFileID = purchasedAsMediaFileID;
                                                lowestRelatedMediaFileIDs = relatedMediaFileIDs;
                                                dtLowestStartDate = dtEntitlementStartDate;
                                                dtLowestEndDate = dtEntitlementEndDate;
                                                #endregion
                                            }
                                        }
                                    }
                                }
                            } // end for                            

                            if (ppvModules.Length > 0 && itemPriceCont.Count == 0 && !isUserSuspended)
                            {
                                if (bOnlyLowest)
                                {
                                    var tempItemPriceContainer = new ItemPriceContainer();

                                    tempItemPriceContainer.Initialize(pLowest, ppvModules[nLowestIndex].PPVModule.m_oPriceCode.m_oPrise,
                                        ppvModules[nLowestIndex].PPVModule.m_sObjectCode, ppvModules[nLowestIndex].PPVModule.m_sDescription,
                                        theLowestReason, relevantLowestSub, relevantLowestCol, ppvModules[nLowestIndex].PPVModule.m_bSubscriptionOnly,
                                        relevantLowestPrePaid, sFirstDeviceNameFound, tempCancellationWindow, lowestPurchasedBySiteGuid,
                                        lowestPurchasedAsMediaFileID, lowestRelatedMediaFileIDs, ppvModules[nLowestIndex].PPVModule.m_Product_Code,
                                        dtLowestStartDate, dtLowestEndDate);
                                    itemPriceCont.Insert(0, tempItemPriceContainer);
                                }
                                else
                                {
                                    ItemPriceContainer[] priceContainer = new ItemPriceContainer[1];
                                    priceContainer[0] = GetFreeItemPriceContainer();

                                    itemPriceCont.Insert(0, priceContainer[0]);

                                }
                            }

                            mf.Initialize(nMediaFileID, itemPriceCont.ToArray(), sProductCode);
                        }
                        else
                        {
                            ItemPriceContainer[] priceContainer = new ItemPriceContainer[1];
                            priceContainer[0] = GetFreeItemPriceContainer();

                            mf.Initialize(nMediaFileID, priceContainer);
                        }

                        ret[i] = mf;
                    });
                }
                else
                {
                    ret = new MediaFileItemPricesContainer[1];
                    MediaFileItemPricesContainer mc = new MediaFileItemPricesContainer();
                    foreach (int mediaFileID in nMediaFiles)
                    {
                        ItemPriceContainer freeContainer = new ItemPriceContainer();
                        freeContainer.m_PriceReason = PriceReason.Free;
                        ItemPriceContainer[] priceContainer = new ItemPriceContainer[1];
                        priceContainer[0] = freeContainer;

                        mc.Initialize(mediaFileID, priceContainer);
                    }
                    ret[0] = mc;
                }

                // add all files that are not for purchased
                tempRet.AddRange(ret);
                ret = tempRet.ToArray();
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder(String.Concat("GetItemsPrices Exception. Msg: ", ex.Message));
                sb.Append(String.Concat(" SiteGuid: ", sUserGUID));
                sb.Append(String.Concat(" Coupon Code: ", sCouponCode));
                sb.Append(String.Concat(" OnlyLowest: ", bOnlyLowest.ToString().ToLower()));
                if (nMediaFiles != null && nMediaFiles.Length > 0)
                {
                    sb.Append(" Media Files: ");
                    for (int i = 0; i < nMediaFiles.Length; i++)
                    {
                        sb.Append(String.Concat(nMediaFiles[i], " "));
                    }
                }
                else
                {
                    sb.Append(" No Media Files ");
                }
                sb.Append(String.Concat(" BaseCAS is: ", this.GetType().Name));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);

                ret = null;
                #endregion
            }
            finally
            {
                #region Disposing
                if (objPricingModule != null)
                {
                    objPricingModule.Dispose();
                }

                #endregion
            }

            return ret;
        }

        /*
         * 1. This method is a helper function for GetItemsPrices.
         * 2. It is used to optimize DB access. In case the data is not needed in the function Utils.GetMediaFileFinalPrice it will not attempt
         * 3. to access the DB.
         */
        private void GetAllUsersInDomainAndMediaFileTypes(MediaFilePPVContainer[] oModules, string sSiteGuid,
            out Dictionary<int, int> mediaFileTypesMapping, out List<int> allUsersInDomain)
        {
            long lSiteGuid = 0;
            if (!string.IsNullOrEmpty(sSiteGuid) && Int64.TryParse(sSiteGuid, out lSiteGuid) && lSiteGuid > 0 && IsExistPPVModule(oModules))
            {
                mediaFileTypesMapping = ConditionalAccessDAL.Get_GroupMediaTypesIDs(m_nGroupID);
                int domainID = 0;
                allUsersInDomain = Utils.GetAllUsersDomainBySiteGUID(sSiteGuid, m_nGroupID, ref domainID);
            }
            else
            {
                mediaFileTypesMapping = new Dictionary<int, int>(0);
                allUsersInDomain = new List<int>(0);
            }
        }

        private bool IsExistPPVModule(MediaFilePPVContainer[] oModules)
        {
            if (oModules != null && oModules.Length > 0)
            {
                for (int i = 0; i < oModules.Length; i++)
                {
                    PPVModuleWithExpiry[] ppvModules = oModules[i].m_oPPVModules;
                    if (ppvModules != null && ppvModules.Length > 0)
                    {
                        return true;
                    }
                }
            }
            return false;
        }

        protected ItemPriceContainer GetFreeItemPriceContainer()
        {
            ItemPriceContainer freeContainer = new ItemPriceContainer();
            freeContainer.m_PriceReason = PriceReason.Free;
            freeContainer.m_oPrice = new Price();
            freeContainer.m_oPrice.m_dPrice = 0.0;

            return freeContainer;
        }

        protected void InitializePricingModule(ref mdoule pm)
        {

            pm = new mdoule();
        }


        protected internal void InitializeBillingModule(ref module bm, ref string sWSUsername, ref string sWSPassword)
        {
            Utils.GetWSCredentials(m_nGroupID, eWSModules.BILLING, ref sWSUsername, ref sWSPassword);

            bm = new module();
        }

        /// <summary>
        /// Get Subscription Dates
        /// </summary>
        protected void GetPurchaseItemDates(Int32 nPurchaseID, ref DateTime dStartDate, ref DateTime dEndDate, BillingItemsType billingType)
        {
            ODBCWrapper.DataSetSelectQuery selectQuery = null;

            string tableName = string.Empty;
            switch (billingType)
            {

                case BillingItemsType.PPV:
                    tableName = "ppv_purchases";
                    break;

                case BillingItemsType.PrePaid:
                case BillingItemsType.PrePaidExpired:
                    tableName = "pre_paid_purchases";
                    break;

                case BillingItemsType.Collection:
                    tableName = "collections_purchases";
                    break;

                case BillingItemsType.Unknown:
                case BillingItemsType.Subscription:
                default:
                    tableName = "subscriptions_purchases";
                    break;
            }

            try
            {
                selectQuery = new ODBCWrapper.DataSetSelectQuery();
                selectQuery.SetConnectionKey("CA_CONNECTION_STRING");
                selectQuery += string.Format("select START_DATE, END_DATE from {0} with (nolock) where ", tableName);
                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nPurchaseID);
                if (selectQuery.Execute("query", true) != null)
                {
                    Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                    if (nCount > 0)
                    {
                        dStartDate = (DateTime)(selectQuery.Table("query").DefaultView[0].Row["START_DATE"]);
                        dEndDate = (DateTime)(selectQuery.Table("query").DefaultView[0].Row["END_DATE"]);
                    }
                }
            }
            finally
            {
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
            }
        }
        /// <summary>
        /// Get Media Title
        /// </summary>
        protected string GetMediaTitle(Int32 nMediaID)
        {
            string sRet = "";
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            try
            {
                selectQuery = new ODBCWrapper.DataSetSelectQuery();
                selectQuery.SetConnectionKey("MAIN_CONNECTION_STRING");
                selectQuery += "select name from media with (nolock) where ";
                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("id", "=", nMediaID);
                if (selectQuery.Execute("query", true) != null)
                {
                    Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                    if (nCount > 0)
                        sRet = selectQuery.Table("query").DefaultView[0].Row["NAME"].ToString();
                }
            }
            finally
            {
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
            }
            return sRet;
        }


        /*
        /// <summary>
        /// Get Safe Double
        /// </summary>
        protected double GetSafeDouble(object o)
        {
            try
            {
                return double.Parse(o.ToString());
            }
            catch
            {
                return 0;
            }
        }
        /// <summary>
        /// Get Safe Int
        /// </summary>
        protected Int32 GetSafeInt(object o)
        {
            try
            {
                return int.Parse(o.ToString());
            }
            catch
            {
                return 0;
            }
        }
        */

        /// <summary>
        /// Get Domains Billing History
        /// 
        /// (for Eutelsat Project)
        /// </summary>
        public virtual DomainsBillingTransactionsResponse GetDomainsBillingHistory(int[] domainIDs, DateTime startDate, DateTime endDate)
        {
            DomainsBillingTransactionsResponse response = new DomainsBillingTransactionsResponse()
            {
                status = new ApiObjects.Response.Status()
                {

                    Code = (int)eResponseStatus.OK,
                    Message = string.Empty
                }
            };

            List<DomainBillingTransactionsResponse> domainsBillingTransactions = new List<DomainBillingTransactionsResponse>();
            List<int> invalidDomains = new List<int>();

            // if not domains were sent - return an "empty" response object            
            if (domainIDs == null || domainIDs.Length == 0)
            {
                response.billingTransactions = domainsBillingTransactions.ToArray();
                return response;
            }

            for (int i = 0; i < domainIDs.Length; i++)
            {
                try
                {
                    DomainBillingTransactionsResponse domainBillingTransactions = new DomainBillingTransactionsResponse();
                    domainBillingTransactions.m_nDomainID = domainIDs[i];

                    string[] sUserGuids = DomainDal.GetUsersInDomain(domainIDs[i], m_nGroupID, 1, 1).Select(ut => ut.Key.ToString()).ToArray();
                    //string[] sUserGuids = userIDs.Select(u => u.ToString()).ToArray();

                    domainBillingTransactions.m_BillingTransactionResponses = GetUsersBillingHistory(sUserGuids, startDate, endDate);

                    domainsBillingTransactions.Add(domainBillingTransactions);
                }
                catch (Exception ex)
                {
                    #region Logging
                    StringBuilder sb = new StringBuilder("Exception at GetDomainsBillingHistory. ");
                    sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                    sb.Append(String.Concat(" Start Date: ", startDate));
                    sb.Append(String.Concat(" End Date: ", endDate));
                    sb.Append(String.Concat(" Domain ID: ", domainIDs[i]));
                    sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                    sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                    log.Error("Exception - " + sb.ToString(), ex);

                    invalidDomains.Add(domainIDs[i]);
                    #endregion

                }
            }

            // Set failure message
            if (invalidDomains.Count > 0)
            {
                response.status.Code = (int)eResponseStatus.Error;
                response.status.Message = string.Concat(
                    "Failed getting billing history of domains: ", string.Join<int>(",", invalidDomains));

            }

            response.billingTransactions = domainsBillingTransactions.ToArray();

            return response;
        }

        /// <summary>
        /// Get Domain Billing History
        /// </summary>
        public virtual DomainTransactionsHistoryResponse GetDomainTransactionsHistory(int domainID, DateTime dStartDate, DateTime dEndDate, int pageSize, int pageIndex, TransactionHistoryOrderBy orderBy)
        {
            DomainTransactionsHistoryResponse domainTransactionsHistoryResponse = new DomainTransactionsHistoryResponse();

            if (domainID == 0)
            {
                domainTransactionsHistoryResponse.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Invalid DomainID");
                domainTransactionsHistoryResponse.TransactionsCount = 0;
                return domainTransactionsHistoryResponse;
            }

            try
            {
                if (pageSize <= 0)
                {
                    domainTransactionsHistoryResponse.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "PageSize must be above 0");
                    domainTransactionsHistoryResponse.TransactionsCount = 0;
                    return domainTransactionsHistoryResponse;
                }

                DataTable domainBillingHistory = ConditionalAccessDAL.GetDomainBillingHistory(m_nGroupID, domainID, 0, dStartDate, dEndDate, (int)orderBy);

                if (domainBillingHistory == null || domainBillingHistory.Rows == null || domainBillingHistory.Rows.Count == 0)
                {
                    domainTransactionsHistoryResponse.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, "no history billing for domain");
                    domainTransactionsHistoryResponse.TransactionsCount = 0;
                    return domainTransactionsHistoryResponse;
                }
                List<DataRow> filteredRows = new List<DataRow>();

                if (pageIndex > 0)
                {
                    int takeTop = pageIndex * pageSize;
                    Int64 maxTransactionID = (from row in domainBillingHistory.AsEnumerable().Take(takeTop)
                                              select row.Field<Int64>("ID")).ToList().Min();
                    filteredRows = (from row in domainBillingHistory.AsEnumerable()
                                    where (Int64)row["ID"] < maxTransactionID
                                    select row).Take(pageSize).ToList();
                }
                else
                {
                    filteredRows.AddRange(domainBillingHistory.AsEnumerable().Take(pageSize));
                }

                foreach (DataRow dr in filteredRows)
                {
                    TransactionHistoryContainer transactionHistory = GetBillingTransactionContainerFromDataRow(dr, true);
                    if (transactionHistory != null)
                    {
                        transactionHistory.SiteGuid = ODBCWrapper.Utils.GetSafeStr(dr["SITE_GUID"]);
                        transactionHistory.UserFullName = ODBCWrapper.Utils.GetSafeStr(dr["FIRST_NAME"]) + " " + ODBCWrapper.Utils.GetSafeStr(dr["LAST_NAME"]);
                        domainTransactionsHistoryResponse.TransactionsHistory.Add(transactionHistory);
                    }
                }
                domainTransactionsHistoryResponse.TransactionsCount = domainBillingHistory.Rows.Count;
                domainTransactionsHistoryResponse.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
            }

            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at GetDomainTransactionsHistory. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Start Date: ", dStartDate));
                sb.Append(String.Concat(" End Date: ", dEndDate));
                sb.Append(String.Concat(" DomainID: ", domainID));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }

            return domainTransactionsHistoryResponse;
        }

        /// <summary>
        /// Get Users Billing History
        /// 
        /// (for Eutelsat Project)
        /// </summary>
        public virtual UserBillingTransactionsResponse[] GetUsersBillingHistory(string[] arrUserGUIDs, DateTime dStartDate, DateTime dEndDate)
        {
            List<UserBillingTransactionsResponse> lUserBillingTransactions = new List<UserBillingTransactionsResponse>();

            if (arrUserGUIDs == null || arrUserGUIDs.Length == 0)
            {
                return lUserBillingTransactions.ToArray();
            }

            for (int i = 0; i < arrUserGUIDs.Length; i++)
            {
                try
                {
                    UserBillingTransactionsResponse userBillingTransactions = new UserBillingTransactionsResponse();
                    userBillingTransactions.m_sSiteGUID = arrUserGUIDs[i];
                    BillingTransactions billingTransactions = GetUserBillingHistoryExt(arrUserGUIDs[i], dStartDate, dEndDate);
                    if (billingTransactions != null)
                    {
                        userBillingTransactions.m_BillingTransactionResponse = billingTransactions.transactions;
                    }
                    lUserBillingTransactions.Add(userBillingTransactions);
                }
                catch (Exception ex)
                {
                    #region Logging
                    StringBuilder sb = new StringBuilder("Exception at GetUsersBillingHistory. ");
                    sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                    sb.Append(String.Concat(" Start Date: ", dStartDate));
                    sb.Append(String.Concat(" End Date: ", dEndDate));
                    sb.Append(String.Concat(" Site Guid: ", arrUserGUIDs[i]));
                    sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                    sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                    log.Error("Exception - " + sb.ToString(), ex);
                    #endregion
                }
            }

            return lUserBillingTransactions.ToArray();
        }

        /// <summary>
        /// Get User Billing History
        /// </summary>
        protected virtual BillingTransactions GetUserBillingHistoryExt(string sUserGUID, DateTime dStartDate, DateTime dEndDate, int nStartIndex = 0, int nNumberOfItems = 0, TransactionHistoryOrderBy orderBy = TransactionHistoryOrderBy.CreateDateDesc)
        {

            BillingTransactionsResponse theResp = new BillingTransactionsResponse();
            BillingTransactions response = new BillingTransactions();

            try
            {
                List<int> lGroupIDs = UtilsDal.GetAllRelatedGroups(m_nGroupID);
                string[] arrGroupIDs = lGroupIDs.Select(g => g.ToString()).ToArray();

                int nTopNum = nStartIndex + nNumberOfItems;
                DataView dvBillHistory = ConditionalAccessDAL.GetUserBillingHistory(arrGroupIDs, sUserGUID, nTopNum, dStartDate, dEndDate, (int)orderBy);


                if (dvBillHistory == null || dvBillHistory.Count == 0)
                {
                    response.resp = new ApiObjects.Response.Status((int)eResponseStatus.OK, "no history billing for user");
                    return response;
                }

                int nCount = dvBillHistory.Count;

                if (nTopNum > nCount || nTopNum == 0)
                {
                    nTopNum = nCount;
                }

                theResp.m_nTransactionsCount = nCount;
                theResp.m_Transactions = new BillingTransactionContainer[nCount];

                for (int i = nStartIndex; i < nTopNum; i++)
                {
                    theResp.m_Transactions[i] = GetBillingTransactionContainerFromDataRow(dvBillHistory[i].Row, false) as BillingTransactionContainer;
                } // for

                response.resp = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                response.transactions = theResp;
            }

            catch (Exception ex)
            {
                log.Error("GetUserBillingHistoryExt - " + string.Format("UserGUID={0}, dStartDate={1}, dEndDate={2}, nStartIndex={3},nNumberOfItems={4}, ex={5} ", sUserGUID, dStartDate, dEndDate, nStartIndex, nNumberOfItems, ex.Message), ex);
                response.resp = new ApiObjects.Response.Status((int)eResponseStatus.Error, ex.Message);
            }

            return response;
        }

        private TransactionHistoryContainer GetBillingTransactionContainerFromDataRow(DataRow dr, bool shouldGetExtendedParams)
        {
            TransactionHistoryContainer res = null;
            mdoule module = null;
            try
            {
                res = new TransactionHistoryContainer();
                module = new mdoule();
                string sWSUserName = string.Empty;
                string sWSPass = string.Empty;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                string sCurrencyCode = ODBCWrapper.Utils.GetSafeStr(dr["CURRENCY_CODE"]);
                string sRemarks = ODBCWrapper.Utils.GetSafeStr(dr["REMARKS"]);

                double dPrice = ODBCWrapper.Utils.GetDoubleSafeVal(dr, "TOTAL_PRICE");
                Int32 nPurchaseID = ODBCWrapper.Utils.GetIntSafeVal(dr, "PURCHASE_ID");
                DateTime dActionDate = (DateTime)(dr["CREATE_DATE"]);
                string sSubscriptionCode = dr["SUBSCRIPTION_CODE"].ToString();
                Int32 nMediaID = ODBCWrapper.Utils.GetIntSafeVal(dr, "MEDIA_ID");
                string sLAST_FOUR_DIGITS = dr["LAST_FOUR_DIGITS"].ToString();
                string sCellNum = dr["CELL_PHONE"].ToString();
                string sID = dr["ID"].ToString();
                int nPAYMENT_NUMBER = ODBCWrapper.Utils.GetIntSafeVal(dr, "PAYMENT_NUMBER");
                int nNUMBER_OF_PAYMENTS = ODBCWrapper.Utils.GetIntSafeVal(dr, "NUMBER_OF_PAYMENTS");
                int nBILLING_METHOD = ODBCWrapper.Utils.GetIntSafeVal(dr, "BILLING_METHOD");
                int nBILLING_PROCESSOR = ODBCWrapper.Utils.GetIntSafeVal(dr, "BILLING_PROCESSOR");
                int nNEW_RENEWABLE_STATUS = ODBCWrapper.Utils.GetIntSafeVal(dr, "NEW_RENEWABLE_STATUS");
                int nBILLING_PROVIDER = ODBCWrapper.Utils.GetIntSafeVal(dr, "BILLING_PROVIDER");
                int nBILLING_PROVIDER_REFFERENCE = ODBCWrapper.Utils.GetIntSafeVal(dr, "BILLING_PROVIDER_REFFERENCE");
                int nPURCHASE_ID = ODBCWrapper.Utils.GetIntSafeVal(dr, "PURCHASE_ID");
                string sPrePaidCode = ODBCWrapper.Utils.GetSafeStr(dr, "pre_paid_code");
                string collectionCode = ODBCWrapper.Utils.GetSafeStr(dr, "COLLECTION_CODE");
                string siteGuid = ODBCWrapper.Utils.GetSafeStr(dr, "SITE_GUID");
                string userFullName = ODBCWrapper.Utils.GetSafeStr(dr, "FIRST_NAME") + " " + ODBCWrapper.Utils.GetSafeStr(dr, "LAST_NAME");


                if (nBILLING_PROVIDER == -1)
                {
                    if (nNEW_RENEWABLE_STATUS == 0)
                    {
                        res.m_eBillingAction = BillingAction.CancelSubscriptionOrder;
                    }
                    if (nNEW_RENEWABLE_STATUS == 1)
                    {
                        res.m_eBillingAction = BillingAction.RenewCancledSubscription;
                    }
                }
                else if (nBILLING_PROVIDER == -2)
                {
                    res.m_eBillingAction = BillingAction.SubscriptionDateChanged;
                }
                else
                {
                    if (nPAYMENT_NUMBER == 1)
                    {
                        res.m_eBillingAction = BillingAction.Purchase;
                    }
                    if (nPAYMENT_NUMBER > 1)
                    {
                        res.m_eBillingAction = BillingAction.RenewPayment;
                    }
                }



                if (!string.IsNullOrEmpty(sPrePaidCode))
                {

                    res.m_eItemType = BillingItemsType.PrePaid;

                    PrePaidModule thePrePaid = null;

                    thePrePaid = module.GetPrePaidModuleData(sWSUserName, sWSPass, int.Parse(sPrePaidCode), string.Empty, string.Empty, string.Empty);

                    res.m_sPurchasedItemCode = sPrePaidCode;
                    res.m_sPurchasedItemName = thePrePaid.m_Title;

                }

                if (!string.IsNullOrEmpty(sSubscriptionCode))
                {
                    res.m_eItemType = BillingItemsType.Subscription;


                    Subscription theSub = null;
                    theSub = module.GetSubscriptionData(sWSUserName, sWSPass, sSubscriptionCode, string.Empty, string.Empty, string.Empty, true);

                    string sMainLang = string.Empty;
                    string sMainLangCode = string.Empty;
                    GetMainLang(ref sMainLang, ref sMainLangCode, m_nGroupID);
                    if (theSub.m_sName != null)
                    {
                        Int32 nNameLangLength = theSub.m_sName.Length;
                        for (int j = 0; j < nNameLangLength; j++)
                        {
                            string sLang = theSub.m_sName[j].m_sLanguageCode3;
                            string sVal = theSub.m_sName[j].m_sValue;

                            if (sLang == sMainLangCode)
                            {
                                res.m_sPurchasedItemName = sVal;
                            }
                        }
                    }

                    res.m_sPurchasedItemCode = sSubscriptionCode;

                    res.m_bIsRecurring = theSub.m_bIsRecurring;
                }

                // check if transaction is a collection type
                if (!string.IsNullOrEmpty(collectionCode))
                {
                    // update type
                    res.m_eItemType = BillingItemsType.Collection;


                    // get collection data
                    Collection collection = null;
                    collection = module.GetCollectionData(sWSUserName, sWSPass, collectionCode, string.Empty, string.Empty, string.Empty, true);

                    // get collection name
                    if (collection != null)
                        res.m_sPurchasedItemName = ((PPVModule)collection).m_sObjectVirtualName;

                    res.m_sPurchasedItemCode = collectionCode;
                }

                if (nMediaID != 0)
                {
                    res.m_eItemType = BillingItemsType.PPV;

                    res.m_sPurchasedItemName = GetMediaTitle(nMediaID);
                    res.m_sPurchasedItemCode = nMediaID.ToString();
                }

                PaymentMethod pm = PaymentMethod.Unknown;

                if (nBILLING_PROVIDER == PAYMENT_GATEWAY)
                {
                    res.m_sPaymentMethodExtraDetails = string.Format("{0}:{1}", "PaymentGateway", nBILLING_METHOD.ToString());

                    PaymentGatewayTransaction paymentGatewayTransaction = GetTransactionDetails(nBILLING_PROVIDER_REFFERENCE);

                    if (paymentGatewayTransaction != null)
                    {
                        res.m_sPaymentMethodExtraDetails += string.Format(", PaymentMethod:{0}, PaymentDetails:{1}",
                            paymentGatewayTransaction.PaymentMethod, paymentGatewayTransaction.PaymentDetails);
                    }
                }
                else
                {
                    //if (nBILLING_METHOD >= 1)
                    if (Enum.IsDefined(typeof(PaymentMethod), nBILLING_METHOD))
                    {
                        pm = (PaymentMethod)(nBILLING_METHOD);
                    }

                    if (pm == PaymentMethod.CreditCard || pm == PaymentMethod.Visa || pm == PaymentMethod.MasterCard)
                    {
                        res.m_sPaymentMethodExtraDetails = sLAST_FOUR_DIGITS;
                    }

                    if (pm == PaymentMethod.SMS || pm == PaymentMethod.M1)
                    {
                        res.m_sPaymentMethodExtraDetails = sCellNum;
                    }
                }

                res.m_ePaymentMethod = pm;

                res.m_bIsRecurring = false;

                res.m_sRecieptCode = sID;
                res.m_nBillingProviderRef = nBILLING_PROVIDER_REFFERENCE;
                res.m_nPurchaseID = nPURCHASE_ID;
                res.m_sRemarks = sRemarks;

                //action date
                res.m_dtActionDate = dActionDate;

                //Subscription dates
                if (nPurchaseID != 0)
                {
                    GetPurchaseItemDates(nPurchaseID, ref res.m_dtStartDate, ref res.m_dtEndDate, res.m_eItemType);
                }

                if (!string.IsNullOrEmpty(sCurrencyCode))
                {
                    res.m_Price = new Price();
                    res.m_Price.m_dPrice = dPrice;
                    res.m_Price.m_oCurrency = module.GetCurrencyValues(sWSUserName, sWSPass, sCurrencyCode);
                }

                if (shouldGetExtendedParams)
                {
                    if (!string.IsNullOrEmpty(siteGuid))
                    {
                        res.SiteGuid = siteGuid;
                    }

                    if (!string.IsNullOrEmpty(userFullName))
                    {
                        res.UserFullName = userFullName;
                    }
                }
            }

            catch (Exception ex)
            {
                log.Error("GetBillingTransactionContainerFromDataRow - " + string.Format("DataRow={0}, ex={1} ", dr, ex.Message), ex);
            }

            finally
            {
                if (module != null)
                {
                    module.Dispose();
                }
            }

            return res;
        }

        private PaymentGatewayTransaction GetTransactionDetails(int billingProviderRefference)
        {
            return DAL.BillingDAL.GetPaymentGatewayTransactionByID(billingProviderRefference, BILLING_CONNECTION_STRING);
        }

        /// <summary>
        /// Get User Billing History
        /// </summary>
        public virtual BillingTransactions GetUserBillingHistory(string sUserGUID, Int32 nStartIndex, Int32 nNumberOfItems, TransactionHistoryOrderBy orderBy)
        {
            BillingTransactions res = null;
            try
            {
                DateTime minDate = new DateTime(2000, 1, 1);
                res = GetUserBillingHistoryExt(sUserGUID, minDate, DateTime.MaxValue, nStartIndex, nNumberOfItems, orderBy);
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at GetUserBillingHistory. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sUserGUID));
                sb.Append(String.Concat(" Start Index: ", nStartIndex));
                sb.Append(String.Concat(" Num Of Items: ", nNumberOfItems));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            return res;

        }

        /// <summary>
        /// GetI tems Prices
        /// </summary>
        public virtual MediaFileItemPricesContainer[] GetItemsPrices(Int32[] nMediaFiles, string sUserGUID, bool bOnlyLowest,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            return GetItemsPrices(nMediaFiles, sUserGUID, "", bOnlyLowest, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, "");
        }
        /// <summary>
        /// GetI tems Prices
        /// </summary>
        public virtual MediaFileItemPricesContainer[] GetItemsPrices(Int32[] nMediaFiles, string sUserGUID, bool bOnlyLowest,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sClientIP = null)
        {
            return GetItemsPrices(nMediaFiles, sUserGUID, "", bOnlyLowest, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, sClientIP);
        }
        /// <summary>
        /// Is Subscription Purchased
        /// </summary>
        public virtual bool IsSubscriptionPurchased(string siteGuid, string subID, ref string reason)
        {
            return true;
        }
        /// <summary>
        /// Is Item Permitted
        /// </summary>
        public virtual bool IsItemPermitted(string sSiteGUID, int mediaID)
        {
            return true;
        }

        /// <summary>
        /// Handle Coupon Uses
        /// </summary>
        protected internal virtual void HandleCouponUses(Subscription relevantSub, string sPPVModuleCode,
            string sSiteGUID, double dPrice, string sCurrency,
            Int32 nMediaFileID, string sCouponCode, string sUserIP,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bFromPurchase, int nPrePaidCode, Int32 relevantCollection)
        {
            if (!string.IsNullOrEmpty(sCouponCode))
            {

                if (bFromPurchase == false)
                {
                    double dPercent = Utils.GetCouponDiscountPercent(m_nGroupID, sCouponCode);

                    if (dPercent < 100)
                        return;
                }

                Int32 nSubCode = 0;

                if (relevantSub != null && relevantSub.m_sObjectCode != null && relevantSub.m_sObjectCode != string.Empty)
                {
                    nSubCode = int.Parse(relevantSub.m_sObjectCode);
                }

                //No media_file and no sub --> do nothing
                if (nMediaFileID == 0 && nSubCode == 0 && nPrePaidCode == 0)
                    return;

                string sWSUserName = string.Empty;
                string sWSPass = string.Empty;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);

                mdoule m = null;
                try
                {
                    m = new mdoule();
                    m.SetCouponUses(sWSUserName, sWSPass, sCouponCode, sSiteGUID, nMediaFileID, nSubCode, nPrePaidCode, relevantCollection);
                }
                catch (Exception ex)
                {
                    #region Logging
                    StringBuilder sb = new StringBuilder(String.Concat("Exception message: ", ex.Message));
                    sb.Append(String.Concat(" Relevant Sub ID: ", relevantSub != null ? relevantSub.m_fictivicMediaID.ToString() : "null"));
                    sb.Append(String.Concat(" PPV Module Code: ", sPPVModuleCode));
                    sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                    sb.Append(String.Concat(" Price: ", dPrice));
                    sb.Append(String.Concat(" Currency: ", sCurrency));
                    sb.Append(String.Concat(" Media File ID: ", nMediaFileID));
                    sb.Append(String.Concat(" Coupon Code: ", sCouponCode));
                    sb.Append(String.Concat(" User IP ", sUserIP));
                    sb.Append(String.Concat(" Country Code: ", sCountryCd));
                    sb.Append(String.Concat(" Language Code: ", sLANGUAGE_CODE));
                    sb.Append(String.Concat(" Device Name: ", sDEVICE_NAME));
                    sb.Append(String.Concat(" bFromPurchase: ", bFromPurchase.ToString().ToLower()));
                    sb.Append(String.Concat(" Pre Paid Code: ", nPrePaidCode));
                    sb.Append(String.Concat(" ST: ", ex.StackTrace));
                    log.Debug("HandleCouponUses - " + sb.ToString());
                    #endregion
                }
                finally
                {
                    #region Disposing
                    if (m != null)
                    {
                        m.Dispose();
                        m = null;
                    }
                    #endregion
                }

            }
        }

        /// <summary>
        /// Get CustomData string  
        /// </summary>
        protected internal virtual string GetCustomData(Subscription relevantSub, PPVModule thePPVModule, Campaign campaign,
               string sSiteGUID, double dPrice, string sCurrency,
               Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCampaignCode, string sCouponCode, string sUserIP,
               string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sOverrideEndDate)
        {
            StringBuilder sb = new StringBuilder();
            sb.Append("<customdata type=\"pp\">");
            if (String.IsNullOrEmpty(sCountryCd) == false)
                sb.Append("<lcc>" + sCountryCd + "</lcc>");
            else
            {
                sb.AppendFormat("<lcc>{0}</lcc>", Utils.GetIP2CountryName(m_nGroupID, sUserIP));
            }
            if (String.IsNullOrEmpty(sLANGUAGE_CODE) == false)
                sb.Append("<llc>" + sLANGUAGE_CODE + "</llc>");
            if (String.IsNullOrEmpty(sDEVICE_NAME) == false)
                sb.Append("<ldn>" + sDEVICE_NAME + "</ldn>");
            sb.Append("<rs>");
            if (relevantSub != null)
                sb.Append(relevantSub.m_sObjectCode);
            sb.Append("</rs>");
            sb.Append("<mnou>");
            if (thePPVModule != null && thePPVModule.m_oUsageModule != null)
                sb.Append(thePPVModule.m_oUsageModule.m_nMaxNumberOfViews.ToString());
            sb.Append("</mnou>");
            sb.Append("<mumlc>");
            if (thePPVModule != null && thePPVModule.m_oUsageModule != null)
                sb.Append(thePPVModule.m_oUsageModule.m_tsMaxUsageModuleLifeCycle.ToString());
            sb.Append("</mumlc>");
            sb.Append("<oed>");
            sb.Append(sOverrideEndDate);
            sb.Append("</oed>");
            sb.Append("<u id=\"" + sSiteGUID + "\"/>");
            sb.Append("<mf>");
            sb.Append(nMediaFileID.ToString());
            sb.Append("</mf>");
            sb.Append("<m>");
            sb.Append(nMediaID.ToString());
            sb.Append("</m>");
            sb.Append("<ppvm>");
            sb.Append(sPPVModuleCode);
            sb.Append("</ppvm>");
            sb.Append("<pm></pm>");
            sb.Append("<cc>");
            sb.Append(sCouponCode);
            sb.Append("</cc>");
            sb.Append("<campcode>");
            sb.Append(sCampaignCode);
            sb.Append("</campcode>");
            sb.Append("<cmnov>");
            if (campaign != null && campaign.m_usageModule != null)
            {
                sb.Append(campaign.m_usageModule.m_nMaxNumberOfViews.ToString());
            }
            sb.Append("</cmnov>");
            sb.Append("<cmumlc>");
            if (campaign != null && campaign.m_usageModule != null)
                sb.Append(campaign.m_usageModule.m_tsMaxUsageModuleLifeCycle.ToString());
            sb.Append("</cmumlc>");
            sb.Append("<p ir=\"false\" n=\"1\" o=\"1\"/>");

            sb.Append("<pc>");
            if (thePPVModule != null && thePPVModule.m_oPriceCode != null)
                sb.Append(thePPVModule.m_oPriceCode.m_sCode);
            sb.Append("</pc>");
            sb.Append("<pri>");
            sb.Append(dPrice.ToString());
            sb.Append("</pri>");
            sb.Append("<cu>");
            sb.Append(sCurrency);
            sb.Append("</cu>");
            sb.Append("</customdata>");

            return sb.ToString();
        }

        // Get CustomData string
        protected internal virtual string GetCustomData(Subscription relevantSub, PPVModule thePPVModule, Campaign campaign,
                                               string sSiteGUID, double dPrice, string sCurrency, Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode,
                                               string sCampaignCode, string sCouponCode, string sUserIP, string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            return GetCustomData(relevantSub, thePPVModule, campaign, sSiteGUID, dPrice, sCurrency, nMediaFileID, nMediaID, sPPVModuleCode,
                                 sCampaignCode, sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty);
        }

        /// <summary>
        /// Get Custom Data For Pre Paid
        /// </summary>
        protected virtual string GetCustomDataForPrePaid(PrePaidModule thePrePaidModule, Campaign campaign, string sPrePaidCode, string sCampaignCode,
        string sSiteGUID, double dPrice, string sCurrency, string sCouponCode, string sUserIP,
        string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sOverrideEndDate)
        {
            bool bIsFixed = thePrePaidModule.m_isFixedCredit;
            StringBuilder sb = new StringBuilder();
            sb.Append("<customdata type=\"prepaid\">");
            if (String.IsNullOrEmpty(sCountryCd) == false)
            {
                sb.Append("<lcc>" + sCountryCd + "</lcc>");
            }
            else
            {
                sb.AppendFormat("<lcc>{0}</lcc>", Utils.GetIP2CountryName(m_nGroupID, sUserIP));
            }

            if (String.IsNullOrEmpty(sLANGUAGE_CODE) == false)
                sb.Append("<llc>" + sLANGUAGE_CODE + "</llc>");
            if (String.IsNullOrEmpty(sDEVICE_NAME) == false)
                sb.Append("<ldn>" + sDEVICE_NAME + "</ldn>");
            sb.Append("<mnou>");
            if (thePrePaidModule != null && thePrePaidModule.m_UsageModule != null)
                sb.Append(thePrePaidModule.m_UsageModule.m_nMaxNumberOfViews.ToString());
            sb.Append("</mnou>");
            sb.Append("<u id=\"" + sSiteGUID + "\"/>");
            sb.AppendFormat("<up>{0}</up>", sUserIP);
            sb.AppendFormat("<pp>{0}</pp>", sPrePaidCode);
            sb.AppendFormat("<cc>{0}</cc>", sCouponCode);
            sb.Append("<if if=\"" + bIsFixed.ToString().ToLower() + "\"/>");
            sb.Append("<vlcs>");
            if (thePrePaidModule != null && thePrePaidModule.m_UsageModule != null)
                sb.Append(thePrePaidModule.m_UsageModule.m_tsViewLifeCycle.ToString());
            sb.Append("</vlcs>");
            sb.Append("<mumlc>");
            if (thePrePaidModule != null && thePrePaidModule.m_UsageModule != null)
                sb.Append(thePrePaidModule.m_UsageModule.m_tsMaxUsageModuleLifeCycle.ToString());
            sb.Append("</mumlc>");
            sb.Append("<oed>");
            sb.Append(sOverrideEndDate);
            sb.Append("</oed>");
            sb.Append("<ppvm>");
            sb.Append("</ppvm>");
            sb.Append("<pm></pm>");
            sb.Append("<pc>");
            if (thePrePaidModule != null && thePrePaidModule.m_PriceCode != null)
                sb.Append(thePrePaidModule.m_PriceCode.m_sCode);
            sb.Append("</pc>");
            sb.Append("<cvpc>");
            if (thePrePaidModule != null && thePrePaidModule.m_CreditValue != null)
                sb.Append(thePrePaidModule.m_CreditValue.m_sCode);
            sb.Append("</cvpc>");
            sb.AppendFormat("<pri>{0}</pri>", dPrice.ToString());
            sb.Append("<cpri>");
            if (thePrePaidModule != null && thePrePaidModule.m_CreditValue != null)
                sb.Append(thePrePaidModule.m_CreditValue.m_oPrise.m_dPrice.ToString());

            sb.Append("</cpri>");
            sb.AppendFormat("<campcode>{0}</campcode>", sCampaignCode);
            sb.Append("<cmnov>");
            if (campaign != null && campaign.m_usageModule != null)
            {
                sb.Append(campaign.m_usageModule.m_tsMaxUsageModuleLifeCycle.ToString());
            }
            sb.Append("</cmnov>");
            sb.Append("<cmumlc>");
            if (campaign != null && campaign.m_usageModule != null)
                sb.Append(campaign.m_usageModule.m_tsMaxUsageModuleLifeCycle.ToString());
            sb.Append("</cmumlc>");
            sb.AppendFormat("<cu>{0}</cu>", sCurrency);
            sb.Append("</customdata>");

            return sb.ToString();

        }

        protected virtual string GetCustomDataForPrePaid(PrePaidModule thePrePaidModule, Campaign campaign, string sPrePaidCode, string sCampaignCode,
           string sSiteGUID, double dPrice, string sCurrency, string sCouponCode, string sUserIP,
           string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            return GetCustomDataForPrePaid(thePrePaidModule, campaign, sPrePaidCode, sCampaignCode,
           sSiteGUID, dPrice, sCurrency, sCouponCode, sUserIP,
           sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty);
        }
        /// <summary>
        /// Get Custom Data For Subscription
        /// </summary>
        protected internal virtual string GetCustomDataForSubscription(Subscription theSub, Campaign campaign, string sSubscriptionCode, string sCampaignCode, string sSiteGUID,
            double dPrice, string sCurrency, string sCouponCode, string sUserIP, string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sOverrideEndDate, string sPreviewModuleID,
            bool previewEntitled, bool isDummy = false, int recurringNumber = 0, bool saveHistory = false)
        {
            bool bIsRecurring = theSub.m_bIsRecurring;

            Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;
            StringBuilder sb = new StringBuilder();
            sb.Append("<customdata type=\"sp\">");
            if (String.IsNullOrEmpty(sCountryCd) == false)
            {
                sb.AppendFormat("<lcc>{0}</lcc>", sCountryCd);
            }
            else
            {
                sb.AppendFormat("<lcc>{0}</lcc>", Utils.GetIP2CountryName(m_nGroupID, sUserIP));
            }
            if (String.IsNullOrEmpty(sLANGUAGE_CODE) == false)
            {
                sb.AppendFormat("<llc>{0}</llc>", sLANGUAGE_CODE);
            }
            if (String.IsNullOrEmpty(sDEVICE_NAME) == false)
            {
                sb.AppendFormat("<ldn>{0}</ldn>", sDEVICE_NAME);
            }
            sb.Append("<mnou>");
            if (theSub != null && theSub.m_oUsageModule != null)
            {
                sb.Append(theSub.m_oUsageModule.m_nMaxNumberOfViews.ToString());
            }
            sb.Append("</mnou>");
            sb.AppendFormat("<u id=\"{0}\"/>", sSiteGUID);
            sb.AppendFormat("<s>{0}</s>", sSubscriptionCode);
            sb.AppendFormat("<cc>{0}</cc>", sCouponCode);
            sb.AppendFormat("<campcode>{0}</campcode>", sCampaignCode);
            sb.Append("<cmnov>");
            if (campaign != null && campaign.m_usageModule != null)
            {
                sb.Append(campaign.m_usageModule.m_tsMaxUsageModuleLifeCycle.ToString());
            }
            sb.Append("</cmnov>");
            sb.Append("<cmumlc>");
            if (campaign != null && campaign.m_usageModule != null)
            {
                sb.Append(campaign.m_usageModule.m_tsMaxUsageModuleLifeCycle.ToString());
            }
            sb.Append("</cmumlc>");
            sb.Append("<oed>");
            sb.Append(sOverrideEndDate);
            sb.Append("</oed>");
            sb.AppendFormat("<p ir=\"{0}\" n=\"1\" o=\"{1}\"/>", /*bIsRecurring.ToString().ToLower()*/ GetIsRecurringStrForSubscriptionCustomData(bIsRecurring, sPreviewModuleID), nRecPeriods.ToString());
            sb.Append("<vlcs>");
            if (theSub != null && theSub.m_oUsageModule != null)
            {
                sb.Append(theSub.m_oUsageModule.m_tsViewLifeCycle.ToString());
            }
            sb.Append("</vlcs>");
            sb.Append("<mumlc>");
            if (theSub != null && theSub.m_oSubscriptionUsageModule != null)
                sb.Append(theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle.ToString());
            sb.Append("</mumlc>");
            sb.Append("<ppvm>");
            sb.Append("</ppvm>");
            sb.Append(String.Concat("<pm>", sPreviewModuleID, "</pm>"));
            sb.Append("<pc>");
            if (theSub != null && theSub.m_oSubscriptionPriceCode != null)
                sb.Append(theSub.m_oSubscriptionPriceCode.m_sCode);
            sb.Append("</pc>");
            sb.Append("<pri>");
            sb.Append(dPrice.ToString());
            sb.Append("</pri>");
            sb.Append("<cu>");
            sb.Append(sCurrency);
            sb.Append("</cu>");
            if (theSub != null && theSub.m_oPreviewModule != null && theSub.m_oPreviewModule.m_tsFullLifeCycle > 0 && previewEntitled)
            {
                sb.Append("<prevlc>");
                sb.Append(theSub.m_oPreviewModule.m_tsFullLifeCycle);
                sb.Append("</prevlc>");
            }
            if (isDummy)
            {
                sb.Append(string.Format("<{0}>1</{0}>", DUMMY));
                sb.Append(string.Format("<{0}>{1}</{0}>", RECURRING_NUMBER, recurringNumber));
                if (saveHistory)
                {
                    sb.Append(string.Format("<{0}>1</{0}>", HISTORY));
                }
            }

            sb.Append("</customdata>");
            return sb.ToString();
        }

        protected internal virtual string GetCustomDataForCollection(Collection theCol, string sCollectionCode,
    string sSiteGUID, double dPrice, string sCurrency, string sCouponCode, string sUserIP,
    string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, string sOverrideEndDate)
        {
            StringBuilder sb = new StringBuilder();
            sb.Append("<customdata type=\"col\">");
            if (String.IsNullOrEmpty(sCountryCd) == false)
            {
                sb.AppendFormat("<lcc>{0}</lcc>", sCountryCd);
            }
            else
            {
                sb.AppendFormat("<lcc>{0}</lcc>", Utils.GetIP2CountryName(m_nGroupID, sUserIP));
            }
            if (String.IsNullOrEmpty(sLANGUAGE_CODE) == false)
            {
                sb.AppendFormat("<llc>{0}</llc>", sLANGUAGE_CODE);
            }
            if (String.IsNullOrEmpty(sDEVICE_NAME) == false)
            {
                sb.AppendFormat("<ldn>{0}</ldn>", sDEVICE_NAME);
            }
            sb.Append("<mnou>");
            if (theCol != null && theCol.m_oUsageModule != null)
            {
                sb.Append(theCol.m_oUsageModule.m_nMaxNumberOfViews.ToString());
            }
            sb.Append("</mnou>");
            sb.AppendFormat("<u id=\"{0}\"/>", sSiteGUID);
            sb.AppendFormat("<cID>{0}</cID>", sCollectionCode);
            sb.AppendFormat("<cc>{0}</cc>", sCouponCode);
            sb.Append("<oed>");
            sb.Append(sOverrideEndDate);
            sb.Append("</oed>");
            sb.Append("<vlcs>");
            if (theCol != null && theCol.m_oUsageModule != null)
            {
                sb.Append(theCol.m_oUsageModule.m_tsViewLifeCycle.ToString());
            }
            sb.Append("</vlcs>");
            sb.Append("<mumlc>");
            if (theCol != null && theCol.m_oCollectionUsageModule != null)
                sb.Append(theCol.m_oCollectionUsageModule.m_tsMaxUsageModuleLifeCycle.ToString());
            sb.Append("</mumlc>");
            sb.Append("<ppvm>");
            sb.Append("</ppvm>");
            sb.Append("<pc>");
            if (theCol != null && theCol.m_oCollectionPriceCode != null)
                sb.Append(theCol.m_oCollectionPriceCode.m_sCode);
            sb.Append("</pc>");
            sb.Append("<pri>");
            sb.Append(dPrice.ToString());
            sb.Append("</pri>");
            sb.Append("<cu>");
            sb.Append(sCurrency);
            sb.Append("</cu>");
            sb.Append("</customdata>");
            return sb.ToString();

        }

        protected virtual string GetCustomDataForSubscription(Subscription theSub, Campaign campaign, string sSubscriptionCode, string sCampaignCode,
   string sSiteGUID, double dPrice, string sCurrency, string sCouponCode, string sUserIP,
   string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {

            return GetCustomDataForSubscription(theSub, campaign, sSubscriptionCode, sCampaignCode,
           sSiteGUID, dPrice, sCurrency, sCouponCode, sUserIP,
           sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty, string.Empty, false);

        }

        public virtual PrePaidResponse PP_ChargeUserForMediaFile(string sSiteGUID, double dPrice, string sCurrency, Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sUserIP, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            return PP_BaseChargeUserForMediaFile(sSiteGUID, dPrice, sCurrency, nMediaFileID, nMediaID, sPPVModuleCode, sCouponCode, sUserIP, sExtraParameters, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
        }
        /// <summary>
        /// PP Base Charge User For Media File
        /// </summary>
        protected PrePaidResponse PP_BaseChargeUserForMediaFile(string sSiteGUID, double dPrice, string sCurrency,
            Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sUserIP, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {

            PrePaidResponse ret = new PrePaidResponse();
            ret.m_oStatus = PrePaidResponseStatus.UnKnown;
            ret.m_sStatusDescription = "";
            API apiWs = null;
            UsersService u = null;
            mdoule m = null;
            ODBCWrapper.InsertQuery insertQuery = null;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            try
            {

                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    ret.m_oStatus = PrePaidResponseStatus.UnKnownUser;
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                    return ret;
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = PrePaidResponseStatus.UnKnownUser;
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                        return ret;
                    }
                    else if (uObj != null && uObj.m_user != null && uObj.m_user.m_eSuspendState == DomainSuspentionStatus.Suspended)
                    {
                        ret.m_oStatus = PrePaidResponseStatus.UserSuspended;
                        ret.m_sStatusDescription = "Cannot charge a suspended user";
                        WriteToUserLog(sSiteGUID, "while trying to purchase media file id(PP): " + nMediaFileID + " error returned: " + ret.m_sStatusDescription);
                        return ret;
                    }
                    else
                    {
                        int domainId = uObj.m_user.m_domianID;
                        //Get User Valid PP
                        UserPrePaidContainer userPPs = new UserPrePaidContainer();
                        userPPs.Initialize(sSiteGUID, sCurrency);

                        sWSUserName = "";
                        sWSPass = "";

                        m = new mdoule();
                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        if (string.IsNullOrEmpty(sPPVModuleCode))
                        {
                            ret.m_oStatus = PrePaidResponseStatus.Fail;
                            ret.m_sStatusDescription = "Charge must have ppv module code";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }
                        // chack if ppvModule related to mediaFile 
                        long ppvModuleCode = 0;
                        long.TryParse(sPPVModuleCode, out ppvModuleCode);

                        PPVModule thePPVModule = m.ValidatePPVModuleForMediaFile(sWSUserName, sWSPass, nMediaFileID, ppvModuleCode);
                        if (thePPVModule == null)
                        {
                            ret.m_oStatus = PrePaidResponseStatus.Fail;
                            ret.m_sStatusDescription = "The ppv module is unknown";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }
                        else if (thePPVModule.m_sObjectCode != ppvModuleCode.ToString() && !string.IsNullOrEmpty(sPPVModuleCode))
                        {
                            ret.m_oStatus = PrePaidResponseStatus.UnKnownPPVModule;
                            ret.m_sStatusDescription = "This PPVModule does not belong to item";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }


                        PriceReason theReason = PriceReason.UnKnown;
                        Subscription relevantSub = null;
                        Collection relevantCol = null;
                        PrePaidModule relevantPP = null;


                        Price p = Utils.GetMediaFileFinalPriceForNonGetItemsPrices(nMediaFileID, thePPVModule, sSiteGUID, sCouponCode, m_nGroupID, ref theReason, ref relevantSub, ref relevantCol, ref relevantPP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        if (theReason == PriceReason.ForPurchase || (theReason == PriceReason.SubscriptionPurchased && p.m_dPrice > 0))
                        {
                            if ((p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency))
                            {
                                if (p.m_dPrice != 0)
                                {
                                    //Check For Credit
                                    if (p.m_dPrice <= userPPs.m_nTotalAmount - userPPs.m_nAmountUsed)
                                    {

                                        if (string.IsNullOrEmpty(sCountryCd) && !string.IsNullOrEmpty(sUserIP))
                                        {
                                            sCountryCd = Utils.GetIP2CountryName(m_nGroupID, sUserIP);
                                        }

                                        //Create the Custom Data
                                        string sCustomData = GetCustomData(relevantSub, thePPVModule, null, sSiteGUID, dPrice, sCurrency,
                                            nMediaFileID, nMediaID, sPPVModuleCode, string.Empty, sCouponCode, sUserIP,
                                            sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                                        HandleCouponUses(relevantSub, sPPVModuleCode, sSiteGUID, p.m_dPrice, sCurrency, nMediaFileID, sCouponCode,
                                            sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, true, 0, 0);

                                        insertQuery = new ODBCWrapper.InsertQuery("ppv_purchases");
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                                        if (relevantSub != null)
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", relevantSub.m_sObjectCode);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MEDIA_FILE_ID", "=", nMediaFileID);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DOMAIN_ID", "=", domainId);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("PRICE", "=", dPrice);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("CURRENCY_CD", "=", sCurrency);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("NUM_OF_USES", "=", 0);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("CUSTOMDATA", "=", sCustomData);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("BILLING_TRANSACTION_ID", "=", 0);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("COUNTRY_CODE", "=", sCountryCd);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("LANGUAGE_CODE", "=", sLANGUAGE_CODE);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DEVICE_NAME", "=", sDEVICE_NAME);
                                        if (thePPVModule != null &&
                                            thePPVModule.m_oUsageModule != null)
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", thePPVModule.m_oUsageModule.m_nMaxNumberOfViews);
                                        else
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", 0);

                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);
                                        if (thePPVModule != null &&
                                            thePPVModule.m_oUsageModule != null)
                                        {
                                            DateTime d = Utils.GetEndDateTime(DateTime.UtcNow, thePPVModule.m_oUsageModule.m_tsMaxUsageModuleLifeCycle);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("END_DATE", "=", d);
                                        }
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("rel_pp", "=", userPPs.m_oUserPPs[0].m_nPPModuleID);

                                        insertQuery.Execute();

                                        Int32 nPurchaseID = 0;
                                        selectQuery = new ODBCWrapper.DataSetSelectQuery();
                                        selectQuery += " select id from ppv_purchases where ";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                                        if (relevantSub != null)
                                        {
                                            selectQuery += "and";
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", relevantSub.m_sObjectCode);
                                        }
                                        selectQuery += "and";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("MEDIA_FILE_ID", "=", nMediaFileID);
                                        selectQuery += "and";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                                        selectQuery += "and";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("PRICE", "=", dPrice);
                                        selectQuery += "and";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("CURRENCY_CD", "=", sCurrency);
                                        selectQuery += "and";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("NUM_OF_USES", "=", 0);
                                        selectQuery += "and";
                                        if (thePPVModule != null &&
                                            thePPVModule.m_oUsageModule != null)
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", thePPVModule.m_oUsageModule.m_nMaxNumberOfViews);
                                        else
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", 0);
                                        selectQuery += "and";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                                        selectQuery += "and";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);
                                        selectQuery += "and";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("rel_pp", "=", userPPs.m_oUserPPs[0].m_nPPModuleID);
                                        selectQuery += "order by id desc";
                                        if (selectQuery.Execute("query", true) != null)
                                        {
                                            Int32 nCount1 = selectQuery.Table("query").DefaultView.Count;
                                            if (nCount1 > 0)
                                                nPurchaseID = int.Parse(selectQuery.Table("query").DefaultView[0].Row["id"].ToString());
                                        }


                                        double sum = 0;
                                        double credit = (userPPs.m_nTotalAmount - userPPs.m_nAmountUsed);

                                        double dMaxAmount = 0.0;
                                        Int32 nRelPrePaidID = 0;

                                        foreach (UserPrePaidObject uppo in userPPs.m_oUserPPs)
                                        {
                                            double diff = p.m_dPrice - sum;
                                            if ((uppo.m_nTotalAmount - uppo.m_nAmountUsed) < diff)
                                            {
                                                diff = (uppo.m_nTotalAmount - uppo.m_nAmountUsed);
                                            }

                                            if (diff > dMaxAmount)
                                            {
                                                dMaxAmount = diff;
                                                nRelPrePaidID = uppo.m_nPPModuleID;
                                            }

                                            credit -= diff;
                                            UpdatePPPurchase(uppo.m_nPPPurchaseID, diff, uppo.m_nAmountUsed);
                                            InsertPPUsesRecord(nPurchaseID, nMediaFileID, BillingItemsType.PPV, sSiteGUID, sCurrency, uppo.m_nPPModuleID, uppo.m_nPPPurchaseID, diff, credit, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                                            sum += diff;

                                            if (sum == p.m_dPrice)
                                            {
                                                ret.m_oStatus = PrePaidResponseStatus.Success;

                                                updateQuery = new ODBCWrapper.UpdateQuery("ppv_purchases");
                                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("rel_pp", "=", nRelPrePaidID);
                                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("update_date", "=", DateTime.Now);
                                                updateQuery += "where";
                                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nPurchaseID);
                                                updateQuery.Execute();

                                                break;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        ret.m_oStatus = PrePaidResponseStatus.NoCredit;
                                    }

                                }
                                if (ret.m_oStatus == PrePaidResponseStatus.Success)
                                {
                                    WriteToUserLog(sSiteGUID, "Media file id: " + nMediaFileID.ToString() + " Purchased(PP): " + dPrice.ToString() + sCurrency);
                                    //send purchase mail
                                    string sEmail = "";
                                    string sPaymentMethod = "Pre Paid";
                                    string sDateOfPurchase = GetDateSTRByGroup(DateTime.UtcNow, m_nGroupID);
                                    string sItemName = ODBCWrapper.Utils.GetTableSingleVal("media", "name", nMediaID, "MAIN_CONNECTION_STRING").ToString();

                                    PurchaseMailRequest sMailReq = GetPurchaseMailRequest(ref sEmail, sSiteGUID, sItemName, sPaymentMethod, sDateOfPurchase, string.Empty, dPrice, sCurrency, m_nGroupID);
                                    apiWs = new API();
                                    string sAPIWSUserName = string.Empty;
                                    string sAPIWSPass = string.Empty;
                                    Utils.GetWSCredentials(m_nGroupID, eWSModules.API, ref sWSUserName, ref sWSPass);

                                    apiWs.SendMailTemplate(sAPIWSUserName, sWSPass, sMailReq);
                                }
                                else
                                {
                                    ret.m_sStatusDescription = "No Credit";
                                    WriteToUserLog(sSiteGUID, "While trying to purchase media file id(PP): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                                }
                            }
                            else
                            {
                                ret.m_oStatus = PrePaidResponseStatus.PriceNotCorrect;
                                ret.m_sStatusDescription = "The price of the request is not the actual price";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(PP): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.PPVPurchased)
                            {
                                ret.m_oStatus = PrePaidResponseStatus.Fail;
                                ret.m_sStatusDescription = "The media file is already purchased";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(PP): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                            else if (theReason == PriceReason.Free)
                            {
                                ret.m_oStatus = PrePaidResponseStatus.Fail;
                                ret.m_sStatusDescription = "The media file is free";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(PP): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                            else if (theReason == PriceReason.ForPurchaseSubscriptionOnly)
                            {
                                ret.m_oStatus = PrePaidResponseStatus.Fail;
                                ret.m_sStatusDescription = "The media file is for purchase with subscription only";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(PP): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                            else if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                ret.m_oStatus = PrePaidResponseStatus.Fail;
                                ret.m_sStatusDescription = "The media file is already purchased (subscription)";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(PP): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                            else if (theReason == PriceReason.NotForPurchase)
                            {
                                ret.m_oStatus = PrePaidResponseStatus.Fail;
                                ret.m_sStatusDescription = "The media file is not valid for purchased";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(PP): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at PP_BaseChargeUserForMediaFile. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" M ID: ", nMediaID));
                sb.Append(String.Concat(" MF ID: ", nMediaFileID));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                if (u != null)
                {
                    u.Dispose();
                }
                if (apiWs != null)
                {
                    apiWs.Dispose();
                }
                if (m != null)
                {
                    m.Dispose();
                }
                if (insertQuery != null)
                {
                    insertQuery.Finish();
                }
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
            }
            return ret;
        }
        /// <summary>
        /// PP Charge User For Subscription
        /// </summary>
        public virtual PrePaidResponse PP_ChargeUserForSubscription(string sSiteGUID, double dPrice, string sCurrency, string sSubscriptionCode, string sCouponCode, string sUserIP, string sExtraParams,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            return PP_BaseChargeUserForSubscription(sSiteGUID, dPrice, sCurrency, sSubscriptionCode, sCouponCode, sUserIP, sExtraParams, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
        }
        /// <summary>
        /// PP Base Charge User For Subscription
        /// </summary>
        protected PrePaidResponse PP_BaseChargeUserForSubscription(string sSiteGUID, double dPrice, string sCurrency, string sSubscriptionCode, string sCouponCode, string sUserIP, string sExtraParams,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            //string sCouponCode = "";
            PrePaidResponse ret = new PrePaidResponse();
            UsersService u = null;
            ODBCWrapper.UpdateQuery updateQuery1 = null;
            ODBCWrapper.InsertQuery insertQuery = null;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            ODBCWrapper.UpdateQuery updateQuery = null;
            try
            {
                if (string.IsNullOrEmpty(sSiteGUID))
                {
                    ret.m_oStatus = PrePaidResponseStatus.UnKnownUser;
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = PrePaidResponseStatus.UnKnownUser;
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                    }
                    else if (uObj != null && uObj.m_user != null && uObj.m_user.m_eSuspendState == DomainSuspentionStatus.Suspended)
                    {
                        ret.m_oStatus = PrePaidResponseStatus.UserSuspended;
                        ret.m_sStatusDescription = "Cannot charge a suspended user";
                        WriteToUserLog(sSiteGUID, "while trying to purchase subscription(PP): " + sSubscriptionCode + " error returned: " + ret.m_sStatusDescription);
                    }
                    else
                    {
                        int domainId = uObj.m_user.m_domianID;
                        //Get User Valid PP
                        UserPrePaidContainer userPPs = new UserPrePaidContainer();
                        userPPs.Initialize(sSiteGUID, sCurrency);

                        //UserPrePaidObject relUppo = null; 

                        PriceReason theReason = PriceReason.UnKnown;
                        Subscription theSub = null;
                        Price p = Utils.GetSubscriptionFinalPrice(m_nGroupID, sSubscriptionCode, sSiteGUID, sCouponCode, ref theReason, ref theSub, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        if (p != null)
                        {
                            dPrice = p.m_dPrice;
                            sCurrency = p.m_oCurrency.m_sCurrencyCD3;
                        }
                        if (theReason == PriceReason.ForPurchase)
                        {
                            if ((p != null && p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency))
                            {
                                if (p.m_dPrice != 0)
                                {
                                    bool bIsRecurring = theSub.m_bIsRecurring;
                                    Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;

                                    //Check For Credit
                                    if (p.m_dPrice <= userPPs.m_nTotalAmount - userPPs.m_nAmountUsed)
                                    {

                                        if (string.IsNullOrEmpty(sCountryCd) && !string.IsNullOrEmpty(sUserIP))
                                        {
                                            sCountryCd = Utils.GetIP2CountryName(m_nGroupID, sUserIP);
                                        }

                                        HandleCouponUses(theSub, string.Empty, sSiteGUID, dPrice, sCurrency, 0, sCouponCode, sUserIP,
                                            sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, true, 0, 0);

                                        updateQuery1 = new ODBCWrapper.UpdateQuery("subscriptions_purchases");
                                        updateQuery1 += ODBCWrapper.Parameter.NEW_PARAM("IS_RECURRING_STATUS", "=", 0);
                                        updateQuery1 += " where ";
                                        updateQuery1 += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                                        updateQuery1 += " and ";
                                        updateQuery1 += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubscriptionCode);
                                        updateQuery1 += " and ";
                                        updateQuery1 += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                                        updateQuery1.Execute();

                                        insertQuery = new ODBCWrapper.InsertQuery("subscriptions_purchases");
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubscriptionCode);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DOMAIN_ID", "=", domainId);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("PRICE", "=", dPrice);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("CURRENCY_CD", "=", sCurrency);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("CUSTOMDATA", "=", string.Empty);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("NUM_OF_USES", "=", 0);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("COUNTRY_CODE", "=", sCountryCd);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("LANGUAGE_CODE", "=", sLANGUAGE_CODE);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DEVICE_NAME", "=", sDEVICE_NAME);
                                        if (theSub != null &&
                                            theSub.m_oUsageModule != null)
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", theSub.m_oUsageModule.m_nMaxNumberOfViews);
                                        else
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", 0);

                                        if (theSub != null &&
                                            theSub.m_oUsageModule != null)
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("VIEW_LIFE_CYCLE_SECS", "=", theSub.m_oUsageModule.m_tsViewLifeCycle);
                                        else
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("VIEW_LIFE_CYCLE_SECS", "=", 0);

                                        if (bIsRecurring == true)
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_RECURRING_STATUS", "=", 1);
                                        else
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_RECURRING_STATUS", "=", 0);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("BILLING_TRANSACTION_ID", "=", 0);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);
                                        if (theSub != null &&
                                            theSub.m_oSubscriptionUsageModule != null)
                                        {
                                            DateTime d = Utils.GetEndDateTime(DateTime.UtcNow, theSub.m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle);
                                            insertQuery += ODBCWrapper.Parameter.NEW_PARAM("END_DATE", "=", d);

                                        }
                                        insertQuery += ODBCWrapper.Parameter.NEW_PARAM("rel_pp", "=", userPPs.m_oUserPPs[0].m_nPPModuleID);
                                        insertQuery.Execute();


                                        Int32 nPurchaseID = 0;

                                        selectQuery = new ODBCWrapper.DataSetSelectQuery();
                                        selectQuery += " select id from subscriptions_purchases where ";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                                        selectQuery += " and ";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SUBSCRIPTION_CODE", "=", sSubscriptionCode);
                                        selectQuery += " and ";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                                        selectQuery += " and ";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("PRICE", "=", dPrice);
                                        selectQuery += " and ";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("CURRENCY_CD", "=", sCurrency);
                                        selectQuery += " and ";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("NUM_OF_USES", "=", 0);
                                        selectQuery += " and ";
                                        if (theSub != null &&
                                            theSub.m_oUsageModule != null)
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", theSub.m_oUsageModule.m_nMaxNumberOfViews);
                                        else
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("MAX_NUM_OF_USES", "=", 0);
                                        selectQuery += " and ";
                                        if (theSub != null &&
                                            theSub.m_oUsageModule != null)
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("VIEW_LIFE_CYCLE_SECS", "=", theSub.m_oUsageModule.m_tsViewLifeCycle);
                                        else
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("VIEW_LIFE_CYCLE_SECS", "=", 0);

                                        selectQuery += " and ";
                                        if (bIsRecurring == true)
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_RECURRING_STATUS", "=", 1);
                                        else
                                            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_RECURRING_STATUS", "=", 0);
                                        selectQuery += " and ";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                                        selectQuery += " and ";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);
                                        selectQuery += " and ";
                                        selectQuery += ODBCWrapper.Parameter.NEW_PARAM("rel_pp", "=", userPPs.m_oUserPPs[0].m_nPPModuleID);
                                        selectQuery += " order by id desc";
                                        if (selectQuery.Execute("query", true) != null)
                                        {
                                            Int32 nCount = selectQuery.Table("query").DefaultView.Count;
                                            if (nCount > 0)
                                            {
                                                nPurchaseID = int.Parse(selectQuery.Table("query").DefaultView[0].Row["id"].ToString());
                                            }
                                        }

                                        double sum = 0;
                                        double credit = (userPPs.m_nTotalAmount - userPPs.m_nAmountUsed);

                                        double dMaxAmount = 0.0;
                                        Int32 nRelPrePaidID = 0;

                                        foreach (UserPrePaidObject uppo in userPPs.m_oUserPPs)
                                        {

                                            double diff = p.m_dPrice - sum;
                                            if ((uppo.m_nTotalAmount - uppo.m_nAmountUsed) < diff)
                                            {
                                                diff = (uppo.m_nTotalAmount - uppo.m_nAmountUsed);
                                            }

                                            if (diff > dMaxAmount)
                                            {
                                                dMaxAmount = diff;
                                                nRelPrePaidID = uppo.m_nPPModuleID;
                                            }

                                            credit -= diff;
                                            UpdatePPPurchase(uppo.m_nPPPurchaseID, diff, uppo.m_nAmountUsed);
                                            InsertPPUsesRecord(nPurchaseID, int.Parse(sSubscriptionCode), BillingItemsType.Subscription, sSiteGUID, sCurrency, uppo.m_nPPModuleID, uppo.m_nPPPurchaseID, diff, credit, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);

                                            sum += diff;

                                            if (sum == p.m_dPrice)
                                            {
                                                ret.m_oStatus = PrePaidResponseStatus.Success;

                                                updateQuery = new ODBCWrapper.UpdateQuery("subscriptions_purchases");
                                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("rel_pp", "=", nRelPrePaidID);
                                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("update_date", "=", DateTime.Now);
                                                updateQuery += "where";
                                                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nPurchaseID);
                                                updateQuery.Execute();

                                                break;
                                            }
                                        }

                                    }
                                    else
                                    {
                                        ret.m_oStatus = PrePaidResponseStatus.NoCredit;
                                    }
                                }
                                if (ret.m_oStatus == PrePaidResponseStatus.Success)
                                {
                                    WriteToUserLog(sSiteGUID, "Subscription purchase (PP): " + sSubscriptionCode);
                                }
                                else
                                {
                                    ret.m_sStatusDescription = "No Credit";
                                    WriteToUserLog(sSiteGUID, "while trying to purchase subscription(PP): " + sSubscriptionCode + " error returned: " + ret.m_sStatusDescription);
                                }
                            }
                            else
                            {
                                ret.m_oStatus = PrePaidResponseStatus.PriceNotCorrect;
                                ret.m_sStatusDescription = "The price of the request is not the actual price";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(PP): " + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.Free)
                            {
                                ret.m_oStatus = PrePaidResponseStatus.Fail;
                                ret.m_sStatusDescription = "The subscription is free";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(PP): " + " error returned: " + ret.m_sStatusDescription);
                            }
                            if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                ret.m_oStatus = PrePaidResponseStatus.Fail;
                                ret.m_sStatusDescription = "The subscription is already purchased";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(PP): " + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at PP_BaseChargeUserForSubscription. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Price: ", dPrice));
                sb.Append(String.Concat(" Currency: ", sCurrency));
                sb.Append(String.Concat(" Sub Cd: ", sSubscriptionCode));
                sb.Append(String.Concat(" User IP: ", sUserIP));
                sb.Append(String.Concat(" Extra Params: ", sExtraParams));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                }
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
                if (insertQuery != null)
                {
                    insertQuery.Finish();
                }
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
                if (updateQuery1 != null)
                {
                    updateQuery1.Finish();
                }
                #endregion
            }
            return ret;
        }
        /// <summary>
        /// Get User Pre Paid Status
        /// </summary>
        public virtual UserPrePaidContainer GetUserPrePaidStatus(string sSiteGUID, string sCurrency)
        {
            UserPrePaidContainer UserPPs = new UserPrePaidContainer();
            UserPPs.Initialize(sSiteGUID, sCurrency);
            return UserPPs;
        }
        /// <summary>
        /// Update PP Purchase
        /// </summary>
        private void UpdatePPPurchase(Int32 nPPPurchaseID, double nAmount, double nUsed)
        {
            ODBCWrapper.UpdateQuery updateQuery = null;
            try
            {
                updateQuery = new ODBCWrapper.UpdateQuery("pre_paid_purchases");
                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("amount_used", "=", nUsed + nAmount);
                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("update_date", "=", DateTime.Now);
                updateQuery += "where";
                updateQuery += ODBCWrapper.Parameter.NEW_PARAM("ID", "=", nPPPurchaseID);
                updateQuery.Execute();
            }
            finally
            {
                if (updateQuery != null)
                {
                    updateQuery.Finish();
                }
            }

        }
        /// <summary>
        /// Insert PP Uses Record
        /// </summary>
        private void InsertPPUsesRecord(Int32 nPurchaseID, Int32 nItemID, BillingItemsType eItemType, string sSiteGUID, string sCurrency, Int32 nPPCD, Int32 nPPPurchaseID,
            double dPrice, double dCredit,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            ODBCWrapper.InsertQuery insertQuery = null;
            try
            {
                insertQuery = new ODBCWrapper.InsertQuery("pre_paid_uses");
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);

                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("ITEM_ID", "=", nItemID);
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("ITEM_TYPE", "=", (int)eItemType);

                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("PRICE", "=", dPrice);
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("CURRENCY_CD", "=", sCurrency);
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("COUNTRY_CODE", "=", sCountryCd);
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("LANGUAGE_CODE", "=", sLANGUAGE_CODE);
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("DEVICE_UDID", "=", sDEVICE_NAME);

                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("PURCHASE_ID", "=", nPurchaseID);
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("PP_CD", "=", nPPCD);
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("PP_PURCHASE_ID", "=", nPPPurchaseID);
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("REMAINS_CREDIT", "=", dCredit);

                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("IS_ACTIVE", "=", 1);
                insertQuery += ODBCWrapper.Parameter.NEW_PARAM("STATUS", "=", 1);

                insertQuery.Execute();
            }
            finally
            {
                if (insertQuery != null)
                {
                    insertQuery.Finish();
                }
            }

        }
        /// <summary>
        /// Get User PrePaidS History
        /// </summary>
        public virtual PrePaidHistoryResponse GetUserPrePaidSHistory(string sSiteGUID, Int32 nNumberOfItems)
        {
            //Get User Valid PP
            UserPrePaidContainer userPPs = new UserPrePaidContainer();
            userPPs.Initialize(sSiteGUID, string.Empty);

            double dLastCredit = (userPPs.m_nTotalAmount - userPPs.m_nAmountUsed);
            DateTime dLastDate = DateTime.UtcNow;

            PrePaidHistoryResponse theResp = new PrePaidHistoryResponse();


            List<PrePaidHistoryContainer> items = new List<PrePaidHistoryContainer>();
            PrePaidHistoryContainer pphc = null;


            ODBCWrapper.DataSetSelectQuery selectQuery = new ODBCWrapper.DataSetSelectQuery();
            selectQuery += "select top " + nNumberOfItems + " item_id, item_type, currency_cd, SUM(price) as price, min(remains_credit) as remains_credit, MIN(create_date) as date, purchase_id from pre_paid_uses with (nolock) ";
            selectQuery += "where is_active=1 and status=1 and";
            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
            selectQuery += " and ";
            selectQuery += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
            selectQuery += "group by item_id, item_type, currency_cd, purchase_id order by date desc";
            if (selectQuery.Execute("query", true) != null)
            {
                Int32 nCount = selectQuery.Table("query").DefaultView.Count;

                for (int i = 0; i < nCount; i++)
                {
                    Int32 nItemID = ODBCWrapper.Utils.GetIntSafeVal(selectQuery, "item_id", i);
                    Int32 nItemType = ODBCWrapper.Utils.GetIntSafeVal(selectQuery, "item_type", i);
                    string sCurrency = ODBCWrapper.Utils.GetStrSafeVal(selectQuery, "currency_cd", i);
                    double dPrice = ODBCWrapper.Utils.GetDoubleSafeVal(selectQuery, "price", i);
                    double dCredit = ODBCWrapper.Utils.GetDoubleSafeVal(selectQuery, "remains_credit", i);
                    DateTime dDate = ODBCWrapper.Utils.GetDateSafeVal(selectQuery, "date", i);

                    if (dLastCredit != dCredit)
                    {
                        ODBCWrapper.DataSetSelectQuery selectQueryE = new ODBCWrapper.DataSetSelectQuery();
                        selectQueryE += "select * from pre_paid_purchases with (nolock) where is_active=1 and status=1 and";
                        selectQueryE += ODBCWrapper.Parameter.NEW_PARAM("GROUP_ID", "=", m_nGroupID);
                        selectQueryE += " and ";
                        selectQueryE += ODBCWrapper.Parameter.NEW_PARAM("SITE_USER_GUID", "=", sSiteGUID);
                        selectQueryE += " and ";
                        selectQueryE += ODBCWrapper.Parameter.NEW_PARAM("end_date", "<", dLastDate);
                        selectQueryE += " and ";
                        selectQueryE += ODBCWrapper.Parameter.NEW_PARAM("end_date", ">", dDate);
                        selectQueryE += "and total_amount>amount_used order by end_date desc";
                        if (selectQueryE.Execute("query", true) != null)
                        {
                            Int32 nCount1 = selectQueryE.Table("query").DefaultView.Count;
                            for (int j = 0; j < nCount1; j++)
                            {
                                if (items.Count == nNumberOfItems)
                                    break;

                                Int32 nPPID = ODBCWrapper.Utils.GetIntSafeVal(selectQueryE, "pre_paid_module_id", j);
                                double dlostAmount = ODBCWrapper.Utils.GetDoubleSafeVal(selectQueryE, "total_amount", j) - ODBCWrapper.Utils.GetDoubleSafeVal(selectQueryE, "amount_used", j);
                                DateTime dExpired = ODBCWrapper.Utils.GetDateSafeVal(selectQueryE, "end_date", j);

                                pphc = new PrePaidHistoryContainer();

                                pphc.m_oPrice = new Price();
                                pphc.m_oPrice.m_dPrice = dlostAmount;
                                pphc.m_oPrice.m_oCurrency = new Currency();
                                pphc.m_oPrice.m_oCurrency.m_sCurrencyCD2 = sCurrency;

                                pphc.m_oCredit = new Price();
                                pphc.m_oCredit.m_dPrice = dLastCredit;
                                pphc.m_oCredit.m_oCurrency = new Currency();
                                pphc.m_oCredit.m_oCurrency.m_sCurrencyCD2 = sCurrency;

                                pphc.m_dtActionDate = dExpired;

                                pphc.m_eItemType = BillingItemsType.PrePaidExpired;

                                mdoule m = new mdoule();
                                PrePaidModule thePrePaid = null;

                                string sWSUserName = string.Empty;
                                string sWSPass = string.Empty;
                                Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                                thePrePaid = m.GetPrePaidModuleData(sWSUserName, sWSPass, nPPID, string.Empty, string.Empty, string.Empty);

                                pphc.m_sPurchasedItemCode = nPPID.ToString();
                                pphc.m_sPurchasedItemName = thePrePaid.m_Title;

                                items.Add(pphc);

                                dLastCredit += dlostAmount;

                            }
                        }
                        selectQueryE.Finish();
                        selectQueryE = null;

                    }

                    if (items.Count == nNumberOfItems)
                        break;

                    pphc = new PrePaidHistoryContainer();

                    pphc.m_oPrice = new Price();
                    pphc.m_oPrice.m_dPrice = dPrice;
                    pphc.m_oPrice.m_oCurrency = new Currency();
                    pphc.m_oPrice.m_oCurrency.m_sCurrencyCD2 = sCurrency;

                    pphc.m_oCredit = new Price();
                    pphc.m_oCredit.m_dPrice = dCredit;
                    pphc.m_oCredit.m_oCurrency = new Currency();
                    pphc.m_oCredit.m_oCurrency.m_sCurrencyCD2 = sCurrency;

                    pphc.m_dtActionDate = dDate;
                    dLastDate = dDate;


                    pphc.m_eItemType = (BillingItemsType)nItemType;

                    //Case PPV
                    if (pphc.m_eItemType == BillingItemsType.PPV)
                    {

                        Int32 nMediaID = Utils.GetMediaIDFromFileID(nItemID, m_nGroupID);
                        if (nMediaID != 0)
                        {
                            pphc.m_sPurchasedItemName = GetMediaTitle(nMediaID);
                            pphc.m_sPurchasedItemCode = nMediaID.ToString();
                        }
                    }
                    //Case Subscription
                    else if (pphc.m_eItemType == BillingItemsType.Subscription)
                    {
                        pphc.m_eItemType = BillingItemsType.Subscription;

                        mdoule m = new mdoule();
                        Subscription theSub = null;

                        string sWSUserName = string.Empty;
                        string sWSPass = string.Empty;
                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        theSub = m.GetSubscriptionData(sWSUserName, sWSPass, nItemID.ToString(), "", "", "", true);
                        string sMainLang = "";
                        string sMainLangCode = "";
                        GetMainLang(ref sMainLang, ref sMainLangCode, m_nGroupID);
                        if (theSub.m_sName != null)
                        {
                            Int32 nNameLangLength = theSub.m_sName.Length;
                            for (int j = 0; j < nNameLangLength; j++)
                            {
                                string sLang = theSub.m_sName[j].m_sLanguageCode3;
                                string sVal = theSub.m_sName[j].m_sValue;
                                if (sLang == sMainLangCode)
                                    pphc.m_sPurchasedItemName = sVal;
                            }
                        }
                        pphc.m_sPurchasedItemCode = nItemID.ToString();
                    }
                    //Case Pre Paid
                    else if (pphc.m_eItemType == BillingItemsType.PrePaid)
                    {
                        mdoule m = new mdoule();
                        PrePaidModule thePrePaid = null;

                        string sWSUserName = string.Empty;
                        string sWSPass = string.Empty;
                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        thePrePaid = m.GetPrePaidModuleData(sWSUserName, sWSPass, nItemID, string.Empty, string.Empty, string.Empty);
                        pphc.m_sPurchasedItemCode = nItemID.ToString();
                        pphc.m_sPurchasedItemName = thePrePaid.m_Title;

                        pphc.m_oPrice.m_dPrice = -dPrice;
                    }

                    dLastCredit += pphc.m_oPrice.m_dPrice;
                    items.Add(pphc);
                }
            }
            selectQuery.Finish();
            selectQuery = null;

            if (items.Count < nNumberOfItems)
            {
                nNumberOfItems = items.Count;
            }


            theResp.m_nTransactionsCount = nNumberOfItems;
            theResp.m_Transactions = new PrePaidHistoryContainer[nNumberOfItems];
            for (int i = 0; i < nNumberOfItems; i++)
            {
                theResp.m_Transactions[i] = new PrePaidHistoryContainer();
                theResp.m_Transactions[i] = items[i];
            }

            return theResp;
        }
        /// <summary>
        /// Get Item Left View Life Cycle
        /// </summary>
        public virtual string GetItemLeftViewLifeCycle(string sMediaFileID, string sSiteGUID, bool bIsCoGuid,
            string sCOUNTRY_CODE, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {
            string strResponse = TimeSpan.Zero.ToString();

            EntitlementResponse objItemLeftLifeCycle = this.GetEntitlement(sMediaFileID, sSiteGUID, bIsCoGuid, sCOUNTRY_CODE, sLANGUAGE_CODE, sDEVICE_NAME);

            if (objItemLeftLifeCycle != null)
            {
                strResponse = objItemLeftLifeCycle.ViewLifeCycle;
            }

            return (strResponse);
        }

        /// <summary>
        /// Gets the time-spans of what's left for this specific item's life cycle (both full and view)
        /// </summary>
        /// <param name="p_sMediaFileID"></param>
        /// <param name="p_sSiteGUID"></param>
        /// <param name="p_bIsCoGuid"></param>
        /// <param name="p_sCOUNTRY_CODE"></param>
        /// <param name="p_sLANGUAGE_CODE"></param>
        /// <param name="p_sDEVICE_NAME"></param>
        /// <returns></returns>
        public EntitlementResponse GetEntitlement(string p_sMediaFileID, string p_sSiteGUID, bool p_bIsCoGuid, string p_sCOUNTRY_CODE, string p_sLANGUAGE_CODE, string p_sDEVICE_NAME, bool isRecording = false)
        {
            EntitlementResponse response = new EntitlementResponse();

            int nMediaFileID = 0;
            string strViewLifeCycle = TimeSpan.Zero.ToString();
            string strFullLifeCycle = TimeSpan.Zero.ToString();
            bool bIsOfflinePlayback = false;
            bool shouldCheckEntitlement = false;            
            int domainId = 0;

            try
            {
                if (p_bIsCoGuid)
                {
                    if (!Utils.GetMediaFileIDByCoGuid(p_sMediaFileID, m_nGroupID, p_sSiteGUID, ref nMediaFileID))
                    {
                        throw new Exception("Failed to retrieve Media File ID from WS Catalog.");
                    }
                }
                else
                {
                    if (string.IsNullOrEmpty(p_sMediaFileID) || !Int32.TryParse(p_sMediaFileID, out nMediaFileID))
                    {
                        throw new ArgumentException(String.Concat("MediaFileID is in incorrect format: ", p_sMediaFileID));
                    }
                }

                if (nMediaFileID > 0)
                {
                    if (isRecording)
                    {
                        long householdId = 0;
                        ResponseStatus validateStatus = Utils.ValidateUser(m_nGroupID, p_sSiteGUID, ref householdId);
                        domainId = (int)householdId;
                        if (validateStatus == ResponseStatus.OK)
                        {
                            int enableCdvr = 0, enableNonEntitled = 0, enableNonExisting = 0;
                            TimeShiftedTvPartnerSettings accountSettings = Utils.GetTimeShiftedTvPartnerSettings(m_nGroupID);
                            if (accountSettings != null)
                            // Assuming accountSettings is not null (no errors), all account settings must have values so no need to check .HasValue
                            {
                                enableCdvr = accountSettings.IsCdvrEnabled.Value ? 1 : 0;
                                enableNonEntitled = accountSettings.IsRecordingPlaybackNonEntitledChannelEnabled.Value ? 1 : 0;
                                enableNonExisting = accountSettings.IsRecordingPlaybackNonExistingChannelEnabled.Value ? 1 : 0;
                            }

                            DataTable dt = ConditionalAccessDAL.GetChannelByMediaFileId(m_nGroupID, nMediaFileID);
                            if (dt != null && dt.Rows != null && dt.Rows.Count == 1)
                            {
                                DataRow dr = dt.Rows[0];
                                int enableChannelCdvr = ODBCWrapper.Utils.GetIntSafeVal(dr, "ENABLE_CDVR", 0);
                                int enableChannelNonEntitled = ODBCWrapper.Utils.GetIntSafeVal(dr, "ENABLE_RECORDING_PLAYBACK_NON_ENTITLED", 0);

                                if (enableCdvr == 1 && enableChannelCdvr == 2)
                                {
                                    enableCdvr = enableChannelCdvr;
                                }

                                if (enableNonEntitled == 1 && enableChannelNonEntitled == 2)
                                {
                                    enableNonEntitled = enableChannelNonEntitled;
                                }
                                
                                if (enableCdvr == 1 && IsServiceAllowed(domainId, eService.NPVR))
                                {                                    
                                    if (enableNonEntitled == 1)
                                    {
                                        //shouldCheckEntitlement is already false
                                        //bIsOfflinePlayback is already false so no need to assign 
                                        GetFreeItemLeftLifeCycle(ref strViewLifeCycle, ref strFullLifeCycle);
                                    }
                                    // if the user has the NPVR service then check entitlements, otherwise he isn't entitled
                                    else
                                    {
                                        shouldCheckEntitlement = true;
                                    }
                                }
                            }
                            else if (enableNonExisting == 1 && IsServiceAllowed(domainId, eService.NPVR))
                            {
                                //shouldCheckEntitlement is already false
                                //bIsOfflinePlayback is already false so no need to assign 
                                GetFreeItemLeftLifeCycle(ref strViewLifeCycle, ref strFullLifeCycle);
                            }
                        }
                    }
                    else
                    {
                        shouldCheckEntitlement = true;
                    }

                    if (shouldCheckEntitlement)
                    {
                        List<int> lstUsersIds = Utils.GetAllUsersDomainBySiteGUID(p_sSiteGUID, m_nGroupID, ref domainId);

                        if (TVinciShared.WS_Utils.GetTcmBoolValue("ShouldUseLicenseLinkCache") && !isRecording)
                        {
                            CachedEntitlementResults cachedEntitlementResults = Utils.GetCachedEntitlementResults(domainId, nMediaFileID);
                            if (cachedEntitlementResults != null)
                            {
                                if (cachedEntitlementResults.IsFree)
                                {
                                    GetFreeItemLeftLifeCycle(ref strViewLifeCycle, ref strFullLifeCycle);
                                    response.ViewLifeCycle = strViewLifeCycle;
                                    response.FullLifeCycle = strFullLifeCycle;
                                }
                                else
                                {
                                    DateTime now = DateTime.UtcNow;
                                    response.IsOfflinePlayBack = cachedEntitlementResults.IsOfflinePlayback;
                                    DateTime viewEndDate = Utils.GetEndDateTime(cachedEntitlementResults.CreditDownloadedDate, cachedEntitlementResults.ViewLifeCycle);
                                    TimeSpan viewLifeCycleLeft = viewEndDate.Subtract(now);
                                    if (viewLifeCycleLeft.TotalSeconds < 0)
                                    {
                                        viewLifeCycleLeft = new TimeSpan();
                                    }

                                    TimeSpan fullLifeCycleLeft = new TimeSpan();
                                    if (cachedEntitlementResults.TransactionType != eTransactionType.PPV && cachedEntitlementResults.EntitlementEndDate.HasValue)
                                    {
                                        fullLifeCycleLeft = cachedEntitlementResults.EntitlementEndDate.Value.Subtract(now);
                                    }
                                    else if (cachedEntitlementResults.TransactionType == eTransactionType.PPV && cachedEntitlementResults.FullLifeCycle > 0 && cachedEntitlementResults.EntitlementStartDate.HasValue)
                                    {
                                        DateTime endDate = Utils.GetEndDateTime(cachedEntitlementResults.EntitlementStartDate.Value, cachedEntitlementResults.FullLifeCycle);
                                        fullLifeCycleLeft = endDate.Subtract(now);
                                    }

                                    if (fullLifeCycleLeft.TotalMilliseconds < 0)
                                    {
                                        fullLifeCycleLeft = new TimeSpan();
                                    }

                                    response.ViewLifeCycle = viewLifeCycleLeft.ToString();
                                    response.FullLifeCycle = fullLifeCycleLeft.ToString();
                                }

                                return response;
                            }
                        }

                        int[] arrMediaFileIDs = { nMediaFileID };
                        MediaFileItemPricesContainer[] arrPrices = GetItemsPrices(arrMediaFileIDs, p_sSiteGUID, string.Empty, true, p_sCOUNTRY_CODE, p_sLANGUAGE_CODE, p_sDEVICE_NAME);
                        if (arrPrices != null && arrPrices.Length > 0)
                        {
                            MediaFileItemPricesContainer objPrice = arrPrices[0];

                            // If the item is free
                            if (IsFreeItem(objPrice))
                            {
                                GetFreeItemLeftLifeCycle(ref strViewLifeCycle, ref strFullLifeCycle);
                            }
                            else if (IsItemPurchased(objPrice))
                            // Item is not free and also not user is not suspended
                            {
                                bool bIsOfflineStatus = false;
                                string sPPVMCode = string.Empty;
                                int nViewLifeCycle = 0;
                                int nFullLifeCycle = 0;
                                DateTime dtViewDate = new DateTime();
                                DateTime dtNow = DateTime.UtcNow;                                
                                List<int> lstRelatedMediaFiles = Utils.GetRelatedMediaFiles(objPrice.m_oItemPrices[0], nMediaFileID);
                                DateTime? dtEntitlementStartDate = Utils.GetStartDate(objPrice.m_oItemPrices[0]);
                                DateTime? dtEntitlementEndDate = Utils.GetEndDate(objPrice.m_oItemPrices[0]);

                                string sPricingUsername = string.Empty;
                                string sPricingPassword = string.Empty;

                                Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sPricingUsername, ref sPricingPassword);

                                // Get latest use (watch/download) of the media file. If there was one, continue.
                                if (ConditionalAccessDAL.Get_LatestMediaFilesUse(lstUsersIds, lstRelatedMediaFiles, ref sPPVMCode, ref bIsOfflineStatus, ref dtNow,
                                    ref dtViewDate))
                                {
                                    if (bIsOfflineStatus)
                                    {
                                        string sGroupUsageModuleCode = string.Empty;

                                        if (PricingDAL.Get_GroupUsageModuleCode(m_nGroupID, "PRICING_CONNECTION", ref sGroupUsageModuleCode))
                                        {
                                            UsageModule objUsageModule = Utils.GetUsageModuleDataWithCaching(sGroupUsageModuleCode, sPricingUsername, sPricingPassword,
                                                p_sCOUNTRY_CODE, p_sLANGUAGE_CODE, p_sDEVICE_NAME, m_nGroupID, "GetOfflineUsageModuleData");

                                            if (objUsageModule != null)
                                            {
                                                nViewLifeCycle = objUsageModule.m_tsViewLifeCycle;
                                                nFullLifeCycle = objUsageModule.m_tsMaxUsageModuleLifeCycle;
                                                bIsOfflinePlayback = objUsageModule.m_bIsOfflinePlayBack;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        bool bIsSuccess = GetLifeCycleByPPVMCode(p_sCOUNTRY_CODE, p_sLANGUAGE_CODE, p_sDEVICE_NAME, ref bIsOfflinePlayback, sPPVMCode,
                                            ref nViewLifeCycle, ref nFullLifeCycle, sPricingUsername, sPricingPassword);

                                        // If getting didn't succeed for any reason, write to log
                                        if (!bIsSuccess)
                                        {
                                            log.Error("Error - " + GetPricingErrLogMsg(sPPVMCode, p_sSiteGUID, p_sMediaFileID, p_bIsCoGuid,
                                                p_sCOUNTRY_CODE, p_sLANGUAGE_CODE, p_sDEVICE_NAME, eTransactionType.PPV));
                                        }
                                    }
                                }

                                // If we found the view cycle (and there was a view), calculate what's left of it
                                // Base date is the view date
                                if (nViewLifeCycle > 0)
                                {
                                    DateTime dtViewEndDate = Utils.GetEndDateTime(dtViewDate, nViewLifeCycle);
                                    TimeSpan tsViewLeftSpan = dtViewEndDate.Subtract(dtNow);
                                    if (tsViewLeftSpan.TotalMilliseconds < 0)
                                        tsViewLeftSpan = new TimeSpan();
                                    strViewLifeCycle = tsViewLeftSpan.ToString();
                                }

                                eTransactionType eBusinessModuleType = GetBusinessModuleType(sPPVMCode);

                                // If it is a subscription, use the end date that is saved in the DB and that was gotten in GetItemPrice
                                if (eBusinessModuleType == eTransactionType.Subscription || eBusinessModuleType == eTransactionType.Collection)
                                {
                                    if (dtEntitlementEndDate.HasValue)
                                    {
                                        TimeSpan tsFullLeftSpan = dtEntitlementEndDate.Value.Subtract(dtNow);
                                        if (tsFullLeftSpan.TotalMilliseconds < 0)
                                            tsFullLeftSpan = new TimeSpan();
                                        strFullLifeCycle = tsFullLeftSpan.ToString();
                                    }
                                }
                                else if (eBusinessModuleType == eTransactionType.PPV)
                                {
                                    // If we found the full cycle, meaning the user purchased the media file, calculate what's left of it
                                    // Base date is purchase date
                                    if (nFullLifeCycle > 0 && dtEntitlementStartDate.HasValue)
                                    {
                                        DateTime dtSubscriptionEndDate = Utils.GetEndDateTime(dtEntitlementStartDate.Value, nFullLifeCycle);
                                        TimeSpan tsFullLeftSpan = dtSubscriptionEndDate.Subtract(dtNow);
                                        if (tsFullLeftSpan.TotalMilliseconds < 0)
                                            tsFullLeftSpan = new TimeSpan();
                                        strFullLifeCycle = tsFullLeftSpan.ToString();
                                    }
                                }
                            }
                        }
                    }

                } // end if nMediaFileID > 0
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at GetItemLeftLifeCycle. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" MF ID or CG: ", p_sMediaFileID));
                sb.Append(String.Concat(" Is CG: ", p_bIsCoGuid.ToString().ToLower()));
                sb.Append(String.Concat(" Site Guid: ", p_sSiteGUID));
                sb.Append(String.Concat(" Country Cd: ", p_sCOUNTRY_CODE));
                sb.Append(String.Concat(" Lng Cd: ", p_sLANGUAGE_CODE));
                sb.Append(String.Concat(" Device Name: ", p_sDEVICE_NAME));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }

            response.ViewLifeCycle = strViewLifeCycle;
            response.FullLifeCycle = strFullLifeCycle;
            response.IsOfflinePlayBack = bIsOfflinePlayback;

            return (response);
        }

        /// <summary>
        /// Returns the default timespans of free items
        /// </summary>
        /// <param name="p_strViewLifeCycle"></param>
        /// <param name="p_strFullLifeCycle"></param>
        private void GetFreeItemLeftLifeCycle(ref string p_strViewLifeCycle, ref string p_strFullLifeCycle)
        {
            // Default is 2 days
            TimeSpan ts = new TimeSpan(2, 0, 0, 0);

            // Get the group's configuration for free view life cycle
            string sFreeLeftView = Utils.GetValueFromConfig(string.Format("free_left_view_{0}", m_nGroupID));

            if (!string.IsNullOrEmpty(sFreeLeftView))
            {
                DateTime dEndDate = Utils.GetEndDateTime(DateTime.UtcNow, int.Parse(sFreeLeftView), true);
                ts = dEndDate.Subtract(DateTime.UtcNow);
            }

            p_strViewLifeCycle = ts.ToString();
            // TODO: Understand what to do with full life cycle of free item. Right now I write it the same as view
            p_strFullLifeCycle = ts.ToString();
        }

        /// <summary>
        /// For a given PPVMCode, returns the full life cycle, view life cycle and is offline playback
        /// </summary>
        /// <param name="p_sCOUNTRY_CODE"></param>
        /// <param name="p_sLANGUAGE_CODE"></param>
        /// <param name="p_sDEVICE_NAME"></param>
        /// <param name="p_bIsOfflinePlayback"></param>
        /// <param name="p_sPPVMCode"></param>
        /// <param name="p_nViewLifeCycle"></param>
        /// <param name="p_nFullLifeCycle"></param>
        /// <param name="p_sPricingUsername"></param>
        /// <param name="p_sPricingPassword"></param>
        /// <returns>If the get succeeded or not</returns>
        private bool GetLifeCycleByPPVMCode(string p_sCOUNTRY_CODE, string p_sLANGUAGE_CODE, string p_sDEVICE_NAME, ref bool p_bIsOfflinePlayback,
            string p_sPPVMCode, ref int p_nViewLifeCycle, ref int p_nFullLifeCycle, string p_sPricingUsername, string p_sPricingPassword)
        {
            bool bIsSuccess = true;

            eTransactionType eBusinessModuleType = GetBusinessModuleType(p_sPPVMCode);

            switch (eBusinessModuleType)
            {
                case eTransactionType.Subscription:
                    {
                        // Get the code itself, without the prefix
                        string sSubCode = p_sPPVMCode.Substring(3);

                        // Get the subscription item of this code
                        Subscription[] arrSubscriptions =
                            Utils.GetSubscriptionsDataWithCaching(new List<string>(1) { sSubCode }, p_sPricingUsername, p_sPricingPassword, m_nGroupID);

                        // If there is a valid subscription with a valid usage module
                        if (arrSubscriptions != null && arrSubscriptions.Length > 0 && arrSubscriptions[0] != null &&
                            arrSubscriptions[0].m_oSubscriptionUsageModule != null)
                        {
                            p_nViewLifeCycle = arrSubscriptions[0].m_oSubscriptionUsageModule.m_tsViewLifeCycle;
                            p_nFullLifeCycle = arrSubscriptions[0].m_oSubscriptionUsageModule.m_tsMaxUsageModuleLifeCycle;
                            p_bIsOfflinePlayback = arrSubscriptions[0].m_oSubscriptionUsageModule.m_bIsOfflinePlayBack;
                        }
                        else
                        {
                            bIsSuccess = false;
                        }
                        break;
                    }
                case eTransactionType.Collection:
                    {
                        // Get the code itself, without the prefix
                        string sCollCode = p_sPPVMCode.Substring(3);

                        // Get the collection item of this code
                        Collection[] arrCollections =
                            Utils.GetCollectionsDataWithCaching(new List<string>(1) { sCollCode }, p_sPricingUsername, p_sPricingPassword, m_nGroupID);

                        // If there is a valid collection with a valid usage module
                        if (arrCollections != null && arrCollections.Length > 0 && arrCollections[0] != null &&
                            arrCollections[0].m_oCollectionUsageModule != null)
                        {
                            p_nViewLifeCycle = arrCollections[0].m_oCollectionUsageModule.m_tsViewLifeCycle;
                            p_nFullLifeCycle = arrCollections[0].m_oCollectionUsageModule.m_tsMaxUsageModuleLifeCycle;
                            p_bIsOfflinePlayback = arrCollections[0].m_oCollectionUsageModule.m_bIsOfflinePlayBack;
                        }
                        else
                        {
                            bIsSuccess = false;
                        }
                        break;
                    }
                case eTransactionType.PPV:
                    {
                        PPVModule objPPV = Utils.GetPPVModuleDataWithCaching(p_sPPVMCode, p_sPricingUsername, p_sPricingPassword, m_nGroupID,
                            p_sCOUNTRY_CODE, p_sLANGUAGE_CODE, p_sDEVICE_NAME);

                        if (objPPV != null && objPPV.m_oUsageModule != null)
                        {
                            p_nViewLifeCycle = objPPV.m_oUsageModule.m_tsViewLifeCycle;
                            p_nFullLifeCycle = objPPV.m_oUsageModule.m_tsMaxUsageModuleLifeCycle;
                            p_bIsOfflinePlayback = objPPV.m_oUsageModule.m_bIsOfflinePlayBack;
                        }
                        else
                        {
                            bIsSuccess = false;
                        }
                        break;
                    }
                default:
                    {
                        break;
                    }
            }

            return (bIsSuccess);
        }

        /// <summary>
        /// Returns the ppv module code of the price container, if it has one
        /// </summary>
        /// <param name="p_objPrice"></param>
        /// <returns></returns>
        private string GetPPVModuleCode(MediaFileItemPricesContainer p_objPrice)
        {
            string strCode = string.Empty;

            if (p_objPrice != null && p_objPrice.m_oItemPrices != null && p_objPrice.m_oItemPrices.Length > 0)
            {
                strCode = p_objPrice.m_oItemPrices[0].m_sPPVModuleCode;
            }

            return (strCode);
        }

        private string GetPricingErrLogMsg(string businessModuleCode, string siteGuid, string mediaFileIDStr,
            bool isCoGuid, string countryCd, string langCode, string deviceName, eTransactionType businessModuleType)
        {
            StringBuilder sb = new StringBuilder("Failed to retrieve business module code from WS Pricing at GetItemLeftViewLifeCycle. ");
            sb.Append(String.Concat(" BM Cd: ", businessModuleCode));
            sb.Append(String.Concat(" BM Type: ", businessModuleType.ToString().ToLower()));
            sb.Append(String.Concat(" SG: ", siteGuid));
            sb.Append(String.Concat(" MF: ", mediaFileIDStr));
            sb.Append(String.Concat(" Is CG: ", isCoGuid.ToString().ToLower()));
            sb.Append(String.Concat(" Country Cd: ", countryCd));
            sb.Append(String.Concat(" Lng Cd: ", langCode));
            sb.Append(String.Concat(" Device Name: ", deviceName));

            return sb.ToString();

        }

        private eTransactionType GetBusinessModuleType(string sPPVModuleCode)
        {
            if (!string.IsNullOrEmpty(sPPVModuleCode))
            {
                if (sPPVModuleCode.Contains("s:"))
                    return eTransactionType.Subscription;
                if (sPPVModuleCode.Contains("c:"))
                    return eTransactionType.Collection;
            }

            return eTransactionType.PPV;
        }

        private bool IsSkipOnFirstUsageModule(int nIndexOfUsageModule, bool bIsUsageModuleIsRenewable, int nTotalNumOfPayments, int nNumOfPayments, bool bIsPurchasedWithPreviewModule)
        {
            if (bIsPurchasedWithPreviewModule)
            {
                if (nNumOfPayments != 0)
                    return nIndexOfUsageModule == 0 && !bIsUsageModuleIsRenewable && nTotalNumOfPayments % nNumOfPayments != 1;
                else
                    return nIndexOfUsageModule == 0 && !bIsUsageModuleIsRenewable && nTotalNumOfPayments == 2;
            }
            return nIndexOfUsageModule == 0 && !bIsUsageModuleIsRenewable && (nNumOfPayments == 0 || nTotalNumOfPayments % nNumOfPayments != 0);
        }

        /*
       * 1. This method was added as a result of a bug discovered in the renewer process
       * 2. The bug occurred in the following case:
       *      a. MPP contains two usage modules
       *      b. The mpp is not renewable
       *      c. However both the usage modules it containes are renewable.
       *      d. The bug caused the renewer to set is_recurring_status = 0 in DB after the first time the second usage module was selected by the renewer.
       *      e. This change in the DB caused the renewer to stop renewing the second usage module.
       * 
       */
        protected bool IsLastPeriodOfLastUsageModule(bool bIsPurchasedWithPreviewModule, bool bIsRecurringInfinitely, int nNumOfRecPeriods, int nPaymentNumber)
        {
            if (nNumOfRecPeriods != 0 && !bIsRecurringInfinitely)
                return nNumOfRecPeriods <= nPaymentNumber;
            return false;
        }

        protected bool IsCouponStillRedeemable(bool bIsPurchasedWithPreviewModule, int nMaxRecurringUsesCountForCoupon, int nTotalPaymentsNumber)
        {
            if (bIsPurchasedWithPreviewModule)
                nTotalPaymentsNumber--;
            return nMaxRecurringUsesCountForCoupon > nTotalPaymentsNumber || nMaxRecurringUsesCountForCoupon == 0;
        }

        private string GetIsRecurringStrForSubscriptionCustomData(bool bIsRecurring, string sPreviewModuleID)
        {
            long lPreviewModuleID = 0;
            return bIsRecurring || (Int64.TryParse(sPreviewModuleID, out lPreviewModuleID) && lPreviewModuleID > 0) ? "true" : "false";
        }

        protected virtual string GetCustomDataForMPPRenewal(Subscription theSub, UsageModule theUsageModule,
           PriceCode p, string sSubscriptionCode, string sSiteGUID, double dPrice, string sCurrency,
           string sCouponCode, string sUserIP, string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME)
        {

            bool bIsRecurring = theSub.m_bIsRecurring;
            Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;

            StringBuilder sb = new StringBuilder();
            sb.Append("<customdata type=\"sp\">");
            if (!String.IsNullOrEmpty(sCountryCd))
            {
                sb.AppendFormat("<lcc>{0}</lcc>", sCountryCd);
            }
            if (!String.IsNullOrEmpty(sLANGUAGE_CODE))
            {
                sb.AppendFormat("<llc>{0}</llc>", sLANGUAGE_CODE);
            }
            if (!String.IsNullOrEmpty(sDEVICE_NAME))
            {
                sb.AppendFormat("<ldn>{0}</ldn>", sDEVICE_NAME);
            }
            sb.Append("<mnou>");
            sb.Append(theUsageModule.m_nMaxNumberOfViews.ToString());
            sb.Append("</mnou>");
            sb.AppendFormat("<u id=\"{0}\"/>", sSiteGUID);
            sb.AppendFormat("<s>{0}</s>", sSubscriptionCode);
            sb.AppendFormat("<cc>{0}</cc>", sCouponCode);
            sb.AppendFormat("<p ir=\"{0}\" n=\"1\" o=\"{1}\"/>", bIsRecurring.ToString().ToLower(), nRecPeriods.ToString());
            sb.Append("<vlcs>");
            sb.Append(theUsageModule.m_tsViewLifeCycle.ToString());
            sb.Append("</vlcs>");
            sb.Append("<mumlc>");
            sb.Append(theUsageModule.m_tsMaxUsageModuleLifeCycle.ToString());
            sb.Append("</mumlc>");
            sb.Append("<ppvm></ppvm>");
            sb.Append("<pm></pm>");
            sb.Append("<pc>");
            sb.Append(p.m_sCode);
            sb.Append("</pc>");
            sb.Append("<pri>");
            sb.Append(dPrice.ToString());
            sb.Append("</pri>");
            sb.Append("<cu>");
            sb.Append(sCurrency);
            sb.Append("</cu>");
            sb.Append("</customdata>");

            return sb.ToString();

        }

        /// <summary>
        /// Credit Card Charge User For Media File
        /// </summary>
        protected BillingResponse Cellular_BaseChargeUserForMediaFile(string sSiteGUID, double dPrice, string sCurrency,
            Int32 nMediaFileID, Int32 nMediaID, string sPPVModuleCode, string sCouponCode, string sUserIP, string sExtraParameters,
            string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bDummy)
        {
            BillingResponse ret = new BillingResponse();
            ret.m_oStatus = BillingResponseStatus.UnKnown;
            ret.m_sRecieptCode = string.Empty;
            ret.m_sStatusDescription = string.Empty;

            UsersService u = null;
            mdoule m = null;
            module bm = null;

            try
            {
                log.Debug("Cellular_BaseChargeUserForMediaFile - " + string.Format("Entering Cellular_BaseChargeUserForMediaFile try block. Site Guid: {0} , Media File ID: {1} , Media ID: {2} , PPV Module Code: {3} , Coupon code: {4} , User IP: {5} , Dummy: {6}", sSiteGUID, nMediaFileID, nMediaID, sPPVModuleCode, sCouponCode, sUserIP, bDummy.ToString().ToLower()));

                long lSiteGuid = 0;
                if (sSiteGUID.Length == 0 || !Int64.TryParse(sSiteGUID, out lSiteGuid) || lSiteGuid == 0)
                {
                    ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_sRecieptCode = string.Empty;
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                    return ret;
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                        WriteToUserLog(sSiteGUID, "while trying to purchase media file id(Cellular): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                        return ret;
                    }
                    else if (uObj != null && uObj.m_user != null && uObj.m_user.m_eSuspendState == DomainSuspentionStatus.Suspended)
                    {
                        ret.m_oStatus = BillingResponseStatus.UserSuspended;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cannot charge a suspended user";
                        WriteToUserLog(sSiteGUID, "while trying to purchase media file id(Cellular): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                        return ret;
                    }
                    else
                    {
                        if (!string.IsNullOrEmpty(sCouponCode) && !Utils.IsCouponValid(m_nGroupID, sCouponCode))
                        {
                            ret.m_oStatus = BillingResponseStatus.Fail;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "Coupon not valid";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }

                        sWSUserName = string.Empty;
                        sWSPass = string.Empty;

                        m = new mdoule();

                        Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sWSUserName, ref sWSPass);
                        if (!bDummy && string.IsNullOrEmpty(sPPVModuleCode))
                        {
                            ret.m_oStatus = BillingResponseStatus.Fail;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "Charge must have ppv module code";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(Cellular): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }
                        // check if ppvModule related to mediaFile 
                        long ppvModuleCode = 0;
                        long.TryParse(sPPVModuleCode, out ppvModuleCode);

                        PPVModule thePPVModule = m.ValidatePPVModuleForMediaFile(sWSUserName, sWSPass, nMediaFileID, ppvModuleCode);
                        if (thePPVModule == null)
                        {
                            ret.m_oStatus = BillingResponseStatus.Fail;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "The ppv module is unknown";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(Cellular): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }

                        if (!bDummy && !thePPVModule.m_sObjectCode.Equals(sPPVModuleCode))
                        {
                            ret.m_oStatus = BillingResponseStatus.UnKnownPPVModule;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "This PPVModule does not belong to item";
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(Cellular): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }

                        if (bDummy)
                        {
                            sPPVModuleCode = thePPVModule.m_sObjectCode;
                            dPrice = thePPVModule.m_oPriceCode.m_oPrise.m_dPrice;
                            sCurrency = thePPVModule.m_oPriceCode.m_oPrise.m_oCurrency.m_sCurrencyCD3;
                            if (!IsTakePriceFromMediaFileFinalPrice(bDummy))
                            { // Cinepolis patch
                                dPrice = 0d;
                            }
                        }

                        PriceReason theReason = PriceReason.UnKnown;

                        Subscription relevantSub = null;
                        Collection relevantCol = null;
                        PrePaidModule relevantPP = null;

                        Price p = Utils.GetMediaFileFinalPriceForNonGetItemsPrices(nMediaFileID, thePPVModule, sSiteGUID, sCouponCode, m_nGroupID, ref theReason, ref relevantSub, ref relevantCol, ref relevantPP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        if ((theReason == PriceReason.ForPurchase || (theReason == PriceReason.SubscriptionPurchased && p.m_dPrice > 0) || bDummy) && theReason != PriceReason.NotForPurchase)
                        {
                            if (bDummy || (p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency))
                            {
                                string sCustomData = string.Empty;
                                if (p.m_dPrice != 0 || bDummy)
                                {
                                    sWSUserName = string.Empty;
                                    sWSPass = string.Empty;

                                    InitializeBillingModule(ref bm, ref sWSUserName, ref sWSPass);
                                    if (string.IsNullOrEmpty(sCountryCd) && !string.IsNullOrEmpty(sUserIP))
                                    {
                                        sCountryCd = Utils.GetIP2CountryName(m_nGroupID, sUserIP);
                                    }
                                    //Create the Custom Data
                                    sCustomData = GetCustomData(relevantSub, thePPVModule, null, sSiteGUID, dPrice, sCurrency,
                                        nMediaFileID, nMediaID, sPPVModuleCode, string.Empty, sCouponCode, sUserIP,
                                        sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                                    log.Debug("CustomData - " + sCustomData);
                                    ret = HandleCellularChargeUser(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sUserIP, sCustomData, 1, 1, sExtraParameters, bDummy, false, ref bm);
                                }
                                if (ret.m_oStatus == BillingResponseStatus.Success)
                                {
                                    long lBillingTransactionID = 0;
                                    long lPurchaseID = 0;
                                    HandleChargeUserForMediaFileBillingSuccess(sWSUserName, sWSPass, sSiteGUID, uObj.m_user.m_domianID, relevantSub, dPrice, sCurrency,
                                                                               sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, ret, sCustomData,
                                                                               thePPVModule, nMediaFileID, ref lBillingTransactionID, ref lPurchaseID, bDummy, ref bm);
                                    // Enqueue notification for PS so they know a collection was charged
                                    var dicData = new Dictionary<string, object>()
                                            {
                                                {"MediaFileID", nMediaFileID},
                                                {"BillingTransactionID", lBillingTransactionID},
                                                {"SiteGUID", sSiteGUID},
                                                {"PurchaseID", lPurchaseID},
                                                {"CouponCode", sCouponCode},
                                                {"CustomData", sCustomData}
                                            };

                                    this.EnqueueEventRecord(NotifiedAction.ChargedMediaFile, dicData);
                                }
                                else
                                {
                                    WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                                }
                            }
                            else
                            {
                                ret.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The price of the request is not the actual price";
                                WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CC): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.PPVPurchased)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The media file is already purchased";
                            }
                            else if (theReason == PriceReason.Free)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The media file is free";
                            }
                            else if (theReason == PriceReason.ForPurchaseSubscriptionOnly)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The media file is for purchase with subscription only";
                            }
                            else if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The media file is already purchased (subscription)";
                            }
                            else if (theReason == PriceReason.UserSuspended)
                            {
                                ret.m_oStatus = BillingResponseStatus.UserSuspended;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The user is suspended";
                            }
                            else if (theReason == PriceReason.NotForPurchase)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The media file is not valid for purchased";
                            }
                            WriteToUserLog(sSiteGUID, "While trying to purchase media file id(CellularC): " + nMediaFileID.ToString() + " error returned: " + ret.m_sStatusDescription);
                        }
                    }
                }// end else if siteguid == ""
            }

            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at Cellular_BaseChargeUserForMediaFile. ");
                sb.Append(String.Concat("Exception msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(" Media File ID: ", nMediaFileID));
                sb.Append(String.Concat(" Media ID: ", nMediaID));
                sb.Append(String.Concat(" Coupon Code: ", sCouponCode));
                sb.Append(String.Concat(" User IP: ", sUserIP));
                sb.Append(String.Concat(" Stack trace: ", ex.StackTrace));

                log.Debug("Cellular_BaseChargeUserForMediaFile - " + sb.ToString());

                WriteToUserLog(sSiteGUID, string.Format("Exception at Cellular_BaseChargeUserForMediaFile. Media File ID: {0} , Media ID: {1} , Coupon Code: {2}", nMediaFileID, nMediaID, sCouponCode));
                #endregion
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                    u = null;
                }
                if (m != null)
                {
                    m.Dispose();
                    m = null;
                }
                if (bm != null)
                {
                    bm.Dispose();
                    bm = null;
                }
                #endregion
            }
            return ret;

        }

        /// <summary>
        /// Credit Card Charge User For Subscription
        /// </summary>
        protected BillingResponse Cellular_BaseChargeUserForSubscription
           (string sSiteGUID, double dPrice, string sCurrency, string sSubscriptionCode, string sCouponCode, string sUserIP, string sExtraParams,
           string sCountryCd, string sLANGUAGE_CODE, string sDEVICE_NAME, bool bDummy)
        {
            BillingResponse ret = new BillingResponse();
            ret.m_oStatus = BillingResponseStatus.UnKnown;
            ret.m_sRecieptCode = string.Empty;
            ret.m_sStatusDescription = string.Empty;

            UsersService u = null;
            module bm = null;
            try
            {
                log.Debug("Cellular_BaseChargeUserForSubscription - " + string.Format("Entering Cellular_BaseChargeUserForSubscription try block. Site Guid: {0} , Sub Code: {1} , Coupon Code: {2} , User IP: {3} , Dummy: {4}", sSiteGUID, sSubscriptionCode, sCouponCode, sUserIP, bDummy.ToString().ToLower()));


                long lSiteGuid = 0;
                if (sSiteGUID.Length == 0 || !Int64.TryParse(sSiteGUID, out lSiteGuid) || lSiteGuid == 0)
                {
                    ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                    ret.m_sRecieptCode = string.Empty;
                    ret.m_sStatusDescription = "Cant charge an unknown user";
                }
                else
                {
                    u = new UsersService();

                    string sWSUserName = string.Empty;
                    string sWSPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.USERS, ref sWSUserName, ref sWSPass);
                    UserResponseObject uObj = u.GetUserData(sWSUserName, sWSPass, sSiteGUID, string.Empty);
                    if (uObj.m_RespStatus != ResponseStatus.OK)
                    {
                        ret.m_oStatus = BillingResponseStatus.UnKnownUser;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cant charge an unknown user";
                    }
                    else if (uObj != null && uObj.m_user != null && uObj.m_user.m_eSuspendState == DomainSuspentionStatus.Suspended)
                    {
                        ret.m_oStatus = BillingResponseStatus.UserSuspended;
                        ret.m_sRecieptCode = string.Empty;
                        ret.m_sStatusDescription = "Cannot charge a suspended user";
                        WriteToUserLog(sSiteGUID, "while trying to purchase subscription(CC): " + sSubscriptionCode + " error returned: " + ret.m_sStatusDescription);
                    }
                    else
                    {
                        if (!string.IsNullOrEmpty(sCouponCode) && !Utils.IsCouponValid(m_nGroupID, sCouponCode))
                        {
                            ret.m_oStatus = BillingResponseStatus.Fail;
                            ret.m_sRecieptCode = string.Empty;
                            ret.m_sStatusDescription = "Coupon not valid";
                            WriteToUserLog(sSiteGUID, "While trying to purchase subscription(CC): " + sSubscriptionCode + " error returned: " + ret.m_sStatusDescription);
                            return ret;
                        }

                        PriceReason theReason = PriceReason.UnKnown;
                        Subscription theSub = null;
                        Price p = Utils.GetSubscriptionFinalPrice(m_nGroupID, sSubscriptionCode, sSiteGUID, sCouponCode, ref theReason, ref theSub, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME);
                        if (bDummy && p != null)
                        {
                            dPrice = p.m_dPrice;
                            sCurrency = p.m_oCurrency.m_sCurrencyCD3;
                        }
                        bool bIsEntitledToPreviewModule = theReason == PriceReason.EntitledToPreviewModule;
                        if (theReason == PriceReason.ForPurchase || bIsEntitledToPreviewModule)
                        {
                            if (bDummy || (p != null && p.m_dPrice == dPrice && p.m_oCurrency.m_sCurrencyCD3 == sCurrency))
                            {
                                string sCustomData = string.Empty;

                                bool bIsRecurring = theSub.m_bIsRecurring;
                                Int32 nRecPeriods = theSub.m_nNumberOfRecPeriods;

                                if (string.IsNullOrEmpty(sCountryCd) && !string.IsNullOrEmpty(sUserIP))
                                {
                                    sCountryCd = Utils.GetIP2CountryName(m_nGroupID, sUserIP);
                                }
                                //Create the Custom Data
                                sCustomData = GetCustomDataForSubscription(theSub, null, sSubscriptionCode, string.Empty, sSiteGUID, dPrice, sCurrency,
                                    sCouponCode, sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, string.Empty, bIsEntitledToPreviewModule ? theSub.m_oPreviewModule.m_nID + "" : string.Empty, bIsEntitledToPreviewModule);

                                log.Debug("CustomData - " + string.Format("Subscription custom data created. Site Guid: {0} , User IP: {1} , Custom data: {2}", sSiteGUID, sUserIP, sCustomData));

                                if (p.m_dPrice != 0 || bDummy)
                                {

                                    sWSUserName = string.Empty;
                                    sWSPass = string.Empty;

                                    InitializeBillingModule(ref bm, ref sWSUserName, ref sWSPass);

                                    ret = HandleCellularChargeUser(sWSUserName, sWSPass, sSiteGUID, dPrice, sCurrency, sUserIP,
                                                                   sCustomData, 1, nRecPeriods, sExtraParams, bDummy, bIsEntitledToPreviewModule, ref bm);

                                }
                                if ((p.m_dPrice == 0 && !string.IsNullOrEmpty(sCouponCode)) || bIsEntitledToPreviewModule)
                                {
                                    ret.m_oStatus = BillingResponseStatus.Success;
                                }
                                if (ret.m_oStatus == BillingResponseStatus.Success)
                                {

                                    long lBillingTransactionID = 0;
                                    long lPurchaseID = 0;
                                    HandleChargeUserForSubscriptionBillingSuccess(sWSUserName, sWSPass, sSiteGUID, uObj.m_user.m_domianID, theSub, dPrice, sCurrency, sCouponCode,
                                                                                  sUserIP, sCountryCd, sLANGUAGE_CODE, sDEVICE_NAME, ret, bIsEntitledToPreviewModule, sSubscriptionCode, sCustomData,
                                                                                  bIsRecurring, ref lBillingTransactionID, ref lPurchaseID, bDummy, ref bm);

                                    // Enqueue notification for PS so they know a collection was charged
                                    var dicData = new Dictionary<string, object>()
                                            {
                                                {"SubscriptionCode", sSubscriptionCode},
                                                {"BillingTransactionID", lBillingTransactionID},
                                                {"SiteGUID", sSiteGUID},
                                                {"PurchaseID", lPurchaseID},
                                                {"CouponCode", sCouponCode},
                                                {"CustomData", sCustomData}
                                            };

                                    this.EnqueueEventRecord(NotifiedAction.ChargedSubscription, dicData);

                                }
                                else
                                {
                                    WriteToUserLog(sSiteGUID, "while trying to purchase subscription(CC): " + sSubscriptionCode + " error returned: " + ret.m_sStatusDescription);
                                }
                            }
                            else
                            {
                                ret.m_oStatus = BillingResponseStatus.PriceNotCorrect;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The price of the request is not the actual price";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(CC): " + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                        else
                        {
                            if (theReason == PriceReason.Free)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The subscription is free";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(CC): " + " error returned: " + ret.m_sStatusDescription);
                            }
                            if (theReason == PriceReason.SubscriptionPurchased)
                            {
                                ret.m_oStatus = BillingResponseStatus.Fail;
                                ret.m_sRecieptCode = string.Empty;
                                ret.m_sStatusDescription = "The subscription is already purchased";
                                WriteToUserLog(sSiteGUID, "while trying to purchase subscription(CC): " + " error returned: " + ret.m_sStatusDescription);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder(String.Concat("Exception msg: ", ex.Message));
                sb.Append(String.Concat(", Stack trace: ", ex.StackTrace));
                sb.Append(String.Concat(", Site Guid: ", sSiteGUID));
                sb.Append(String.Concat(", Price: ", dPrice));
                sb.Append(String.Concat(", Currency: ", sCurrency));
                sb.Append(String.Concat(", Subscription Code: ", sSubscriptionCode));
                sb.Append(String.Concat(", Coupon Code: ", sCouponCode));
                sb.Append(String.Concat(", User IP: ", sUserIP));
                sb.Append(String.Concat(", Extra Params: ", sExtraParams));
                sb.Append(String.Concat(", Country Code: ", sCountryCd));
                sb.Append(String.Concat(", Language Code: ", sLANGUAGE_CODE));
                sb.Append(String.Concat(", Device Name: ", sDEVICE_NAME));
                sb.Append(String.Concat(", Dummy: ", bDummy.ToString().ToLower()));
                log.Debug("Cellular_BaseChargeUserForSubscription - " + sb.ToString());
                WriteToUserLog(sSiteGUID, string.Format("While trying to purchase subscription id: {0} , Exception occurred.", sSubscriptionCode));
                #endregion
                long lBillingID = 0;
                if (ret.m_oStatus != BillingResponseStatus.Success || ret.m_sRecieptCode.Length == 0 || !Int64.TryParse(ret.m_sRecieptCode, out lBillingID) || lBillingID == 0)
                {
                    ret.m_oStatus = BillingResponseStatus.UnKnown;
                    ret.m_sStatusDescription = "Exception occurred.";
                    ret.m_sRecieptCode = string.Empty;
                }
            }
            finally
            {
                #region Disposing
                if (u != null)
                {
                    u.Dispose();
                    u = null;
                }
                if (bm != null)
                {
                    bm.Dispose();
                    bm = null;
                }
                #endregion
            }
            return ret;
        }

        protected void UpdatePurchaseIDInExternalBillingTable(string sWSUsername, string sWSPassword, long lBillingTransactionID, long lPurchaseID, ref module wsBillingService)
        {
            int nExternalTransactionID = 0;
            int nBillingProvider = 0;
            ODBCWrapper.DataSetSelectQuery selectQuery = null;
            try
            {
                selectQuery = new ODBCWrapper.DataSetSelectQuery();
                selectQuery.SetConnectionKey("MAIN_CONNECTION_STRING");
                selectQuery += "select billing_provider_refference,billing_provider from billing_transactions(nolock) where ";
                selectQuery += ODBCWrapper.Parameter.NEW_PARAM("id", "=", lBillingTransactionID);
                if (selectQuery.Execute("query", true) != null)
                {
                    int count = selectQuery.Table("query").DefaultView.Count;
                    if (count > 0)
                    {
                        nExternalTransactionID = ODBCWrapper.Utils.GetIntSafeVal(selectQuery.Table("query").Rows[0]["billing_provider_refference"]);
                        nBillingProvider = ODBCWrapper.Utils.GetIntSafeVal(selectQuery.Table("query").Rows[0]["billing_provider"]);
                    }
                }
            }
            finally
            {
                if (selectQuery != null)
                {
                    selectQuery.Finish();
                }
            }

            if (nExternalTransactionID > 0 && nBillingProvider > 0 && Enum.IsDefined(typeof(eBillingProvider), nBillingProvider))
            {
                UpdatePurchaseIDInBilling(sWSUsername, sWSPassword, lPurchaseID, lBillingTransactionID, ref wsBillingService);
            }
            else
            {
                log.Debug("UpdatePurchaseIDInExternalBillingTable - " + string.Format("Unexpected error. Billing transaction ID: {0} , Purchase ID: {1} , BaseConditionalAccess is: {2} , Billing Provider: {3} , External transaction ID: {4}", lBillingTransactionID, lPurchaseID, this.GetType().Name, nBillingProvider, nExternalTransactionID));
            }
        }

        protected bool IsPreviewModuleInGroupIDCostsZero()
        {
            string sKeyOfMinPrice = String.Concat("PreviewModuleMinPrice", m_nGroupID);
            double dMinPriceForPreviewModule = Utils.DEFAULT_MIN_PRICE_FOR_PREVIEW_MODULE;
            string sValInConfig = Utils.GetValueFromConfig(sKeyOfMinPrice);
            if (sValInConfig.Length > 0 && double.TryParse(sValInConfig, out dMinPriceForPreviewModule))
                return dMinPriceForPreviewModule == 0d;
            return false;

        }


        //Change subscription for a given user - the user will be able to watch the new subscription content, 
        //but the billing for the new subscription will happen only when the previous subcription ends 
        public ChangeSubscriptionStatus ChangeSubscription(string sSiteGuid, int nOldSub, int nNewSub)
        {
            try
            {
                //check if user exists
                DomainSuspentionStatus suspendStatus = DomainSuspentionStatus.OK;
                int domainID = 0;

                if (!Utils.IsUserValid(sSiteGuid, m_nGroupID, ref domainID, ref suspendStatus))
                {
                    log.Debug("ChangeSubscription - User with siteGuid: " + sSiteGuid + " does not exist. Subscription was not changed");
                    return ChangeSubscriptionStatus.UserNotExists;
                }

                if (suspendStatus == DomainSuspentionStatus.Suspended)
                {
                    log.Debug("ChangeSubscription - User with siteGuid: " + sSiteGuid + " Suspended. Subscription was not changed");
                    return ChangeSubscriptionStatus.UserSuspended;
                }

                PermittedSubscriptionContainer[] userSubsArray = GetUserPermittedSubscriptions(sSiteGuid);//get all the valid subscriptions that this user has
                Subscription userSubNew = null;
                PermittedSubscriptionContainer userSubOld = new PermittedSubscriptionContainer();
                List<PermittedSubscriptionContainer> userOldSubList = new List<PermittedSubscriptionContainer>();
                //check if old sub exists
                if (userSubsArray != null)
                {
                    userOldSubList = userSubsArray.Where(x => x.m_sSubscriptionCode == nOldSub.ToString()).ToList();
                }
                if (userOldSubList == null || userOldSubList.Count == 0)
                {
                    return ChangeSubscriptionStatus.OldSubNotExists;
                }
                else
                {
                    if (userOldSubList.Count > 0 && userOldSubList[0] != null)
                    {
                        userSubOld = userOldSubList[0];
                        //check if the Subscription has autorenewal  
                        if (!userSubOld.m_bRecurringStatus)
                        {
                            log.Debug("ChangeSubscription - Previous Subscription ID: " + nOldSub + " is not renewable. Subscription was not changed");
                            return ChangeSubscriptionStatus.OldSubNotRenewable;
                        }
                    }
                }

                //check if new subscsription already exists for this user
                List<PermittedSubscriptionContainer> userNewSubList = userSubsArray.Where(x => x.m_sSubscriptionCode == nNewSub.ToString()).ToList();
                if (userNewSubList != null && userNewSubList.Count > 0 && userNewSubList[0] != null)
                {
                    log.Debug("ChangeSubscription - New Subscription ID: " + nNewSub + " is already attached to this user. Subscription was not changed");
                    return ChangeSubscriptionStatus.UserHadNewSub;
                }
                string pricingUsername = string.Empty, pricingPassword = string.Empty;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref pricingUsername, ref pricingPassword);

                Subscription[] subs = Utils.GetSubscriptionsDataWithCaching(new List<int>(1) { nNewSub }, pricingUsername, pricingPassword, m_nGroupID);
                if (subs != null && subs.Length > 0)
                {
                    userSubNew = subs[0];
                }
                //set new subscprion
                if (userSubNew != null && userSubNew.m_SubscriptionCode != null)
                {
                    if (!userSubNew.m_bIsRecurring)
                    {
                        log.Debug("ChangeSubscription - New Subscription ID: " + nNewSub + " is not renewable. Subscription was not changed");
                        return ChangeSubscriptionStatus.NewSubNotRenewable;
                    }

                    return SetSubscriptionChange(sSiteGuid, domainID, userSubNew, userSubOld);
                }
                else
                {
                    log.Debug("ChangeSubscription - New Subscription ID: " + nNewSub + " was not found. Subscription was not changed");
                    return ChangeSubscriptionStatus.NewSubNotExits;
                }


            }
            catch (Exception exc)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at ChangeSubscription. ");
                sb.Append(String.Concat(" Ex Msg: ", exc.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGuid));
                sb.Append(String.Concat(" New Sub: ", nNewSub));
                sb.Append(String.Concat(" Old Sub: ", nOldSub));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", exc.GetType().Name));
                sb.Append(String.Concat(" ST: ", exc.StackTrace));
                log.Error("Exception - " + sb.ToString(), exc);
                #endregion

                return ChangeSubscriptionStatus.Error;
            }
        }

        //the new subscription is dummy charged and its end date is set according the previous subscriptions end date
        //the previous  subscription is cancled and its end date is set to 'now'
        private ChangeSubscriptionStatus SetSubscriptionChange(string sSiteGuid, int nDomainID, Subscription subNew, PermittedSubscriptionContainer userSubOld)
        {
            ChangeSubscriptionStatus status = ChangeSubscriptionStatus.Error;
            try
            {
                #region Initialize
                string sCurrency = string.Empty;
                double dPrice = 0;
                string sCouponCode = string.Empty;
                string sUserIP = string.Empty;
                string sCountry = string.Empty;
                string sLanguage = string.Empty;
                string sDeviceName = string.Empty;
                string sSubscriptionCode = subNew.m_SubscriptionCode;
                bool isDummyCharge = true;
                string extraParams = string.Empty;
                string sBillingMethod = string.Empty;//used only in real billing and not dummy
                string sEncryptedCVV = string.Empty;//used only in real billing and not dummy                  

                if (subNew.m_oPriceCode != null && subNew.m_oPriceCode.m_oPrise != null)
                {
                    dPrice = subNew.m_oPriceCode.m_oPrise.m_dPrice;
                    if (subNew.m_oPriceCode.m_oPrise.m_oCurrency != null)
                        sCurrency = subNew.m_oPriceCode.m_oPrise.m_oCurrency.m_sCurrencyCD3;
                }

                if (subNew.m_oSubscriptionUsageModule != null && subNew.m_oSubscriptionUsageModule.m_coupon_id > 0)
                {
                    sCouponCode = subNew.m_oSubscriptionUsageModule.m_coupon_id.ToString();
                }

                string sCouponCodeOld = string.Empty;
                #endregion

                //charge the user for the new subscription with dummy charge
                dPrice = 0d; // Patch for Cinepolis. price == 0 && string.IsNullOrEmpty(encryptedCVV) && string.IsNullOrEmpty(paymentMethodID) will cause billing to dummy charge.
                BillingResponse billResp = CC_BaseChargeUserForBundle(sSiteGuid, dPrice, sCurrency, sSubscriptionCode, sCouponCode, sUserIP, extraParams, sCountry, sLanguage, sDeviceName,
                    isDummyCharge, sBillingMethod, sEncryptedCVV, eBundleType.SUBSCRIPTION);

                //check if the charge was succesful: if so update relevant parameters and cancel the subsciption  
                if (billResp.m_oStatus == BillingResponseStatus.Success)
                {
                    int nBillingTransID = 0;
                    if (Int32.TryParse(billResp.m_sRecieptCode, out nBillingTransID) && nBillingTransID > 0)
                    {
                        //update the new subscription End Date and Billing Method
                        bool updateEndDateNew = ConditionalAccessDAL.Update_SubscriptionPurchaseEndDate(null, sSiteGuid, nBillingTransID, userSubOld.m_dEndDate); // set new sub end date to be the end date of the old sub
                        int nBillingMethod = (int)PaymentMethod.ChangeSubscription;
                        bool updateBillingTrans = ConditionalAccessDAL.Update_BillingMethodInBillingTransactions(nBillingTransID, nBillingMethod);

                        //update the old subscription : is_recurring_status = 0, end_date = 'now'               
                        bool bCancel = ConditionalAccessDAL.CancelSubscription(userSubOld.m_nSubscriptionPurchaseID, m_nGroupID, sSiteGuid, userSubOld.m_sSubscriptionCode) > 0;
                        bool updateEndDateOld = ConditionalAccessDAL.Update_SubscriptionPurchaseEndDate(userSubOld.m_nSubscriptionPurchaseID, sSiteGuid, null, DateTime.UtcNow);

                        if (updateEndDateNew && updateBillingTrans && bCancel && updateEndDateOld)
                        {
                            // Update domain DLM with new DLM from subscription or if no DLM in new subscription, with last domain DLM
                            UpdateDLM(nDomainID, subNew.m_nDomainLimitationModule);
                            status = ChangeSubscriptionStatus.OK;
                            WriteSubChangeToUserLog(sSiteGuid, subNew, userSubOld);
                            // Enqueue notification for PS so they know a collection was charged
                            var dicData = new Dictionary<string, object>()
                            {
                                {"oldSubscription", userSubOld.m_sSubscriptionCode},
                                {"newSubscription", subNew},
                                {"SiteGUID", sSiteGuid},
                                {"domainID", nDomainID}
                            };

                            this.EnqueueEventRecord(NotifiedAction.ChangedSubscription, dicData);
                        }
                        else
                        {
                            status = ChangeSubscriptionStatus.Error;
                            #region Logging
                            StringBuilder sb = new StringBuilder(String.Concat("SetSubscriptionChange. Update of new subscription: ", sSubscriptionCode, " from prev sub: ", userSubOld.m_sSubscriptionCode, " for user: ", sSiteGuid, " failed."));
                            sb.Append(String.Concat(" updateEndDateNew: ", updateEndDateNew.ToString().ToLower()));
                            sb.Append(String.Concat(" updateBillingTrans: ", updateBillingTrans.ToString().ToLower()));
                            sb.Append(String.Concat(" bCancel: ", bCancel.ToString().ToLower()));
                            sb.Append(String.Concat(" updateEndDateOld: ", updateEndDateOld.ToString().ToLower()));

                            log.Error("CriticalError - " + sb.ToString());

                            #endregion
                        }
                    }
                    else
                    {
                        status = ChangeSubscriptionStatus.Error;
                        #region Logging
                        StringBuilder parseMsg = new StringBuilder(String.Concat("SetSubscriptionChange. Failed to parse billing trans id: ", billResp.m_sRecieptCode));
                        parseMsg.Append(String.Concat(" Site Guid: ", sSiteGuid));
                        parseMsg.Append(String.Concat(" New Sub: ", sSubscriptionCode));
                        parseMsg.Append(String.Concat(" Old Sub: ", userSubOld.m_sSubscriptionCode));
                        log.Error("Error - " + parseMsg.ToString());
                        #endregion
                    }
                }
                else
                {
                    status = ChangeSubscriptionStatus.Error;
                    #region Logging
                    StringBuilder billingErr = new StringBuilder(String.Concat("SiteGuid: ", sSiteGuid, " did not receive success from WS_Billing while trying to change subscription. "));
                    billingErr.Append(String.Concat("New Sub: ", sSubscriptionCode));
                    billingErr.Append(String.Concat(" Price: ", dPrice));
                    billingErr.Append(String.Concat(" Curr: ", sCurrency));
                    billingErr.Append(String.Concat(" Coupon Cd: ", sCouponCode));
                    billingErr.Append(String.Concat(" User IP: ", sUserIP));
                    billingErr.Append(String.Concat(" Extra Params: ", extraParams));
                    billingErr.Append(String.Concat(" Cntry: ", sCountry));
                    billingErr.Append(String.Concat(" Lng: ", sLanguage));
                    billingErr.Append(String.Concat(" Device Nm: ", sDeviceName));
                    billingErr.Append(String.Concat(" Is Dummy: ", isDummyCharge.ToString().ToLower()));
                    billingErr.Append(String.Concat(" Bill Resp Status: ", billResp.m_oStatus.ToString()));
                    log.Error("Error - " + billingErr.ToString());
                    #endregion
                }
            }
            catch (Exception exc)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception in SetSubscriptionChange. ");
                sb.Append(String.Concat("Ex Msg: ", exc.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGuid));
                sb.Append(String.Concat(" Stack Trace: ", exc.StackTrace));
                log.Error("SetSubscriptionChange - " + sb.ToString(), exc);
                #endregion
                status = ChangeSubscriptionStatus.Error;
            }
            return status;
        }

        private void WriteSubChangeToUserLog(string sSiteGuid, Subscription subNew, PermittedSubscriptionContainer userSubOld)
        {
            StringBuilder sb = new StringBuilder("Subscription Change Request.");
            sb.Append(String.Concat(" Site Guid: ", sSiteGuid));
            if (subNew != null)
            {
                sb.Append(String.Concat(" Sub New ID: ", subNew.m_SubscriptionCode));
            }
            else
            {
                sb.Append(" Sub New ID is null.");
            }
            if (userSubOld != null)
            {
                sb.Append(String.Concat(" Sub Old ID: ", userSubOld.m_sSubscriptionCode));
            }
            else
            {
                sb.Append(" Sub Old ID is null.");
            }

            WriteToUserLog(sSiteGuid, sb.ToString());
        }

        /// <summary>
        /// Immediately cancel a household service 
        /// Cancel immediately if within cancellation window and content not already consumed OR if force flag is provided
        /// </summary>
        /// <param name="p_nDomainID"></param>
        /// <param name="p_nAssetID"></param>
        /// <param name="p_enmTransactionType"></param>
        /// <param name="p_bIsForce"></param>
        /// <returns></returns>
        public virtual ApiObjects.Response.Status CancelServiceNow(int p_nDomainID, int p_nAssetID,
            eTransactionType p_enmTransactionType, bool p_bIsForce = false)
        {
            ApiObjects.Response.Status oResult = new ApiObjects.Response.Status();

            bool bResult = false;

            try
            {
                // Start with getting domain info for validation
                Domain oDomain = Utils.GetDomainInfo(p_nDomainID, this.m_nGroupID);


                // Check if the domain is OK
                if (oDomain == null)
                {
                    oResult.Code = (int)eResponseStatus.DomainNotExists;
                    oResult.Message = "Domain doesn't exist";
                    log.Error("Domain doesn't exist");
                }
                else
                {
                    if (oDomain.m_DomainStatus != DomainStatus.OK &&
                        oDomain.m_DomainStatus != DomainStatus.DomainCreatedWithoutNPVRAccount)
                    {
                        if (oDomain.m_DomainStatus == DomainStatus.DomainSuspended)
                        {
                            oResult.Code = (int)eResponseStatus.DomainSuspended;
                            oResult.Message = "Domain suspended";
                        }
                        else
                        {
                            oResult.Code = (int)eResponseStatus.DomainNotExists;
                            oResult.Message = "Domain doesn't exist";
                        }
                        log.Error("Domain status: " + oDomain.m_DomainStatus.ToString());
                    }
                    else
                    {
                        DataTable dtUserPurchases = null;
                        DataRow drUserPurchase = null;
                        string sPurchasingSiteGuid = string.Empty;

                        // Check if within cancellation window
                        bool bCancellationWindow = GetCancellationWindow(p_nAssetID, p_enmTransactionType, ref dtUserPurchases, p_nDomainID);

                        // Check if the user purchased the asset at all
                        if (dtUserPurchases == null || dtUserPurchases.Rows == null || dtUserPurchases.Rows.Count == 0)
                        {
                            oResult.Code = (int)eResponseStatus.InvalidPurchase;
                            oResult.Message = "There is not a valid purchase for this user and asset ID";
                        }
                        // Cancel immediately if within cancellation window and content not already consumed OR if force flag is provided
                        else if (bCancellationWindow || p_bIsForce)
                        {
                            drUserPurchase = dtUserPurchases.Rows[0];
                            sPurchasingSiteGuid = ODBCWrapper.Utils.ExtractString(drUserPurchase, "SITE_USER_GUID");
                            int nNumOfUses = ODBCWrapper.Utils.ExtractInteger(drUserPurchase, "NUM_OF_USES");

                            // If user already consumed service - cannot be cancelled without force
                            if (nNumOfUses > 0 && !p_bIsForce)
                            {
                                oResult.Code = (int)eResponseStatus.ContentAlreadyConsumed;
                                oResult.Message = "Service could not be cancelled because content was already consumed";
                            }
                            else
                            {
                                // Cancel NOW - according to type
                                switch (p_enmTransactionType)
                                {
                                    case eTransactionType.PPV:
                                        {
                                            bResult = DAL.ConditionalAccessDAL.CancelPPVPurchaseTransaction(sPurchasingSiteGuid, p_nAssetID, p_nDomainID);
                                            break;
                                        }
                                    case eTransactionType.Subscription:
                                        {
                                            bResult = DAL.ConditionalAccessDAL.CancelSubscriptionPurchaseTransaction(sPurchasingSiteGuid, p_nAssetID, p_nDomainID, (int)SubscriptionPurchaseStatus.CancelNow);
                                            break;
                                        }
                                    case eTransactionType.Collection:
                                        {
                                            bResult = DAL.ConditionalAccessDAL.CancelCollectionPurchaseTransaction(sPurchasingSiteGuid, p_nAssetID, p_nDomainID);
                                            break;
                                        }
                                    default:
                                        {
                                            break;
                                        }
                                }

                                if (bResult)
                                {
                                    // Update domain with last domain DLM
                                    UpdateDLM(p_nDomainID, 0);

                                    // Report to user log
                                    WriteToUserLog(sPurchasingSiteGuid,
                                        string.Format("user :{0} CancelServiceNow for {1} item :{2}", p_nDomainID, Enum.GetName(typeof(eTransactionType), p_enmTransactionType),
                                        p_nAssetID));
                                    //call billing to the client specific billing gateway to perform a cancellation action on the external billing gateway                   

                                    oResult.Code = (int)eResponseStatus.OK;
                                    oResult.Message = "Service successfully cancelled";

                                    if (drUserPurchase != null)
                                    {
                                        DateTime dtEndDate = ODBCWrapper.Utils.ExtractDateTime(drUserPurchase, "END_DATE");

                                        EnqueueCancelServiceRecord(p_nDomainID, p_nAssetID, p_enmTransactionType, dtEndDate);
                                    }

                                    string invalidationKey = LayeredCacheKeys.GetCancelServiceNowInvalidationKey(p_nDomainID);
                                    if (!LayeredCache.Instance.SetInvalidationKey(invalidationKey))
                                    {
                                        log.ErrorFormat("Failed to set invalidation key on CancelServiceNow key = {0}", invalidationKey);
                                    }
                                }
                                else
                                {
                                    oResult.Code = (int)eResponseStatus.Error;
                                    oResult.Message = "Cancellation failed";
                                }
                            }
                        }
                        else
                        {
                            oResult.Code = (int)eResponseStatus.CancelationWindowPeriodExpired;
                            oResult.Message = string.Format("{0} could not be cancelled because it is not in cancellation window", p_enmTransactionType.ToString());
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                #region Logging
                string sLoggingMessage =
                    string.Format("Exception at CancelServiceNow. Ex Msg: {0}, Domain Id: {1}, Asset ID: {2}. Trans Type: {6}. This is {3}, Ex type: {4}, ST: {5}",
                    ex.Message, p_nDomainID, p_nAssetID, this.GetType().Name, ex.GetType().Name, ex.StackTrace, p_enmTransactionType.ToString());
                StringBuilder sb = new StringBuilder("Exception at CancelServiceNow. ");

                log.Error("Exception - " + sLoggingMessage, ex);
                #endregion

                oResult.Code = (int)eResponseStatus.Error;
                oResult.Message = "Unexpected error occurred";
            }

            return oResult;
        }

        /// <summary>
        /// Fire event that cancellation occurred 
        /// </summary>
        /// <param name="p_nDomainId"></param>
        /// <param name="p_nAssetID"></param>
        /// <param name="p_enmTransactionType"></param>
        /// <param name="p_dtServiceEndDate"></param>
        private bool EnqueueCancelServiceRecord(int p_nDomainId, int p_nAssetID, eTransactionType p_enmTransactionType, DateTime p_dtServiceEndDate)
        {
            bool bResult = false;
            try
            {
                Dictionary<string, object> dicData = new Dictionary<string, object>();
                dicData.Add("DomainId", p_nDomainId);
                dicData.Add("ServiceID", p_nAssetID);
                dicData.Add("ServiceType", (int)p_enmTransactionType);
                dicData.Add("ServiceEndDate", p_dtServiceEndDate);

                bResult = EnqueueEventRecord(NotifiedAction.CancelDomainServiceNow, dicData);
            }
            catch (Exception ex)
            {
                log.Error("Exception - " + string.Format("Error when trying to enqueue event record. Msg: {0}", ex.Message));
            }

            return (bResult);
        }

        /// <summary>
        /// Fire event to the queue
        /// </summary>
        /// <param name="dataDictionary"></param>
        protected internal bool EnqueueEventRecord(NotifiedAction action, Dictionary<string, object> dataDictionary)
        {
            bool result = false;

            try
            {
                string task = Utils.GetValueFromConfig("ProfessionalServices.task");

                PSNotificationData oNotification = new PSNotificationData(task, m_nGroupID, dataDictionary, action);

                PSNotificationsQueue qNotificationQueue = new PSNotificationsQueue();

                string routingKey = Utils.GetValueFromConfig("ProfessionalServices.routingKey");

                if (string.IsNullOrEmpty(routingKey))
                {
                    routingKey = m_nGroupID.ToString();
                }

                result = qNotificationQueue.Enqueue(oNotification, routingKey);
                log.Debug(string.Format("EnqueueEventRecord - Notification:{0}, Res:{1}", oNotification.ToString(), result));
            }
            catch (Exception ex)
            {
                log.Error(string.Empty, ex);
            }
            return result;
        }

        /// <summary>
        /// Immediately cancel a household service 
        /// Cancel immediately if within cancellation window and content not already consumed OR if force flag is provided
        /// </summary>
        /// <param name="p_sSiteGuid"></param>
        /// <param name="p_nAssetID"></param>
        /// <param name="p_enmTransactionType"></param>        
        /// <param name="p_bIsForce"></param>
        /// <returns></returns>
        public virtual bool CancelTransaction(string p_sSiteGuid, int p_nAssetID, eTransactionType p_enmTransactionType, bool p_bIsForce = false)
        {
            bool bResult = false;

            try
            {
                System.Data.DataTable dtUserPurchases = null;
                // Get domainID to support canceling a transaction made by a deleted user (not the current p_sSiteGuid)
                long domainid = 0;
                if (Utils.ValidateUser(m_nGroupID, p_sSiteGuid, ref domainid) != ResponseStatus.OK || domainid == 0)
                {
                    return false;
                }
                // Check if within cancellation window
                bool bCancellationWindow = GetCancellationWindow(p_nAssetID, p_enmTransactionType, ref dtUserPurchases, (int)domainid);

                // Cancel immediately if within cancellation window and content not already consumed OR if force flag is provided
                if (bCancellationWindow || p_bIsForce)
                {
                    // Cancel NOW - according to type

                    switch (p_enmTransactionType)
                    {
                        case eTransactionType.PPV:
                            {
                                bResult = DAL.ConditionalAccessDAL.CancelPPVPurchaseTransaction(p_sSiteGuid, p_nAssetID, (int)domainid);
                                break;
                            }
                        case eTransactionType.Subscription:
                            {
                                bResult = DAL.ConditionalAccessDAL.CancelSubscriptionPurchaseTransaction(p_sSiteGuid, p_nAssetID, (int)domainid, (int)SubscriptionPurchaseStatus.CancelNow);
                                break;
                            }
                        case eTransactionType.Collection:
                            {
                                bResult = DAL.ConditionalAccessDAL.CancelCollectionPurchaseTransaction(p_sSiteGuid, p_nAssetID, (int)domainid);
                                break;
                            }
                        default:
                            {
                                break;
                            }
                    }
                }

                if (bResult)
                {
                    // Report to user log
                    WriteToUserLog(p_sSiteGuid, string.Format("user :{0} CancelTransaction for {1} item :{2}", p_sSiteGuid, Enum.GetName(typeof(eTransactionType), p_enmTransactionType), p_nAssetID));
                    //call billing to the client specific billing gateway to perform a cancellation action on the external billing gateway                   

                    string invalidationKey = LayeredCacheKeys.GetCancelTransactionInvalidationKey((long)domainid);
                    if (!LayeredCache.Instance.SetInvalidationKey(invalidationKey))
                    {
                        log.ErrorFormat("Failed to set invalidation key on CancelTransaction key = {0}", invalidationKey);
                    }
                }


            }
            catch (Exception ex)
            {
                #region Logging
                string sLoggingMessage = string.Format("Exception at CancelTransaction. Ex Msg: {0}, Site Guid: {1}, Asset ID: {2}. Trans Type: {6}. This is {3}, Ex type: {4}, ST: {5}",
                    ex.Message, p_sSiteGuid, p_nAssetID, this.GetType().Name, ex.GetType().Name, ex.StackTrace, p_enmTransactionType.ToString());
                StringBuilder sb = new StringBuilder("Exception at CancelTransaction. ");

                log.Error("Exception - " + sLoggingMessage, ex);
                #endregion
            }

            return bResult;
        }

        /// <summary>
        /// Tells whether the users can still cancel the given asset or not - if they are within the cancellation window
        /// </summary>        
        /// <param name="p_nAssetID"></param>
        /// <param name="p_enmServiceType"></param>
        /// <param name="p_nGroupID"></param>
        /// <param name="p_dtUserPurchases"></param>
        /// <param name="p_domainID"></param>
        /// <returns></returns>
        private bool GetCancellationWindow(int p_nAssetID, eTransactionType p_enmServiceType, ref DataTable p_dtUserPurchases, int p_domainID)
        {
            UsageModule oUsageModule = null;
            bool bCancellationWindow = false;
            DateTime dtCreateDate = DateTime.MinValue;
            string sAssetCode = string.Empty;

            // According to service type (sub, ppv or col), get all purchases of users
            switch (p_enmServiceType)
            {
                case eTransactionType.PPV:
                    {
                        p_dtUserPurchases = ConditionalAccessDAL.Get_AllPPVPurchasesByUserIDsAndMediaFileID(p_nAssetID, null, m_nGroupID, p_domainID);
                        break;
                    }
                case eTransactionType.Subscription:
                    {
                        p_dtUserPurchases = ConditionalAccessDAL.Get_AllSubscriptionPurchasesByUserIDsAndSubscriptionCode(p_nAssetID, null, m_nGroupID, p_domainID);
                        break;
                    }
                case eTransactionType.Collection:
                    {
                        p_dtUserPurchases = ConditionalAccessDAL.Get_AllCollectionPurchasesByUserIDsAndCollectionCode(p_nAssetID, null, m_nGroupID, p_domainID);
                        break;
                    }
                default:
                    {
                        bCancellationWindow = false;
                        break;
                    }
            }

            // If any of the users purchased this asset and it is valid
            if (p_dtUserPurchases != null && p_dtUserPurchases.Rows != null && p_dtUserPurchases.Rows.Count > 0)
            {
                // First row is supposed to be the relevant purchase
                DataRow drUserPurchase = p_dtUserPurchases.Rows[0];

                dtCreateDate = ODBCWrapper.Utils.ExtractDateTime(drUserPurchase, "CREATE_DATE");
                sAssetCode = ODBCWrapper.Utils.ExtractString(drUserPurchase, "assetCode"); // ppvCode/SubscriptionCode/CollectionCode

                IsCancellationWindow(ref oUsageModule, sAssetCode, dtCreateDate, ref bCancellationWindow, p_enmServiceType);
            }

            return bCancellationWindow;
        }

        /*This method shall set the waiver flag on the user entitlement table (susbcriptions/ppv/collection_purchases) 
         * and the waiver_date field to the current date.*/
        public virtual ApiObjects.Response.Status WaiverTransaction(string sSiteGuid, int nAssetID, eTransactionType transactionType)
        {
            ApiObjects.Response.Status status = new ApiObjects.Response.Status() { Code = (int)eResponseStatus.Error, Message = "Error" };
            bool bRes = false;
            System.Data.DataTable dt = null;

            try
            {
                // Get domainID to support waiver a transaction made by a deleted user (not the current p_sSiteGuid)
                long domainid = 0;
                ResponseStatus responseStatus = Utils.ValidateUser(m_nGroupID, sSiteGuid, ref domainid);
                if (responseStatus != ResponseStatus.OK || domainid == 0)
                {
                    status = Utils.SetResponseStatus(responseStatus);
                    log.ErrorFormat("User validation failed: {0}, sSiteGuid: {1}", status.Message, sSiteGuid);
                    return status;
                }

                bool bCancellationWindow = GetCancellationWindow(nAssetID, transactionType, ref dt, (int)domainid);

                if (bCancellationWindow)
                {
                    // if it's relevant by dates cancel it
                    switch (transactionType)
                    {
                        case eTransactionType.PPV:
                            bRes = ConditionalAccessDAL.WaiverPPVPurchaseTransaction(sSiteGuid, nAssetID, (int)domainid);
                            break;
                        case eTransactionType.Subscription:
                            bRes = ConditionalAccessDAL.WaiverSubscriptionPurchaseTransaction(sSiteGuid, nAssetID, (int)domainid);
                            break;
                        case eTransactionType.Collection:
                            bRes = ConditionalAccessDAL.WaiverCollectionPurchaseTransaction(sSiteGuid, nAssetID, (int)domainid);
                            break;
                        default:
                            bRes = false;
                            break;
                    }
                }


                if (bRes)
                {
                    status = new ApiObjects.Response.Status() { Code = (int)eResponseStatus.OK, Message = "OK" };
                    WriteToUserLog(sSiteGuid, string.Format("user :{0} waiver cancellation for {1} item :{2}", sSiteGuid, Enum.GetName(typeof(eTransactionType), transactionType), nAssetID));
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at WaiverTransaction. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", sSiteGuid));
                sb.Append(String.Concat(" Asset ID: ", nAssetID));
                sb.Append(String.Concat(" Trans Type: ", transactionType.ToString()));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
            }

            return status;
        }

        private bool TryGetFileUrlLinks(int groupId, int mediaFileID, string userIP, string siteGuid, ref string mainUrl, ref string altUrl,
            ref int mainStreamingCoID, ref int altStreamingCoID, ref int mediaID)
        {
            bool res = false;

            string key = LayeredCacheKeys.GetFileCdnDataKey(mediaFileID);
            DataTable dt = null;
            // try to get from cache            
            bool cacheResult = LayeredCache.Instance.Get<DataTable>(key, ref dt, Utils.GetFileUrlLinks, new Dictionary<string, object>() { { "mediaFileId", mediaFileID } }, groupId, FILE_CDN_DATA_LAYERED_CACHE_CONFIG_NAME);
            if (cacheResult && dt != null && dt.Rows != null && dt.Rows.Count > 0)
            {
                DataRow dr = dt.Rows[0];

                mainUrl = ODBCWrapper.Utils.GetSafeStr(dr, "mainUrl");
                altUrl = ODBCWrapper.Utils.GetSafeStr(dr, "altUrl");
                mainStreamingCoID = ODBCWrapper.Utils.GetIntSafeVal(dr, "CdnID");
                altStreamingCoID = ODBCWrapper.Utils.GetIntSafeVal(dr, "AltCdnID");
                mediaID = ODBCWrapper.Utils.GetIntSafeVal(dr, "media_id");
                res = true;
            }
            return res;
        }


        public virtual LicensedLinkResponse GetLicensedLinks(string sSiteGuid, Int32 nMediaFileID, string sBasicLink, string sUserIP,
           string sRefferer, string sCountryCode, string sLanguageCode, string sDeviceName, string sCouponCode)
        {
            int fileMainStreamingCoID = 0;
            int mediaId = 0;
            string fileType = string.Empty;
            return GetLicensedLinks(sSiteGuid, nMediaFileID, sBasicLink, sUserIP, sRefferer, sCountryCode, sLanguageCode, sDeviceName, sCouponCode, eObjectType.Media,
                ref fileMainStreamingCoID, ref mediaId, ref fileType);
        }

        public virtual LicensedLinkResponse GetLicensedLinks(string sSiteGuid, Int32 nMediaFileID, string sBasicLink, string sUserIP,
           string sRefferer, string sCountryCode, string sLanguageCode, string sDeviceName, string sCouponCode, ref int fileMainStreamingCoID, ref string fileType)
        {
            int mediaId = 0;
            return GetLicensedLinks(sSiteGuid, nMediaFileID, sBasicLink, sUserIP, sRefferer, sCountryCode, sLanguageCode, sDeviceName, sCouponCode, eObjectType.Media,
                ref fileMainStreamingCoID, ref mediaId, ref fileType);
        }

        public virtual LicensedLinkResponse GetLicensedLinks(string sSiteGuid, Int32 nMediaFileID, string sBasicLink, string sUserIP,
            string sRefferer, string sCountryCode, string sLanguageCode, string sDeviceName, string sCouponCode, eObjectType eLinkType, ref int fileMainStreamingCoID, ref int mediaId, ref string fileType)
        {
            LicensedLinkResponse res = new LicensedLinkResponse();

            try
            {
                int[] mediaFiles = new int[1] { nMediaFileID };
                int streamingCoID = 0;
                if (IsAlterBasicLink(sBasicLink, nMediaFileID))
                {
                    sBasicLink = Utils.GetBasicLink(m_nGroupID, mediaFiles, nMediaFileID, sBasicLink, out streamingCoID, out fileType);
                }

                // validate parameters
                if (string.IsNullOrEmpty(sBasicLink) || nMediaFileID <= 0)
                {
                    log.Debug("GetLicensedLinks - " + string.Format("input is invalid. user:{0}, MFID:{1}, device:{2}, link:{3}", sSiteGuid, nMediaFileID, sDeviceName, sBasicLink));

                    res = new LicensedLinkResponse(string.Empty, string.Empty, eLicensedLinkStatus.InvalidInput.ToString(), (int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                    return res;
                }

                MediaFileItemPricesContainer[] prices = GetItemsPrices(mediaFiles, sSiteGuid, sCouponCode, true, sCountryCode,
                    sLanguageCode, sDeviceName, sUserIP);

                if (prices != null && prices.Length > 0)
                {
                    int nMediaID = 0;
                    List<int> lRuleIDS = new List<int>();
                    DomainResponseStatus mediaConcurrencyResponse;

                    string fileMainUrl = string.Empty;
                    string fileAltUrl = string.Empty;
                    int fileAltStreamingCoID = 0;

                    // validate user suspension status
                    if (IsUserSuspended(prices[0]))
                    {
                        log.Debug("GetLicensedLinks - " + string.Format("User is suspended. user:{0}, MFID:{1}", sSiteGuid, nMediaFileID));
                        //returns empty url
                        res = new LicensedLinkResponse(string.Empty, string.Empty, eLicensedLinkStatus.UserSuspended.ToString(), (int)eResponseStatus.UserSuspended, "User suspended");
                        return res;
                    }

                    // validate file parameters
                    if (!TryGetFileUrlLinks(m_nGroupID, nMediaFileID, sUserIP, sSiteGuid, ref fileMainUrl, ref fileAltUrl, ref fileMainStreamingCoID, ref fileAltStreamingCoID, ref nMediaID))
                    {
                        log.Debug("GetLicensedLinks - " + string.Format("Failed to retrieve data from Catalog, user:{0}, MFID:{1}, link:{2}", sSiteGuid, nMediaFileID, sBasicLink));
                        res = new LicensedLinkResponse(string.Empty, string.Empty, eLicensedLinkStatus.InvalidFileData.ToString(), (int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                        return res;
                    }

                    mediaId = nMediaID;

                    // validate prices
                    if (!IsFreeItem(prices[0]) && !IsItemPurchased(prices[0]))
                    {
                        log.Debug("GetLicensedLinks - " + string.Format("Price not valid, user:{0}, MFID:{1}, priceReason:{2}, price:{3}", 
                            sSiteGuid, 
                            nMediaFileID, 
                            prices[0].m_oItemPrices[0].m_PriceReason.ToString(), 
                            prices[0].m_oItemPrices[0].m_oPrice != null? prices[0].m_oItemPrices[0].m_oPrice.m_dPrice.ToString(): string.Empty));
                        res = new LicensedLinkResponse(string.Empty, string.Empty, eLicensedLinkStatus.InvalidPrice.ToString(), (int)eResponseStatus.NotEntitled, "Not entitled");
                        return res;
                    }

                    string CdnStrID = string.Empty;
                    bool bIsDynamic = Utils.GetStreamingUrlType(fileMainStreamingCoID, ref CdnStrID);

                    // validate link
                    if (!sBasicLink.ToLower().Trim().EndsWith(fileMainUrl.ToLower().Trim()) && !bIsDynamic)
                    {
                        log.Debug("GetLicensedLinks - " + string.Format("Error ValidateBaseLink, user:{0}, MFID:{1}, link:{2}", sSiteGuid, nMediaFileID, sBasicLink));
                        res = new LicensedLinkResponse(string.Empty, string.Empty, eLicensedLinkStatus.InvalidBaseLink.ToString(), (int)eResponseStatus.InvalidBaseLink, "Invalid base link");
                        return res;
                    }

                    int domainID = 0;
                    mediaConcurrencyResponse = CheckMediaConcurrency(sSiteGuid, nMediaFileID, sDeviceName, prices, nMediaID, sUserIP, ref lRuleIDS, ref domainID);

                    if (mediaConcurrencyResponse != DomainResponseStatus.OK)
                    {
                        log.Debug("GetLicensedLinks - " + string.Format("{0}, user:{1}, MFID:{2}", mediaConcurrencyResponse.ToString(), sSiteGuid, nMediaFileID));
                        res = new LicensedLinkResponse(string.Empty, string.Empty, mediaConcurrencyResponse.ToString());
                        res.Status = ConcurrencyResponseToResponseStatus(mediaConcurrencyResponse);
                        return res;
                    }

                    if (IsItemPurchased(prices[0]))
                    {
                        PlayUsesManager.HandlePlayUses(this, prices[0], sSiteGuid, nMediaFileID, sUserIP, sCountryCode, sLanguageCode, sDeviceName, sCouponCode, domainID, m_nGroupID);
                    }
                    // item must be free otherwise we wouldn't get this far
                    else if (TVinciShared.WS_Utils.GetTcmBoolValue("ShouldUseLicenseLinkCache")
                            && !Utils.InsertOrSetCachedEntitlementResults(domainID, nMediaFileID, new CachedEntitlementResults(0, 0, DateTime.UtcNow, true, false, eTransactionType.PPV)))
                                // transaction type doesn't matter when item is free so just pass PPV
                    {
                        log.DebugFormat("Failed to insert cachedEntitlementResults, domainId: {0}, mediaFileId: {1}", domainID, nMediaFileID);
                    }

                    if (eLinkType == eObjectType.EPG)
                    {
                        res.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                        return res;
                    }

                    // get adapter
                    bool isDefaultAdapter = false;
                    var adapterResponse = Utils.GetRelevantCDN(m_nGroupID, fileMainStreamingCoID, eAssetTypes.MEDIA, ref isDefaultAdapter);

                    // if adapter response is not null and is adapter (has an adapter url) - call the adapter
                    if (adapterResponse.Adapter != null && !string.IsNullOrEmpty(adapterResponse.Adapter.AdapterUrl))
                    {

                        // if the adapter is default - append the adapter's base url to the file urls
                        if (isDefaultAdapter)
                        {
                            fileMainUrl = string.Format("{0}{1}", adapterResponse.Adapter.BaseUrl, fileMainUrl);
                            fileAltUrl = string.Format("{0}{1}", adapterResponse.Adapter.BaseUrl, fileAltUrl);
                        }

                        // main url
                        var link = CDNAdapterController.GetInstance().GetVodLink(m_nGroupID, adapterResponse.Adapter.ID, sSiteGuid, fileMainUrl, fileType, nMediaID, nMediaFileID, sUserIP);
                        res.mainUrl = link != null ? link.Url : string.Empty;

                        // alt url
                        link = CDNAdapterController.GetInstance().GetVodLink(m_nGroupID, adapterResponse.Adapter.ID, sSiteGuid, fileAltUrl, fileType, nMediaID, nMediaFileID, sUserIP);
                        res.altUrl = link != null ? link.Url : string.Empty;
                    }
                    else if (!string.IsNullOrEmpty(CdnStrID))
                    {
                        Dictionary<string, string> licensedLinkParams = GetLicensedLinkParamsDict(sSiteGuid, nMediaFileID.ToString(),
                            fileMainUrl, sUserIP, sCountryCode, sLanguageCode, sDeviceName, sCouponCode);

                        // TO DO if dynamic call to right provider to get the URL
                        if (eLinkType == eObjectType.Media && bIsDynamic)
                        {
                            //call the right provider to get the link 
                            StreamingProvider.ILSProvider provider = StreamingProvider.LSProviderFactory.GetLSProvidernstance(CdnStrID);
                            if (provider != null)
                            {
                                string vodUrl = provider.GenerateVODLink(sBasicLink);
                                if (!string.IsNullOrEmpty(vodUrl))
                                {
                                    licensedLinkParams[CDNTokenizers.Constants.URL] = vodUrl;
                                }
                            }
                        }

                        res.mainUrl = GetLicensedLink(fileMainStreamingCoID, licensedLinkParams);
                        licensedLinkParams[CDNTokenizers.Constants.URL] = fileAltUrl;
                        res.altUrl = GetLicensedLink(fileAltStreamingCoID, licensedLinkParams);
                    }
                    else
                    {
                        log.DebugFormat("GetLicensedLink: No CDN configuration, fileId = {0}", nMediaFileID);
                        res.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "No CDN configuration");
                        res.mainUrl = string.Empty;
                        res.altUrl = string.Empty;
                        return res;
                    }

                    if (!string.IsNullOrEmpty(res.mainUrl))
                    {
                        res.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                        res.status = mediaConcurrencyResponse.ToString();
                    }

                    // create PlayCycle
                    CreatePlayCycle(sSiteGuid, nMediaFileID, sUserIP, sDeviceName, nMediaID, lRuleIDS, domainID);

                }

            }
            catch (Exception ex)
            {
                res = new LicensedLinkResponse(string.Empty, string.Empty, eLicensedLinkStatus.Error.ToString(), (int)eResponseStatus.Error, eResponseStatus.Error.ToString());

                #region Logging
                StringBuilder sb = new StringBuilder("Exception at GetLicensedLinks. ");
                sb.Append(String.Concat("Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" SiteGuid: ", sSiteGuid));
                sb.Append(String.Concat(" MF ID: ", nMediaFileID));
                sb.Append(String.Concat(" Basic Link: ", sBasicLink));
                sb.Append(String.Concat(" User IP: ", sUserIP));
                sb.Append(String.Concat(" Referrer: ", sRefferer));
                sb.Append(String.Concat(" Country Cd: ", sCountryCode));
                sb.Append(String.Concat(" Lng Cd: ", sLanguageCode));
                sb.Append(String.Concat(" Device Name: ", sDeviceName));
                sb.Append(String.Concat(" Coupon Cd: ", sCouponCode));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);

                #endregion
            }

            return res;
        }

        private ApiObjects.Response.Status ConcurrencyResponseToResponseStatus(DomainResponseStatus mediaConcurrencyResponse)
        {
            ApiObjects.Response.Status res;

            switch (mediaConcurrencyResponse)
            {
                case DomainResponseStatus.LimitationPeriod:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.LimitationPeriod, "Limitation period");
                    break;
                case DomainResponseStatus.Error:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                    break;
                case DomainResponseStatus.ExceededLimit:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.ExceededLimit, "Exceeded limit");
                    break;
                case DomainResponseStatus.DeviceTypeNotAllowed:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.DeviceTypeNotAllowed, "Device type not allowed");
                    break;
                case DomainResponseStatus.DeviceNotInDomain:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.DeviceNotInDomain, "Device not in household");
                    break;
                case DomainResponseStatus.DeviceAlreadyExists:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.DeviceAlreadyExists, "Device already exists");
                    break;
                case DomainResponseStatus.OK:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                    break;
                case DomainResponseStatus.DeviceExistsInOtherDomains:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.DeviceExistsInOtherDomains, "Device exists in other household");
                    break;
                case DomainResponseStatus.ConcurrencyLimitation:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.ConcurrencyLimitation, "Concurrency limitation");
                    break;
                case DomainResponseStatus.MediaConcurrencyLimitation:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.MediaConcurrencyLimitation, "Media concurrency limitation");
                    break;
                default:
                    res = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                    break;
            }

            return res;
        }

        /*******************************************************************************************
         * This method create the PlayCycleSession in CB and also inserts into DB with the (media_concurrency) mc_rule_id 
         ***************************************************************************************** */
        private void CreatePlayCycle(string sSiteGuid, Int32 nMediaFileID, string sUserIP, string sDeviceName, int nMediaID, List<int> lRuleIDS, int domainID)
        {
            int ruleID = 0;
            // create PlayCycle       
            if (lRuleIDS != null && lRuleIDS.Count > 0)
            {
                ruleID = lRuleIDS[0]; // take the first rule (probably will be just one rule)
            }
            string sPlayCycleKey;
            PlayCycleSession playCycleSession = null;
            if (!Utils.IsAnonymousUser(sSiteGuid))
            {
                playCycleSession = Tvinci.Core.DAL.CatalogDAL.InsertPlayCycleSession(sSiteGuid, nMediaFileID, m_nGroupID, sDeviceName, 0, ruleID, domainID);
            }
            if (playCycleSession != null && !string.IsNullOrEmpty(playCycleSession.PlayCycleKey))
            {
                sPlayCycleKey = playCycleSession.PlayCycleKey;
            }
            else
            {
                sPlayCycleKey = Guid.NewGuid().ToString();
            }

            int nCountryID = Utils.GetIP2CountryId(m_nGroupID, sUserIP);
            Tvinci.Core.DAL.CatalogDAL.InsertPlayCycleKey(sSiteGuid, nMediaID, nMediaFileID, sDeviceName, 0, nCountryID, ruleID, m_nGroupID, sPlayCycleKey);
        }

        private DomainResponseStatus CheckMediaConcurrency(string sSiteGuid, Int32 nMediaFileID, string sDeviceName, MediaFileItemPricesContainer[] prices,
            int nMediaID, string sUserIP, ref List<int> lRuleIDS, ref int domainID)
        {
            DomainResponseStatus response = DomainResponseStatus.OK;
            WS_Domains.module domainsWS = null;
            API apiWs = null;

            if (Utils.IsAnonymousUser(sSiteGuid))
            {
                return response;
            }

            try
            {
                int nDeviceFamilyBrand = 0;
                long lSiteGuid = 0;
                long.TryParse(sSiteGuid, out lSiteGuid);

                ValidationResponseObject validationResponse = new ValidationResponseObject();
                domainsWS = new WS_Domains.module();
                string domainUsername = string.Empty;
                string domainPassword = string.Empty;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.DOMAINS, ref domainUsername, ref domainPassword);

                bool skipValidateLimitationModule = false;

                if (prices != null && prices.Length > 0)
                {
                    /*Get Media Concurrency Rules*/
                    string apiUsername = string.Empty;
                    string apiPassword = string.Empty;
                    apiWs = new API();
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.API, ref apiUsername, ref apiPassword);
                    int bmID = 0;
                    bool bSuccess = false;
                    eBusinessModule eBM = eBusinessModule.PPV;

                    if (prices[0].m_oItemPrices != null && prices[0].m_oItemPrices[0].m_PriceReason == PriceReason.PPVPurchased)
                    {
                        bSuccess = int.TryParse(prices[0].m_oItemPrices[0].m_sPPVModuleCode, out bmID);
                    }
                    else if (prices[0].m_oItemPrices != null && prices[0].m_oItemPrices[0].m_PriceReason == PriceReason.SubscriptionPurchased)
                    {
                        bSuccess = int.TryParse(prices[0].m_oItemPrices[0].m_sPPVModuleCode, out bmID);
                        eBM = eBusinessModule.Subscription;
                    }
                    if (!bSuccess)
                    {
                        return response;
                    }

                    List<MediaConcurrencyRule> mcRules = apiWs.GetMediaConcurrencyRules(apiUsername, apiPassword, nMediaID, sUserIP, bmID, eBM);
                    /*MediaConurrency Check */

                    if (mcRules != null && mcRules.Count() > 0)
                    {
                        skipValidateLimitationModule = true;
                        foreach (MediaConcurrencyRule mcRule in mcRules)
                        {
                            lRuleIDS.Add(mcRule.RuleID); // for future use

                            validationResponse = domainsWS.ValidateLimitationModule(domainUsername, domainPassword, sDeviceName, nDeviceFamilyBrand, lSiteGuid, 0,
                                Users.ValidationType.Concurrency, mcRule.RuleID, 0, nMediaID);
                            if (response == DomainResponseStatus.OK && validationResponse != null) // when there is more then one rule  - change response status only when status is still OK (that mean that this is the first time it's change)
                            {
                                response = validationResponse.m_eStatus;
                            }
                        }
                    }
                }

                if (!skipValidateLimitationModule)
                {
                    validationResponse = domainsWS.ValidateLimitationModule(domainUsername, domainPassword, sDeviceName, nDeviceFamilyBrand, lSiteGuid, 0,
                           Users.ValidationType.Concurrency, 0, 0, nMediaID);
                    response = validationResponse.m_eStatus;
                }

                // get domainID from response
                if (validationResponse != null)
                {
                    domainID = (int)validationResponse.m_lDomainID;
                }

                return response;
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at CheckMediaConcurrency. ");
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" SiteGuid: ", sSiteGuid));
                sb.Append(String.Concat(" MF ID: ", nMediaFileID));
                sb.Append(String.Concat(" Device: ", sDeviceName));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
                log.Error("Exception - " + sb.ToString(), ex);
                #endregion
                response = DomainResponseStatus.Error;
            }
            finally
            {
                if (domainsWS != null)
                {
                    domainsWS.Dispose();
                }
                if (apiWs != null)
                {
                    apiWs.Dispose();
                }
            }

            return response;
        }

        private Dictionary<string, string> GetLicensedLinkParamsDict(string sSiteGuid, string mediaFileIDStr, string basicLink,
            string userIP, string countryCode, string langCode,
            string deviceName, string couponCode)
        {
            Dictionary<string, string> res = new Dictionary<string, string>(8);

            res.Add(CDNTokenizers.Constants.SITE_GUID, sSiteGuid);
            res.Add(CDNTokenizers.Constants.MEDIA_FILE_ID, mediaFileIDStr);
            res.Add(CDNTokenizers.Constants.URL, basicLink);
            res.Add(CDNTokenizers.Constants.IP, userIP);
            res.Add(CDNTokenizers.Constants.COUNTRY_CODE, countryCode);
            res.Add(CDNTokenizers.Constants.LANGUAGE_CODE, langCode);
            res.Add(CDNTokenizers.Constants.DEVICE_NAME, deviceName);
            res.Add(CDNTokenizers.Constants.COUPON_CODE, couponCode);

            return res;
        }

        internal bool IsItemPurchased(MediaFileItemPricesContainer price)
        {
            bool res = false;
            if (price == null || price.m_oItemPrices == null || price.m_oItemPrices.Length == 0)
            {
                return res;
            }
            PriceReason reason = price.m_oItemPrices[0].m_PriceReason;
            switch (reason)
            {
                case PriceReason.SubscriptionPurchased:
                case PriceReason.PrePaidPurchased:
                case PriceReason.CollectionPurchased:
                case PriceReason.PPVPurchased:
                    res = price.m_oItemPrices[0].m_oPrice.m_dPrice == 0d;
                    break;
                default:
                    break;

            }

            return res;
        }

        private bool IsAlterBasicLink(string sBasicLink, int nMediaFileID)
        {
            return sBasicLink.Contains(string.Format("||{0}", nMediaFileID));
        }

        private bool IsGetLicensedLinksInputValid(string siteGuid, int mediaFileID, string basicLink)
        {
            int temp = 0;
            return basicLink != null && mediaFileID > 0 && !string.IsNullOrEmpty(siteGuid) && Int32.TryParse(siteGuid, out temp) && temp > 0;
        }

        internal bool IsFreeItem(MediaFileItemPricesContainer container)
        {
            return container != null && (container.m_oItemPrices == null || container.m_oItemPrices.Length == 0 || container.m_oItemPrices[0].m_PriceReason == PriceReason.Free);
        }

        private bool IsUserSuspended(MediaFileItemPricesContainer container)
        {
            return (container.m_oItemPrices[0] != null && container.m_oItemPrices[0].m_PriceReason == PriceReason.UserSuspended);
        }

        public virtual RecordResponse RecordNPVR(string siteGuid, string assetID, bool isSeries)
        {
            throw new NotImplementedException("Not implemented yet.");
        }

        public virtual RecordResponse RecordSeriesByProgramID(string siteGuid, string epgProgramIdAssignedToSeries)
        {
            throw new NotImplementedException("Not implemented yet.");
        }

        public virtual RecordResponse RecordSeriesByName(string siteGuid, string seriesName)
        {
            throw new NotImplementedException("Not implemented yet.");
        }

        public virtual NPVRResponse CancelNPVR(string siteGuid, string assetID, bool isSeries)
        {
            throw new NotImplementedException("Not implemented yet.");
        }

        public virtual NPVRResponse DeleteNPVR(string siteGuid, string assetID, bool isSeries)
        {
            throw new NotImplementedException("Not implemented yet.");
        }

        public virtual QuotaResponse GetNPVRQuota(string siteGuid)
        {
            throw new NotImplementedException("Not implemented yet.");
        }

        public virtual NPVRResponse SetNPVRProtectionStatus(string siteGuid, string assetID, bool isSeries, bool isProtect)
        {
            throw new NotImplementedException("Not implemented yet.");
        }

        protected string GetNPVRLogMsg(string msg, string siteGuid, string assetID, bool isSeries, Exception ex)
        {
            StringBuilder sb = new StringBuilder(String.Concat(msg, "."));
            sb.Append(String.Concat(" Site Guid: ", siteGuid));
            sb.Append(String.Concat(" Asset ID: ", assetID));
            sb.Append(String.Concat(" Is Series: ", isSeries.ToString().ToLower()));
            sb.Append(String.Concat(" this is: ", this.GetType().Name));
            sb.Append(String.Concat(" Group ID: ", m_nGroupID));
            if (ex != null)
            {
                sb.Append(String.Concat(" Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(" ST: ", ex.StackTrace));
            }

            return sb.ToString();
        }

        protected virtual string CalcNPVRLicensedLink(string sProgramId, DateTime dStartTime, int format, string sSiteGUID, Int32 nMediaFileID, string sBasicLink, string sUserIP,
            string sRefferer, string sCOUNTRY_CODE, string sLANGUAGE_CODE, string sDEVICE_NAME, string sCouponCode)
        {
            return string.Empty;
        }
        public ConditionalAccess.Response.DomainServicesResponse GetDomainServices(int domainID)
        {
            DomainServicesResponse domainServicesResponse = new DomainServicesResponse((int)eResponseStatus.OK);
            PermittedSubscriptionContainer[] domainSubscriptions = GetDomainPermittedSubscriptions(domainID);

            if (domainSubscriptions != null)
            {
                List<long> subscriptionIDs = domainSubscriptions.Select(s => long.Parse(s.m_sSubscriptionCode)).ToList();
                DataTable subscriptionServices = PricingDAL.Get_SubscriptionsServices(m_nGroupID, subscriptionIDs);
                if (subscriptionServices != null && subscriptionServices.Rows != null && subscriptionServices.Rows.Count > 0)
                {
                    HashSet<int> uniqueIds = new HashSet<int>();

                    foreach (DataRow row in subscriptionServices.Rows)
                    {
                        int serviceId = ODBCWrapper.Utils.ExtractInteger(row, "service_id");

                        if (!uniqueIds.Contains(serviceId))
                        {
                            domainServicesResponse.Services.Add(new ServiceObject()
                            {
                                ID = serviceId,
                                Name = ODBCWrapper.Utils.GetSafeStr(row["description"])
                            });

                            uniqueIds.Add(serviceId);
                        }
                    }
                }
            }

            return domainServicesResponse;
        }

        protected internal void UpdateDLM(long domainID, int dlm)
        {
            if (dlm == 0)
            {
                long lastDomainDLM = ConditionalAccessDAL.Get_LastDomainDLM(m_nGroupID, domainID);
                ChangeDLMObj changeDlmObj = Utils.ChangeDLM(m_nGroupID, domainID, (int)lastDomainDLM);
                if (changeDlmObj.resp == null || changeDlmObj.resp.Code != (int)eResponseStatus.OK)
                {
                    #region Logging
                    StringBuilder sb = new StringBuilder("Failed to change domain DLM to last DLM");
                    sb.Append(String.Concat(" with Status: ", changeDlmObj.resp));
                    sb.Append(String.Concat(" Domain ID: ", domainID));
                    sb.Append(String.Concat(" Last DLM ID: ", lastDomainDLM));
                    sb.Append(String.Concat(" BaseConditionalAccess is: ", this.GetType().Name));
                    log.Debug("ChangeDLM - " + sb.ToString());
                    #endregion
                }
            }
            else
            {
                ChangeDLMObj changeDlmObj = Utils.ChangeDLM(m_nGroupID, domainID, dlm);
                if (changeDlmObj.resp == null || changeDlmObj.resp.Code != (int)eResponseStatus.OK)
                {
                    #region Logging
                    StringBuilder sb = new StringBuilder("Failed to change domain DLM to new DLM");
                    sb.Append(String.Concat(" with Status: ", changeDlmObj.resp));
                    sb.Append(String.Concat(" Domain ID: ", domainID));
                    sb.Append(String.Concat(" New DLM ID: ", dlm));
                    sb.Append(String.Concat(" BaseConditionalAccess is: ", this.GetType().Name));
                    log.Debug("ChangeDLM - " + sb.ToString());
                    #endregion
                }
            }
        }

        protected bool IsServiceAllowed(int domainID, eService service)
        {
            List<int> enforcedGroupServices = Utils.GetGroupEnforcedServices(m_nGroupID);
            //check if service is part of the group enforced services
            if (enforcedGroupServices == null || enforcedGroupServices.Count == 0 || !enforcedGroupServices.Contains((int)service))
            {
                return true;
            }

            // check if the service is allowed for the domain
            ConditionalAccess.Response.DomainServicesResponse allowedDomainServicesRes = GetDomainServices(domainID);
            if (allowedDomainServicesRes != null && allowedDomainServicesRes.Status.Code == 0 &&
                allowedDomainServicesRes.Services != null && allowedDomainServicesRes.Services.Count > 0 && allowedDomainServicesRes.Services.Where(s => s.ID == (int)service).FirstOrDefault() != null)
            {
                return true;
            }

            return false;
        }

        protected eService GetServiceByEPGFormat(eEPGFormatType eformat)
        {
            eService eservice;

            switch (eformat)
            {
                case eEPGFormatType.Catchup:
                    eservice = eService.CatchUp;
                    break;
                case eEPGFormatType.StartOver:
                    eservice = eService.StartOver;
                    break;
                case eEPGFormatType.LivePause:
                    eservice = eService.Unknown;
                    break;
                case eEPGFormatType.NPVR:
                    eservice = eService.NPVR;
                    break;
                default:
                    eservice = eService.Unknown;
                    break;
            }
            return eservice;
        }

        /// <summary>
        /// Get User Subscriptions
        /// </summary>
        public virtual Entitlements GetUserSubscriptions(string sSiteGUID)
        {
            Entitlements response = new Entitlements();

            try
            {
                PermittedSubscriptionContainer[] psc = GetUserPermittedSubscriptions(new List<int>() { int.Parse(sSiteGUID) }, false, 0);
                if (psc != null && psc.Length > 0)
                {
                    // fill Entitlement object
                    response.status = new ApiObjects.Response.Status((int)ApiObjects.Response.eResponseStatus.OK, "OK");
                    response.entitelments = new List<Entitlement>();
                    foreach (PermittedSubscriptionContainer item in psc)
                    {
                        Entitlement ent = new Entitlement(item);
                        response.entitelments.Add(ent);
                    }
                }
                else
                {
                    response = new Entitlements();
                    response.status = new ApiObjects.Response.Status((int)ApiObjects.Response.eResponseStatus.OK, "no items return");
                }
            }
            catch (Exception ex)
            {
                log.Error("GetUserSubscriptions - " + string.Format("failed GetUserPermittedSubscriptions ex = {0}", ex.Message), ex);
                response = new Entitlements();
                response.status = new ApiObjects.Response.Status((int)ApiObjects.Response.eResponseStatus.Error, ApiObjects.Response.eResponseStatus.Error.ToString());
            }
            return response;
        }

        /// <summary>
        /// Get users' entitlements (PPV or subscriptions or collections)
        /// </summary>
        public virtual Entitlements GetUsersEntitlements(int domainID, List<int> userIds, eTransactionType type, bool isExpired = false, int numOfItems = 0, bool shouldCheckByDomain = true,
            int pageSize = 500, int pageIndex = 0, EntitlementOrderBy orderBy = EntitlementOrderBy.PurchaseDateAsc)
        {
            Entitlements response = new Entitlements();
            response.status = new ApiObjects.Response.Status((int)ApiObjects.Response.eResponseStatus.Error, ApiObjects.Response.eResponseStatus.Error.ToString());

            if (!shouldCheckByDomain)
            {
                domainID = 0;
            }

            try
            {
                switch (type)
                {
                    case eTransactionType.PPV:
                        {
                            response = GetUsersEntitlementPPVItems(userIds, isExpired, domainID, shouldCheckByDomain, pageSize, pageIndex, orderBy);
                            break;
                        }
                    case eTransactionType.Subscription:
                        {
                            response = GetUsersEntitlementSubscriptionsItems(userIds, isExpired, domainID, shouldCheckByDomain, pageSize, pageIndex, orderBy);
                            break;
                        }
                    case eTransactionType.Collection:
                        {
                            response = GetUsersEntitlementCollectionsItems(userIds, isExpired, domainID, shouldCheckByDomain, pageSize, pageIndex, orderBy);
                            break;
                        }
                    default:
                        break;
                }
            }
            catch (Exception ex)
            {
                log.Error("GetUserSubscriptions - " + string.Format("failed GetUserPermittedSubscriptions ex = {0}", ex.Message), ex);
                response = new Entitlements();
                response.status = new ApiObjects.Response.Status((int)ApiObjects.Response.eResponseStatus.Error, ApiObjects.Response.eResponseStatus.Error.ToString());
            }
            return response;
        }

        private Entitlements GetUsersEntitlementCollectionsItems(List<int> userIds, bool isExpired, int domainID, bool shouldCheckByDomain, int pageSize, int pageIndex, EntitlementOrderBy orderBy)
        {
            Entitlements entitlementsResponse = new Entitlements();
            try
            {
                // Get domainID from one of the users
                if (shouldCheckByDomain && domainID == 0 && userIds.Count > 0)
                {
                    UserResponseObject user = Utils.GetExistUser(userIds.First().ToString(), m_nGroupID);
                    if (user != null && user.m_RespStatus == ResponseStatus.OK && user.m_user != null)
                    {
                        domainID = user.m_user.m_domianID;
                    }
                }

                DataTable allCollectionsPurchases = ConditionalAccessDAL.Get_UsersPermittedCollections(userIds, isExpired, domainID, (int)orderBy);
                if (allCollectionsPurchases == null || allCollectionsPurchases.Rows == null || allCollectionsPurchases.Rows.Count == 0)
                {
                    entitlementsResponse.status = new ApiObjects.Response.Status((int)eResponseStatus.OK, "no permitted items");
                    return entitlementsResponse;
                }

                //Get Iteration Rows according page size and index
                IEnumerable<DataRow> iterationRows = GetIterationRows(pageSize, pageIndex, allCollectionsPurchases);

                Entitlement entitlement = null;
                foreach (DataRow dr in iterationRows)
                {
                    entitlement = CreateCollectionEntitelment(dr, isExpired);
                    if (entitlement != null)
                    {
                        if (entitlement != null)
                        {
                            entitlementsResponse.entitelments.Add(entitlement);
                        }
                    }
                }
                entitlementsResponse.status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
            }
            catch (Exception ex)
            {
                log.Error("Exception at GetUserPermittedCollections {0} - ", ex);
                entitlementsResponse.status = new ApiObjects.Response.Status((int)ApiObjects.Response.eResponseStatus.Error, ApiObjects.Response.eResponseStatus.Error.ToString());
            }
            return entitlementsResponse;
        }

        private Entitlement CreateCollectionEntitelment(DataRow dataRow, bool isExpired)
        {
            UsageModule oUsageModule = null;
            Entitlement entitlement = new Entitlement();

            entitlement.type = eTransactionType.Collection;
            entitlement.entitlementId = ODBCWrapper.Utils.GetSafeStr(dataRow, "COLLECTION_CODE");

            entitlement.endDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow, "END_DATE");
            int maxUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "MAX_NUM_OF_USES");
            int currentUses = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "NUM_OF_USES");
            entitlement.lastViewDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow, "LAST_VIEW_DATE");

            if (isExpired && maxUses != 0 && currentUses >= maxUses)
            {
                entitlement.endDate = entitlement.lastViewDate;
            }

            entitlement.currentDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow, "cDate");
            entitlement.purchaseDate = ODBCWrapper.Utils.GetDateSafeVal(dataRow, "CREATE_DATE");
            entitlement.purchaseID = ODBCWrapper.Utils.GetIntSafeVal(dataRow, "ID");
            entitlement.paymentMethod = GetBillingTransMethod(ODBCWrapper.Utils.GetIntSafeVal(dataRow, "billing_transaction_id"), ODBCWrapper.Utils.GetSafeStr(dataRow, "BILLING_GUID"));
            entitlement.deviceUDID = ODBCWrapper.Utils.GetSafeStr(dataRow, "device_name");
            entitlement.deviceName = string.Empty;
            if (!string.IsNullOrEmpty(entitlement.deviceUDID))
            {
                entitlement.deviceName = GetDeviceName(entitlement.deviceUDID);
            }

            if (ODBCWrapper.Utils.GetIntSafeVal(dataRow, "WAIVER") == 0 &&
              entitlement.lastViewDate < entitlement.purchaseDate)// user didn't waiver yet and didn't use the PPV yet
            {
                bool cancellationWindow = false;
                IsCancellationWindow(ref oUsageModule, entitlement.entitlementId, entitlement.purchaseDate, ref cancellationWindow, eTransactionType.Subscription);
                entitlement.cancelWindow = cancellationWindow;
            }
            return entitlement;
        }

        public virtual Entitlements GetUserEntitlements(string siteGuid, eTransactionType type, bool isExpired = false, int pageSize = 500, int pageIndex = 0, EntitlementOrderBy orderBy = EntitlementOrderBy.PurchaseDateAsc)
        {
            int userId, domainID = 0;
            DomainSuspentionStatus userSuspendStatus = DomainSuspentionStatus.OK;
            if (int.TryParse(siteGuid, out userId) && Utils.IsUserValid(siteGuid, m_nGroupID, ref domainID, ref userSuspendStatus))
            {
                return GetUsersEntitlements(domainID, new List<int>() { userId }, type, isExpired, 0, false, pageSize, pageIndex, orderBy);
            }
            else
            {
                Entitlements response = new Entitlements();
                response.status = new ApiObjects.Response.Status((int)ApiObjects.Response.eResponseStatus.UserDoesNotExist, ApiObjects.Response.eResponseStatus.UserDoesNotExist.ToString());
                return response;
            }
        }

        public virtual Entitlements GetDomainEntitlements(int domainId, eTransactionType type, bool isExpired = false, int pageSize = 500, int pageIndex = 0, EntitlementOrderBy orderBy = EntitlementOrderBy.PurchaseDateAsc)
        {
            List<int> intUsersList = GetDomainsUsers(domainId);
            return GetUsersEntitlements(domainId, intUsersList, type, isExpired);
        }

        /// <summary>
        /// Purchase
        /// </summary>
        public virtual TransactionResponse Purchase(string siteguid, long household, double price, string currency, int contentId, int productId,
                                                 eTransactionType transactionType, string coupon, string userIp, string deviceName, int paymentGwId, int paymentMethodId, string adapterData)
        {
            return PurchaseManager.Purchase(this, this.m_nGroupID, siteguid, household, price, currency, contentId, productId, transactionType, coupon, userIp, deviceName,
                paymentGwId, paymentMethodId, adapterData);
        }

        /// <summary>
        /// Purchase
        /// </summary>
        public virtual TransactionResponse ProcessReceipt(string siteguid, long household, int contentId, int productId, eTransactionType transactionType,
                                                          string userIp, string deviceName, string purchaseToken, string paymentGatewayName)
        {
            TransactionResponse response = new TransactionResponse((int)eResponseStatus.Error, eResponseStatus.Error.ToString());

            // log request
            string logString = string.Format("Purchase request: siteguid {0}, household {1}, contentId {2}, productId {3}, productType {4}, userIp {5}, deviceName {6}, purchaseToken {7}, paymentGatewayName {8}",
                !string.IsNullOrEmpty(siteguid) ? siteguid : string.Empty,           // {0}
                household,                                                           // {1}
                contentId,                                                           // {2}
                productId,                                                           // {3}   
                transactionType.ToString(),                                          // {4}
                !string.IsNullOrEmpty(userIp) ? userIp : string.Empty,               // {5}
                !string.IsNullOrEmpty(deviceName) ? deviceName : string.Empty,       // {6}
                !string.IsNullOrEmpty(purchaseToken) ? purchaseToken : string.Empty, // {7}
                !string.IsNullOrEmpty(paymentGatewayName) ? paymentGatewayName : string.Empty);// {8}

            log.Debug(logString);

            // validate siteguid
            if (string.IsNullOrEmpty(siteguid))
            {
                response.Status.Message = "Illegal user ID";
                log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                return response;
            }

            // validate productId
            if (productId < 1)
            {
                response.Status.Message = "Illegal product ID";
                log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                return response;
            }

            // validate purchase token
            if (string.IsNullOrEmpty(purchaseToken))
            {
                response.Status.Message = "Illegal purchase token";
                log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                return response;
            }

            // validate payment gateway 
            if (string.IsNullOrEmpty(paymentGatewayName))
            {
                response.Status.Message = "Illegal payment gateway type";
                log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                return response;
            }

            try
            {
                // validate user
                ResponseStatus userValidStatus = ResponseStatus.OK;
                userValidStatus = Utils.ValidateUser(m_nGroupID, siteguid, ref household);

                if (userValidStatus != ResponseStatus.OK)
                {
                    // user validation failed
                    response.Status = Utils.SetResponseStatus(userValidStatus);
                    log.ErrorFormat("User validation failed: {0}, data: {1}", response.Status.Message, logString);
                    return response;
                }

                // validate household
                if (household < 1)
                {
                    response.Status.Message = "Illegal household";
                    log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                    return response;
                }

                switch (transactionType)
                {
                    case eTransactionType.PPV:
                        response = ProcessPPVReceipt(siteguid, household, productId, userIp, deviceName, purchaseToken, paymentGatewayName, contentId);
                        break;
                    case eTransactionType.Subscription:
                        response = ProcessSubscriptionReceipt(siteguid, household, productId, userIp, deviceName, purchaseToken, paymentGatewayName);
                        break;
                    case eTransactionType.Collection:
                        response = ProcessCollectionReceipt(siteguid, household, productId, userIp, deviceName, purchaseToken, paymentGatewayName);
                        break;
                    default:
                        response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Illegal product ID");
                        log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                        break;
                }
            }
            catch (Exception ex)
            {
                log.Error(string.Format("Purchase Error. data: {0}", logString), ex);
            }

            return response;
        }


        private TransactionResponse ProcessPPVReceipt(string siteguid, long householdId, int productId, string userIp, string deviceName, string purchaseToken, string paymentGwName, int contentId)
        {
            TransactionResponse response = new TransactionResponse((int)eResponseStatus.Error, eResponseStatus.Error.ToString());

            // log request
            string logString = string.Format("TVOD - Purchase request: siteguid {0}, household {1}, productId {2}, userIp {3}, deviceName {4}, purchaseToken {5}, paymentGwName {6}, content ID {7}",
                !string.IsNullOrEmpty(siteguid) ? siteguid : string.Empty,           // {0}
                householdId,                                                         // {1}
                productId,                                                           // {2}   
                !string.IsNullOrEmpty(userIp) ? userIp : string.Empty,               // {3}
                !string.IsNullOrEmpty(deviceName) ? deviceName : string.Empty,       // {4}
                !string.IsNullOrEmpty(purchaseToken) ? purchaseToken : string.Empty, // {5}
                !string.IsNullOrEmpty(paymentGwName) ? paymentGwName : string.Empty, // {6}
                contentId);                                                          // {7}

            try
            {
                // validate content ID
                if (contentId < 1)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, ILLEGAL_CONTENT_ID);
                    log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                    return response;
                }

                // validate content ID related media
                int mediaID = ConditionalAccess.Utils.GetMediaIDFromFileID(contentId, m_nGroupID);
                if (mediaID < 1)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Content ID with a related media");
                    log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                    return response;
                }

                // validate PPV 
                PPVModule ppv = null;
                ApiObjects.Response.Status status = Utils.ValidatePPVModuleCode(m_nGroupID, productId, contentId, ref ppv);
                if (status.Code != (int)eResponseStatus.OK)
                {
                    response.Status = status;
                    log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                    return response;
                }

                // validate price
                PriceReason ePriceReason = PriceReason.UnKnown;
                Subscription relevantSub = null;
                Collection relevantCol = null;
                PrePaidModule relevantPP = null;
                Price oPrice = Utils.GetMediaFileFinalPriceForNonGetItemsPrices(contentId, ppv, siteguid, string.Empty, m_nGroupID,
                                                                                              ref ePriceReason, ref relevantSub, ref relevantCol, ref relevantPP,
                                                                                              string.Empty, string.Empty, deviceName);

                if (ePriceReason == PriceReason.ForPurchase ||
                   (ePriceReason == PriceReason.SubscriptionPurchased && oPrice.m_dPrice > 0))
                {
                    // item is for purchase

                    string country = string.Empty;
                    if (!string.IsNullOrEmpty(userIp))
                    {
                        // get country by user IP
                        country = Utils.GetIP2CountryName(m_nGroupID, userIp);
                    }

                    // create custom data
                    string customData = GetCustomData(relevantSub, ppv, null, siteguid, oPrice.m_dPrice, oPrice.m_oCurrency.m_sCurrencyCD3,
                                                      contentId, mediaID, productId.ToString(), string.Empty, string.Empty,
                                                      userIp, country, string.Empty, deviceName);

                    // create new GUID for billing transaction
                    string billingGuid = Guid.NewGuid().ToString();

                    // get PPV product code - first priority from file, second from PPV
                    string ppvCode = ppv.m_Product_Code;
                    var mediaMappers = Utils.GetMediaMapper(m_nGroupID, new int[] { contentId });
                    if (mediaMappers != null && mediaMappers.Length > 0)
                    {
                        if (!string.IsNullOrEmpty(mediaMappers[0].m_sProductCode))
                            ppvCode = mediaMappers[0].m_sProductCode;
                    }

                    // purchase
                    response = VerifyPurchase(siteguid, householdId, oPrice.m_dPrice, oPrice.m_oCurrency.m_sCurrencyCD3, userIp, customData,
                                                productId, ppvCode, eTransactionType.PPV, billingGuid, paymentGwName, contentId, purchaseToken);
                    if (response != null &&
                        response.Status != null)
                    {
                        // Status OK + (State OK || State Pending) = grant entitlement
                        if (response.Status.Code == (int)eResponseStatus.OK &&
                           (response.State.Equals(eTransactionState.OK.ToString()) ||
                            response.State.Equals(eTransactionState.Pending.ToString())))
                        {
                            // purchase passed
                            long purchaseId = 0;

                            // update entitlement date
                            DateTime entitlementDate = DateTime.UtcNow;
                            response.CreatedAt = DateUtils.DateTimeToUnixTimestamp(entitlementDate);

                            // grant entitlement
                            bool handleBillingPassed = HandlePPVBillingSuccess(ref response, siteguid, householdId, relevantSub, oPrice.m_dPrice, oPrice.m_oCurrency.m_sCurrencyCD3, string.Empty, userIp,
                                                                               country, deviceName, long.Parse(response.TransactionID), customData, ppv,
                                                                               productId, contentId, billingGuid, entitlementDate, ref purchaseId);

                            if (handleBillingPassed)
                            {
                                WriteToUserLog(siteguid, string.Format("PPV Purchase, ProductID:{0}, ContentID:{1}, PurchaseID:{2}, BillingTransactionID:{3}",
                                    productId, contentId, purchaseId, response.TransactionID));

                                // entitlement passed - build notification message
                                var dicData = new Dictionary<string, object>()
                                    {
                                        {"MediaFileID", contentId},
                                        {"BillingTransactionID", response.TransactionID},
                                        {"PPVModuleCode", productId},
                                        {"SiteGUID", siteguid},
                                        {"CouponCode", string.Empty},
                                        {"CustomData", customData},
                                        {"PurchaseID", purchaseId}
                                    };

                                // notify purchase
                                if (!this.EnqueueEventRecord(NotifiedAction.ChargedMediaFile, dicData))
                                {
                                    log.DebugFormat("Error while enqueue purchase record: {0}, data: {1}", response.Status.Message, logString);
                                }
                            }
                            else
                            {
                                // purchase passed, entitlement failed
                                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "purchase passed, entitlement failed");
                                log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                            }
                        }
                        else
                        {
                            // purchase failed - received error status
                            log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                        }
                    }
                    else
                    {
                        // purchase failed - no status error
                        response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "purchase failed");
                        log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                    }

                }
                else
                {
                    // not for purchase
                    response.Status = Utils.SetResponseStatus(ePriceReason);
                    log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                }
            }
            catch (Exception ex)
            {
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error);
                log.Error("Exception occurred. data: " + logString, ex);
            }
            return response;
        }

        private TransactionResponse ProcessSubscriptionReceipt(string siteguid, long householdId, int productId, string userIp, string deviceName, string purchaseToken, string paymentGwName)
        {
            TransactionResponse response = new TransactionResponse((int)eResponseStatus.Error, eResponseStatus.Error.ToString());

            // log request
            string logString = string.Format("SVOD - Purchase request: siteguid {0}, household {1}, productId {2}, userIp {3}, deviceName {4}, purchaseToken {5}, paymentGwName {6}",
                !string.IsNullOrEmpty(siteguid) ? siteguid : string.Empty,           // {0}
                householdId,                                                         // {1}
                productId,                                                           // {2}   
                !string.IsNullOrEmpty(userIp) ? userIp : string.Empty,               // {3}
                !string.IsNullOrEmpty(deviceName) ? deviceName : string.Empty,       // {4}
                !string.IsNullOrEmpty(purchaseToken) ? purchaseToken : string.Empty, // {5}
                !string.IsNullOrEmpty(paymentGwName) ? paymentGwName : string.Empty);// {6}

            try
            {
                string country = string.Empty;
                if (!string.IsNullOrEmpty(userIp))
                {
                    // get country by user IP
                    country = Utils.GetIP2CountryName(m_nGroupID, userIp);
                }

                // validate item is for purchased
                PriceReason priceReason = PriceReason.UnKnown;
                Subscription subscription = null;
                Price priceResponse = Utils.GetSubscriptionFinalPrice(m_nGroupID, productId.ToString(), siteguid, string.Empty, ref priceReason, ref subscription, country, string.Empty, deviceName);

                bool entitleToPreview = priceReason == PriceReason.EntitledToPreviewModule;

                if (priceReason == PriceReason.ForPurchase ||
                    entitleToPreview)
                {
                    // item is for purchase
                    if (priceResponse != null)
                    {
                        // price is validated, create custom data
                        string customData = GetCustomDataForSubscription(subscription, null, productId.ToString(), string.Empty, siteguid, priceResponse.m_dPrice, priceResponse.m_oCurrency.m_sCurrencyCD3,
                                                                         string.Empty, userIp, country, string.Empty, deviceName, string.Empty,
                                                                         entitleToPreview ? subscription.m_oPreviewModule.m_nID + "" : string.Empty,
                                                                         entitleToPreview);

                        // create new GUID for billing transaction
                        string billingGuid = Guid.NewGuid().ToString();

                        // purchase
                        response = VerifyPurchase(siteguid, householdId, priceResponse.m_dPrice, priceResponse.m_oCurrency.m_sCurrencyCD3, userIp, customData,
                                                  productId, subscription.m_ProductCode, eTransactionType.Subscription, billingGuid, paymentGwName, 0, purchaseToken);
                        if (response != null &&
                            response.Status != null)
                        {
                            // Status OK + (State OK || State Pending) = grant entitlement
                            if (response.Status.Code == (int)eResponseStatus.OK &&
                               (response.State.Equals(eTransactionState.OK.ToString()) ||
                                response.State.Equals(eTransactionState.Pending.ToString())))
                            {
                                // purchase passed
                                long purchaseID = 0;

                                // update entitlement date
                                DateTime entitlementDate = DateTime.UtcNow;
                                response.CreatedAt = DateUtils.DateTimeToUnixTimestamp(entitlementDate);

                                DateTime? subscriptionEndDate = null;
                                if (response.EndDateSeconds > 0)
                                {
                                    subscriptionEndDate = DateUtils.UnixTimeStampToDateTime(response.EndDateSeconds);
                                }

                                bool isRecurring = subscription.m_bIsRecurring && response.AutoRenewing;

                                // grant entitlement
                                bool handleBillingPassed = HandleSubscriptionBillingSuccess(ref response, siteguid, householdId, subscription, priceResponse.m_dPrice, priceResponse.m_oCurrency.m_sCurrencyCD3, string.Empty, userIp,
                                                                                      country, deviceName, long.Parse(response.TransactionID), customData, productId,
                                                                                      billingGuid.ToString(), entitleToPreview, isRecurring, entitlementDate, ref purchaseID, ref subscriptionEndDate, SubscriptionPurchaseStatus.OK);

                                if (handleBillingPassed && subscriptionEndDate.HasValue)
                                {
                                    // entitlement passed, update domain DLM with new DLM from subscription or if no DLM in new subscription, with last domain DLM
                                    if (subscription.m_nDomainLimitationModule != 0)
                                    {
                                        UpdateDLM(householdId, subscription.m_nDomainLimitationModule);
                                    }

                                    if (subscription.m_bIsRecurring)
                                    {
                                        PaymentGateway paymentGatewayResponse = null;
                                        try
                                        {
                                            // call billing process renewal
                                            string billingUserName = string.Empty;
                                            string billingPassword = string.Empty;
                                            module wsBillingService = null;
                                            InitializeBillingModule(ref wsBillingService, ref billingUserName, ref billingPassword);
                                            paymentGatewayResponse = wsBillingService.GetPaymentGatewayByBillingGuid(billingUserName, billingPassword, householdId, billingGuid);

                                            DateTime nextRenewalDate = subscriptionEndDate.Value.AddMinutes(-5); // default

                                            if (paymentGatewayResponse == null)
                                            {
                                                // error getting PG
                                                log.Error("Error getting the PG");
                                            }
                                            else
                                            {
                                                nextRenewalDate = subscriptionEndDate.Value.AddMinutes(paymentGatewayResponse.RenewalStartMinutes);
                                            }

                                            // enqueue renew transaction
                                            RenewTransactionsQueue queue = new RenewTransactionsQueue();
                                            RenewTransactionData data = new RenewTransactionData(m_nGroupID, siteguid, purchaseID, billingGuid, TVinciShared.DateUtils.DateTimeToUnixTimestamp((DateTime)subscriptionEndDate),
                                                nextRenewalDate);
                                            bool enqueueSuccessful = queue.Enqueue(data, string.Format(ROUTING_KEY_PROCESS_RENEW_SUBSCRIPTION, m_nGroupID));
                                            if (!enqueueSuccessful)
                                            {
                                                log.ErrorFormat("Failed enqueue of renew transaction {0}", data);
                                            }
                                            else
                                                log.DebugFormat("New task created (upon process subscription receipt response). Next renewal date: {0} data: {1}", nextRenewalDate, data);
                                        }
                                        catch (Exception ex)
                                        {
                                            log.Error("Error while trying to get the PG", ex);
                                        }
                                    }

                                    // build notification message
                                    var dicData = new Dictionary<string, object>()
                                    {
                                        {"SubscriptionCode", productId},
                                        {"BillingTransactionID", response.TransactionID},
                                        {"SiteGUID", siteguid},
                                        {"PurchaseID", purchaseID},
                                        {"CouponCode", string.Empty},
                                        {"CustomData", customData}
                                    };

                                    // notify purchase
                                    if (!this.EnqueueEventRecord(NotifiedAction.ChargedSubscription, dicData))
                                    {
                                        log.ErrorFormat("Error while enqueue purchase record: {0}, data: {1}", response.Status.Message, logString);
                                    }
                                }
                                else
                                {
                                    // purchase passed, entitlement failed
                                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "purchase passed but entitlement failed");
                                    log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                                }
                            }
                            else
                            {
                                // purchase failed - received error status
                                log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                            }
                        }
                        else
                        {
                            // purchase failed - no status error
                            response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "purchase failed");
                            log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                        }
                    }
                    else
                    {
                        // incorrect price
                        response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Error while getting item price");
                        log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                    }
                }
                else
                {
                    // item not for purchase
                    response.Status = Utils.SetResponseStatus(priceReason);
                    log.ErrorFormat("Error: {0}, data: {1}", response.Status.Message, logString);
                }
            }
            catch (Exception ex)
            {
                log.Error(string.Empty, ex);
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }
            return response;
        }

        private TransactionResponse ProcessCollectionReceipt(string siteguid, long householdId, int productId, string userIp, string deviceName, string purchaseToken, string paymentGwType)
        {
            return null;
        }

        protected TransactionResponse VerifyPurchase(string siteGUID, long houseHoldID, double price, string currency, string userIP, string customData,
                                                 int productID, string productCode, eTransactionType transactionType, string billingGuid, string paymentGWName, int contentId, string purchaseToken)
        {
            TransactionResponse response = new TransactionResponse();

            string logString = string.Format("fail get response from billing service siteGUID={0}, houseHoldID={1}, price={2}, currency={3}, userIP={4}, customData={5}, productID={6}, productCode={7}, transactionType={8}, billingGuid={9}, paymentGWId={10}, purchaseToken={11}, content ID={12}",
                                        !string.IsNullOrEmpty(siteGUID) ? siteGUID : string.Empty,              // {0}
                                        houseHoldID,                                                            // {1}
                                        price,                                                                  // {2}
                                        !string.IsNullOrEmpty(currency) ? currency : string.Empty,              // {3}
                                        !string.IsNullOrEmpty(userIP) ? userIP : string.Empty,                  // {4}
                                        !string.IsNullOrEmpty(customData) ? customData : string.Empty,          // {5}
                                        productID,                                                              // {6}
                                        productCode,                                                            // {7}
                                        transactionType.ToString(),                                             // {8}
                                        !string.IsNullOrEmpty(billingGuid) ? billingGuid : string.Empty,        // {9}
                                        !string.IsNullOrEmpty(paymentGWName) ? paymentGWName : string.Empty,    // {10}
                                        !string.IsNullOrEmpty(purchaseToken) ? purchaseToken : string.Empty,    // {11}
                                        contentId);                                                             // {12}

            try
            {
                string userName = string.Empty;
                string password = string.Empty;
                module wsBillingService = null;
                InitializeBillingModule(ref wsBillingService, ref userName, ref password);

                // call new billing method for charge adapter
                var transactionResponse = wsBillingService.VerifyReceipt(userName, password, siteGUID, (int)houseHoldID, price, currency, userIP, customData, productID, productCode, transactionType,
                                                                         contentId, purchaseToken, paymentGWName, billingGuid);

                response = ConvertTransactResultToTransactionResponse(logString, transactionResponse);

            }
            catch (Exception ex)
            {
                log.Error(logString, ex);
                response = new TransactionResponse((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }

            return response;
        }

        public ApiObjects.Response.Status UpdatePendingTransaction(string paymentGatewayId, int adapterTransactionState, string externalTransactionId, string externalStatus,
            string externalMessage, int failReason, string signature)
        {
            ApiObjects.Response.Status response;

            // log
            log.DebugFormat("update pending transaction: paymentGatewayId = {0}, adapterTransactionState = {1}, failReason = {2}, externalTransactionId = {3}, externalStatus = {4}, externalMessage = {5}, signature = {6}",
                paymentGatewayId, adapterTransactionState, failReason, externalTransactionId, externalStatus, externalMessage, signature);

            try
            {
                // update billing
                string userName = string.Empty;
                string password = string.Empty;
                module wsBillingService = null;
                InitializeBillingModule(ref wsBillingService, ref userName, ref password);

                var billingResponse = wsBillingService.UpdatePendingTransaction(userName, password, paymentGatewayId, adapterTransactionState, externalTransactionId,
                    externalStatus, externalMessage, failReason, signature);

                // validate response
                if (billingResponse == null)
                {
                    response = new ApiObjects.Response.Status((int)eResponseStatus.Error, "error while updating pending transaction");
                    return response;
                }

                if (billingResponse.Status.Code != (int)eResponseStatus.OK)
                {
                    response = new ApiObjects.Response.Status(billingResponse.Status.Code, billingResponse.Status.Message);
                    return response;
                }


                // if status pending or completed - nothing to update
                if (billingResponse.TransactionState == eTransactionState.OK || billingResponse.TransactionState == eTransactionState.Pending)
                {
                    response = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                    return response;
                }
                // update cas
                else
                {
                    bool isUpdated = false;
                    switch (billingResponse.ProductType)
                    {
                        case eTransactionType.PPV:
                            isUpdated = ConditionalAccessDAL.UpdatePPVPurchaseActiveStatus(billingResponse.BillingGuid, 0);
                            break;
                        case eTransactionType.Subscription:
                            isUpdated = ConditionalAccessDAL.UpdateSubscriptionPurchaseActiveStatus(billingResponse.BillingGuid, 0, 0);
                            break;
                        case eTransactionType.Collection:
                            isUpdated = ConditionalAccessDAL.UpdateCollectionPurchaseActiveStatus(billingResponse.BillingGuid, 0);
                            break;
                        default:
                            break;
                    }

                    if (isUpdated)
                    {
                        response = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                        string invalidationKey = LayeredCacheKeys.GetCancelTransactionInvalidationKey(billingResponse.DomainId);
                        if (!LayeredCache.Instance.SetInvalidationKey(invalidationKey))
                        {
                            log.ErrorFormat("Failed to set invalidation key on UpdatePendingTransaction key = {0}", invalidationKey);
                        }
                    }
                    else
                    {
                        response = new ApiObjects.Response.Status((int)eResponseStatus.ErrorUpdatingPendingTransaction, "error while updating pending transaction entitlement");
                    }
                }
            }
            catch (Exception ex)
            {
                log.Error("UpdatePendingTransaction  ", ex);
                response = new ApiObjects.Response.Status((int)eResponseStatus.Error, "error while updating pending transaction");
            }
            return response;
        }

        public ApiObjects.Response.Status CheckPendingTransaction(long paymentGatewayPendingId, int numberOfRetries, string billingGuid,
            long paymentGatewayTransactionId, string siteGuid, int productId, int productType)
        {
            ApiObjects.Response.Status response = null;

            // log
            log.DebugFormat("CheckPendingTransaction: paymentGatewayPendingId {0}, numberOfRetries {1}, billingGuid {2}, paymengGatewayTransactionId {3}",
                paymentGatewayPendingId, numberOfRetries, billingGuid, paymentGatewayTransactionId);

            try
            {
                #region Validate user and domain

                long domainId = 0;
                var validateUser = Utils.ValidateUser(this.m_nGroupID, siteGuid, ref domainId);

                if (validateUser != ResponseStatus.OK && validateUser != ResponseStatus.UserSuspended)
                {
                    // user validation failed
                    response = Utils.SetResponseStatus(validateUser);
                    return response;
                }

                #endregion

                //GetEntitlement(
                // update billing
                string userName = string.Empty;
                string password = string.Empty;
                module billingWebService = null;
                InitializeBillingModule(ref billingWebService, ref userName, ref password);

                var billingResponse = billingWebService.CheckPendingTransaction(userName, password,
                    paymentGatewayPendingId, numberOfRetries, billingGuid, paymentGatewayTransactionId, siteGuid);

                // validate response
                if (billingResponse == null)
                {
                    response = new ApiObjects.Response.Status((int)eResponseStatus.Error, "error while checking pending transaction");
                    return response;
                }

                if (billingResponse.Status.Code != (int)eResponseStatus.OK)
                {
                    response = new ApiObjects.Response.Status(billingResponse.Status.Code, billingResponse.Status.Message);
                    return response;
                }

                // if status pending or completed - nothing to update
                if (billingResponse.State == eTransactionState.OK ||
                    billingResponse.State == eTransactionState.Pending)
                {
                    WriteToUserLog(siteGuid, string.Format("Check Pending Transaction : TransactionID:{0}, State:{1}", billingResponse.TransactionID, billingResponse.State));

                    response = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                    return response;
                }
                // update cas
                else
                {
                    bool isUpdated = false;
                    switch ((eTransactionType)productType)
                    {
                        case eTransactionType.PPV:
                            isUpdated = ConditionalAccessDAL.UpdatePPVPurchaseActiveStatus(billingGuid, 0);
                            break;
                        case eTransactionType.Subscription:
                            isUpdated = ConditionalAccessDAL.UpdateSubscriptionPurchaseActiveStatus(billingGuid, 0, 0);
                            break;
                        case eTransactionType.Collection:
                            isUpdated = ConditionalAccessDAL.UpdateCollectionPurchaseActiveStatus(billingGuid, 0);
                            break;
                        default:
                            break;
                    }

                    if (isUpdated)
                    {
                        response = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                        WriteToUserLog(siteGuid, string.Format("Check Pending Transaction - Remove Entitlement: TransactionID:{0}, State:{1}, FailReasonCode:{2}, ",
                            billingResponse.TransactionID, billingResponse.State, billingResponse.FailReasonCode));

                        string invalidationKey = LayeredCacheKeys.GetCancelTransactionInvalidationKey(domainId);
                        if (!LayeredCache.Instance.SetInvalidationKey(invalidationKey))
                        {
                            log.ErrorFormat("Failed to set invalidation key on CheckPendingTransaction key = {0}", invalidationKey);
                        }
                    }
                    else
                    {
                        response = new ApiObjects.Response.Status((int)eResponseStatus.ErrorUpdatingPendingTransaction, "error while updating pending transaction entitlement");
                    }
                }
            }
            catch (Exception ex)
            {
                log.ErrorFormat("CheckPendingTransaction error {0} ", ex);
                response = new ApiObjects.Response.Status((int)eResponseStatus.Error, "error while checking pending transaction");
            }

            return response;
        }


        public ApiObjects.Response.Status GrantEntitlements(string userId, long householdId, int contentId, int productId, eTransactionType transactionType, string ip,
            string udid, bool history)
        {
            return GrantManager.GrantEntitlements(this, this.m_nGroupID, userId, householdId, contentId, productId, transactionType, ip, udid, history);
        }

        public virtual bool GiftCardReminder(string siteguid, long purchaseId, string billingGuid, long endDate)
        {
            return RenewManager.GiftCardReminder(this, this.m_nGroupID, siteguid, purchaseId, billingGuid, endDate);
        }

        public bool Renew(string siteguid, long purchaseId, string billingGuid, long nextEndDate, ref bool shouldUpdateTaskStatus)
        {
            return RenewManager.Renew(this, this.m_nGroupID, siteguid, purchaseId, billingGuid, nextEndDate, ref shouldUpdateTaskStatus);
        }

        public bool UpdateSubscriptionRenewingStatus(long purchaseId, string billingGuid, bool isActive)
        {
            return ConditionalAccessDAL.Update_SubscriptionPurchaseRenewalActiveStatus(m_nGroupID, purchaseId, billingGuid, Convert.ToInt16(isActive));
        }


        public AssetItemPriceResponse GetAssetPrices(List<AssetFiles> assetFiles, string siteGuid,
            string couponCode, string countryCd2, string languageCode3, string deviceName, string clientIP)
        {
            AssetItemPriceResponse response = new AssetItemPriceResponse();

            // Validate main parameter
            if (assetFiles == null)
            {
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Missing parameter - asset files list");
                return response;
            }

            // no count no party
            if (assetFiles.Count == 0)
            {
                response.Status = new ApiObjects.Response.Status();
                return response;
            }

            List<int> mediaFiles = new List<int>();
            Dictionary<int, int> fileToAsset = new Dictionary<int, int>();

            foreach (var asset in assetFiles)
            {
                foreach (var file in asset.FileIds)
                {
                    fileToAsset.Add(file, Convert.ToInt32(asset.AssetId));
                }

                mediaFiles.AddRange(asset.FileIds);
            }

            // Validate that all file IDs match the given asset IDs
            MeidaMaper[] mapper = Utils.GetMediaMapper(m_nGroupID, mediaFiles.ToArray());
            HashSet<int> mappedFileIds = new HashSet<int>();

            if (mapper != null)
            {
                // Checked that all mappings match
                foreach (var mapping in mapper)
                {
                    int fileId = mapping.m_nMediaFileID;
                    int assetId = 0;

                    if (fileToAsset.TryGetValue(fileId, out assetId))
                    {
                        mappedFileIds.Add(fileId);

                        if (mapping.m_nMediaID != assetId)
                        {
                            response.Status = new ApiObjects.Response.Status((int)eResponseStatus.FileToMediaMismatch,
                                string.Format("File Id does not match media id: file = {0}, media = {1}", fileId, assetId));
                            return response;
                        }
                    }
                    else
                    {
                        response.Status = new ApiObjects.Response.Status((int)eResponseStatus.FileToMediaMismatch,
                            string.Format("Could not find asset of file {0}", fileId));
                        return response;
                    }
                }
            }

            // Check that all IDs had a match and nobody was left out
            foreach (var fileId in mediaFiles)
            {
                if (!mappedFileIds.Contains(fileId))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.FileToMediaMismatch,
                        string.Format("Could not find mapping for file {0}", fileId));
                    return response;
                }
            }

            var itemPrices = this.GetItemsPrices(mediaFiles.ToArray(), siteGuid, couponCode, false, countryCd2, languageCode3, deviceName, clientIP);

            if (itemPrices == null)
            {
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error,
                    "Failed getting prices of items");
                return response;
            }

            Dictionary<int, AssetItemPrices> fileToAssetItem = new Dictionary<int, AssetItemPrices>();

            response.Prices = new List<AssetItemPrices>();

            // Map file Ids to asset item price object
            foreach (var item in assetFiles)
            {
                var assetItem = new AssetItemPrices()
                {
                    AssetId = item.AssetId,
                    AssetType = item.AssetType,
                    PriceContainers = new List<MediaFileItemPricesContainer>()
                };

                foreach (var fileId in item.FileIds)
                {
                    fileToAssetItem.Add(fileId, assetItem);
                }

                response.Prices.Add(assetItem);
            }

            // Add price containers to asset item price objects that we created a step earlier
            foreach (var itemPrice in itemPrices)
            {
                AssetItemPrices current;
                if (fileToAssetItem.TryGetValue(itemPrice.m_nMediaFileID, out current))
                {
                    current.PriceContainers.Add(itemPrice);
                }
            }

            response.Status = new ApiObjects.Response.Status();

            return response;
        }

        public ApiObjects.Response.Status ReconcileEntitlements(string userId)
        {
            ApiObjects.Response.Status response = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());

            // validate user
            long householdId = 0;
            var userValidStatus = Utils.ValidateUser(m_nGroupID, userId, ref householdId);

            if (userValidStatus != ResponseStatus.OK)
            {
                // user validation failed
                response = Utils.SetResponseStatus(userValidStatus);
                log.ErrorFormat("User validation failed: {0}, userId: {1}", response.Message, userId);
                return response;
            }

            // validate household
            if (householdId < 1)
            {
                response.Message = "Illegal household";
                log.ErrorFormat("Error: {0}, userId: {1}", response.Message, userId);
                return response;
            }

            // frequency (tcm)
            long frequency = TVinciShared.WS_Utils.GetTcmIntValue("reconciliation_frequency_seconds");
            if (frequency == 0)
            {
                frequency = DEFAULT_RECONCILIATION_FREQUENCY_SECONDS;
            }

            // get household last reconciliation date
            DateTime? householdLastReconciliationDate = null;
            var householdLastReconciliation = ODBCWrapper.Utils.GetTableSingleVal("domains", "LAST_RECONCILIATION_DATE", "ID", "=", householdId, "USERS_CONNECTION_STRING");
            if (!(householdLastReconciliation is DBNull))
            {
                householdLastReconciliationDate = Convert.ToDateTime(householdLastReconciliation);
            }

            // check if reconciliation is allowed for the household now
            if (householdLastReconciliationDate != null && householdLastReconciliationDate.HasValue && DateTime.UtcNow <= householdLastReconciliationDate.Value.AddSeconds(frequency))
            {
                log.ErrorFormat("Entitlements reconciliation was not done due to frequency. userId = {0}, householdId = {1}, groupId = {2}, householdLastReconciliation = {3}",
                    userId, householdId, m_nGroupID, householdLastReconciliationDate);
                response = new ApiObjects.Response.Status((int)eResponseStatus.ReconciliationFrequencyLimitation, "reconciliation too frequent");
                return response;
            }

            // call oss adapter through ws api to get the entitlements
            OSSAdapterEntitlementsResponse entitlementsResponse = null;

            using (API wsApi = new API())
            {
                string wsApiUsername = string.Empty;
                string wsApiPass = string.Empty;
                Utils.GetWSCredentials(m_nGroupID, eWSModules.API, ref wsApiUsername, ref wsApiPass);

                if (string.IsNullOrEmpty(wsApiUsername) || string.IsNullOrEmpty(wsApiPass))
                {
                    log.ErrorFormat("ReconcileEntitlements: failed to get WS API credentials. groupId = {0}, userId = {1}", m_nGroupID, userId);
                    return response;
                }

                try
                {
                    entitlementsResponse = wsApi.GetExternalEntitlements(wsApiUsername, wsApiPass, userId);
                }
                catch (Exception ex)
                {
                    log.Error(string.Format("ReconcileEntitlements: Error while calling WS API GetExternalEntitlements. groupId = {0}, userId = {1}", m_nGroupID, userId), ex);
                    return response;
                }
            }

            // validate response
            if (entitlementsResponse == null || entitlementsResponse.Status == null)
            {
                response = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Failed to get entitlements");
                return response;
            }

            if (entitlementsResponse.Status.Code != (int)eResponseStatus.OK)
            {
                response = new ApiObjects.Response.Status(entitlementsResponse.Status.Code, entitlementsResponse.Status.Message);
                return response;
            }

            if (entitlementsResponse.Entitlements != null && entitlementsResponse.Entitlements.Count > 0)
            {
                // handle subscriptions entitlements
                ReconcileSubscriptions(userId, householdId, entitlementsResponse.Entitlements);

                // handle ppv entitlements
                ReconcilePPVs(userId, householdId, entitlementsResponse.Entitlements);
            }

            DomainDal.Set_DomainLastReconciliationDate(m_nGroupID, householdId, DateTime.UtcNow);

            response = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());

            return response;
        }

        private void ReconcilePPVs(string userId, long householdId, List<ExternalEntitlement> entitlements)
        {
            var ppvEntitlementsToInsert = entitlements.Where(e => e.EntitlementType == eTransactionType.PPV).ToList();
            List<EntitlementObject> ppvEntitlementsToDelete = new List<EntitlementObject>();

            // get ppvs ids by product codes if there are external ppv entitlements
            Dictionary<long, PPVModule> ppvsModulesDictionary = GetPpvModulesDataForExternalEntitlements(userId, ref ppvEntitlementsToInsert);

            var ppvDictionary = DAL.ConditionalAccessDAL.Get_AllUsersEntitlements((int)householdId, null);
            if (ppvDictionary != null && ppvDictionary.Count > 0)
            {
                ExternalEntitlement ppvEntitlement;

                foreach (var ppv in ppvDictionary.Values)
                {
                    ppvEntitlement = ppvEntitlementsToInsert.Where(p => p.ProductId == ppv.ppvCode && p.ContentId == ppv.purchasedAsMediaFileID.ToString()).FirstOrDefault();
                    if (ppvEntitlement != null)
                    {
                        if (DateUtils.UnixTimeStampToDateTime(ppvEntitlement.EndDateSeconds) != ppv.endDate || DateUtils.UnixTimeStampToDateTime(ppvEntitlement.StartDateSeconds) != ppv.startDate)
                        {
                            ppvEntitlement.PurchaseId = ppv.ID;

                            // update ppv
                            UpdateReconciledPPVEntitlement(householdId, ppvEntitlement, ppvsModulesDictionary);
                        }

                        ppvEntitlementsToInsert.Remove(ppvEntitlement);
                    }
                    else
                    {
                        ppvEntitlementsToDelete.Add(ppv);
                    }
                }
            }

            // insert ppvs
            InsertReconciledPPVEntitlements(userId, householdId, ppvEntitlementsToInsert);

            // delete ppvs
            DeleteReconciledPPVEntitlements(householdId, ppvEntitlementsToDelete);
        }

        private Dictionary<long, PPVModule> GetPpvModulesDataForExternalEntitlements(string userId, ref List<ExternalEntitlement> ppvEntitlementsToInsert)
        {
            Dictionary<long, PPVModule> ppvsModulesDictionary = new Dictionary<long, PPVModule>();

            if (ppvEntitlementsToInsert.Count > 0)
            {
                using (mdoule wsPricing = new mdoule())
                {
                    string wsPricingUsername = string.Empty;
                    string wsPricingPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref wsPricingUsername, ref wsPricingPass);

                    if (string.IsNullOrEmpty(wsPricingUsername) || string.IsNullOrEmpty(wsPricingPass))
                    {
                        log.ErrorFormat("ReconcilePPVs: failed to get WS Pricing credentials or URL. groupId = {0}, userId = {1}", m_nGroupID, userId);
                    }

                    try
                    {
                        // get the ppv modules
                        var ppvModules = wsPricing.GetPPVModulesByProductCodes(wsPricingUsername, wsPricingPass, ppvEntitlementsToInsert.Select(pe => pe.ProductCode).ToArray());

                        if (ppvModules != null)
                        {
                            // set the ppv module for each entitlement
                            foreach (var ppvEntitlement in ppvEntitlementsToInsert)
                            {
                                var ppvModule = ppvModules.Where(pm => pm.m_Product_Code == ppvEntitlement.ProductCode).FirstOrDefault();
                                if (ppvModule != null)
                                {
                                    ppvEntitlement.ProductId = int.Parse(ppvModule.m_sObjectCode);
                                    if (!ppvsModulesDictionary.ContainsKey(ppvEntitlement.ProductId))
                                    {
                                        ppvsModulesDictionary.Add(ppvEntitlement.ProductId, ppvModule);
                                    }
                                }
                                else
                                {
                                    ppvEntitlementsToInsert.Remove(ppvEntitlement);
                                    log.ErrorFormat("ReconcilePPVs: subscription with productCode = {0} was not found for userId = {1} and will be ignored.", ppvEntitlement.ProductCode, userId);
                                }
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        log.Error(string.Format("ReconcilePPVs: Error while calling WSPricing GetPPVModulesByProductCodes. groupId = {0}, userId = {1}", m_nGroupID, userId), ex);
                    }
                }
            }

            return ppvsModulesDictionary;
        }

        private void DeleteReconciledPPVEntitlements(long householdId, List<EntitlementObject> ppvsToDelete)
        {
            if (ppvsToDelete.Count > 0)
            {
                if (ConditionalAccessDAL.Delete_PPVPurchases(ppvsToDelete.Select(pi => pi.ID).ToList()))
                {
                    log.ErrorFormat("ReconcileEntitlements: failed to delete PPV entitlements for household = {0}", householdId);
                }
            }
        }

        private void UpdateReconciledPPVEntitlement(long householdId, ExternalEntitlement ppvToUpdate, Dictionary<long, PPVModule> ppvs)
        {
            if (ppvToUpdate != null)
            {
                DateTime startDate, endDate;
                startDate = ppvToUpdate.StartDateSeconds != 0 ? DateUtils.UnixTimeStampToDateTime(ppvToUpdate.StartDateSeconds) : DateTime.UtcNow;

                if (ppvToUpdate.EndDateSeconds == 0)
                {
                    // get the end date for the ppv module
                    if (ppvs.ContainsKey(ppvToUpdate.ProductId))
                    {
                        endDate = Utils.GetEndDateTime(startDate, ppvs[ppvToUpdate.ProductId].m_oUsageModule.m_tsMaxUsageModuleLifeCycle);
                    }
                    else
                    {
                        log.ErrorFormat("ReconcileEntitlements: trying to update dates for PPV module with invalid productId or contentId. productCode = {0}, contentId = {1}, for household = {2}",
                                ppvToUpdate.ProductCode, ppvToUpdate.ContentId, householdId);
                        return;
                    }
                }
                else
                {
                    endDate = DateUtils.UnixTimeStampToDateTime(ppvToUpdate.EndDateSeconds);
                }

                if (!ConditionalAccessDAL.Update_PPVPurchaseDates(ppvToUpdate.PurchaseId, startDate, endDate))
                {
                    log.ErrorFormat("ReconcileEntitlements: failed to update dates for PPV entitlement. ppv purchase id = {0}, for household = {1}",
                                ppvToUpdate.ProductId, householdId);
                }
            }
        }

        private void InsertReconciledPPVEntitlements(string userId, long householdId, List<ExternalEntitlement> ppvsToInsert)
        {
            if (ppvsToInsert.Count != 0)
            {
                //grant entitlements
                int contentId = 0;

                foreach (var ppv in ppvsToInsert)
                {
                    if (ppv != null && int.TryParse(ppv.ContentId, out contentId))
                    {
                        DateTime? startDate = null;
                        if (ppv.StartDateSeconds != 0)
                            startDate = DateUtils.UnixTimeStampToDateTime(ppv.StartDateSeconds);

                        DateTime? endDate = null;
                        if (ppv.EndDateSeconds != 0)
                            endDate = DateUtils.UnixTimeStampToDateTime(ppv.EndDateSeconds);

                        var res = GrantManager.GrantPPV(this, m_nGroupID, userId, householdId, contentId, (int)ppv.ProductId, string.Empty, string.Empty, false, startDate, endDate);
                        string logString = string.Format("userId = {0}, ppv productCode = {1}, ppv contentId = {2}", userId, ppv.ProductCode, ppv.ContentId);
                        if (res.Code != (int)eResponseStatus.OK)
                        {
                            log.ErrorFormat("failed to reconcile external PPV entitlement for {0}", logString);
                        }
                        else
                        {
                            log.DebugFormat("Reconciled external PPV entitlement for {0}", logString);
                        }
                    }
                }
            }
        }

        private void ReconcileSubscriptions(string userId, long householdId, List<ExternalEntitlement> entitlements)
        {
            var subscriptionEntitlementsToInsert = entitlements.Where(e => e.EntitlementType == eTransactionType.Subscription).ToList();
            List<int> subscriptionEntitlementsToDelete = new List<int>();

            // get subscriptions ids by product codes if there are external subscription entitlements
            Dictionary<long, Subscription> subscriptionsDictionary = GetSubscriptionsDataForExternalEntitlements(userId, ref subscriptionEntitlementsToInsert);

            DataTable dt = DAL.ConditionalAccessDAL.Get_AllSubscriptionsPurchasesByUsersIDsOrDomainID((int)householdId, null, m_nGroupID);
            if (dt != null && dt.Rows.Count > 0)
            {
                string subscriptionCode;
                ExternalEntitlement subscription;
                DateTime startDate, endDate;

                foreach (DataRow dr in dt.Rows)
                {
                    subscriptionCode = ODBCWrapper.Utils.GetSafeStr(dr["SUBSCRIPTION_CODE"]);
                    if (!string.IsNullOrEmpty(subscriptionCode))
                    {
                        subscription = subscriptionEntitlementsToInsert.Where(s => s.ProductId.ToString() == subscriptionCode).FirstOrDefault();

                        if (subscription != null)
                        {
                            subscription.PurchaseId = ODBCWrapper.Utils.GetIntSafeVal(dr["ID"]);
                            startDate = ODBCWrapper.Utils.GetDateSafeVal(dr["START_DATE"]);
                            endDate = ODBCWrapper.Utils.GetDateSafeVal(dr["END_DATE"]);

                            if (DateUtils.UnixTimeStampToDateTime(subscription.EndDateSeconds) != endDate || DateUtils.UnixTimeStampToDateTime(subscription.StartDateSeconds) != startDate)
                            {
                                // update subscription
                                UpdateReconciledSubscriptionEntitlement(householdId, subscription, subscriptionsDictionary);
                            }
                            subscriptionEntitlementsToInsert.Remove(subscription);
                        }
                        else
                        {
                            subscriptionEntitlementsToDelete.Add(ODBCWrapper.Utils.GetIntSafeVal(dr["ID"]));
                        }
                    }
                }
            }

            // insert subscriptions
            InsertReconciledSubscriptionEntitlements(userId, householdId, subscriptionEntitlementsToInsert);

            // delete subscriptions 
            DeleteReconciledSubscriptionEntitlements(householdId, subscriptionEntitlementsToDelete);
        }

        private void UpdateReconciledSubscriptionEntitlement(long householdId, ExternalEntitlement subscriptionEntitlementToUpdate, Dictionary<long, Subscription> subscriptions)
        {
            if (subscriptionEntitlementToUpdate != null)
            {
                DateTime startDate, endDate;
                startDate = subscriptionEntitlementToUpdate.StartDateSeconds != 0 ? DateUtils.UnixTimeStampToDateTime(subscriptionEntitlementToUpdate.StartDateSeconds) : DateTime.UtcNow;

                if (subscriptionEntitlementToUpdate.EndDateSeconds == 0)
                {
                    // get the end date for the ppv module
                    if (subscriptions.ContainsKey(subscriptionEntitlementToUpdate.ProductId))
                    {
                        endDate = CalcSubscriptionEndDate(subscriptions[subscriptionEntitlementToUpdate.ProductId], false, startDate);
                    }
                    else
                    {
                        log.ErrorFormat("ReconcileEntitlements: trying to update dates for subscription but subscription not found. productCode = {0}, contentId = {1}, for household = {2}",
                            subscriptionEntitlementToUpdate.ProductCode, subscriptionEntitlementToUpdate.ContentId, householdId);
                        return;
                    }
                }
                else
                {
                    endDate = DateUtils.UnixTimeStampToDateTime(subscriptionEntitlementToUpdate.EndDateSeconds);
                }

                if (!ConditionalAccessDAL.Update_SubscriptionPurchaseDates(subscriptionEntitlementToUpdate.PurchaseId, startDate, endDate))
                {
                    log.ErrorFormat("ReconcileEntitlements: failed to update dates for subscription. subscription purchase id = {0}, for household = {1}",
                                subscriptionEntitlementToUpdate.ProductId, householdId);
                }
            }
        }

        private Dictionary<long, Subscription> GetSubscriptionsDataForExternalEntitlements(string userId, ref List<ExternalEntitlement> subscriptionEntitlementsToInsert)
        {
            Dictionary<long, Subscription> subscriptionsDictionary = new Dictionary<long, Subscription>();

            if (subscriptionEntitlementsToInsert.Count > 0)
            {
                using (mdoule wsPricing = new mdoule())
                {
                    string wsPricingUsername = string.Empty;
                    string wsPricingPass = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref wsPricingUsername, ref wsPricingPass);

                    if (string.IsNullOrEmpty(wsPricingUsername) || string.IsNullOrEmpty(wsPricingPass))
                    {
                        log.ErrorFormat("ReconcileSubscriptions: failed to get WS Pricing credentials or URL. groupId = {0}, userId = {1}", m_nGroupID, userId);
                    }

                    try
                    {
                        // get the subscriptions modules
                        var subscriptions = wsPricing.GetSubscriptionsByProductCodes(wsPricingUsername, wsPricingPass, subscriptionEntitlementsToInsert.Select(se => se.ProductCode).ToArray());

                        if (subscriptions != null)
                        {
                            // set the subscription for each entitlement
                            foreach (var entitlement in subscriptionEntitlementsToInsert)
                            {
                                var subscription = subscriptions.Where(s => s.m_ProductCode == entitlement.ProductCode).FirstOrDefault();
                                if (subscription != null)
                                {
                                    entitlement.ProductId = int.Parse(subscription.m_SubscriptionCode);
                                    if (!subscriptionsDictionary.ContainsKey(entitlement.ProductId))
                                    {
                                        subscriptionsDictionary.Add(entitlement.ProductId, subscription);
                                    }
                                }
                                else
                                {
                                    subscriptionEntitlementsToInsert.Remove(entitlement);
                                    log.ErrorFormat("ReconcileSubscriptions: subscription with productCode = {0} was not found for userId = {1} and will be ignored.", entitlement.ProductCode, userId);
                                }
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        log.Error(string.Format("ReconcileSubscriptions: Error while calling WSPricing GetPPVModulesByProductCodes. groupId = {0}, userId = {1}", m_nGroupID, userId), ex);
                    }
                }
            }

            return subscriptionsDictionary;
        }

        private void DeleteReconciledSubscriptionEntitlements(long householdId, List<int> subscriptionsToDelete)
        {
            if (subscriptionsToDelete.Count > 0)
            {
                if (ConditionalAccessDAL.Delete_SubscriptionPurchases(subscriptionsToDelete))
                {
                    log.ErrorFormat("ReconcileEntitlements: failed to delete subscription entitlements for household = {0}", householdId);
                }
            }
        }

        private void InsertReconciledSubscriptionEntitlements(string userId, long householdId, List<ExternalEntitlement> subscriptionsToInsert)
        {
            if (subscriptionsToInsert.Count > 0)
            {
                //grant entitlements            
                foreach (var subscription in subscriptionsToInsert)
                {
                    if (subscription != null)
                    {
                        DateTime? startDate = null;
                        if (subscription.StartDateSeconds != 0)
                            startDate = DateUtils.UnixTimeStampToDateTime(subscription.StartDateSeconds);

                        DateTime? endDate = null;
                        if (subscription.EndDateSeconds != 0)
                            endDate = DateUtils.UnixTimeStampToDateTime(subscription.EndDateSeconds);
                        var res = GrantManager.GrantSubscription(this, m_nGroupID, userId, householdId, (int)subscription.ProductId, string.Empty, string.Empty, false, 0, startDate, endDate);
                        string logString = string.Format("userId = {0}, subscriptionId = {1}, subscriptionproductCode = {2}", userId, subscription.ProductId, subscription.ProductCode);
                        if (res.Code != (int)eResponseStatus.OK)
                        {
                            log.ErrorFormat("failed to reconcile external subscription entitlement for {0}", logString);
                        }
                        else
                        {
                            log.DebugFormat("Reconciled external subscription entitlement for {0}", logString);
                        }
                    }
                }
            }
        }

        public UserBundlesResponse GetUserBundles(int domainID, int[] fileTypeIDs)
        {
            UserBundlesResponse response = new UserBundlesResponse()
            {
                channels = new List<int>(),
                status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString())
            };

            // Validate the fileTypeIDs
            if (!Utils.ValidateFileTypesConatainedInGroup(m_nGroupID, fileTypeIDs))
            {
                response.status.Code = (int)eResponseStatus.NotEntitled;
                response.status.Message = eResponseStatus.NotEntitled.ToString();
                return response;
            }
            
            ConditionalAccess.DomainEntitlements.BundleEntitlements bundleEntitlements = Utils.InitializeDomainBundles(domainID, m_nGroupID, new List<int>(), true);            
            if (bundleEntitlements != null)
            {
                // Get all subscriptions
                if (bundleEntitlements.FileTypeIdToSubscriptionMappings != null && bundleEntitlements.FileTypeIdToSubscriptionMappings.Count > 0)
                {
                    if (fileTypeIDs != null && fileTypeIDs.Length > 0)
                    {
                        // Get subscriptions that don't have specific fileTypeIDs defined
                        if (bundleEntitlements.FileTypeIdToSubscriptionMappings.ContainsKey(0) && bundleEntitlements.FileTypeIdToSubscriptionMappings[0].Count > 0)
                        {
                            response.channels.AddRange(Utils.GetChannelsListFromSubscriptions(bundleEntitlements.FileTypeIdToSubscriptionMappings[0]));
                        }

                        // Get subscriptions that have the specific fileTypeID defined
                        foreach (int fileTypeID in fileTypeIDs)
                        {
                            if (bundleEntitlements.FileTypeIdToSubscriptionMappings.ContainsKey(fileTypeID) && bundleEntitlements.FileTypeIdToSubscriptionMappings[fileTypeID].Count > 0)
                            {
                                response.channels.AddRange(Utils.GetChannelsListFromSubscriptions(bundleEntitlements.FileTypeIdToSubscriptionMappings[fileTypeID]));
                            }
                        }
                    }

                    //Incase we want to ignore filetypeIDs (sent as null or empty)
                    else
                    {
                        response.channels.AddRange(Utils.GetChannelsListFromSubscriptions(bundleEntitlements.SubscriptionsData.Values.ToList()));
                    }
                }

                if (response.channels != null && response.channels.Count > 0)
                {
                    response.channels = response.channels.Distinct().ToList();
                }

                // Get all collections
                if (bundleEntitlements.CollectionsData != null && bundleEntitlements.CollectionsData.Count > 0)
                {
                    foreach (Collection collection in bundleEntitlements.CollectionsData.Values)
                    {
                        if (collection.m_sCodes != null)
                        {
                            // Get channels from collections
                            foreach (BundleCodeContainer bundleCode in collection.m_sCodes)
                            {
                                int channelID;
                                if (int.TryParse(bundleCode.m_sCode, out channelID) && !response.channels.Contains(channelID))
                                {
                                    response.channels.Add(channelID);
                                }
                            }
                        }
                    }
                }

                response.status.Code = (int)eResponseStatus.OK;
                response.status.Message = eResponseStatus.OK.ToString();
            }

            return response;
        }

        public UserPurhcasedAssetsResponse GetUserPurchasedAssets(int domainID, int[] fileTypeIDs)
        {
            UserPurhcasedAssetsResponse response = new UserPurhcasedAssetsResponse()
            {
                assets = new List<ApiObjects.KeyValuePair>(),
                status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString())
            };

            // Validate the fileTypeIDs
            if (!Utils.ValidateFileTypesConatainedInGroup(m_nGroupID, fileTypeIDs))
            {
                response.status.Code = (int)eResponseStatus.NotEntitled;
                response.status.Message = eResponseStatus.NotEntitled.ToString();
                return response;
            }

            try
            {
                // Get all PPV Entitlements
                Dictionary<string, EntitlementObject> getAllUserEntitlements = ConditionalAccessDAL.Get_AllUsersEntitlements(domainID, new List<int>());

                // Map entitlements in an accessible dictionary
                Dictionary<string, List<int>> ppvToMediaFileIDsDictionary = new Dictionary<string, List<int>>();

                foreach (var currentEntitlement in getAllUserEntitlements.Values)
                {
                    string ppvCode = currentEntitlement.ppvCode.ToString();

                    if (!ppvToMediaFileIDsDictionary.ContainsKey(ppvCode))
                    {
                        ppvToMediaFileIDsDictionary.Add(ppvCode, new List<int>());
                    }

                    ppvToMediaFileIDsDictionary[ppvCode].Add(currentEntitlement.purchasedAsMediaFileID);
                }

                if (ppvToMediaFileIDsDictionary != null && ppvToMediaFileIDsDictionary.Count > 0)
                {
                    string sPricingUsername = string.Empty;
                    string sPricingPassword = string.Empty;
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref sPricingUsername, ref sPricingPassword);
                    mdoule pricingModule = new mdoule();
                    // Get PPV Modules data
                    PPVModuleResponse ppvModulesResponse = pricingModule.GetPPVModulesData(sPricingUsername, sPricingPassword, ppvToMediaFileIDsDictionary.Keys.Cast<string>().ToArray(), String.Empty, String.Empty, String.Empty);
                    if (ppvModulesResponse != null && ppvModulesResponse.Status.Code == (int)eResponseStatus.OK && ppvModulesResponse.PPVModules.Length > 0)
                    {
                        List<int> mediaFilesToMap = new List<int>();
                        foreach (PPVModule ppvModule in ppvModulesResponse.PPVModules)
                        {
                            if (fileTypeIDs != null && fileTypeIDs.Length > 0)
                            {
                                // PPV does not have specific file types defined --> supports all file types, add PPV purchased mediaFile to list
                                if (ppvModule.m_relatedFileTypes == null)
                                {
                                    foreach (var entitlement in ppvToMediaFileIDsDictionary[ppvModule.m_sObjectCode])
                                    {
                                        if (!mediaFilesToMap.Contains(entitlement))
                                        {
                                            mediaFilesToMap.Add(entitlement);
                                        }
                                    }
                                }

                                // PPV has one of the requested file types, add PPV purchased mediaFile to list
                                else if (ppvModule.m_relatedFileTypes.Count > 0)
                                {
                                    int[] relevantFileTypes = ppvModule.m_relatedFileTypes.Intersect(fileTypeIDs).ToArray();
                                    if (relevantFileTypes != null && relevantFileTypes.Length > 0)
                                    {
                                        foreach (var entitlement in ppvToMediaFileIDsDictionary[ppvModule.m_sObjectCode])
                                        {
                                            if (!mediaFilesToMap.Contains(entitlement))
                                            {
                                                mediaFilesToMap.Add(entitlement);
                                            }
                                        }
                                    }
                                }
                            }
                            //Incase we want to ignore filetypeIDs (sent as null or empty)
                            else
                            {
                                foreach (var entitlement in ppvToMediaFileIDsDictionary[ppvModule.m_sObjectCode])
                                {
                                    if (!mediaFilesToMap.Contains(entitlement))
                                    {
                                        mediaFilesToMap.Add(entitlement);
                                    }
                                }
                            }
                        }

                        // Get mediaIds according to mediaFiles from ws_api (MapMediaFiles)
                        if (mediaFilesToMap.Count > 0)
                        {
                            string sAPIUsername = string.Empty;
                            string sAPIPassword = string.Empty;
                            Utils.GetWSCredentials(m_nGroupID, eWSModules.API, ref sAPIUsername, ref sAPIPassword);
                            MeidaMaper[] mapper = Utils.GetMediaMapper(m_nGroupID, mediaFilesToMap.ToArray(), sAPIUsername, sAPIPassword);

                            // Add mediaIDs to response
                            if (mapper != null && mapper.Length > 0)
                            {
                                response.assets.AddRange(
                                    mapper.Select(x => new ApiObjects.KeyValuePair(eAssetTypes.MEDIA.ToString(),
                                        x.m_nMediaID.ToString())));
                            }
                        }
                    }
                }
                // add all ppvCode to the assets of the response
            }
            catch (Exception ex)
            {
                response.status.Code = (int)eResponseStatus.Error;
                response.status.Message = eResponseStatus.Error.ToString();
                StringBuilder sb = new StringBuilder("Exception at GetUserPurchasedAssets. ");
                sb.Append(String.Concat("Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", DomainID: ", domainID));
                sb.Append(", FileTypes: ");
                foreach (int fileTypeID in fileTypeIDs)
                {
                    sb.Append(String.Concat(fileTypeID, ", "));
                }
                sb.Append(String.Concat("Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error("Exception - " + sb.ToString(), ex);
            }

            return response;
        }

        public ApiObjects.Response.Status RecordTransaction(string userId, long householdId, int state, string paymentGatewayReferenceID, string paymentGatewayResponseCode, int customDataId,
              double price, string currency, int contentId, int productId, eTransactionType transactionType, string paymentDetails, string paymentMethod, int paymentGatewayId, string paymentMethodExternalID)
        {
            ApiObjects.Response.Status status = new ApiObjects.Response.Status();

            try
            {
                // 1. validate user and household
                //---------------------------------
                status = Utils.ValidateUserAndDomain(m_nGroupID, userId, ref householdId);

                if (status.Code != (int)eResponseStatus.OK || householdId <= 0)
                {
                    return status;
                }

                // 2. Get Custom Data by Id  
                string customData = string.Empty;
                if (customDataId == 0 || !BillingDAL.Get_CustomDataByID((long)customDataId, ref customData, BILLING_CONNECTION_STRING) || string.IsNullOrEmpty(customData))
                {
                    log.ErrorFormat("RecordTransaction - Invalid Custom data identifier {0}", customDataId.ToString());
                    return new ApiObjects.Response.Status((int)eResponseStatus.InvalidCustomDataIdentifier, "Invalid Custom data identifier");
                }

                // Get Price, currency from customData
                //-------------------------------------
                double customDataPrice = 0.0;
                string customDataCurrency = string.Empty;
                string userIP = string.Empty;
                string coupon = string.Empty;
                string udid = string.Empty; //TODO

                GetDataFromCustomData(customDataId, customData, ref customDataPrice, ref customDataCurrency, ref userIP, ref coupon, ref udid);

                if (price != customDataPrice || string.IsNullOrEmpty(currency) || (currency != customDataCurrency))
                {
                    log.ErrorFormat("RecordTransaction - mismatch price {0}, currency {1} input with custom data Id {2}", price.ToString(), currency, customDataId.ToString());
                }

                // coupon validation
                if (!string.IsNullOrEmpty(coupon) && !Utils.IsCouponValid(m_nGroupID, coupon))
                {
                    log.ErrorFormat("RecordTransaction - Coupon Not Valid {0}", coupon);
                    return new ApiObjects.Response.Status((int)eResponseStatus.CouponNotValid, "Coupon Not Valid");
                }

                // 3. grant entitlement according to ppv/ sub..
                TransactionResponse transactionResponse = new TransactionResponse();
                switch (transactionType)
                {
                    // choose price or customDataPrice
                    case eTransactionType.PPV:
                        status = RecordPPVEntitlement(userId, householdId, contentId, productId, coupon, price, currency, customData, userIP, udid, state, paymentGatewayId, paymentGatewayReferenceID,
                            paymentGatewayResponseCode, paymentDetails, paymentMethod, paymentMethodExternalID);
                        break;

                    case eTransactionType.Subscription:
                        status = RecordSubscriptionEntitlement(userId, householdId, contentId, productId, transactionType, coupon, price, currency, customData, userIP, udid, state, paymentGatewayId,
                            paymentGatewayReferenceID, paymentGatewayResponseCode, paymentDetails, paymentMethod, paymentMethodExternalID);
                        break;
                    case eTransactionType.Collection:
                    default:
                        break;
                }
                return status;
            }
            catch (Exception ex)
            {
                log.Error("RecordTransaction ", ex);
                status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "error SetEntitlement");
                return status;
            }
        }

        private ApiObjects.Response.Status RecordSubscriptionEntitlement(string userId, long householdId, int contentId, int productId, eTransactionType transactionType, string coupon,
            double price, string currency, string customData, string userIP, string udid, int state, int paymentGatewayId, string paymentGatewayReferenceID, string paymentGatewayResponseCode,
            string paymentDetails, string paymentMethod, string paymentMethodExternalID)
        {
            ApiObjects.Response.Status status = new ApiObjects.Response.Status();

            // log request
            string logString = string.Format("RecoredSubscriptionEntitlement request: siteguid {0}, household {1}, price {2}, currency {3}, productId {4}, coupon {5}, userIp {6}, paymentGatewayId {7}",
                !string.IsNullOrEmpty(userId) ? userId : string.Empty, householdId, price, !string.IsNullOrEmpty(currency) ? currency : string.Empty, productId,
                !string.IsNullOrEmpty(coupon) ? coupon : string.Empty, !string.IsNullOrEmpty(userIP) ? userIP : string.Empty, paymentGatewayId);

            log.Debug(logString);

            try
            {
                string country = string.Empty;
                if (!string.IsNullOrEmpty(userIP))
                {
                    // get country by user IP
                    country = Utils.GetIP2CountryName(m_nGroupID, userIP);
                }

                // validate price
                PriceReason priceReason = PriceReason.UnKnown;
                Subscription subscription = null;
                Price priceResponse = Utils.GetSubscriptionFinalPrice(m_nGroupID, productId.ToString(), userId, coupon, ref priceReason, ref subscription, country, string.Empty, string.Empty);

                if (priceResponse == null)
                {
                    status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Error Getting price");
                    log.ErrorFormat("Error: {0}, data: {1}", status.Message, logString);
                    return status;
                }

                bool entitleToPreview = priceReason == PriceReason.EntitledToPreviewModule;

                if (priceReason == PriceReason.ForPurchase || entitleToPreview)
                {
                    // item is for purchase
                    if (priceResponse.m_dPrice == price && priceResponse.m_oCurrency.m_sCurrencyCD3 == currency)
                    {
                        // create new GUID for billing transaction
                        string billingGuid = Guid.NewGuid().ToString();

                        // RecordTransaction
                        //------------------
                        TransactionResponse transactionResponse = RecordBillingTransaction(userId, householdId, contentId, productId, transactionType, paymentDetails, paymentMethod,
                            paymentGatewayId, billingGuid, customData, paymentGatewayReferenceID, paymentGatewayResponseCode, state, paymentMethodExternalID);

                        if (transactionResponse == null || transactionResponse.Status == null)
                        {
                            log.ErrorFormat("Error: failed to record transaction, data: {0}", logString);
                            return new ApiObjects.Response.Status((int)ApiObjects.Response.eResponseStatus.Error, ApiObjects.Response.eResponseStatus.Error.ToString());
                        }

                        // Status OK + (State OK || State Pending) = grant entitlement
                        if (transactionResponse.Status.Code == (int)eResponseStatus.OK &&
                            (transactionResponse.State.Equals(eTransactionState.OK.ToString()) ||
                            transactionResponse.State.Equals(eTransactionState.Pending.ToString())))
                        {
                            // purchase passed
                            long purchaseID = 0;

                            // update entitlement date
                            DateTime entitlementDate = DateTime.UtcNow;
                            DateTime? endDate = null;
                            transactionResponse.CreatedAt = DateUtils.DateTimeToUnixTimestamp(entitlementDate);

                            // grant entitlement
                            bool handleBillingPassed = HandleSubscriptionBillingSuccess(ref transactionResponse, userId, householdId, subscription, price, currency, coupon, userIP,
                                country, udid, long.Parse(transactionResponse.TransactionID), customData, productId, billingGuid.ToString(), entitleToPreview, subscription.m_bIsRecurring,
                                entitlementDate, ref purchaseID, ref endDate, SubscriptionPurchaseStatus.OK);

                            if (handleBillingPassed && endDate.HasValue)
                            {
                                status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());

                                WriteToUserLog(userId, string.Format("Subscription Purchase, productId:{0}, PurchaseID:{1}, BillingTransactionID:{2}",
                                    productId, purchaseID, transactionResponse.TransactionID));

                                // entitlement passed, update domain DLM with new DLM from subscription or if no DLM in new subscription, with last domain DLM
                                if (subscription.m_nDomainLimitationModule != 0)
                                {
                                    UpdateDLM(householdId, subscription.m_nDomainLimitationModule);
                                }

                                if (subscription.m_bIsRecurring)
                                {
                                    PaymentGateway paymentGatewayResponse = null;
                                    try
                                    {
                                        // call billing process renewal
                                        string billingUserName = string.Empty;
                                        string billingPassword = string.Empty;
                                        module wsBillingService = null;
                                        InitializeBillingModule(ref wsBillingService, ref billingUserName, ref billingPassword);
                                        paymentGatewayResponse = wsBillingService.GetPaymentGatewayByBillingGuid(billingUserName, billingPassword, householdId, billingGuid);

                                        DateTime nextRenewalDate = endDate.Value.AddMinutes(-5); //default
                                        if (paymentGatewayResponse == null)
                                        {
                                            // error getting PG
                                            log.Error("Error getting the PG - no renewal taks sent");
                                        }
                                        else
                                        {
                                            nextRenewalDate = endDate.Value.AddMinutes(paymentGatewayResponse.RenewalStartMinutes);
                                        }
                                        // enqueue renew transaction
                                        RenewTransactionsQueue queue = new RenewTransactionsQueue();
                                        RenewTransactionData data = new RenewTransactionData(m_nGroupID, userId, purchaseID, billingGuid,
                                            TVinciShared.DateUtils.DateTimeToUnixTimestamp((DateTime)endDate), nextRenewalDate);
                                        bool enqueueSuccessful = queue.Enqueue(data, string.Format(ROUTING_KEY_PROCESS_RENEW_SUBSCRIPTION, m_nGroupID));
                                        if (!enqueueSuccessful)
                                        {
                                            log.ErrorFormat("Failed enqueue of renew transaction {0}", data);
                                        }
                                        else
                                            log.DebugFormat("New task created (upon subscription purchase success). next renewal date: {0}, data: {1}", nextRenewalDate, data);
                                    }
                                    catch (Exception ex)
                                    {
                                        log.Error("Error while trying to get the PG", ex);
                                    }
                                }

                                // build notification message
                                var dicData = new Dictionary<string, object>()
                                    {
                                        {"SubscriptionCode", productId},
                                        {"BillingTransactionID", transactionResponse.TransactionID},
                                        {"SiteGUID", userId},
                                        {"PurchaseID", purchaseID},
                                        {"CouponCode", coupon},
                                        {"CustomData", customData}
                                    };
                                // notify purchase
                                if (!this.EnqueueEventRecord(NotifiedAction.ChargedSubscription, dicData))
                                {
                                    log.ErrorFormat("Error while enqueue purchase record: {0}, data: {1}", transactionResponse.Status.Message, logString);
                                }
                            }
                            else
                            {
                                // purchase passed, entitlement failed
                                status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "purchase passed but entitlement failed");
                                log.ErrorFormat("Error: {0}, data: {1}", transactionResponse.Status.Message, logString);
                            }
                        }
                        else
                        {
                            // purchase failed - received error status
                            status = new ApiObjects.Response.Status(transactionResponse.Status.Code, transactionResponse.Status.Message);
                            log.ErrorFormat("Error: {0}, data: {1}", status.Message, logString);
                        }

                    }
                    else
                    {
                        // incorrect price
                        status = new ApiObjects.Response.Status((int)eResponseStatus.IncorrectPrice, "The price of the request is not the actual price");
                        log.ErrorFormat("Error: {0}, data: {1}", status.Message, logString);
                    }
                }
                else
                {
                    // item not for purchase
                    status = Utils.SetResponseStatus(priceReason);
                    log.ErrorFormat("Error: {0}, data: {1}", status.Message, logString);
                }
            }

            catch (Exception ex)
            {
                log.Error(string.Empty, ex);
                status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }
            return status;
        }

        private ApiObjects.Response.Status RecordPPVEntitlement(string userId, long householdId, int contentId, int productId, string coupon, double price,
            string currency, string customData, string userIP, string udid, int state, int paymentGatewayId, string paymentGatewayReferenceID, string paymentGatewayResponseCode, string paymentDetails,
            string paymentMethod, string paymentMethodExternalID)
        {
            ApiObjects.Response.Status status = new ApiObjects.Response.Status();
            // log request
            string logString =
                string.Format("RecoredPPVEntitlement request: siteguid {0}, household {1}, price {2}, currency {3}, contentId {4}, productId {5}, coupon {6}, userIp {7}, paymentGatewayId {8}",
                !string.IsNullOrEmpty(userId) ? userId : string.Empty, householdId, price, !string.IsNullOrEmpty(currency) ? currency : string.Empty,
                contentId, productId, !string.IsNullOrEmpty(coupon) ? coupon : string.Empty, !string.IsNullOrEmpty(userIP) ? userIP : string.Empty, paymentGatewayId);

            log.Debug(logString);

            try
            {
                // validate content ID
                if (contentId < 1)
                {
                    status = new ApiObjects.Response.Status((int)eResponseStatus.Error, ILLEGAL_CONTENT_ID);
                    log.ErrorFormat("Error: {0}, contentId: {1}", status.Message, contentId.ToString());
                    return status;
                }

                // validate content ID related media
                int mediaID = ConditionalAccess.Utils.GetMediaIDFromFileID(contentId, m_nGroupID);
                if (mediaID < 1)
                {
                    status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Content ID with no related media");
                    log.ErrorFormat("Error: {0}, contentId: {1}", status.Message, contentId.ToString());
                    return status;
                }

                // validate PPV 
                PPVModule thePPVModule = null;
                status = Utils.ValidatePPVModuleCode(m_nGroupID, productId, contentId, ref thePPVModule);
                if (status.Code != (int)eResponseStatus.OK)
                {
                    log.ErrorFormat("Error: {0}, productId: {1}, contentId: {2}", status.Message, productId, contentId);
                    return status;
                }

                // validate price
                PriceReason priceReason = PriceReason.UnKnown;
                Subscription relevantSub = null;
                Collection relevantCol = null;
                PrePaidModule relevantPP = null;
                Price mediaPrice = Utils.GetMediaFileFinalPriceForNonGetItemsPrices(contentId, thePPVModule, userId, coupon, m_nGroupID,
                                                                                              ref priceReason, ref relevantSub, ref relevantCol, ref relevantPP,
                                                                                              string.Empty, string.Empty, string.Empty);
                if (mediaPrice == null)
                {
                    // incorrect price
                    status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Error Getting price");
                    log.ErrorFormat("Error: {0}, data: {1}", status.Message, logString);
                    return status;
                }

                bool couponFullDiscount = (priceReason == PriceReason.Free) && !string.IsNullOrEmpty(coupon);

                if (priceReason == PriceReason.ForPurchase ||
                    (priceReason == PriceReason.SubscriptionPurchased && mediaPrice.m_dPrice > 0) ||
                    couponFullDiscount)
                {
                    // item is for purchase                    
                    if (mediaPrice.m_dPrice == price && mediaPrice.m_oCurrency.m_sCurrencyCD3 == currency)
                    {
                        // create new GUID for billing transaction
                        string billingGuid = Guid.NewGuid().ToString();

                        // RecordTransaction
                        //------------------
                        TransactionResponse transactionResponse = RecordBillingTransaction(userId, householdId, contentId, productId, eTransactionType.PPV, paymentDetails, paymentMethod,
                            paymentGatewayId, billingGuid, customData, paymentGatewayReferenceID, paymentGatewayResponseCode, state, paymentMethodExternalID);

                        if (transactionResponse == null || transactionResponse.Status == null)
                        {
                            // purchase failed - no status error
                            log.ErrorFormat("Error: failed to record transaction, data: {0}", logString);
                            return new ApiObjects.Response.Status((int)eResponseStatus.Error, "record transaction failed");
                        }

                        // Status OK + (State OK || State Pending) = grant entitlement
                        if (transactionResponse.Status.Code == (int)eResponseStatus.OK &&
                            (transactionResponse.State.Equals(eTransactionState.OK.ToString()) ||
                            transactionResponse.State.Equals(eTransactionState.Pending.ToString())))
                        {
                            string country = string.Empty;
                            if (!string.IsNullOrEmpty(userIP))
                            {
                                // get country by user IP
                                country = Utils.GetIP2CountryName(m_nGroupID, userIP);
                            }
                            // purchase passed
                            long purchaseId = 0;

                            // update entitlement date
                            DateTime entitlementDate = DateTime.UtcNow;
                            transactionResponse.CreatedAt = DateUtils.DateTimeToUnixTimestamp(entitlementDate);

                            // grant entitlement
                            bool handleBillingPassed = HandlePPVBillingSuccess(ref transactionResponse, userId, householdId, relevantSub, price, currency, coupon, userIP,
                                            country, userId, long.Parse(transactionResponse.TransactionID), customData, thePPVModule,
                                          productId, contentId, billingGuid, entitlementDate, ref purchaseId);

                            if (handleBillingPassed)
                            {
                                WriteToUserLog(userId, string.Format("PPV Purchase, ProductID:{0}, ContentID:{1}, PurchaseID:{2}, BillingTransactionID:{3}",
                                    productId, contentId, purchaseId, transactionResponse.TransactionID));

                                // entitlement passed - build notification message
                                var dicData = new Dictionary<string, object>()
                                    {
                                        {"MediaFileID", contentId},
                                        {"BillingTransactionID", transactionResponse.TransactionID},
                                        {"PPVModuleCode", productId},
                                        {"SiteGUID", userId},
                                        {"CouponCode", coupon},
                                        {"CustomData", customData},
                                        {"PurchaseID", purchaseId}
                                    };

                                // notify purchase
                                if (!this.EnqueueEventRecord(NotifiedAction.ChargedMediaFile, dicData))
                                {
                                    log.ErrorFormat("Error while enqueue purchase record: {0}, data: {1}", status.Message, logString);
                                }

                                status = new ApiObjects.Response.Status((int)eResponseStatus.OK, "OK");
                            }
                            else
                            {
                                // purchase passed, entitlement failed
                                status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "purchase passed, entitlement failed");
                                log.ErrorFormat("Error: {0}, data: {1}", status.Message, logString);
                            }
                        }
                        else
                        {
                            // purchase failed - received error status
                            status = new ApiObjects.Response.Status(transactionResponse.Status.Code, transactionResponse.Status.Message);
                            log.ErrorFormat("Error: {0}, data: {1}", status.Message, logString);
                        }
                    }
                    else
                    {
                        // incorrect price
                        status = new ApiObjects.Response.Status((int)eResponseStatus.IncorrectPrice, "The request price is incorrect");
                        log.ErrorFormat("Error: {0}, data: {1}", status.Message, logString);
                    }
                }
                else
                {
                    // not for purchase
                    status = Utils.SetResponseStatus(priceReason);
                    log.ErrorFormat("Error: {0}, data: {1}", status.Message, logString);
                }
            }
            catch (Exception ex)
            {
                status = new ApiObjects.Response.Status((int)eResponseStatus.Error);
                log.Error("Exception occurred. data: " + logString, ex);
            }
            return status;
        }

        private static void GetDataFromCustomData(int customDataId, string customData, ref double customDataPrice, ref string customDataCurrency, ref string userIP, ref string coupon, ref string udid)
        {
            try
            {
                XmlDocument doc = new XmlDocument();
                doc.LoadXml(customData);
                XmlNode theRequest = doc.FirstChild;

                customDataCurrency = XmlUtils.GetSafeValue(CURRENCY, ref theRequest);
                userIP = XmlUtils.GetSafeValue(USER_IP, ref theRequest);
                coupon = XmlUtils.GetSafeValue(COUPON_CODE, ref theRequest);
                udid = XmlUtils.GetSafeValue(DEVICE_NAME, ref theRequest);
                if (!Double.TryParse(XmlUtils.GetSafeValue(PRICE, ref theRequest), out customDataPrice))
                {
                    customDataPrice = 0.0;
                }

            }
            catch (Exception exc)
            {
                log.ErrorFormat("SetEntitlement - error load custom data xml {0} Exception:{1}", customDataId, exc);
                throw exc;
            }
        }

        private TransactionResponse RecordBillingTransaction(string userId, long householdId, int contentId, int productId, eTransactionType transactionType, string paymentDetails,
            string paymentMethod, int paymentGatewayId, string billingGuid, string customData, string paymentGatewayReferenceID,
            string paymentGatewayResponseCode, int state, string paymentMethodExternalID)
        {
            TransactionResponse response = new TransactionResponse();

            string logString = string.Format("RecordBillingTransaction billing service siteGUID={0}, houseHoldID={1}, customData={2}, productID={3}, transactionType={4}, billingGuid={5}, paymentGatewayId={6}",
                                       !string.IsNullOrEmpty(userId) ? userId : string.Empty, householdId, !string.IsNullOrEmpty(customData) ? customData : string.Empty,
                                       productId, (int)transactionType, !string.IsNullOrEmpty(billingGuid) ? billingGuid : string.Empty, paymentGatewayId);
            log.Debug(logString);

            try
            {
                string userName = string.Empty;
                string password = string.Empty;
                module wsBillingService = null;
                InitializeBillingModule(ref wsBillingService, ref userName, ref password);

                // call new billing method for charge adapter
                var transactionResponse = wsBillingService.RecordTransaction(userName, password, userId, (int)householdId, paymentGatewayReferenceID, paymentGatewayResponseCode, productId, (int)transactionType,
                                                                                billingGuid, contentId, string.Empty, state, paymentGatewayId, 0, paymentMethod, paymentDetails, customData, paymentMethodExternalID);

                response = ConvertTransactResultToTransactionResponse(logString, transactionResponse);
            }
            catch (Exception ex)
            {
                log.Error(logString, ex);
                response = new TransactionResponse((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }

            return response;
        }

        protected internal static TransactionResponse ConvertTransactResultToTransactionResponse(string logString, TransactResult transactResult)
        {
            TransactionResponse response = new TransactionResponse();

            if (transactResult != null)
            {
                // convert response to purchase response
                //--------------------------------------
                response.PGReferenceID = transactResult.PGReferenceID != null ? transactResult.PGReferenceID : string.Empty;
                response.PGResponseCode = transactResult.PGResponseID != null ? transactResult.PGResponseID : string.Empty;
                response.TransactionID = transactResult.TransactionID.ToString();
                response.State = transactResult.State.ToString();
                response.FailReasonCode = transactResult.FailReasonCode;
                response.StartDateSeconds = transactResult.StartDateSeconds;
                response.EndDateSeconds = transactResult.EndDateSeconds;
                response.AutoRenewing = transactResult.AutoRenewing;

                if (transactResult.Status != null)
                    response.Status = new ApiObjects.Response.Status((int)transactResult.Status.Code, transactResult.Status.Message);
                else
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "No status returned from billing service");
                    log.Error("Received error from billing service. " + logString);
                }
            }
            return response;
        }

        public ApiObjects.Response.Status UpdateRecordedTransaction(long householdId, string paymentGatewayReferenceID, string paymentDetails, string paymentMethod, int paymentGatewayId,
            string paymentMethodExternalId)
        {
            ApiObjects.Response.Status status = new ApiObjects.Response.Status();

            string logData = string.Format("paymentGatewayReferenceID: {0}, paymentDetails: {1}, paymentMethod: {2}, paymentGatewayId: {3}, paymentMethodExternalId: {4}",
               paymentGatewayReferenceID, paymentDetails, paymentMethod, paymentGatewayId, paymentMethodExternalId);
            try
            {
                string userName = string.Empty;
                string password = string.Empty;
                module wsBillingService = null;
                InitializeBillingModule(ref wsBillingService, ref userName, ref password);

                // call new billing method for charge adapter
                var response = wsBillingService.UpdateRecordedTransaction(userName, password, (int)householdId, paymentGatewayReferenceID, paymentDetails, paymentMethod, paymentGatewayId,
                    paymentMethodExternalId);

                if (response != null)
                {
                    status = new ApiObjects.Response.Status() { Code = response.Code, Message = response.Message };
                }
            }
            catch (Exception ex)
            {
                status = new ApiObjects.Response.Status((int)eResponseStatus.Error);
                log.Error("Exception occurred. data: " + logData, ex);
            }

            return status;

        }

        public CDVRAdapterResponseList GetCDVRAdapters()
        {
            CDVRAdapterResponseList response = new CDVRAdapterResponseList();
            try
            {
                response.Adapters = ConditionalAccessDAL.GetCDVRAdapterList(m_nGroupID);
                if (response.Adapters == null || response.Adapters.Count == 0)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, "No adapters found");
                }
                else
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                }
            }
            catch (Exception ex)
            {
                response = new CDVRAdapterResponseList();
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                log.Error(string.Format("Failed groupID={0}", m_nGroupID), ex);
            }

            return response;
        }

        public ApiObjects.Response.Status DeleteCDVRAdapter(int adapterId)
        {
            ApiObjects.Response.Status response = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
            try
            {

                if (adapterId == 0)
                {
                    response = new ApiObjects.Response.Status((int)eResponseStatus.AdapterIdentifierRequired, ADAPTER_ID_REQUIRED);
                    return response;
                }

                //// in case adapterId is the group selected CDVR Adapter  - delete isnt allowed
                ////-------------------------------------------------------------------------------
                //object defaultAdapter = ODBCWrapper.Utils.GetTableSingleVal("groups_parameters", "OSS_ADAPTER", "GROUP_ID", "=", m_nGroupID, "billing_connection");
                //int cdvrAdapterIdentifier = 0;
                //if (defaultAdapter != null && int.TryParse(defaultAdapter.ToString(), out cdvrAdapterIdentifier) && cdvrAdapterIdentifier > 0)
                //{
                //    if (cdvrAdapterIdentifier == adapterId)
                //    {
                //        response = new ApiObjects.Response.Status((int)eResponseStatus.ActionIsNotAllowed, ACTION_IS_NOT_ALLOWED);
                //        return response;
                //    }
                //}

                //check CDVR Adapter exist
                CDVRAdapter adapter = ConditionalAccessDAL.GetCDVRAdapter(m_nGroupID, adapterId);
                if (adapter == null || adapter.ID <= 0)
                {
                    response = new ApiObjects.Response.Status((int)eResponseStatus.AdapterNotExists, ADAPTER_NOT_EXIST);
                    return response;
                }


                bool isSet = ConditionalAccessDAL.DeleteCDVRAdapter(m_nGroupID, adapterId);
                if (isSet)
                {
                    response = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                }
                else
                {
                    response = new ApiObjects.Response.Status((int)eResponseStatus.AdapterNotExists, ADAPTER_NOT_EXIST);
                }

                string version = TVinciShared.WS_Utils.GetTcmConfigValue("Version");
                string[] keys = new string[1] 
                    { 
                        string.Format("{0}_cdvr_adapter_{1}", version, adapterId)
                    };

                QueueUtils.UpdateCache(m_nGroupID, CouchbaseManager.eCouchbaseBucket.CACHE.ToString(), keys);

            }
            catch (Exception ex)
            {
                response = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                log.Error(string.Format("Failed groupID={0}, adapterID={1}", m_nGroupID, adapterId), ex);
            }
            return response;
        }

        public CDVRAdapterResponse InsertCDVRAdapter(CDVRAdapter adapter)
        {
            CDVRAdapterResponse response = new CDVRAdapterResponse();

            try
            {
                if (adapter == null)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.NoAdapterToInsert, NO_ADAPTER_TO_INSERT);
                    return response;
                }

                if (string.IsNullOrEmpty(adapter.Name))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.NameRequired, NAME_REQUIRED);
                    return response;
                }

                if (string.IsNullOrEmpty(adapter.AdapterUrl))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterUrlRequired, ADAPTER_URL_REQUIRED);
                    return response;
                }

                if (string.IsNullOrEmpty(adapter.ExternalIdentifier))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExternalIdentifierRequired, EXTERNAL_IDENTIFIER_REQUIRED);
                    return response;
                }

                // Create Shared secret 
                adapter.SharedSecret = Guid.NewGuid().ToString().Replace("-", "").Substring(0, 16);

                //check External Identifier uniqueness 
                CDVRAdapter responseAdapter = ConditionalAccessDAL.GetCDVRAdapterByExternalId(m_nGroupID, adapter.ExternalIdentifier);

                if (responseAdapter != null && responseAdapter.ID > 0)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExternalIdentifierMustBeUnique, ERROR_EXT_ID_ALREADY_IN_USE);
                    return response;
                }

                response.Adapter = ConditionalAccessDAL.InsertCDVRAdapter(m_nGroupID, adapter);
                if (response.Adapter != null && response.Adapter.ID > 0)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());

                    if (!SendConfigurationToAdapter(m_nGroupID, response.Adapter))
                    {
                        log.ErrorFormat("InsertCDVRAdapter - SendConfigurationToAdapter failed : adapterID = {0}", response.Adapter.ID);
                    }

                    // remove adapter from cache
                    string version = TVinciShared.WS_Utils.GetTcmConfigValue("Version");
                    string[] keys = new string[1] 
                    { 
                        string.Format("{0}_cdvr_adapter_{1}", version, adapter.ID)
                    };

                    QueueUtils.UpdateCache(m_nGroupID, CouchbaseManager.eCouchbaseBucket.CACHE.ToString(), keys);
                }
                else
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "failed to insert new CDVR Adapter");
                }
            }
            catch (Exception ex)
            {
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                log.Error(string.Format("Failed groupID={0}", m_nGroupID), ex);
            }
            return response;
        }

        public CDVRAdapterResponse GenerateCDVRSharedSecret(int adapterId)
        {
            CDVRAdapterResponse response = new CDVRAdapterResponse();

            try
            {
                if (adapterId <= 0)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterIdentifierRequired, ADAPTER_ID_REQUIRED);
                    return response;
                }

                //check CDVR Adapter exist
                CDVRAdapter adapter = ConditionalAccessDAL.GetCDVRAdapter(m_nGroupID, adapterId);
                if (adapter == null || adapter.ID <= 0)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterNotExists, ADAPTER_NOT_EXIST);
                    return response;
                }

                // Create Shared secret 
                string sharedSecret = Guid.NewGuid().ToString().Replace("-", "").Substring(0, 16);

                response.Adapter = ConditionalAccessDAL.SetCDVRAdapterSharedSecret(m_nGroupID, adapterId, sharedSecret);

                if (response.Adapter != null && response.Adapter.ID > 0)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());

                    bool isSendSucceeded = SendConfigurationToAdapter(m_nGroupID, response.Adapter);
                    if (!isSendSucceeded)
                    {
                        log.DebugFormat("SetCDVRAdapter - SendConfigurationToAdapter failed : AdapterID = {0}", adapter.ID);
                    }

                    // remove adapter from cache
                    string version = TVinciShared.WS_Utils.GetTcmConfigValue("Version");
                    string[] keys = new string[1] 
                    { 
                        string.Format("{0}_cdvr_adapter_{1}", version,adapterId)
                    };

                    QueueUtils.UpdateCache(m_nGroupID, CouchbaseManager.eCouchbaseBucket.CACHE.ToString(), keys);
                }
                else
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                }

            }
            catch (Exception ex)
            {
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                log.Error(string.Format("Failed groupID={0}, adapterId={1}", m_nGroupID, adapterId), ex);
            }
            return response;
        }

        public CDVRAdapterResponse SendConfigurationToAdapter(CDVRAdapter adapter)
        {
            CDVRAdapterResponse response = new CDVRAdapterResponse();

            try
            {
                if (adapter == null)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterIsRequired, NO_ADAPTER_TO_UPDATE);
                    return response;
                }

                if (adapter.ID == 0)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterIdentifierRequired, ADAPTER_ID_REQUIRED);
                    return response;
                }
                if (string.IsNullOrEmpty(adapter.Name))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.NameRequired, NAME_REQUIRED);
                    return response;
                }

                if (string.IsNullOrEmpty(adapter.ExternalIdentifier))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExternalIdentifierRequired, EXTERNAL_IDENTIFIER_REQUIRED);
                    return response;
                }

                if (string.IsNullOrEmpty(adapter.AdapterUrl))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterUrlRequired, ADAPTER_URL_REQUIRED);
                    return response;
                }

                // SharedSecret generated only at insert 
                // this value not relevant at update and should be ignored
                //--------------------------------------------------------
                adapter.SharedSecret = null;

                //check External Identifier uniqueness 
                CDVRAdapter responseAdpater = ConditionalAccessDAL.GetCDVRAdapter(m_nGroupID, adapter.ID);

                if (responseAdpater == null)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterNotExists, ADAPTER_NOT_EXIST);
                    return response;
                }

                CDVRAdapter responseAdpaterExternal = ConditionalAccessDAL.GetCDVRAdapterByExternalId(m_nGroupID, adapter.ExternalIdentifier);

                if (responseAdpaterExternal != null && responseAdpaterExternal.ID != adapter.ID)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExternalIdentifierMustBeUnique, ERROR_EXT_ID_ALREADY_IN_USE);
                    return response;
                }
                bool isSetSucceeded = SendConfigurationToAdapter(m_nGroupID, responseAdpater);
                if (!isSetSucceeded)
                {
                    log.DebugFormat("SetCDVRAdapter - SendConfigurationToAdapter failed : AdapterID = {0}", adapter.ID);
                }
                else
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                }

            }
            catch (Exception ex)
            {
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                log.Error(string.Format("Failed groupID={0}, adapterId={1}, name={2}, adapterUrl={3}, isActive={4}",
                    m_nGroupID, adapter.ID, adapter.Name, adapter.AdapterUrl, adapter.IsActive), ex);
            }
            return response;
        }

        private static bool SendConfigurationToAdapter(int groupId, CDVRAdapter adapter)
        {
            try
            {
                CdvrAdapterController cdvrAdapter = CdvrAdapterController.GetInstance();
                return cdvrAdapter.SetConfiguration(adapter, groupId);
            }
            catch 
            {
                return false;
            }
        }

        public Recording Record(string userID, long epgID, RecordingType recordingType, long domainSeriesRecordingId = 0)
        {
            Recording recording = new Recording() { EpgId = epgID };
            RecordingResponse recordingResponse = new RecordingResponse();
            try
            {
                long domainID = 0;

                recordingResponse = QueryRecords(userID, new List<long>() { epgID }, ref domainID, recordingType, true);
                if (recordingResponse.Status.Code != (int)eResponseStatus.OK || recordingResponse.TotalItems == 0)
                {
                    log.DebugFormat("RecordingResponse status not valid, EpgID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", epgID, domainID, userID, recording.ToString());
                    recording.Status = recordingResponse.Status;
                    return recording;
                }

                recording = recordingResponse.Recordings[0];
                if (recording == null || recording.Status == null || recording.Status.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("Recording status not valid, EpgID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", epgID, domainID, userID, recording.ToString());
                    return recording;
                }

                if (recording.Id == 0 || !Utils.IsValidRecordingStatus(recording.RecordingStatus))
                {
                    log.DebugFormat("Recording ID is 0 or RecordingStatus not valid, EpgID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", epgID, domainID, userID, recording.ToString());
                    recording = RecordingsManager.Instance.Record(m_nGroupID, recording.EpgId, recording.ChannelId, recording.EpgStartDate, recording.EpgEndDate, recording.Crid);
                    if (recording != null && recording.Status != null && recording.Status.Code == (int)eResponseStatus.OK
                        && recording.Id > 0 && Utils.IsValidRecordingStatus(recording.RecordingStatus))
                    {
                        int recordingDuration = (int)(recording.EpgEndDate - recording.EpgStartDate).TotalSeconds;
                        if (QuotaManager.Instance.IncreaseDomainUsedQuota(m_nGroupID, domainID, recordingDuration))
                        {
                            recording.Type = recordingType;
                            if (!RecordingsDAL.UpdateOrInsertDomainRecording(m_nGroupID, long.Parse(userID), domainID, recording, domainSeriesRecordingId))
                            {
                                // increase the quota back to the user                               
                                if (!QuotaManager.Instance.DecreaseDomainUsedQuota(m_nGroupID, domainID, recordingDuration))
                                {
                                    log.ErrorFormat("Failed giving the quota back to the domain, EpgID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", epgID, domainID, userID, recording.ToString());
                                }

                                log.ErrorFormat("Failed saving record to domain recordings table, EpgID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", epgID, domainID, userID, recording.ToString());
                                recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                            }
                        }
                        else
                        {
                            log.ErrorFormat("Not enough quota to record, EpgID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", epgID, domainID, userID, recording.ToString());
                            recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExceededQuota, eResponseStatus.ExceededQuota.ToString());
                        }
                    }
                    else
                    {
                        recording = new Recording() { Status = new ApiObjects.Response.Status((int)eResponseStatus.RecordingFailed, eResponseStatus.RecordingFailed.ToString()) };
                    }
                }
            }
            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at Record. ");
                sb.Append(String.Concat("userID: ", userID));
                sb.Append(String.Concat(", epgID: ", epgID));
                sb.Append(String.Concat(", Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error(sb.ToString(), ex);
            }

            return recording;
        }

        public Recording CancelOrDeleteRecord(string userId, long domainId, long domainRecordingId, TstvRecordingStatus tstvRecordingStatus, bool shouldValidateUserAndDomain = true)
        {
            Recording recording = new Recording();
            try
            {
                bool res = false;
                if (shouldValidateUserAndDomain)
                {
                    Domain domain;
                    ApiObjects.Response.Status validationStatus = Utils.ValidateUserAndDomain(m_nGroupID, userId, ref domainId, out domain);

                    if (validationStatus.Code != (int)eResponseStatus.OK)
                    {
                        log.DebugFormat("User or Domain not valid, DomainID: {0}, UserID: {1}", domainId, userId);
                        recording.Status = new ApiObjects.Response.Status(validationStatus.Code, validationStatus.Message);
                        return recording;
                    }
                }
                // user is OK - see if user sign to recordID
                recording = Utils.ValidateRecordID(m_nGroupID, domainId, domainRecordingId);
                if (recording.Status.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("recording status not valid, recordID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", domainRecordingId, domainId, userId, recording != null ? recording.ToString() : string.Empty);
                    return recording;
                }
                List<TstvRecordingStatus> RecordingStatus = new List<TstvRecordingStatus>();
                DomainRecordingStatus? domainStatus = Utils.ConvertToDomainRecordingStatus(tstvRecordingStatus);
                bool shouldCancel = false;
                switch (tstvRecordingStatus)
                {
                    case TstvRecordingStatus.Canceled:
                    case TstvRecordingStatus.SeriesCancel:
                        RecordingStatus = new List<TstvRecordingStatus>() { TstvRecordingStatus.Recording, TstvRecordingStatus.Scheduled };
                        shouldCancel = true;
                        break;
                    case TstvRecordingStatus.Deleted:
                        RecordingStatus = new List<TstvRecordingStatus>() { TstvRecordingStatus.Recorded };
                        break;
                    case TstvRecordingStatus.SeriesDelete:
                        RecordingStatus = new List<TstvRecordingStatus>() { TstvRecordingStatus.Recorded, TstvRecordingStatus.Recording };
                        break;
                    default:
                        break;
                }

                if (!Utils.IsValidRecordingStatus(recording.RecordingStatus, RecordingStatus))
                {
                    log.DebugFormat("CancelOrDeleteRecord - domainRecordingId: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", domainRecordingId, domainId, userId, recording.ToString());
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.RecordingStatusNotValid, recording.RecordingStatus.ToString());
                    recording.Id = domainRecordingId;
                    return recording;
                }
                else if (shouldCancel)
                {
                    res = RecordingsDAL.CancelDomainRecording(domainRecordingId, domainStatus.Value);  // delete recording id from domain
                    log.DebugFormat("canceled domainRecordingId: {0} with result: {1}", domainRecordingId, res);
                }
                else
                {
                    res = RecordingsDAL.DeleteDomainRecording(domainRecordingId, domainStatus.Value);
                    log.DebugFormat("deleted domainRecordingId: {0} with result: {1}", domainRecordingId, res);
                }

                if (res)
                {
                    if (QuotaManager.Instance.DecreaseDomainUsedQuota(m_nGroupID, domainId, (int)(recording.EpgEndDate - recording.EpgStartDate).TotalSeconds))
                    {
                        ContextData contextData = new ContextData();
                        System.Threading.Tasks.Task async = Task.Factory.StartNew((taskDomainId) =>
                        {
                            contextData.Load();
                            if (!CompleteDomainSeriesRecordings((long)taskDomainId))
                            {
                                log.ErrorFormat("Failed CompleteHouseholdSeriesRecordings after CancelOrDeleteRecord: domainId: {0}", domainId);
                            }
                        }, domainId);
                    }
                    recording.RecordingStatus = tstvRecordingStatus;
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                }
                else
                {
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "fail to perform cancel or delete");
                    recording.Id = domainRecordingId;
                    log.ErrorFormat("fail to perform cancel or delete recordingId = {0}, domainRecordingID = {1}, tstvRecordingStatus = {2}", recording.Id, domainRecordingId, tstvRecordingStatus.ToString());
                }

                recording.Id = domainRecordingId;
            }
            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at CancelOrDeleteRecord. ");
                sb.Append(String.Concat("userID: ", userId));
                sb.Append(String.Concat(", recordID: ", domainRecordingId));
                sb.Append(String.Concat(", Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error(sb.ToString(), ex);
            }
            return recording;
        }

        public RecordingResponse QueryRecords(string userID, List<long> epgIDs, ref long domainID, RecordingType recordingType, bool shouldCheckCatchup)
        {
            RecordingResponse response = new RecordingResponse();
            try
            {
                bool isSingleRecording = recordingType == RecordingType.Single;
                Domain domain;
                ApiObjects.Response.Status validationStatus = Utils.ValidateUserAndDomain(m_nGroupID, userID, ref domainID, out domain);

                if (validationStatus.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("User or Domain not valid, DomainID: {0}, UserID: {1}", domainID, userID);
                    response.Status = new ApiObjects.Response.Status(validationStatus.Code, validationStatus.Message);
                    return response;
                }

                TimeShiftedTvPartnerSettings accountSettings = Utils.GetTimeShiftedTvPartnerSettings(m_nGroupID);
                if (accountSettings == null || !accountSettings.IsCdvrEnabled.HasValue || !accountSettings.IsCdvrEnabled.Value)
                {
                    log.DebugFormat("account CDVR not enabled, DomainID: {0}, UserID: {1}", domainID, userID);
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AccountCdvrNotEnabled, eResponseStatus.AccountCdvrNotEnabled.ToString());
                    return response;
                }

                if (!IsServiceAllowed((int)domainID, eService.NPVR))
                {
                    log.DebugFormat("Premium Service not allowed, DomainID: {0}, UserID: {1}, Service: {2}", domainID, userID, eService.NPVR.ToString());
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ServiceNotAllowed, eResponseStatus.ServiceNotAllowed.ToString());
                    return response;
                }

                if (recordingType == RecordingType.Series && (!accountSettings.IsSeriesRecordingEnabled.HasValue || !accountSettings.IsSeriesRecordingEnabled.Value))
                {
                    log.DebugFormat("account series recordings not enabled, DomainID: {0}, UserID: {1}", domainID, userID);
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AccountSeriesRecordingNotEnabled, eResponseStatus.AccountSeriesRecordingNotEnabled.ToString());
                    return response;
                }

                List<EPGChannelProgrammeObject> epgs = Utils.GetEpgsByIds(m_nGroupID, epgIDs);
                if (epgs == null)
                {
                    log.DebugFormat("Failed Getting EPGs from Catalog, DomainID: {0}, UserID: {1}, EpgIDs: {2}", domainID, userID, string.Join(",", epgIDs));
                    epgs = new List<EPGChannelProgrammeObject>();
                }

                List<long> validEpgIds = epgs.Select(x => x.EPG_ID).ToList();
                foreach (long epgId in epgIDs)
                {
                    if (!validEpgIds.Contains(epgId))
                    {
                        Recording invalidAsset = new Recording() { Status = new ApiObjects.Response.Status((int)eResponseStatus.InvalidAssetId, eResponseStatus.InvalidAssetId.ToString()), EpgId = epgId };
                        response.Recordings.Add(invalidAsset);
                    }
                }

                Dictionary<long, bool> validEpgsForRecording = new Dictionary<long, bool>();
                // check if Epgs are valid for recording - CDVR enabled and Catch-Up enabled if needed
                foreach (EPGChannelProgrammeObject epg in epgs)
                {
                    Recording recording = Utils.ValidateEpgForRecord(accountSettings, epg, shouldCheckCatchup);
                    if (recording != null && recording.Status != null && recording.Status.Code == (int)eResponseStatus.OK)
                    {
                        if (isSingleRecording)
                        {
                            ApiObjects.Response.Status IsFollowingResponse = Utils.IsFollowingEpgAsSeriesOrSeason(m_nGroupID, epg, domainID, recordingType);
                            if (IsFollowingResponse.Code != (int)eResponseStatus.OK)
                            {
                                recording.Status = IsFollowingResponse;
                                response.Recordings.Add(recording);
                            }
                            else
                            {
                                validEpgsForRecording.Add(recording.EpgId, false);
                            }
                        }
                        else
                        {
                            validEpgsForRecording.Add(recording.EpgId, false);
                        }
                    }
                    else
                    {
                        // add nonValidEpgs to response
                        response.Recordings.Add(recording);
                    }
                }

                // validate epgs entitlement and add to response
                ValidateEpgForRecording(userID, domainID, ref response, epgs, validEpgsForRecording);

                // if the recording is of type Single then quota should be checked for each valid recording
                if (isSingleRecording)
                {
                    int totalSeconds = QuotaManager.Instance.GetDomainAvailableQuota(this.m_nGroupID, domainID);
                    foreach (Recording recording in response.Recordings.Where(x => x.Status != null && x.Status.Code == (int)eResponseStatus.OK && x.RecordingStatus == TstvRecordingStatus.OK))
                    {
                        int recordingDuration = (int)(recording.EpgEndDate - recording.EpgStartDate).TotalSeconds;
                        if (recordingDuration > totalSeconds)
                        {
                            recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExceededQuota, eResponseStatus.ExceededQuota.ToString());
                        }
                    }
                }

                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());

                response.TotalItems = response.Recordings.Count;
            }
            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at QueryRecords. ");
                sb.Append(String.Concat("userID: ", userID));
                sb.Append(", epgIDs: ");
                foreach (int epgID in epgIDs)
                {
                    sb.Append(String.Concat(epgID, ", "));
                }
                sb.Append(String.Concat("Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error(sb.ToString(), ex);
            }

            return response;
        }

        private void ValidateEpgForRecording(string userID, long domainID, ref RecordingResponse response, List<EPGChannelProgrammeObject> epgs, Dictionary<long, bool> validEpgsForRecording)
        {
            if (validEpgsForRecording != null && validEpgsForRecording.Count > 0)
            {
                Dictionary<long, string> epgsToChannelMap = new Dictionary<long, string>();
                foreach (long epgId in validEpgsForRecording.Keys)
                {
                    if (!epgsToChannelMap.ContainsKey(epgId))
                    {
                        epgsToChannelMap.Add(epgId, epgs.FirstOrDefault(x => x.EPG_ID == epgId).EPG_CHANNEL_ID);
                    }
                }

                // get all fileIds from Epgs that are valid for recording
                Dictionary<int, List<long>> fileIdsToEpgsMap = Utils.GetFileIdsToEpgIdsMap(m_nGroupID, epgsToChannelMap);

                if (fileIdsToEpgsMap != null && fileIdsToEpgsMap.Count > 0)
                {
                    MediaFileItemPricesContainer[] prices = GetItemsPrices(fileIdsToEpgsMap.Keys.ToArray(), userID, true, string.Empty, string.Empty, string.Empty);
                    if (prices != null && prices.Length > 0)
                    {
                        foreach (MediaFileItemPricesContainer price in prices)
                        {
                            if (IsFreeItem(price) || IsItemPurchased(price))
                            {
                                foreach (long epgId in fileIdsToEpgsMap[price.m_nMediaFileID])
                                {
                                    validEpgsForRecording[epgId] = true;
                                }
                            }
                        }
                    }

                    List<long> epgsWithNoEntitlement = validEpgsForRecording.Where(x => x.Value == false).Select(x => x.Key).ToList();
                    if (epgsWithNoEntitlement != null)
                    {
                        foreach (long epgId in epgsWithNoEntitlement)
                        {
                            Recording RecordingWithNoEntitlement = new Recording() { EpgId = epgId, Status = new ApiObjects.Response.Status((int)eResponseStatus.NotEntitled, eResponseStatus.NotEntitled.ToString()) };
                            response.Recordings.Add(RecordingWithNoEntitlement);
                        }
                    }

                    List<long> epgIdsWithEntitlement = validEpgsForRecording.Where(x => x.Value == true).Select(x => x.Key).ToList();
                    if (epgIdsWithEntitlement != null)
                    {
                        Dictionary<long, EPGChannelProgrammeObject> validEpgObjectForRecordingMap = new Dictionary<long, EPGChannelProgrammeObject>();
                        foreach (long epgId in epgIdsWithEntitlement)
                        {
                            validEpgObjectForRecordingMap.Add(epgId, epgs.FirstOrDefault(x => x.EPG_ID == epgId));
                        }
                        if (validEpgObjectForRecordingMap != null && validEpgObjectForRecordingMap.Count > 0)
                        {
                            List<Recording> recordings = Utils.CheckDomainExistingRecordingsByEpgs(m_nGroupID, domainID, validEpgObjectForRecordingMap);
                            response.Recordings.AddRange(recordings);
                        }
                    }
                }
                else
                {
                    log.DebugFormat("No files were found for all the requested EPGs, DomainID: {1}, UserID: {2}", domainID, userID);
                    foreach (long epgId in validEpgsForRecording.Keys)
                    {
                        Recording RecordingWithNoFileIds = new Recording() { EpgId = epgId, Status = new ApiObjects.Response.Status((int)eResponseStatus.NotEntitled, eResponseStatus.NotEntitled.ToString()) };
                        response.Recordings.Add(RecordingWithNoFileIds);
                    }
                }
            }
        }

        public CDVRAdapterResponse SendConfigurationToAdapter(int adapterID)
        {
            CDVRAdapterResponse response = new CDVRAdapterResponse();

            try
            {
                if (adapterID == 0)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterIdentifierRequired, ADAPTER_ID_REQUIRED);
                    return response;
                }
                // get adapter from DB 
                //check External Identifier uniqueness 
                CDVRAdapter adapter = ConditionalAccessDAL.GetCDVRAdapter(m_nGroupID, adapterID);

                if (adapter == null)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterNotExists, ADAPTER_NOT_EXIST);
                    return response;
                }
                if (string.IsNullOrEmpty(adapter.Name))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.NameRequired, NAME_REQUIRED);
                    return response;
                }

                if (string.IsNullOrEmpty(adapter.ExternalIdentifier))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExternalIdentifierRequired, EXTERNAL_IDENTIFIER_REQUIRED);
                    return response;
                }

                if (string.IsNullOrEmpty(adapter.AdapterUrl))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterUrlRequired, ADAPTER_URL_REQUIRED);
                    return response;
                }

                // SharedSecret generated only at insert 
                // this value not relevant at update and should be ignored
                //--------------------------------------------------------
                //adapter.SharedSecret = null;
                //CDVRAdapter responseAdpaterExternal = DAL.ConditionalAccessDAL.GetCDVRAdapterByExternalId(m_nGroupID, adapter.ExternalIdentifier);

                //if (responseAdpaterExternal != null && responseAdpaterExternal.ID != adapter.ID)
                //{
                //    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExternalIdentifierMustBeUnique, ERROR_EXT_ID_ALREADY_IN_USE);
                //    return response;
                //}
                bool isSetSucceeded = SendConfigurationToAdapter(m_nGroupID, adapter);
                if (!isSetSucceeded)
                {
                    log.DebugFormat("SetCDVRAdapter - SendConfigurationToAdapter failed : AdapterID = {0}", adapter.ID);
                }
                else
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                }

            }
            catch (Exception ex)
            {
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                log.Error(string.Format("Failed groupID={0}, adapterId={1}", m_nGroupID, adapterID), ex);
            }
            return response;
        }

        public RecordingResponse SerachDomainRecordings(string userID, long domainID, List<ApiObjects.TstvRecordingStatus> recordingStatuses,
            string filter, int pageIndex, int pageSize, ApiObjects.SearchObjects.OrderObj orderBy, bool shouldIgnorePaging)
        {
            RecordingResponse response = new RecordingResponse();
            try
            {
                if (recordingStatuses == null || recordingStatuses.Count == 0)
                {
                    //Create recording statuses list (without deleted)
                    log.DebugFormat("RecordingStatuses is null or empty, creating status list, DomainID: {0}, UserID: {1}", domainID, userID);
                    recordingStatuses = new List<TstvRecordingStatus>() 
                        { 
                            TstvRecordingStatus.Recorded, 
                            TstvRecordingStatus.Recording,
                            TstvRecordingStatus.Scheduled, 
                            TstvRecordingStatus.Failed, 
                            TstvRecordingStatus.Canceled                            
                        };
                }

                ApiObjects.Response.Status validationStatus = Utils.ValidateUserAndDomain(m_nGroupID, userID, ref domainID);
                if (validationStatus.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("User or Domain not valid, DomainID: {0}, UserID: {1}, recordingStatuses: {2}", domainID, userID, recordingStatuses);
                    response.Status = new ApiObjects.Response.Status(validationStatus.Code, validationStatus.Message);
                    return response;
                }

                // add cancelSeries if cancel is on the list (we don't have cancelSeries on REST)
                if (recordingStatuses.Contains(TstvRecordingStatus.Canceled) && !recordingStatuses.Contains(TstvRecordingStatus.SeriesCancel))
                {
                    recordingStatuses.Add(TstvRecordingStatus.SeriesCancel);
                }

                Dictionary<long, Recording> DomainRecordingIdToRecordingMap = Utils.GetDomainRecordingsByTstvRecordingStatuses(m_nGroupID, domainID, recordingStatuses);

                if (DomainRecordingIdToRecordingMap != null && DomainRecordingIdToRecordingMap.Count > 0)
                {
                    Dictionary<long, Recording> recordingIdToDomainRecording = new Dictionary<long, Recording>();
                    foreach (KeyValuePair<long, Recording> pair in DomainRecordingIdToRecordingMap)
                    {
                        if (!recordingIdToDomainRecording.ContainsKey(pair.Value.Id))
                        {
                            long recordingId = pair.Value.Id;
                            pair.Value.Id = pair.Key;
                            recordingIdToDomainRecording.Add(recordingId, pair.Value);
                        }
                    }

                    int totalResults = 0;
                    List<Recording> searchRecordings;
                    if (string.IsNullOrEmpty(filter) && Utils.ShouldOrderByWithoutCatalg(orderBy))
                    {
                        searchRecordings = Utils.OrderRecordingWithoutCatalog(DomainRecordingIdToRecordingMap.Values.ToList(), orderBy, pageIndex, pageSize, ref totalResults, shouldIgnorePaging);
                    }
                    else
                    {
                        searchRecordings = Utils.SearchDomainRecordingIDsByFilter(m_nGroupID, string.Empty, 0, recordingIdToDomainRecording, filter, pageIndex, pageSize, orderBy, ref totalResults);
                    }
                    if (searchRecordings != null)
                    {
                        response.Recordings = searchRecordings;
                        response.TotalItems = totalResults;
                    }
                    else
                    {
                        log.DebugFormat("searchRecordings is null, DomainID: {0}, UserID: {1}, pageIndex: {2}, pageSize: {3}, filter: {4}", domainID, userID, pageIndex, pageSize, filter);
                    }

                }

                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
            }

            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at SerachDomainRecordings. ");
                sb.Append(String.Concat("userID: ", userID));
                sb.Append(String.Concat("domainID: ", domainID));
                sb.Append(", RecordingStatuses: ");
                foreach (int recordingStatus in recordingStatuses)
                {
                    sb.Append(String.Concat(recordingStatus, ", "));
                }
                sb.Append(String.Concat("Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error(sb.ToString(), ex);
            }

            return response;
        }

        public Recording GetRecordingByID(long domainID, long domainRecordingID, bool shouldReplaceRecordingObjectId = true)
        {
            Recording response = new Recording();
            try
            {
                Dictionary<long, Recording> DomainRecordingIdToRecordingMap = Utils.GetDomainRecordingIdsToRecordingsMap(m_nGroupID, domainID, new List<long>() { domainRecordingID });
                if (DomainRecordingIdToRecordingMap == null || DomainRecordingIdToRecordingMap.Count == 0 ||
                    !DomainRecordingIdToRecordingMap.ContainsKey(domainRecordingID) || DomainRecordingIdToRecordingMap[domainRecordingID].RecordingStatus == TstvRecordingStatus.Deleted)
                {
                    log.DebugFormat("No valid recording was returned from Utils.GetDomainRecordingIdsToRecordingsMap");
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.RecordingNotFound, eResponseStatus.RecordingNotFound.ToString());
                    return response;
                }

                response = DomainRecordingIdToRecordingMap[domainRecordingID];
                if (shouldReplaceRecordingObjectId)
                {
                    response.Id = domainRecordingID;
                }
            }

            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at GetRecordingByID. ");
                sb.Append(string.Format("domainRecordingID: {0}, ", domainRecordingID));
                sb.Append(String.Concat("Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error(sb.ToString(), ex);
            }

            return response;
        }

        public CDVRAdapterResponse SetCDVRAdapter(CDVRAdapter adapter)
        {
            CDVRAdapterResponse response = new CDVRAdapterResponse();

            try
            {
                if (adapter == null)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterIsRequired, NO_ADAPTER_TO_UPDATE);
                    return response;
                }

                if (adapter.ID == 0)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterIdentifierRequired, ADAPTER_ID_REQUIRED);
                    return response;
                }
                if (string.IsNullOrEmpty(adapter.Name))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.NameRequired, NAME_REQUIRED);
                    return response;
                }

                if (string.IsNullOrEmpty(adapter.ExternalIdentifier))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExternalIdentifierRequired, EXTERNAL_IDENTIFIER_REQUIRED);
                    return response;
                }

                if (string.IsNullOrEmpty(adapter.AdapterUrl))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterUrlRequired, ADAPTER_URL_REQUIRED);
                    return response;
                }

                // SharedSecret generated only at insert 
                // this value not relevant at update and should be ignored
                //--------------------------------------------------------
                adapter.SharedSecret = null;

                //check External Identifier uniqueness 
                CDVRAdapter responseAdpater = ConditionalAccessDAL.GetCDVRAdapterByExternalId(m_nGroupID, adapter.ExternalIdentifier);

                if (responseAdpater != null && responseAdpater.ID > 0 && responseAdpater.ID != adapter.ID)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExternalIdentifierMustBeUnique, ERROR_EXT_ID_ALREADY_IN_USE);
                    return response;
                }

                if (responseAdpater == null)
                {
                    //check adapter exists 
                    responseAdpater = ConditionalAccessDAL.GetCDVRAdapter(m_nGroupID, adapter.ID);
                    if (responseAdpater == null)
                    {
                        response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AdapterNotExists, ADAPTER_NOT_EXIST);
                        return response;
                    }
                }

                if (adapter.Settings == null)
                {
                    adapter.Settings = responseAdpater.Settings;
                }

                response.Adapter = ConditionalAccessDAL.SetCDVRAdapter(m_nGroupID, adapter);

                if (response.Adapter != null && response.Adapter.ID > 0)
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());

                    bool isSendSucceeded = SendConfigurationToAdapter(m_nGroupID, response.Adapter);
                    if (!isSendSucceeded)
                    {
                        log.DebugFormat("SetCDVRAdapter - SendConfigurationToAdapter failed : AdapterID = {0}", adapter.ID);
                    }

                    // remove adapter from cache
                    string version = TVinciShared.WS_Utils.GetTcmConfigValue("Version");
                    string[] keys = new string[1] 
                    { 
                        string.Format("{0}_cdvr_adapter_{1}", version, adapter.ID)
                    };

                    QueueUtils.UpdateCache(m_nGroupID, CouchbaseManager.eCouchbaseBucket.CACHE.ToString(), keys);
                }
                else
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                }

            }
            catch (Exception ex)
            {
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                log.Error(string.Format("Failed groupID={0}, adapterId={1}, name={2}, adapterUrl={3}, isActive={4}",
                    m_nGroupID, adapter.ID, adapter.Name, adapter.AdapterUrl, adapter.IsActive), ex);
            }
            return response;
        }

        public ApiObjects.Response.Status IngestRecording(List<long> epgIds, eAction action)
        {
            ApiObjects.Response.Status status = null;

            // Nothing to do
            if (epgIds == null || epgIds.Count == 0)
            {
                return new ApiObjects.Response.Status((int)eResponseStatus.OK);
            }

            // check if CDVR is enabled
            var tstvSettings = Utils.GetTimeShiftedTvPartnerSettings(m_nGroupID);
            if (!tstvSettings.IsCdvrEnabled.HasValue || !tstvSettings.IsCdvrEnabled.Value)
            {
                return new ApiObjects.Response.Status((int)eResponseStatus.OK);
            }

            // In case an EPG was deleted - recording should be canceled as well
            if (action == eAction.Delete)
            {
                foreach (var id in epgIds)
                {
                    Recording recording = ConditionalAccess.Utils.GetRecordingByEpgId(m_nGroupID, id);

                    var currentStatus = RecordingsManager.Instance.DeleteRecording(m_nGroupID, recording);

                    // If something went wrong, use the first status that failed
                    if (status == null)
                    {
                        if (currentStatus == null)
                        {
                            status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "RecordingsManager.Instance.CancelOrDeleteRecording did not return a status object");
                        }
                        else if (currentStatus.Code != (int)eResponseStatus.OK)
                        {
                            status = currentStatus;
                        }
                    }
                }

                // If we got here and have no status - we are OK
                if (status == null)
                {
                    status = new ApiObjects.Response.Status((int)eResponseStatus.OK);
                }
            }
            // In case of update/turning on
            else if (action == eAction.On || action == eAction.Update)
            {
                // Get EPG objects from Catalog, by their IDs
                List<EPGChannelProgrammeObject> epgs = Utils.GetEpgsByIds(m_nGroupID, epgIds);

                // Simple validation
                if (epgs == null || epgs.Count == 0)
                {
                    log.DebugFormat("Failed Getting EPGs from Catalog, EpgIDs: {0}", string.Join(",", epgIds));
                    status = new ApiObjects.Response.Status((int)eResponseStatus.InvalidAssetId, eResponseStatus.InvalidAssetId.ToString());
                }
                else
                {
                    TimeShiftedTvPartnerSettings accountSettings = Utils.GetTimeShiftedTvPartnerSettings(m_nGroupID);
                    if (accountSettings != null && accountSettings.PaddingBeforeProgramStarts.HasValue && accountSettings.PaddingAfterProgramEnds.HasValue)
                    {
                        DateTime startDate;
                        DateTime endDate;

                        foreach (var epg in epgs)
                        {
                            // Parse start date
                            if (!DateTime.TryParseExact(epg.START_DATE, EPG_DATETIME_FORMAT, System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out startDate))
                            {
                                log.ErrorFormat("Failed parsing EPG start date, epgID: {0}, startDate: {1}", epg.EPG_ID, epg.START_DATE);
                            }
                            else
                            {
                                // Parse end date
                                if (!DateTime.TryParseExact(epg.END_DATE, EPG_DATETIME_FORMAT, System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out endDate))
                                {
                                    log.ErrorFormat("Failed parsing EPG end date, epgID: {0}, endDate: {1}", epg.EPG_ID, epg.START_DATE);
                                }
                                else
                                {
                                    DateTime paddedStartDate = startDate.AddSeconds((-1) * accountSettings.PaddingBeforeProgramStarts.Value);
                                    DateTime paddedEndDate = endDate.AddSeconds(accountSettings.PaddingAfterProgramEnds.Value);

                                    ApiObjects.Response.Status currentStatus = null;
                                    if (action == eAction.Update)
                                    {
                                        currentStatus = RecordingsManager.Instance.UpdateRecording(m_nGroupID, epg.EPG_ID, paddedStartDate, paddedEndDate);

                                        if (status == null)
                                        {
                                            // If we failed with one (and it is the first) - save it so we would later return it
                                            if (currentStatus == null)
                                            {
                                                status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Recording manager failed to update recording");
                                            }
                                            else if (currentStatus.Code != (int)eResponseStatus.Error)
                                            {
                                                status = currentStatus;
                                            }
                                        }
                                    }

                                    if (action == eAction.On || (currentStatus != null && currentStatus.Code == (int)eResponseStatus.OK))
                                    {
                                        // check if the epg is series by getting the fields mappings for the epg
                                        Dictionary<string, string> epgFieldMappings = Utils.GetEpgFieldTypeEntitys(m_nGroupID, epg, RecordingType.Series);
                                        if (epgFieldMappings != null && epgFieldMappings.Count > 0)
                                        {
                                            long channelId;
                                            if (!long.TryParse(epg.EPG_CHANNEL_ID, out channelId))
                                            {
                                                log.ErrorFormat("failed parsing EPG_CHANNEL_ID, epgId = {0}, epgChannelId: {1}", epg.EPG_ID, epg.EPG_CHANNEL_ID);
                                                status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                                                return status;
                                            }

                                            string sereisId = epgFieldMappings[Utils.SERIES_ID];
                                            int seasonNum = epgFieldMappings.ContainsKey(Utils.SEASON_NUMBER) ? int.Parse(epgFieldMappings[Utils.SEASON_NUMBER]) : 0;
                                            Recording recording = Utils.ValidateEpgForRecord(accountSettings, epg, true);
                                            // check if epg is in recording schedule window + in catch-up buffer and series if followed by at least 1 domain
                                            if (recording != null && recording.Status != null && recording.Status.Code == (int)eResponseStatus.OK
                                                && RecordingsDAL.IsSeriesFollowed(m_nGroupID, sereisId, seasonNum, channelId))
                                            {
                                                // record
                                                Recording serieRecording = RecordingsManager.Instance.Record(m_nGroupID, epg.EPG_ID, channelId, startDate, endDate, epg.CRID);
                                                if (serieRecording == null || serieRecording.Status == null || serieRecording.Status.Code != (int)eResponseStatus.OK || serieRecording.Id == 0)
                                                {
                                                    log.ErrorFormat("failed to record epg as series on IngestRecording, epgId = {0}", epg.EPG_ID);
                                                }
                                                else
                                                {
                                                    log.DebugFormat("successfully recorded epg as series on IngestRecording, epgId = {0}, recordingId = {1}", epg.EPG_ID, serieRecording.Id);
                                                    DateTime distributeTime = startDate.AddMinutes(1);
                                                    eRecordingTask task = eRecordingTask.DistributeRecording;
                                                    RecordingsManager.EnqueueMessage(m_nGroupID, serieRecording.EpgId, serieRecording.Id, serieRecording.EpgStartDate, distributeTime, task);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        log.ErrorFormat("Failed getting account padding, groupID: {0}", m_nGroupID);
                        status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                    }

                    // If we finished foreach and there is no status - everything is ok
                    if (status == null)
                    {
                        status = new ApiObjects.Response.Status((int)eResponseStatus.OK);
                    }
                }
            }

            return status;
        }

        public ApiObjects.Response.Status RecoverRecordingMessages(int groupID)
        {
            ApiObjects.Response.Status status = new ApiObjects.Response.Status();

            try
            {
                RecordingsManager.Instance.RecoverRecordings(groupID);
            }
            catch (Exception ex)
            {
                log.ErrorFormat("Failed recovering recording messages for group = {0}. ex = {1}", groupID, ex);
                status = new ApiObjects.Response.Status((int)eResponseStatus.Error, ex.Message);
            }

            return status;
        }

        public ApiObjects.Response.Status RemovePaymentMethodHouseholdPaymentGateway(int groupId, int paymentGatewayId, string siteGuid, long householdId, int paymentMethodId, bool force)
        {
            ApiObjects.Response.Status status = new ApiObjects.Response.Status();

            try
            {
                // 1. validate user and household
                //---------------------------------
                status = Utils.ValidateUserAndDomain(m_nGroupID, siteGuid, ref householdId);
                if (status.Code != (int)eResponseStatus.OK || householdId <= 0)
                {
                    return status;
                }

                if (!force)
                {
                    DataSet ds = DAL.ConditionalAccessDAL.Get_RecurringSubscriptiosAndPendingPurchasesByPaymentMethod(groupId, (int)householdId, paymentMethodId);
                    if (ds == null || ds.Tables == null || ds.Tables.Count < 3 || ds.Tables[0].Rows == null || ds.Tables[1].Rows == null || ds.Tables[2].Rows == null)
                    {
                        status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "Internal Error");
                        log.ErrorFormat("RemovePaymentMethodHouseholdPaymentGateway: Error getting recurring subscriptions from DB. groupID={0}, paymentGatewayId={1}, siteGuid= {2}, paymentMethodId {3}, ex: {4}", groupId, paymentGatewayId, siteGuid, paymentMethodId);
                        return status;
                    }

                    if (ds.Tables[0].Rows.Count > 0 || ds.Tables[1].Rows.Count > 0 || ds.Tables[2].Rows.Count > 0)
                    {
                        log.ErrorFormat("RemovePaymentMethodHouseholdPaymentGateway: Error removing payment method, method is used by household. groupID={0}, paymentGatewayId={1}, siteGuid= {2}, paymentMethodId {3}", groupId, paymentGatewayId, siteGuid, paymentMethodId);
                        status = new ApiObjects.Response.Status((int)eResponseStatus.PaymentMethodIsUsedByHousehold, "Payment Method Is Used By Household");
                        return status;
                    }
                }

                status = RemovePaymentMethodHouseholdInBilling(groupId, paymentGatewayId, siteGuid, householdId, paymentMethodId, force);

                if (status.Code != (int)eResponseStatus.OK)
                    log.ErrorFormat("RemovePaymentMethodHouseholdPaymentGateway: Error removing payment method. groupID={0}, paymentGatewayId={1}, siteGuid= {2}, paymentMethodId {3}, error: ({4}) {5}", groupId, paymentGatewayId, siteGuid, paymentMethodId, status.Code, status.Message);
                else
                    log.DebugFormat("RemovePaymentMethodHouseholdPaymentGateway: Removed payment method. groupID={0}, paymentGatewayId={1}, siteGuid= {2}, paymentMethodId {3}", groupId, paymentGatewayId, siteGuid, paymentMethodId);
            }
            catch (Exception ex)
            {
                status = new ApiObjects.Response.Status((int)eResponseStatus.Error, ex.Message);
                log.ErrorFormat("Failed groupID={0}, paymentGatewayId={1}, siteGuid= {2}, paymentMethodId {3}, ex: {4}", groupId, paymentGatewayId, siteGuid, paymentMethodId, ex);
            }
            return status;
        }

        private ApiObjects.Response.Status RemovePaymentMethodHouseholdInBilling(int groupId, int paymentGatewayId, string siteGuid, long householdId, int paymentMethodId, bool force)
        {
            ApiObjects.Response.Status status = new ApiObjects.Response.Status();

            string logString = string.Format("RemovePaymentMethodHouseholdInBilling billing service groupId={0}, paymentGatewayId={1}, siteGuid={2}, householdId={3}, paymentMethodId={4}",
                                       groupId, paymentGatewayId, siteGuid, householdId, paymentMethodId);
            log.Debug(logString);

            try
            {
                string userName = string.Empty;
                string password = string.Empty;
                module wsBillingService = null;
                InitializeBillingModule(ref wsBillingService, ref userName, ref password);

                // call new billing method for charge adapter
                var billingResponse = wsBillingService.RemovePaymentMethodHouseholdPaymentGateway(userName, password, paymentGatewayId, siteGuid, (int)householdId, paymentMethodId, force);
                if (billingResponse == null)
                    status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());

                status = new ApiObjects.Response.Status((int)billingResponse.Code, billingResponse.Message);
            }
            catch (Exception ex)
            {
                log.Error(logString, ex);
                status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }

            return status;
        }

        public ApiObjects.TimeShiftedTv.DomainQuotaResponse GetDomainQuota(string userID, long domainID)
        {
            ApiObjects.TimeShiftedTv.DomainQuotaResponse response = new DomainQuotaResponse();

            try
            {
                ApiObjects.Response.Status validationStatus = Utils.ValidateUserAndDomain(m_nGroupID, userID, ref domainID);

                if (validationStatus.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("User or Domain not valid, DomainID: {0}, UserID: {1}", domainID, userID);
                    response.Status = new ApiObjects.Response.Status(validationStatus.Code, validationStatus.Message);
                    return response;
                }

                TimeShiftedTvPartnerSettings accountSettings = Utils.GetTimeShiftedTvPartnerSettings(m_nGroupID);
                if (accountSettings == null || !accountSettings.IsCdvrEnabled.HasValue || !accountSettings.IsCdvrEnabled.Value)
                {
                    log.DebugFormat("account CDVR not enabled, DomainID: {0}, UserID: {1}", domainID, userID);
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.AccountCdvrNotEnabled, eResponseStatus.AccountCdvrNotEnabled.ToString());
                    return response;
                }

                if (!IsServiceAllowed((int)domainID, eService.NPVR))
                {
                    log.DebugFormat("Premium Service not allowed, DomainID: {0}, UserID: {1}, Service: {2}", domainID, userID, eService.NPVR.ToString());
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ServiceNotAllowed, eResponseStatus.ServiceNotAllowed.ToString());
                    return response;
                }

                response = QuotaManager.Instance.GetDomainQuotaResponse(this.m_nGroupID, domainID);
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK);
            }
            catch (Exception ex)
            {
                log.ErrorFormat("Error when getting domain quota: domain = {0}, user = {1}, ex = {2}",
                    domainID, userID, ex);
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error);
            }

            return response;
        }

        public Recording ProtectRecord(string userID, long domainRecordingID)
        {
            Recording recording = new Recording() { Id = domainRecordingID };
            try
            {
                Domain domain;
                long domainID = 0;
                ApiObjects.Response.Status validationStatus = Utils.ValidateUserAndDomain(m_nGroupID, userID, ref domainID, out domain);

                // Validate user and domain
                if (validationStatus.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("User or Domain not valid, DomainID: {0}, UserID: {1}", domainID, userID);
                    recording.Status = new ApiObjects.Response.Status(validationStatus.Code, validationStatus.Message);
                    return recording;
                }

                // Validate recording exists
                recording = Utils.ValidateRecordID(m_nGroupID, domainID, domainRecordingID);
                if (recording.Status.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("Recording is not valid for protection, recordID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", domainRecordingID, domainID, userID, recording != null ? recording.ToString() : string.Empty);
                    recording.Id = domainRecordingID;
                    return recording;
                }

                // Validate recording is in "Recorded" status
                if (recording.RecordingStatus != TstvRecordingStatus.Recorded)
                {
                    log.DebugFormat("RecordingStatus is not valid for protection, recordID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", domainRecordingID, domainID, userID, recording.ToString());
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.RecordingStatusNotValid, "Protection failed, only recording in status Recorded can be protected");
                    recording.Id = domainRecordingID;
                    return recording;
                }

                TimeShiftedTvPartnerSettings accountSettings = Utils.GetTimeShiftedTvPartnerSettings(m_nGroupID);

                // Check if protect is defined and enabled
                if (accountSettings == null || !accountSettings.IsProtectionEnabled.HasValue)
                {
                    log.ErrorFormat("Failed getting account protection quota percentage, DomainID: {0}, UserID: {1}, recordID: {2}", domainID, userID, domainRecordingID);
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                    recording.Id = domainRecordingID;
                    return recording;
                }
                else if (!accountSettings.IsProtectionEnabled.Value)
                {
                    log.DebugFormat("Protect is not enabled on the account, DomainID: {0}, UserID: {1}, recordID: {2}", domainID, userID, domainRecordingID);
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.AccountProtectRecordNotEnabled, eResponseStatus.AccountProtectRecordNotEnabled.ToString());
                    recording.Id = domainRecordingID;
                    return recording;
                }

                // Get domains quota
                int domainsQuotaInSeconds = QuotaManager.Instance.GetDomainAvailableQuota(this.m_nGroupID, domainID);

                // Get protection quota percentages                
                if (accountSettings == null || !accountSettings.ProtectionQuotaPercentage.HasValue)
                {
                    log.ErrorFormat("Failed getting account protection quota percentage, DomainID: {0}, UserID: {1}, recordID: {2}", domainID, userID, domainRecordingID);
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                    recording.Id = domainRecordingID;
                    return recording;
                }

                // Calculate total protection quota (round up according to spec)
                int availableProtectionSeconds = (int)Math.Ceiling((double)((domainsQuotaInSeconds * accountSettings.ProtectionQuotaPercentage.Value) / 100));
                // Get domain used protection minutes
                Dictionary<long, Recording> domainProtectedRecordings = Utils.GetDomainProtectedRecordings(m_nGroupID, domainID);
                // Check protection quota before applying protection on recording
                ApiObjects.Response.Status protectionQuotaStatus = QuotaManager.Instance.CheckQuotaByTotalSeconds(m_nGroupID, domainID, availableProtectionSeconds, false, new List<Recording>() { recording }, domainProtectedRecordings != null ? domainProtectedRecordings.Values.ToList() : new List<Recording>());
                if (protectionQuotaStatus == null || protectionQuotaStatus.Code != (int)eResponseStatus.OK || recording.Status == null || recording.Status.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("Domain Exceeded Protection Quota, DomainID: {0}, UserID: {1}, recordID: {2}", domainID, userID, domainRecordingID);
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.ExceededProtectionQuota, eResponseStatus.ExceededProtectionQuota.ToString());
                    recording.Id = domainRecordingID;
                    return recording;
                }

                // Check protection period is defined
                if (!accountSettings.ProtectionPeriod.HasValue)
                {
                    log.ErrorFormat("Failed getting account protection period, DomainID: {0}, UserID: {1}, recordID: {2}", domainID, userID, domainRecordingID);
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                    recording.Id = domainRecordingID;
                    return recording;
                }

                // update recording ID to domainRecordingId
                recording.Id = domainRecordingID;
                DateTime protectedUntilDate = DateTime.UtcNow.AddDays(accountSettings.ProtectionPeriod.Value);
                long protectedUntilEpoch = TVinciShared.DateUtils.DateTimeToUnixTimestamp(protectedUntilDate);
                // Try to Update protection details for domain recording and update recording status
                if (RecordingsDAL.ProtectRecording(recording.Id, protectedUntilDate, protectedUntilEpoch))
                {
                    recording.ProtectedUntilDate = protectedUntilEpoch;
                    if (!recording.ViewableUntilDate.HasValue || (recording.ViewableUntilDate.HasValue && recording.ViewableUntilDate.Value < protectedUntilEpoch))
                    {
                        recording.ViewableUntilDate = protectedUntilEpoch;
                    }
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                }
                else
                {
                    log.DebugFormat("Failed updating recording protection details on DB, DomainID: {0}, UserID: {1}, recordID: {2}", domainID, userID, domainRecordingID);
                    recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                }
            }
            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at ProtectRecord. ");
                sb.Append(String.Concat("userID: ", userID));
                sb.Append(String.Concat("recordID: ", domainRecordingID));
                sb.Append(String.Concat("Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error(sb.ToString(), ex);
                recording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                recording.Id = domainRecordingID;
            }

            return recording;
        }

        public bool CleanupRecordings()
        {
            double recordingCleanupIntervalSec = 0;
            bool shouldInsertToQueue = false;

            try
            {
                // try to get interval for next cleanup or take default
                BaseScheduledTaskLastRunDetails cleanupScheduledTask = new BaseScheduledTaskLastRunDetails(ScheduledTaskType.recordingsCleanup);
                ScheduledTaskLastRunDetails lastRunDetails = cleanupScheduledTask.GetLastRunDetails();
                cleanupScheduledTask = lastRunDetails != null ? (BaseScheduledTaskLastRunDetails)lastRunDetails : null;
                if (cleanupScheduledTask != null && cleanupScheduledTask.Status.Code == (int)eResponseStatus.OK && cleanupScheduledTask.NextRunIntervalInSeconds > 0)
                {
                    recordingCleanupIntervalSec = cleanupScheduledTask.NextRunIntervalInSeconds;
                    if (cleanupScheduledTask.LastRunDate.AddSeconds(recordingCleanupIntervalSec - MAX_SERVER_TIME_DIF) > DateTime.UtcNow)
                    {
                        return true;
                    }
                    else
                    {
                        shouldInsertToQueue = true;
                    }
                }
                else
                {
                    shouldInsertToQueue = true;
                    recordingCleanupIntervalSec = RECORDING_CLEANUP_INTERVAL_SEC;
                }

                // get current utc epoch
                long utcNowEpoch = TVinciShared.DateUtils.UnixTimeStampNow();
                // get first batch
                int totalRecordingsToCleanup = 0, totalRecordingsDeleted = 0;
                Dictionary<int, int> groupIdToAdapterIdMap = new Dictionary<int, int>();
                Dictionary<long, KeyValuePair<int, Recording>> recordingsForDeletion = RecordingsDAL.GetRecordingsForCleanup(utcNowEpoch);
                HashSet<long> recordingsThatFailedDeletion = new HashSet<long>();
                while (recordingsForDeletion != null && recordingsForDeletion.Count > 0)
                {
                    totalRecordingsToCleanup += recordingsForDeletion.Count;
                    List<long> deletedRecordingIds = new List<long>();
                    int adapterId = 0;
                    // set max amount of concurrent tasks
                    int maxDegreeOfParallelism = TVinciShared.WS_Utils.GetTcmIntValue("MaxDegreeOfParallelism");
                    if (maxDegreeOfParallelism == 0)
                    {
                        maxDegreeOfParallelism = 5;
                    }
                    ParallelOptions options = new ParallelOptions() { MaxDegreeOfParallelism = maxDegreeOfParallelism };
                    ContextData contextData = new ContextData();
                    Parallel.ForEach(recordingsForDeletion.Values.AsEnumerable(), options, (pair) =>
                    {
                        contextData.Load();
                        if (!groupIdToAdapterIdMap.ContainsKey(pair.Key))
                        {
                            adapterId = ConditionalAccessDAL.GetTimeShiftedTVAdapterId(pair.Key);
                            groupIdToAdapterIdMap.Add(pair.Key, adapterId);
                        }

                        ApiObjects.Response.Status deleteStatus = RecordingsManager.Instance.DeleteRecording(pair.Key, pair.Value, adapterId);
                        if (deleteStatus.Code != (int)eResponseStatus.OK)
                        {
                            if (!recordingsThatFailedDeletion.Contains(pair.Value.Id))
                            {
                                recordingsThatFailedDeletion.Add(pair.Value.Id);
                            }
                            log.ErrorFormat("Failed deleting recordingID: {0} for groupID {1}", pair.Value.Id, pair.Key);
                        }
                        else
                        {
                            deletedRecordingIds.Add(pair.Value.Id);
                            log.DebugFormat("recordingID {0} has been successfully cleaned up for groupID {1}", pair.Value.Id, pair.Key);
                        }
                    });

                    totalRecordingsDeleted += deletedRecordingIds.Count;

                    recordingsForDeletion = RecordingsDAL.GetRecordingsForCleanup(utcNowEpoch);
                    recordingsForDeletion = recordingsForDeletion.Where(x => !recordingsThatFailedDeletion.Contains(x.Key)).ToDictionary(x => x.Key, x => x.Value);
                }

                // update successful cleanup date
                if (totalRecordingsDeleted == totalRecordingsToCleanup)
                {
                    cleanupScheduledTask = new BaseScheduledTaskLastRunDetails(DateTime.UtcNow, totalRecordingsDeleted, recordingCleanupIntervalSec, ScheduledTaskType.recordingsCleanup);
                    if (!cleanupScheduledTask.SetLastRunDetails())
                    {
                        log.InfoFormat("Failed updating recordings cleanup last run details, RecordingsScheduledTask: {0}", cleanupScheduledTask.ToString());
                    }
                    else
                    {
                        log.Debug("Successfully updated recordings cleanup date");
                    }

                    if (totalRecordingsDeleted > 0)
                    {
                        log.DebugFormat("Successfully cleaned up {0} recordings and updated {1} rows on domain recordings", totalRecordingsDeleted);
                    }
                    else
                    {
                        log.DebugFormat("Did not find any recordings to cleanup");
                    }
                }
                else
                {
                    log.Info("Failed recordings cleanup");
                }
            }
            catch (Exception ex)
            {
                log.ErrorFormat("Error in CleanupRecordings: ex = {0}, ST = {1}", ex.Message, ex.StackTrace);
                shouldInsertToQueue = true;
            }
            finally
            {
                if (shouldInsertToQueue)
                {
                    if (recordingCleanupIntervalSec == 0)
                    {
                        recordingCleanupIntervalSec = RECORDING_CLEANUP_INTERVAL_SEC;
                    }

                    DateTime nextExecutionDate = DateTime.UtcNow.AddSeconds(recordingCleanupIntervalSec);
                    SetupTasksQueue queue = new SetupTasksQueue();
                    CelerySetupTaskData data = new CelerySetupTaskData(0, eSetupTask.RecordingsCleanup, new Dictionary<string, object>()) { ETA = nextExecutionDate };
                    queue.Enqueue(data, ROUTING_KEY_RECORDINGS_CLEANUP);
                }
            }

            return true;
        }

        public bool HandleRecordingsLifetime()
        {
            double scheduledTaskIntervalSec = 0;
            bool shouldInsertToQueue = false;

            try
            {
                // try to get interval for next run take default
                BaseScheduledTaskLastRunDetails recordingsLifetimeScheduledTask = new BaseScheduledTaskLastRunDetails(ScheduledTaskType.recordingsLifetime);
                ScheduledTaskLastRunDetails lastRunDetails = recordingsLifetimeScheduledTask.GetLastRunDetails();
                recordingsLifetimeScheduledTask = lastRunDetails != null ? (BaseScheduledTaskLastRunDetails)lastRunDetails : null;
                if (recordingsLifetimeScheduledTask != null && recordingsLifetimeScheduledTask.Status.Code == (int)eResponseStatus.OK && recordingsLifetimeScheduledTask.NextRunIntervalInSeconds > 0)
                {
                    scheduledTaskIntervalSec = recordingsLifetimeScheduledTask.NextRunIntervalInSeconds;
                    if (recordingsLifetimeScheduledTask.LastRunDate.AddSeconds(scheduledTaskIntervalSec - MAX_SERVER_TIME_DIF) > DateTime.UtcNow)
                    {
                        return true;
                    }
                    else
                    {
                        shouldInsertToQueue = true;
                    }
                }
                else
                {
                    shouldInsertToQueue = true;
                    scheduledTaskIntervalSec = HANDLE_RECORDINGS_LIFETIME_INTERVAL_SEC;
                }

                // get current utc epoch
                long utcNowEpoch = TVinciShared.DateUtils.UnixTimeStampNow();
                // get first batch
                int totalRecordingsExpired = RecordingsDAL.InsertExpiredRecordingsTasks(utcNowEpoch);

                // update successful run date
                if (totalRecordingsExpired > -1)
                {
                    recordingsLifetimeScheduledTask = new BaseScheduledTaskLastRunDetails(DateTime.UtcNow, totalRecordingsExpired, scheduledTaskIntervalSec, ScheduledTaskType.recordingsLifetime);
                    if (!recordingsLifetimeScheduledTask.SetLastRunDetails())
                    {
                        log.ErrorFormat("Failed updating expired recordings last run details, RecordingsScheduledTask: {0}", recordingsLifetimeScheduledTask.ToString());
                    }
                    else
                    {
                        log.Debug("Successfully updated expired recordings run details");
                    }
                }
                else
                {
                    log.Error("Failed inserting expired recordings tasks");
                }
            }
            catch (Exception ex)
            {
                log.ErrorFormat("Error in HandleExpiredRecordings: ex = {0}, ST = {1}", ex.Message, ex.StackTrace);
                shouldInsertToQueue = true;
            }
            finally
            {
                if (shouldInsertToQueue)
                {
                    if (scheduledTaskIntervalSec == 0)
                    {
                        scheduledTaskIntervalSec = HANDLE_RECORDINGS_LIFETIME_INTERVAL_SEC;
                    }

                    DateTime nextExecutionDate = DateTime.UtcNow.AddSeconds(scheduledTaskIntervalSec);
                    SetupTasksQueue queue = new SetupTasksQueue();
                    CelerySetupTaskData data = new CelerySetupTaskData(0, eSetupTask.InsertExpiredRecordingsTasks, new Dictionary<string, object>()) { ETA = nextExecutionDate };
                    queue.Enqueue(data, RECORDINGS_LIFETIME_ROUTING_KEY);
                }
            }

            return true;
        }

        public bool CompleteDomainSeriesRecordings(long domainId)
        {
            bool response = true;
            try
            {
                // check if recording is enabled only in advanced - in this case nothing to do
                var tstvSettings = Utils.GetTimeShiftedTvPartnerSettings(m_nGroupID);
                if (tstvSettings.IsRecordingScheduleWindowEnabled.HasValue && tstvSettings.IsRecordingScheduleWindowEnabled.Value && tstvSettings.RecordingScheduleWindow <= 0)
                {
                    log.DebugFormat("recording is enabled only in advanced, cannot complete series recordings for domainId = {0}", domainId);
                    return response;
                }

                // get household quota - if no quota - nothing to do
                int availibleQuota = QuotaManager.Instance.GetDomainAvailableQuota(m_nGroupID, domainId);

                // min quota threshold for skipping this process                
                if (availibleQuota <= 60)
                {
                    log.DebugFormat("Not enough quota to complete series recordings for domainId = {0}", domainId);
                    return response;
                }

                List<DomainSeriesRecording> series = null;
                DataSet serieDs = null;
                // get household followed series / seasons - if not following anything - nothing to do
                serieDs = RecordingsDAL.GetDomainSeriesRecordings(m_nGroupID, domainId);

                series = Utils.GetDomainSeriesRecordingFromDataSet(serieDs);

                if (series == null || series.Count == 0)
                {
                    log.DebugFormat("no series to complete for domainId = {0}", domainId);
                    return response;
                }
                else
                {
                    bool shouldCallAgain = false;
                    foreach (DomainSeriesRecording currentDomainSeries in series)
                    {
                        shouldCallAgain = RecordingsDAL.IsFirstFollowerLockExists(m_nGroupID, currentDomainSeries.SeriesId, currentDomainSeries.SeasonNumber, currentDomainSeries.EpgChannelId.ToString());
                        // if first one of the series is locked we stop and call complete again in 1 min
                        if (shouldCallAgain)
                        {
                            break;
                        }
                    }

                    if (shouldCallAgain)
                    {
                        QueueWrapper.GenericCeleryQueue queue = new QueueWrapper.GenericCeleryQueue();
                        ApiObjects.QueueObjects.SeriesRecordingTaskData data = new ApiObjects.QueueObjects.SeriesRecordingTaskData(m_nGroupID, string.Empty, domainId, string.Empty, string.Empty, 0,
                                                                                                                     eSeriesRecordingTask.CompleteRecordings) { ETA = DateTime.UtcNow.AddMinutes(1) };
                        queue.Enqueue(data, string.Format(ROUTING_KEY_SERIES_RECORDING_TASK, m_nGroupID));
                        return response;
                    }
                }

                // get CRIDs of all household recordings that were recorded as part of the series - all statuses but 'Failed'/ SeriesCancel/SeriesDelete
                HashSet<string> excludedCrids = RecordingsDAL.GetDomainRecordingsCridsByDomainsSeriesIds(m_nGroupID, domainId, series.Select(s => s.Id).Distinct().ToList());

                // get all the relevant (series + seasons + CRID not in the list of household recordings) existing recordings from ES
                List<ConditionalAccess.WS_Catalog.ExtendedSearchResult> relevantRecordingsForRecord = null;

                relevantRecordingsForRecord = Utils.SearchSeriesRecordings(m_nGroupID, excludedCrids.ToList(), series, SearchSeriesRecordingsTimeOptions.past);

                if (relevantRecordingsForRecord == null)
                {
                    log.ErrorFormat("failed to search relevant recordings of series for domainId = {0}", domainId);
                    return false;
                }

                // if there are no available recordings to complete - nothing to do
                if (relevantRecordingsForRecord.Count == 0)
                {
                    log.DebugFormat("no relevant recordings of series were found for domainId = {0}", domainId);
                    return response;
                }

                // calculate the total padding length
                long padding = (tstvSettings.PaddingBeforeProgramStarts.HasValue ? tstvSettings.PaddingBeforeProgramStarts.Value : 0) +
                    (tstvSettings.PaddingAfterProgramEnds.HasValue ? tstvSettings.PaddingAfterProgramEnds.Value : 0);

                long programLengthSeconds = 0;
                string userId = string.Empty;
                long epgId = 0;
                string crid = string.Empty;
                long epgChannelId = 0;

                Dictionary<long, List<string>> recordedCridsPerChannel = new Dictionary<long, List<string>>();

                // calculate which recording should be recorded for the household based on quota 
                foreach (var potentialRecording in relevantRecordingsForRecord)
                {
                    // calculate program length wit padding
                    programLengthSeconds = (long)(potentialRecording.EndDate - potentialRecording.StartDate).TotalSeconds + padding;

                    if (programLengthSeconds < availibleQuota)
                    {
                        crid = Utils.GetStringParamFromExtendedSearchResult(potentialRecording, "crid");
                        epgChannelId = Utils.GetLongParamFromExtendedSearchResult(potentialRecording, "epg_channel_id");

                        // check if a program with the same CRID was already recorded
                        if (recordedCridsPerChannel.ContainsKey(epgChannelId) && recordedCridsPerChannel[epgChannelId].Contains(crid))
                        {
                            log.DebugFormat("found relevant program to record but a program with the same CRID already recorded for the channel. household  = {0}, crid = {1}, recordingId = {2}",
                                domainId, crid, potentialRecording.AssetId);
                            return response;
                        }

                        RecordingType recordingType;
                        long domainSeriesRecordingId;
                        userId = Utils.GetFollowingUserIdForSerie(m_nGroupID, series, potentialRecording, out recordingType, out domainSeriesRecordingId);
                        epgId = Utils.GetLongParamFromExtendedSearchResult(potentialRecording, "epg_id");

                        if (epgId > 0 && !string.IsNullOrEmpty(userId) && domainSeriesRecordingId > 0)
                        {
                            var recording = Record(userId, epgId, recordingType, domainSeriesRecordingId);

                            if (recording != null && recording.Status != null && recording.Status.Code == (int)eResponseStatus.OK && recording.Id > 0)
                            {
                                log.DebugFormat("successfully recorded episode for domainId = {0}, epgId = {1}, new recordingId = {2}", domainId, epgId, recording.Id);

                                availibleQuota = QuotaManager.Instance.GetDomainAvailableQuota(m_nGroupID, domainId);

                                if (!recordedCridsPerChannel.ContainsKey(epgChannelId))
                                {
                                    recordedCridsPerChannel.Add(epgChannelId, new List<string>());
                                }

                                recordedCridsPerChannel[epgChannelId].Add(recording.Crid);
                            }
                            else
                            {
                                log.ErrorFormat("failed to record episode for household = {0}, epgId = {1}", domainId, epgId);
                            }
                        }
                        else
                        {
                            log.ErrorFormat("received extended search result without 'epg_id' for recording = {0}, for domainId = {1}", potentialRecording.AssetId, domainId);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                log.Error(string.Format("Error in 'CompleteHouseholdSeriesRecordings' for domainId = {0}", domainId), ex);
            }

            return response;
        }

        public bool HandleRecordingsScheduledTasks()
        {
            double scheduledTaskIntervalSec = 0;
            bool shouldInsertToQueue = false;

            try
            {
                // try to get interval for next run take default
                BaseScheduledTaskLastRunDetails recordingsScheduledTask = new BaseScheduledTaskLastRunDetails(ScheduledTaskType.recordingsScheduledTasks);
                ScheduledTaskLastRunDetails lastRunDetails = recordingsScheduledTask.GetLastRunDetails();
                recordingsScheduledTask = lastRunDetails != null ? (BaseScheduledTaskLastRunDetails)lastRunDetails : null;
                if (recordingsScheduledTask != null && recordingsScheduledTask.Status.Code == (int)eResponseStatus.OK && recordingsScheduledTask.NextRunIntervalInSeconds > 0)
                {
                    scheduledTaskIntervalSec = recordingsScheduledTask.NextRunIntervalInSeconds;
                    if (recordingsScheduledTask.LastRunDate.AddSeconds(scheduledTaskIntervalSec - MAX_SERVER_TIME_DIF) > DateTime.UtcNow)
                    {
                        return true;
                    }
                    else
                    {
                        shouldInsertToQueue = true;
                    }
                }
                else
                {
                    shouldInsertToQueue = true;
                    scheduledTaskIntervalSec = HANDLE_RECORDINGS_SCHEDULED_TASKS_INTERVAL_SEC;
                }

                // get current utc epoch
                long utcNowEpoch = TVinciShared.DateUtils.UnixTimeStampNow();
                // get first batch
                Dictionary<long, HandleDomainQuataByRecordingTask> expiredRecordingsToSchedule = Utils.UpdateAndGetExpiredRecordingsTasks(utcNowEpoch);
                // update successful run date
                List<HandleDomainQuataByRecordingTask> alreadyDeletedOrCanceledRecordings = new List<HandleDomainQuataByRecordingTask>();
                if (expiredRecordingsToSchedule != null)
                {
                    foreach (HandleDomainQuataByRecordingTask expiredRecording in expiredRecordingsToSchedule.Values)
                    {
                        GenericCeleryQueue queue = new GenericCeleryQueue();
                        RecordingModificationData data = new RecordingModificationData(expiredRecording.GroupId, expiredRecording.Id, expiredRecording.RecordingId, expiredRecording.ScheduledExpirationEpoch) { ETA = DateTime.UtcNow };
                        bool queueExpiredRecordingResult = queue.Enqueue(data, string.Format(ROUTING_KEY_MODIFIED_RECORDING, expiredRecording.GroupId));
                        if (!queueExpiredRecordingResult)
                        {
                            log.ErrorFormat("Failed to queue ExpiredRecordingScheduledTask: {0}", expiredRecording.ToString());
                        }
                    }

                    recordingsScheduledTask = new BaseScheduledTaskLastRunDetails(DateTime.UtcNow, expiredRecordingsToSchedule.Count, scheduledTaskIntervalSec, ScheduledTaskType.recordingsScheduledTasks);
                    if (!recordingsScheduledTask.SetLastRunDetails())
                    {
                        log.ErrorFormat("Failed updating recording scheduled tasks last run details, RecordingsScheduledTask: {0}", recordingsScheduledTask.ToString());
                    }
                    else
                    {
                        log.Debug("Successfully updated recording scheduled task run details");
                    }
                }
                else
                {
                    log.Error("Failed GetExpiredRecordingsTasks");
                }
            }
            catch (Exception ex)
            {
                log.ErrorFormat("Error in HandleRecordingScheduledTasks: ex = {0}, ST = {1}", ex.Message, ex.StackTrace);
                shouldInsertToQueue = true;
            }
            finally
            {
                if (shouldInsertToQueue)
                {
                    if (scheduledTaskIntervalSec == 0)
                    {
                        scheduledTaskIntervalSec = HANDLE_RECORDINGS_SCHEDULED_TASKS_INTERVAL_SEC;
                    }

                    DateTime nextExecutionDate = DateTime.UtcNow.AddSeconds(scheduledTaskIntervalSec);
                    SetupTasksQueue queue = new SetupTasksQueue();
                    CelerySetupTaskData data = new CelerySetupTaskData(0, eSetupTask.RecordingScheduledTasks, new Dictionary<string, object>()) { ETA = nextExecutionDate };
                    queue.Enqueue(data, RECORDING_TASKS_ROUTING_KEY);
                }
            }

            return true;
        }

        /// <summary>
        /// This method handles Expired/Failed/Canceled/Deleted recordings
        /// </summary>
        public bool HandleDomainQuotaByRecording(HandleDomainQuataByRecordingTask task)
        {
            bool result = false;
            try
            {
                Recording recording = Utils.GetRecordingById(task.RecordingId, false);
                bool shouldGetDomainRecordings = true;
                if (recording == null)
                {
                    log.DebugFormat("Failed fetching recording with ID: {0} on HandleDomainQuotaByRecording", task.RecordingId);
                    return true;
                }
                // check if expired recording is still valid
                if (task.Id > 0 && recording.RecordingStatus != TstvRecordingStatus.Recorded)
                {
                    log.DebugFormat("Recording has already been deleted/canceled/failed, taskId: {0}, recordingId:{1}", task.Id, task.RecordingId);
                    shouldGetDomainRecordings = false;
                    result = true;
                }

                // check to what status we need to update the domain recordings
                DomainRecordingStatus? domainRecordingStatus = Utils.ConvertToDomainRecordingStatus(recording.RecordingStatus);
                if (!domainRecordingStatus.HasValue)
                {
                    log.DebugFormat("Failed ConvertToDomainRecordingStatus for recordingId: {0}, recordingStatus: {1}", recording.Id, recording.RecordingStatus.ToString());
                    shouldGetDomainRecordings = false;
                }

                if (shouldGetDomainRecordings)
                {
                    int status = 1;
                    // Currently canceled can be only due to IngestRecording which Deletes EPG
                    if (domainRecordingStatus.Value != DomainRecordingStatus.OK)
                    {
                        status = 2;
                        domainRecordingStatus = DomainRecordingStatus.DeletedBySystem;
                    }

                    int recordingDuration = (int)(recording.EpgEndDate - recording.EpgStartDate).TotalSeconds;
                    long maxDomainRecordingId = 0;
                    DataTable modifiedDomainRecordings = RecordingsDAL.UpdateAndGetDomainsRecordingsByRecordingIdAndProtectDate(task.RecordingId, task.ScheduledExpirationEpoch, status, domainRecordingStatus.Value, maxDomainRecordingId);

                    // set max amount of concurrent tasks
                    int maxDegreeOfParallelism = TVinciShared.WS_Utils.GetTcmIntValue("MaxDegreeOfParallelism");
                    if (maxDegreeOfParallelism == 0)
                    {
                        maxDegreeOfParallelism = 5;
                    }

                    ParallelOptions options = new ParallelOptions() { MaxDegreeOfParallelism = maxDegreeOfParallelism };
                    while (modifiedDomainRecordings != null && modifiedDomainRecordings.Rows != null && modifiedDomainRecordings.Rows.Count > 0)
                    {
                        ContextData contextData = new ContextData();
                        Parallel.For(0, modifiedDomainRecordings.Rows.Count, options, i =>
                        {
                            contextData.Load();
                            DataRow dr = modifiedDomainRecordings.Rows[i];
                            if (dr != null)
                            {
                                long domainId = ODBCWrapper.Utils.GetLongSafeVal(dr, "DOMAIN_ID", 0);
                                bool quotaSuccessfullyUpdated = false;

                                // if old recording duration was sent use the difference, otherwise use the recording length  
                                int recordingDurationDif = task.OldRecordingDuration != 0 ? task.OldRecordingDuration - recordingDuration : recordingDuration;
                                if (recordingDurationDif > 0)
                                {
                                    quotaSuccessfullyUpdated = QuotaManager.Instance.IncreaseDomainUsedQuota(task.GroupId, domainId, recordingDurationDif, true);
                                }
                                else if (recordingDurationDif < 0)
                                {

                                    quotaSuccessfullyUpdated = QuotaManager.Instance.DecreaseDomainUsedQuota(m_nGroupID, domainId, -recordingDurationDif);
                                }

                                if (quotaSuccessfullyUpdated)
                                {
                                    if (!CompleteDomainSeriesRecordings(domainId))
                                    {
                                        log.ErrorFormat("Failed CompleteHouseholdSeriesRecordings after modifiedRecordingId: {0}, for domainId: {1}", task.RecordingId, domainId);
                                    }
                                }
                                else
                                {
                                    log.ErrorFormat("Failed Updating domain {0} available quota", domainId);
                                }
                            }
                            else
                            {
                                log.ErrorFormat("Data row is null for modifiedRecordingId[{0}]", i);
                            }
                        });

                        maxDomainRecordingId = ODBCWrapper.Utils.GetLongSafeVal(modifiedDomainRecordings.Rows[modifiedDomainRecordings.Rows.Count - 1], "ID");
                        modifiedDomainRecordings = RecordingsDAL.UpdateAndGetDomainsRecordingsByRecordingIdAndProtectDate(task.RecordingId, task.ScheduledExpirationEpoch, status, domainRecordingStatus.Value, maxDomainRecordingId);
                    }

                    long minProtectionEpoch = RecordingsDAL.GetRecordingMinProtectedEpoch(task.RecordingId, task.ScheduledExpirationEpoch);
                    // add recording schedule task for next min protected date
                    if (minProtectionEpoch > 0)
                    {
                        if (!RecordingsDAL.InsertExpiredRecordingNextTask(task.RecordingId, task.GroupId, minProtectionEpoch, TVinciShared.DateUtils.UnixTimeStampToDateTime(minProtectionEpoch)))
                        {
                            log.ErrorFormat("failed InsertExpiredRecordingNextTask for recordingId: {0}, minProtectionDate {1}", task.RecordingId, minProtectionEpoch);
                        }
                    }
                    else
                    {
                        log.DebugFormat("recordingId: {0} has no domain recording that protect it", task.RecordingId);
                    }

                }

                // incase expiredRecording.Id = 0 it means we are handling a FAILED recording and no need to update the table recording_scheduled_tasks 
                if (task.Id > 0 && !RecordingsDAL.UpdateExpiredRecordingAfterScheduledTask(task.Id))
                {
                    log.ErrorFormat("failed UpdateExpiredRecordingScheduledTask for expiredRecording: {0}", task.ToString());
                }

                result = true;
            }
            catch (Exception ex)
            {
                log.ErrorFormat("Error in HandleDomainQuotaByRecording, expiredRecording: {0}, ex = {1}, ST = {2}", task.ToString(), ex.Message, ex.StackTrace);

            }

            return result;
        }

        public bool HandleFirstFollowerRecording(string userId, long domainId, string channelId, string seriesId, int seasonNumber)
        {
            bool result = false;
            try
            {
                TimeShiftedTvPartnerSettings accountSettings = Utils.GetTimeShiftedTvPartnerSettings(m_nGroupID);
                DateTime? windowStartDate = null;
                if (accountSettings.IsRecordingScheduleWindowEnabled.HasValue && accountSettings.IsRecordingScheduleWindowEnabled.Value && accountSettings.RecordingScheduleWindow.HasValue)
                {
                    windowStartDate = DateTime.UtcNow.AddMinutes(-accountSettings.RecordingScheduleWindow.Value);
                }

                List<ConditionalAccess.WS_Catalog.ExtendedSearchResult> epgsToRecord = Utils.GetFirstFollowerEpgIdsToRecord(m_nGroupID, channelId, seriesId, seasonNumber, windowStartDate);
                if (epgsToRecord == null)
                {
                    log.ErrorFormat("Failed GetFirstFollowerEpgIdsToRecord, seriesId: {0}, seassonNumber: {1}", seriesId, seasonNumber);
                    return result;
                }

                long paddingBeforeProgramStarts = 0;
                if (accountSettings.PaddingBeforeProgramStarts.HasValue)
                {
                    paddingBeforeProgramStarts = accountSettings.PaddingBeforeProgramStarts.Value;
                }

                long paddingAfterProgramEnds = 0;
                if (accountSettings.PaddingAfterProgramEnds.HasValue)
                {
                    paddingAfterProgramEnds = accountSettings.PaddingAfterProgramEnds.Value;
                }

                long epgId = 0;
                string crid = string.Empty;
                List<long> epgsInThePastToRecord = new List<long>();
                long epgChannelId = 0;
                if (!long.TryParse(channelId, out epgChannelId))
                {
                    return result;
                }
                long domainSeriesRecordingId = RecordingsDAL.GetDomainSeriesId(m_nGroupID, domainId, seriesId, seasonNumber, epgChannelId);
                HashSet<string> userRecordingCrids = RecordingsDAL.GetDomainRecordingsCridsByDomainsSeriesIds(m_nGroupID, domainId, new List<long>() { domainSeriesRecordingId });
                foreach (ConditionalAccess.WS_Catalog.ExtendedSearchResult epg in epgsToRecord)
                {
                    if (!long.TryParse(epg.AssetId, out epgId))
                    {
                        log.ErrorFormat("failed parsing assetId on HandleFirstFollowerRecording, domainId: {0}, channelId: {1}, seriesId: {2}, seassonNumber: {3}", domainId, channelId, seriesId, seasonNumber);
                        continue;
                    }
                    if (!long.TryParse(Utils.GetStringParamFromExtendedSearchResult(epg, "epg_channel_id"), out epgChannelId))
                    {
                        log.ErrorFormat("failed parsing epgChannelId on HandleFirstFollowerRecording, domainId: {0}, channelId: {1}, seriesId: {2}, seassonNumber: {3}", domainId, channelId, seriesId, seasonNumber);
                        continue;
                    }
                    crid = Utils.GetStringParamFromExtendedSearchResult(epg, "crid");

                    DateTime epgPaddedStartDate = epg.StartDate.AddSeconds(-1 * paddingBeforeProgramStarts);
                    DateTime epgPaddedEndDate = epg.EndDate.AddSeconds(paddingAfterProgramEnds);
                    Recording globalRecording = RecordingsManager.Instance.Record(m_nGroupID, epgId, epgChannelId, epgPaddedStartDate, epgPaddedEndDate, crid);
                    if (globalRecording == null || globalRecording.Status == null || globalRecording.Status.Code != (int)eResponseStatus.OK)
                    {
                        log.ErrorFormat("RecordingsManager.Instance.Record failed for epgId: {0}, epgChannelId: {1}, epgPaddedStartDate: {2}, epgPaddedEndDate: {3}, crid: {4}", epgId, epgChannelId, epgPaddedStartDate, epgPaddedEndDate, crid);
                        continue;
                    }

                    if (globalRecording.EpgStartDate > DateTime.UtcNow)
                    {
                        // add message which will add the recording to all the following domains
                        DateTime distributeTime = epgPaddedStartDate.AddMinutes(1);
                        eRecordingTask task = eRecordingTask.DistributeRecording;
                        RecordingsManager.EnqueueMessage(m_nGroupID, globalRecording.EpgId, globalRecording.Id, epgPaddedStartDate, distributeTime, task);
                    }
                    else if (!userRecordingCrids.Contains(globalRecording.Crid))
                    {
                        Recording userRecording = Record(userId, globalRecording.EpgId, seasonNumber == 0 ? RecordingType.Series : RecordingType.Season, domainSeriesRecordingId);
                        userRecordingCrids.Add(globalRecording.Crid);
                        if (userRecording != null && userRecording.Status != null && userRecording.Status.Code == (int)eResponseStatus.OK && userRecording.Id > 0)
                        {
                            log.DebugFormat("successfully recorded epgId = {0}, domainId = {1}, new recordingId = {2}", epgId, domainId, userRecording.Id);
                        }
                    }
                }

                if (epgsToRecord.Count > 0)
                {
                    if (!RecordingsDAL.InsertFirstFollowerLock(m_nGroupID, seriesId, seasonNumber, channelId, false))
                    {
                        log.ErrorFormat("Failed InsertFirstFollowerLock, groupId: {0}, seriesId: {1}, seasonNumber: {2}, channelId: {3}", m_nGroupID, seriesId, seasonNumber, channelId);
                    }
                }
                else if (!RecordingsDAL.DeleteFirstFollowerLock(m_nGroupID, seriesId, seasonNumber, channelId))
                {
                    log.ErrorFormat("Failed DeleteFirstFollowerLock, groupId: {0}, seriesId: {1}, seasonNumber: {2}, channelId: {3}", m_nGroupID, seriesId, seasonNumber, channelId);
                }

                result = true;
            }

            catch (Exception ex)
            {
                log.Error(string.Format("Error on HandleFirstFollowerRecording {0} ", seriesId), ex);
            }

            return result;

        }

        public SeriesRecording CancelOrDeleteSeriesRecord(string userId, long domainId, long domainSeriesRecordingId, long epgId, long seasonNumber, TstvRecordingStatus tstvRecordingStatus)
        {
            SeriesRecording seriesRecording = new SeriesRecording();
            try
            {
                if (epgId > 0 && seasonNumber > 0)
                {
                    log.ErrorFormat("can't get epgid and season number, DomainID: {0}, UserID: {1}, domainSeriesRecordingId: {2}", domainId, userId, domainSeriesRecordingId);
                    seriesRecording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                    return seriesRecording;
                }
                Domain domain;
                ApiObjects.Response.Status validationStatus = Utils.ValidateUserAndDomain(m_nGroupID, userId, ref domainId, out domain);

                if (validationStatus.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("User or Domain not valid, DomainID: {0}, UserID: {1}", domainId, userId);
                    seriesRecording.Status = new ApiObjects.Response.Status(validationStatus.Code, validationStatus.Message);
                    return seriesRecording;
                }
                // user is OK - see if user sign to recordID
                seriesRecording = Utils.ValidateSeriesRecordID(m_nGroupID, domainId, domainSeriesRecordingId);
                if (seriesRecording.Status.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("series recording status not valid, recordID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", domainSeriesRecordingId, domainId, userId, seriesRecording != null ? seriesRecording.ToString() : string.Empty);
                    return seriesRecording;
                }
                if (epgId > 0) // cancel / delete specific epg that recorder as part of series
                {
                    CancelOrDeleteEpg(userId, domainId, seriesRecording, tstvRecordingStatus, epgId, domainSeriesRecordingId);
                    seriesRecording.Id = domainSeriesRecordingId;
                }
                else // cancel / delete all epgs related to series or to season number
                {
                    if (seriesRecording.SeasonNumber == 0 || seasonNumber == 0 || (seriesRecording.SeasonNumber == seasonNumber))
                    {
                        CancelOrDeleteSeries(userId, domainId, seriesRecording, tstvRecordingStatus, domainSeriesRecordingId, seasonNumber);
                        seriesRecording.Id = domainSeriesRecordingId;
                    }
                    else
                    {
                        log.ErrorFormat("SeasonNumber that was sent diffrent from each other , DomainID: {0}, UserID: {1}, seriesRecording.SeasonNumber = {2}, seasonNumber = {3}", domainId, userId, seriesRecording.SeasonNumber, seasonNumber);
                        seriesRecording.Status = new ApiObjects.Response.Status((int)eResponseStatus.SeasonNumberNotMatch, eResponseStatus.SeasonNumberNotMatch.ToString());
                        return seriesRecording;
                    }

                }
            }
            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at CancelOrDeleteSeriesRecord. ");
                sb.Append(String.Concat("userID: ", userId));
                sb.Append(String.Concat(", recordID: ", domainSeriesRecordingId));
                sb.Append(String.Concat(", Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error(sb.ToString(), ex);
            }
            return seriesRecording;
        }

        private void CancelOrDeleteSeries(string userId, long domainId, SeriesRecording seriesRecording, TstvRecordingStatus tstvRecordingStatus, long domainSeriesRecordingId, long seasonNumber)
        {
            Dictionary<long, Recording> domainRecordings = Utils.GetDomainRecordingsByDomainSeriesId(m_nGroupID, domainId, domainSeriesRecordingId);

            // if the domain has recordings of the series
            if (domainRecordings != null && domainRecordings.Count > 0)
            {
                List<string> epgIds = domainRecordings.Select(x => x.Value.EpgId.ToString()).ToList();
                TvinciEpgBL epgBLTvinci = new TvinciEpgBL(m_nGroupID);
                List<EpgCB> epgs = epgBLTvinci.GetEpgs(epgIds);
                if (epgs != null && epgs.Count > 0)
                {
                    // check if epg related to series and season
                    List<EpgCB> epgMatch = Utils.GetEpgRelatedToSeriesRecording(m_nGroupID, seriesRecording, epgs, seasonNumber);
                    if (epgMatch != null && epgMatch.Count > 0)
                    {
                        // convert status Cancel/Delete ==> SeriesCancel/SeriesDelete
                        TstvRecordingStatus? seriesStatus = Utils.ConvertToSeriesStatus(tstvRecordingStatus);
                        if (!seriesStatus.HasValue)
                        {
                            log.ErrorFormat("fail to perform cancel or delete domainSeriesRecordingId = {1}, tstvRecordingStatus = {2}", domainSeriesRecordingId, tstvRecordingStatus.ToString());
                            return;
                        }

                        List<TstvRecordingStatus> validRecordingStatuses = new List<TstvRecordingStatus>() { TstvRecordingStatus.Recording, TstvRecordingStatus.Scheduled, TstvRecordingStatus.Recorded };

                        // set max amount of concurrent tasks
                        int maxDegreeOfParallelism = TVinciShared.WS_Utils.GetTcmIntValue("MaxDegreeOfParallelism");
                        if (maxDegreeOfParallelism == 0)
                        {
                            maxDegreeOfParallelism = 5;
                        }
                        ParallelOptions options = new ParallelOptions() { MaxDegreeOfParallelism = maxDegreeOfParallelism };
                        ContextData contextData = new ContextData();
                        Parallel.ForEach(epgMatch, options, (currentEpg) =>
                        {
                            contextData.Load();
                            KeyValuePair<long, Recording> pair = domainRecordings.Where(x => x.Value.EpgId == (long)currentEpg.EpgID).FirstOrDefault();
                            //call cancelOrDelete if the recordings status is valid (Cancel possible only for recording/scheduled)
                            if (pair.Value != null && pair.Value.Status.Code == (int)eResponseStatus.OK && validRecordingStatuses.Contains(pair.Value.RecordingStatus))
                            {
                                CancelOrDeleteRecord(userId, domainId, pair.Key, seriesStatus.Value, false);
                            }
                        });
                    }
                }
            }

            // mark the row in status = 2
            if (seasonNumber > 0) // need to insert new "record" series+ season to domain series recordings
            {
                if (RecordingsDAL.InsertOrUpdateDomainSeriesExclude(m_nGroupID, domainId, userId, domainSeriesRecordingId, seasonNumber))
                {
                    seriesRecording.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                    log.DebugFormat("Series recording {0} has been updated to status {1}", seriesRecording.Id, tstvRecordingStatus.ToString());
                }
                else
                {
                    seriesRecording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "fail to perform cancel or delete");
                    log.ErrorFormat("Series recording {0} has been updated for season {1} to status {2}", seriesRecording.Id, seasonNumber, tstvRecordingStatus.ToString());
                }
            }
            else if (RecordingsDAL.CancelSeriesRecording(domainSeriesRecordingId))
            {
                seriesRecording.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                log.DebugFormat("Series recording {0} has been updated to status {1}", seriesRecording.Id, tstvRecordingStatus.ToString());
            }
            else
            {
                seriesRecording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "fail to perform cancel or delete");
                log.ErrorFormat("fail to perform cancel or delete domainSeriesRecordingId = {1}, tstvRecordingStatus = {2}", domainSeriesRecordingId, tstvRecordingStatus.ToString());
            }
        }

        private void CancelOrDeleteEpg(string userId, long domainId, SeriesRecording seriesRecording, TstvRecordingStatus tstvRecordingStatus, long epgId, long domainSeriesRecordingId)
        {
            try
            {
                long domainRecordingID = 0;
                // check that epg related to series id
                TvinciEpgBL epgBLTvinci = new TvinciEpgBL(m_nGroupID);
                List<EpgCB> epgs = epgBLTvinci.GetEpgs(new List<string> { epgId.ToString() });
                // check if epg related to series and season
                List<EpgCB> epgMatch = Utils.GetEpgRelatedToSeriesRecording(m_nGroupID, seriesRecording, epgs);
                if (epgMatch != null && epgMatch.Count > 0) // epg related to series and season
                {
                    // convert status Cancel/Delete ==> SeriesCancel/SeriesDelete
                    TstvRecordingStatus? seriesStatus = Utils.ConvertToSeriesStatus(tstvRecordingStatus);
                    if (!seriesStatus.HasValue)
                    {
                        log.ErrorFormat("fail to perform cancel or delete domainSeriesRecordingId = {1}, tstvRecordingStatus = {2}", domainSeriesRecordingId, tstvRecordingStatus.ToString());
                        return;
                    }
                    // check if this epg already in DB 
                    DataTable dt = RecordingsDAL.GetDomainExistingRecordingsByEpgIds(m_nGroupID, domainId, new List<long>() { epgId });
                    if (dt != null && dt.Rows != null)
                    {
                        foreach (DataRow dr in dt.Rows)
                        {
                            domainRecordingID = ODBCWrapper.Utils.GetLongSafeVal(dr, "ID");
                            if (domainRecordingID > 0)
                            {
                                // cancel / delete record 

                                Recording recording = CancelOrDeleteRecord(userId, domainId, domainRecordingID, seriesStatus.Value, false);
                                if (recording == null || (recording != null && recording.Status.Code != (int)eResponseStatus.OK))
                                {
                                    seriesRecording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, string.Format("fail to cancel or delete epgid = {0}", epgId));
                                }
                                else
                                {
                                    log.DebugFormat("CancelOrDelete Epg={0} has been updated to status={1}, domainSeriesRecordingId = {2}", epgId, tstvRecordingStatus.ToString(), domainSeriesRecordingId);
                                }
                            }
                        }
                    }

                    if (domainRecordingID == 0)
                    {
                        // try to get recording by epg
                        Recording recording = ConditionalAccess.Utils.GetRecordingByEpgId(m_nGroupID, epgId);
                        // insert new domains_recordings to domain with status delete / cancel
                        if (recording == null || recording.Id == 0)
                        {
                            recording = new Recording()
                                {
                                    Id = 0,
                                    ChannelId = (long)epgMatch[0].ChannelID,
                                    EpgId = epgId,
                                    RecordingStatus = seriesStatus.Value,
                                    Type = seriesRecording.SeasonNumber > 0 ? RecordingType.Season : RecordingType.Series
                                };
                        }
                        else
                        {
                            recording.Type = seriesRecording.SeasonNumber > 0 ? RecordingType.Season : RecordingType.Series;
                            recording.RecordingStatus = seriesStatus.Value;
                        }
                        bool res = RecordingsDAL.UpdateOrInsertDomainRecording(m_nGroupID, long.Parse(userId), domainId, recording, domainSeriesRecordingId);
                        if (!res)
                        {
                            seriesRecording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, "fail to cancel or delete epgid");
                        }
                    }
                }
                else
                {
                    seriesRecording.Status = new ApiObjects.Response.Status((int)eResponseStatus.EpgIdNotPartOfSeries, string.Format("epgid = {0} not part of series", epgId));
                }
            }
            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at CancelOrDeleteEpg. ");
                sb.Append(String.Concat("userID: ", userId));
                sb.Append(String.Concat("domainId: ", domainId));
                sb.Append(String.Concat("epgId: ", epgId));
                sb.Append(String.Concat(", recordID: ", seriesRecording != null ? seriesRecording.Id : 0));
                sb.Append(String.Concat(", Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error(sb.ToString(), ex);
            }
        }

        public SeriesResponse GetFollowSeries(string userId, long domainId, ApiObjects.TimeShiftedTv.SeriesRecordingOrderObj orderBy)
        {
            SeriesResponse response = new SeriesResponse()
                {
                    Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString())
                };
            try
            {
                Domain domain;
                ApiObjects.Response.Status validationStatus = Utils.ValidateUserAndDomain(m_nGroupID, userId, ref domainId, out domain);

                if (validationStatus.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("User or Domain not valid, DomainID: {0}, UserID: {1}", domainId, userId);
                    response.Status = new ApiObjects.Response.Status(validationStatus.Code, validationStatus.Message);
                    return response;
                }

                // user is OK - get all domain series recording
                DataSet ds = RecordingsDAL.GetDomainSeriesRecordings(m_nGroupID, domainId);
                List<SeriesRecording> SeriesRecordings = BuildSeriesRecording(ds, orderBy);
                if (SeriesRecordings == null || SeriesRecordings.Count == 0)
                {
                    response = new SeriesResponse()
                    {
                        Status = new ApiObjects.Response.Status((int)eResponseStatus.SeriesRecordingNotFound, eResponseStatus.SeriesRecordingNotFound.ToString())
                    };
                }
                else
                {
                    response = new SeriesResponse()
                    {
                        Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString()),
                        SeriesRecordings = SeriesRecordings,
                        TotalItems = SeriesRecordings.Count
                    };
                }
            }
            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at GetFollowSeries. ");
                sb.Append(String.Concat("userId: ", userId));
                sb.Append(String.Concat(", domainId: ", domainId));
                sb.Append(String.Concat(", Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));
                log.Error(sb.ToString(), ex);

                response = new SeriesResponse()
                {
                    Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString())
                };
            }
            return response;
        }

        private List<SeriesRecording> BuildSeriesRecording(DataSet ds, ApiObjects.TimeShiftedTv.SeriesRecordingOrderObj orderByObj)
        {
            List<SeriesRecording> response = new List<SeriesRecording>();
            try
            {
                response = Utils.BuildSeriesRecordingDetails(ds);
                if (response != null && response.Count > 0)
                {
                    switch (orderByObj.OrderBy)
                    {
                        case ApiObjects.TimeShiftedTv.SeriesOrderBy.START_DATE:
                            if (orderByObj.OrderDir == ApiObjects.SearchObjects.OrderDir.ASC)
                            {
                                response = response.OrderBy(x => x.CreateDate).ToList();
                            }
                            else
                            {
                                response = response.OrderByDescending(x => x.CreateDate).ToList();
                            }
                            break;
                        case ApiObjects.TimeShiftedTv.SeriesOrderBy.SERIES_ID:
                            if (orderByObj.OrderDir == ApiObjects.SearchObjects.OrderDir.ASC)
                            {
                                response = response.OrderBy(x => x.SeriesId).ToList();
                            }
                            else
                            {
                                response = response.OrderByDescending(x => x.SeriesId).ToList();
                            }
                            break;
                        default:
                            if (orderByObj.OrderDir == ApiObjects.SearchObjects.OrderDir.ASC)
                            {
                                response = response.OrderBy(x => x.Id).ToList();
                            }
                            else
                            {
                                response = response.OrderByDescending(x => x.Id).ToList();
                            }
                            break;
                    }
                }
            }
            catch (Exception ex)
            {
                log.Error("fail BuildSeriesRecording ", ex);
            }
            return response;
        }

        public SeriesRecording RecordSeasonOrSeries(string userID, long epgID, RecordingType recordingType)
        {
            SeriesRecording seriesRecording = new SeriesRecording() { EpgId = epgID };
            RecordingResponse recordingResponse = new RecordingResponse();
            try
            {
                long domainID = 0;
                recordingResponse = QueryRecords(userID, new List<long>() { epgID }, ref domainID, recordingType, false);
                if (recordingResponse.Status.Code != (int)eResponseStatus.OK || recordingResponse.TotalItems == 0)
                {
                    log.DebugFormat("RecordingResponse status not valid, EpgID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", epgID, domainID, userID, seriesRecording.ToString());
                    seriesRecording.Status = recordingResponse.Status;
                    return seriesRecording;
                }

                seriesRecording = new SeriesRecording(recordingResponse.Recordings[0]);
                if (seriesRecording == null || seriesRecording.Status == null || seriesRecording.Status.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("Recording status not valid, EpgID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", epgID, domainID, userID, seriesRecording.ToString());
                    return seriesRecording;
                }

                // check if already following as season or series - QueryRecords checks it only for single recordings
                List<EPGChannelProgrammeObject> epgs = Utils.GetEpgsByIds(m_nGroupID, new List<long>() { epgID });
                // no need to validate epg, it is already checked on QueryRecords
                if (epgs == null || epgs.Count == 0)
                {
                    log.DebugFormat("Failed Getting EPGs from Catalog, DomainID: {0}, UserID: {1}, EpgID: {2}", domainID, userID, epgID);
                    epgs = new List<EPGChannelProgrammeObject>();
                }

                ApiObjects.Response.Status IsFollowingResponse = Utils.IsFollowingEpgAsSeriesOrSeason(m_nGroupID, epgs[0], domainID, recordingType);
                if (IsFollowingResponse.Code != (int)eResponseStatus.OK)
                {
                    seriesRecording.Status = IsFollowingResponse;
                    return seriesRecording;
                }

                bool isSeriesFollowed = false;
                List<long> futureSeriesRecordingIds = new List<long>();
                seriesRecording = Utils.FollowSeasonOrSeries(m_nGroupID, userID, domainID, epgID, recordingType, ref isSeriesFollowed, ref futureSeriesRecordingIds, epgs[0]);
                if (seriesRecording == null || seriesRecording.Status == null)
                {
                    log.ErrorFormat("Failed Utils.FollowSeasonOrSeries, EpgID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", epgID, domainID, userID, seriesRecording.ToString());
                    seriesRecording.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                    return seriesRecording;
                }
                else if (seriesRecording.Status.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("seriesRecording status after FollowSeasonOrSeries is not valid, EpgID: {0}, DomainID: {1}, UserID: {2}, Recording: {3}", epgID, domainID, userID, seriesRecording.ToString());                    
                    return seriesRecording;
                }
                // successfully followed season or series and we have found future recordings, if the domain has programs of this season or series scheduled, they need to be canceled
                else if (futureSeriesRecordingIds.Count > 0)
                {
                    Dictionary<long, Recording> domainFutureSingleRecordings = Utils.GetFutureDomainRecordingsByRecordingIDs(m_nGroupID, domainID, futureSeriesRecordingIds, RecordingType.Single);
                    if (domainFutureSingleRecordings != null)
                    {
                        // set max amount of concurrent tasks
                        int maxDegreeOfParallelism = TVinciShared.WS_Utils.GetTcmIntValue("MaxDegreeOfParallelism");
                        if (maxDegreeOfParallelism == 0)
                        {
                            maxDegreeOfParallelism = 5;
                        }
                        ParallelOptions options = new ParallelOptions() { MaxDegreeOfParallelism = maxDegreeOfParallelism };
                        ContextData contextData = new ContextData();
                        Parallel.ForEach(domainFutureSingleRecordings.AsEnumerable(), options, (pair) =>
                        {
                            contextData.Load();
                            //call cancelOrDelete
                            if (pair.Value.RecordingStatus == TstvRecordingStatus.Scheduled)
                            {
                                CancelOrDeleteRecord(userID, domainID, pair.Key, TstvRecordingStatus.Canceled, false);
                            }
                        });
                    }
                }

                // if series is already followed then complete the series recordings for the domain
                if (isSeriesFollowed)
                {
                    QueueWrapper.GenericCeleryQueue queue = new QueueWrapper.GenericCeleryQueue();
                    ApiObjects.QueueObjects.SeriesRecordingTaskData data = new ApiObjects.QueueObjects.SeriesRecordingTaskData(m_nGroupID, string.Empty, domainID, string.Empty, string.Empty, 0,
                                                                                                                    eSeriesRecordingTask.CompleteRecordings) { ETA = DateTime.UtcNow.AddMinutes(1) };
                    queue.Enqueue(data, string.Format(ROUTING_KEY_SERIES_RECORDING_TASK, m_nGroupID));
                }
                // if first user, SeriesRecordingTask should be filled on FollowSeasonOrSeries
                else
                {
                    if (!RecordingsDAL.InsertFirstFollowerLock(m_nGroupID, seriesRecording.SeriesId, seriesRecording.SeasonNumber, seriesRecording.EpgChannelId.ToString(), true))
                    {
                        log.ErrorFormat("Failed InsertFirstFollowerLock, groupId: {0}, seriesId: {1}, seasonNumber: {2}, channelId: {3}",
                                        m_nGroupID, seriesRecording.SeriesId, seriesRecording.SeasonNumber, seriesRecording.EpgChannelId);
                    }

                    QueueWrapper.GenericCeleryQueue queue = new QueueWrapper.GenericCeleryQueue();
                    SeriesRecordingTaskData SeriesRecordingTask = new SeriesRecordingTaskData(m_nGroupID, userID, domainID, seriesRecording.EpgChannelId.ToString(), seriesRecording.SeriesId, seriesRecording.SeasonNumber, eSeriesRecordingTask.FirstFollower);
                    queue.Enqueue(SeriesRecordingTask, string.Format(ROUTING_KEY_SERIES_RECORDING_TASK, m_nGroupID));
                }

            }
            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at RecordSeasonOrSeries. ");
                sb.Append(String.Concat("userID: ", userID));
                sb.Append(String.Concat(", epgID: ", epgID));
                sb.Append(String.Concat(", Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error(sb.ToString(), ex);
            }

            return seriesRecording;
        }

        public bool DistributeRecording(long epgId, long id, DateTime epgStartDate, List<long> domainSeriesIds = null)
        {
            bool result = true;
            Recording recording = Utils.GetRecordingById(id);
            if (recording == null || recording.Status == null || recording.Status.Code != (int)eResponseStatus.OK)
            {
                // don't try distributing again
                return result;
            }

            if (recording.RecordingStatus != TstvRecordingStatus.Recording && recording.RecordingStatus != TstvRecordingStatus.Recorded)
            {
                // don't try distributing again
                return result;
            }

            List<EPGChannelProgrammeObject> epgs = Utils.GetEpgsByIds(m_nGroupID, new List<long>() { epgId });
            if (epgs == null || epgs.Count != 1)
            {
                log.DebugFormat("Failed Getting EPG from Catalog, groupId: {0}, EpgId: {1}", m_nGroupID, epgId);
                return result;
            }

            EPGChannelProgrammeObject epg = epgs.First();
            Dictionary<string, string> epgFieldMappings = Utils.GetEpgFieldTypeEntitys(m_nGroupID, epg, RecordingType.Series);
            if (epgFieldMappings == null || epgFieldMappings.Count == 0)
            {
                log.ErrorFormat("failed GetEpgFieldTypeEntitys, groupId: {0}, epgId: {1}", m_nGroupID, epg.EPG_ID);
                return result;
            }

            string seriesId = epgFieldMappings[Utils.SERIES_ID];
            int epgSeasonNumber = 0;

            if (epgFieldMappings.ContainsKey(Utils.SEASON_NUMBER) && !int.TryParse(epgFieldMappings[Utils.SEASON_NUMBER], out epgSeasonNumber))
            {
                log.ErrorFormat("failed parsing SEASON_NUMBER, groupId: {0}, epgId: {1}", m_nGroupID, epg.EPG_ID);
                return result;
            }

            int recordingDuration = (int)(recording.EpgEndDate - recording.EpgStartDate).TotalSeconds;
            long maxDomainSeriesId = 0;
            DataTable followingDomains = null;
            // batching is done by remote tasks so get followingDomains by domainIds 
            if (domainSeriesIds != null && domainSeriesIds.Count > 0)
            {
                followingDomains = RecordingsDAL.GetSeriesFollowingDomainsByIds(string.Join(",", domainSeriesIds));
            }
            else
            {
                followingDomains = RecordingsDAL.GetSeriesFollowingDomains(m_nGroupID, seriesId, epgSeasonNumber, maxDomainSeriesId);
            }

            while (followingDomains != null && followingDomains.Rows != null && followingDomains.Rows.Count > 0 && maxDomainSeriesId > -1)
            {
                // set max amount of concurrent tasks
                int maxDegreeOfParallelism = TVinciShared.WS_Utils.GetTcmIntValue("MaxDegreeOfParallelism");
                if (maxDegreeOfParallelism == 0)
                {
                    maxDegreeOfParallelism = 5;
                }

                ParallelOptions options = new ParallelOptions() { MaxDegreeOfParallelism = maxDegreeOfParallelism };
                ContextData contextData = new ContextData();
                // loop on all rows
                Parallel.For(0, followingDomains.Rows.Count, options, i =>
                {
                    contextData.Load();
                    DataRow dr = followingDomains.Rows[i];
                    long domainId = ODBCWrapper.Utils.GetLongSafeVal(dr, "DOMAIN_ID", 0);
                    long userId = ODBCWrapper.Utils.GetLongSafeVal(dr, "USER_ID", 0);
                    int seasonNumber = ODBCWrapper.Utils.GetIntSafeVal(dr, "SEASON_NUMBER", 0);
                    long domainSeriesRecordingId = ODBCWrapper.Utils.GetLongSafeVal(dr, "ID", 0);
                    RecordingType recordingType = seasonNumber > 0 ? RecordingType.Season : RecordingType.Series;
                    if (domainId > 0 && userId > 0 && QuotaManager.Instance.GetDomainAvailableQuota(m_nGroupID, domainId) >= recordingDuration)
                    {
                        HashSet<string> domainRecordedCrids = RecordingsDAL.GetDomainRecordingsCridsByDomainsSeriesIds(m_nGroupID, domainId, new List<long>() { domainSeriesRecordingId }, recording.Crid);
                        if (!domainRecordedCrids.Contains(recording.Crid))
                        {
                            Recording userRecording = Record(userId.ToString(), epgId, recordingType, domainSeriesRecordingId);
                            if (userRecording != null && userRecording.Status != null && userRecording.Status.Code == (int)eResponseStatus.OK && userRecording.Id > 0)
                            {
                                log.DebugFormat("successfully distributed recording for domainId = {0}, epgId = {1}, new recordingId = {2}", domainId, epgId, userRecording.Id);
                            }
                        }
                    }
                });

                System.Threading.Thread.Sleep(10);

                // batching is already done on remote tasks so stop here
                if (domainSeriesIds != null)
                {
                    followingDomains = null;
                    break;

                }
                else
                {
                    // max domain series ID because GetSeriesFollowingDomains is ordered by id asc
                    maxDomainSeriesId = ODBCWrapper.Utils.GetLongSafeVal(followingDomains.Rows[followingDomains.Rows.Count - 1], "ID", -1);
                    followingDomains = RecordingsDAL.GetSeriesFollowingDomains(m_nGroupID, seriesId, epgSeasonNumber, maxDomainSeriesId);
                }

            }

            return result;
        }

        public Recording GetRecordingStatus(int groupID, long recordingId)
        {
            Recording recording = new Recording()
                {
                    Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString())
                };
            try
            {
                recording = Recordings.RecordingsManager.Instance.GetRecordingStatus(groupID, recordingId);
                //Recordings entitlements modifications
                //Updated definitions for future/scheduled single recordings on channel entitlements revoke
                if (recording.RecordingStatus == TstvRecordingStatus.Recorded)
                {
                    Dictionary<string, long> userDomainDictionary = new Dictionary<string, long>();// fill with users with no Entitlement

                    // look for all users asked for this recordingId as SINGLE recording 
                    DataTable dt = RecordingsDAL.GetExistingDomainRecordingsByRecordingID(groupID, recordingId, RecordingType.Single);
                    if (dt != null && dt.Rows != null && dt.Rows.Count > 0)
                    {
                        long epgId = ODBCWrapper.Utils.GetLongSafeVal(dt.Rows[0], "epg_id");
                        //Check user Entiteled for the channel 
                        //Updated definitions for future/scheduled single recordings on channel entitlements revoke  to allow lazy removal
                        List<EPGChannelProgrammeObject> epgs = Utils.GetEpgsByIds(m_nGroupID, new List<long>() { epgId });
                        if (epgs == null)
                        {
                            log.DebugFormat("Failed Getting EPGs from Catalog, recordingId: {0}, epgId: {1}", recordingId, epgId);
                            epgs = new List<EPGChannelProgrammeObject>();
                        }
                        else
                        {
                            RecordingResponse response;
                            var userDomainlist = dt.AsEnumerable().Select(r => new
                                                        {
                                                            UserId = r.Field<long>("user_id"),
                                                            DomainId = r.Field<long>("domain_id")
                                                        }).ToList();

                            Dictionary<long, bool> validEpgsForRecording = new Dictionary<long, bool>();
                            validEpgsForRecording.Add(recording.EpgId, false);

                            foreach (var userDomain in userDomainlist)
                            {
                                response = new RecordingResponse();

                                // domain not allowd to service
                                if (!IsServiceAllowed((int)userDomain.DomainId, eService.NPVR))
                                {
                                    if (!userDomainDictionary.ContainsKey(userDomain.UserId.ToString()))
                                    {
                                        userDomainDictionary.Add(userDomain.UserId.ToString(), userDomain.DomainId);
                                    }
                                }
                                else // validate epgs entitlement and add to response
                                {
                                    ValidateEpgForRecording(userDomain.UserId.ToString(), userDomain.DomainId, ref response, epgs, validEpgsForRecording);
                                    if (response.Recordings.FirstOrDefault().Status.Code == (int)eResponseStatus.NotEntitled)
                                    {
                                        if (!userDomainDictionary.ContainsKey(userDomain.UserId.ToString()))
                                        {
                                            userDomainDictionary.Add(userDomain.UserId.ToString(), userDomain.DomainId);
                                        }
                                    }
                                }
                            }
                            // get all other recording in status SCHEDULED for the non entitled users
                            if (userDomainDictionary != null && userDomainDictionary.Count > 0) // some domains not entitled to channel
                            {
                                DomainRecordingStatus? domainRecordingStatus = Utils.ConvertToDomainRecordingStatus(TstvRecordingStatus.Scheduled);
                                List<int> statuses = new List<int>() { (int)domainRecordingStatus };
                                DataTable dtNotEntitled = RecordingsDAL.GetDomainsRecordingsByRecordingStatusesAndChannel(userDomainDictionary.Values.ToList(), groupID, recording.ChannelId, statuses, (int)RecordingType.Single, recording.EpgStartDate);
                                if (dtNotEntitled != null && dtNotEntitled.Rows != null && dtNotEntitled.Rows.Count > 0)
                                {
                                    //cancel all of those + the record with the epgid we got before 
                                    // set max amount of concurrent tasks
                                    int maxDegreeOfParallelism = TVinciShared.WS_Utils.GetTcmIntValue("MaxDegreeOfParallelism");
                                    if (maxDegreeOfParallelism == 0)
                                    {
                                        maxDegreeOfParallelism = 5;
                                    }
                                    ParallelOptions options = new ParallelOptions() { MaxDegreeOfParallelism = maxDegreeOfParallelism };
                                    ContextData contextData = new ContextData();
                                    Parallel.ForEach(dtNotEntitled.AsEnumerable(), options, (drow) =>
                                    {
                                        contextData.Load();
                                        //call cancelOrDelete                  
                                        string userId = ODBCWrapper.Utils.GetSafeStr(drow, "user_id");
                                        long domainId = ODBCWrapper.Utils.GetLongSafeVal(drow, "domain_id");
                                        long domainRecordingId = ODBCWrapper.Utils.GetLongSafeVal(drow, "id");
                                        long currentRecordingId = ODBCWrapper.Utils.GetLongSafeVal(drow, "recording_id");
                                        TstvRecordingStatus currentTstv = currentRecordingId == recordingId ? TstvRecordingStatus.Deleted : TstvRecordingStatus.Canceled;
                                        // cancel or delete all of these recordes 
                                        CancelOrDeleteRecord(userId, domainId, domainRecordingId, currentTstv, false);
                                    });
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                StringBuilder sb = new StringBuilder("Exception at GetRecordingStatus. ");
                sb.Append(String.Concat("groupID: ", groupID));
                sb.Append(String.Concat(", recordingId: ", recordingId));
                sb.Append(String.Concat(", Ex Msg: ", ex.Message));
                sb.Append(String.Concat(", Ex Type: ", ex.GetType().Name));
                sb.Append(String.Concat(", Stack Trace: ", ex.StackTrace));

                log.Error(sb.ToString(), ex);
            }
            return recording;
        }

        public LicensedLinkResponse GetRecordingLicensedLink(string userId, int domainRecordingId, string udid, string userIp, string fileType)
        {
            LicensedLinkResponse response = new LicensedLinkResponse()
            {
                Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString())
            };

            try
            {
                // validate user
                Domain domain;
                long domainId = 0;
                ApiObjects.Response.Status validationStatus = Utils.ValidateUserAndDomain(m_nGroupID, userId, ref domainId, out domain);

                if (validationStatus.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("User or domain not valid, groupId = {0}, userId: {1}, domainId = {2}", m_nGroupID, userId, domainId);
                    response.Status = new ApiObjects.Response.Status(validationStatus.Code, validationStatus.Message);
                    return response;
                }

                // get device brand ID - and make sure the device is in the domain
                if (!Utils.IsDeviceInDomain(domain, udid))
                {
                    log.ErrorFormat("Device not in the user's domain. groupId = {0}, userId = {1}, domainId = {2}, domainRecordingId = {3}, udid = {4}",
                        m_nGroupID, userId, domainId, domainRecordingId, udid);
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.DeviceNotInDomain, "Device not in the user's domain");
                    return response;
                }

                // validate recording
                Recording recording;
                var domainRecordings = Utils.GetDomainRecordingIdsToRecordingsMap(m_nGroupID, domainId, new List<long>() { domainRecordingId });
                if (domainRecordings == null || domainRecordings.Count == 0 || (recording = domainRecordings[domainRecordingId]) == null)
                {
                    log.ErrorFormat("Recording does not exist. groupId = {0}, userId = {1}, domainId = {2}, domainRecordingId = {3}", m_nGroupID, userId, domainId, domainRecordingId);
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.RecordingNotFound, "Recording was not found");
                    return response;
                }
                if (recording.RecordingStatus != TstvRecordingStatus.Recorded)
                {
                    log.ErrorFormat("Recording status is not valid for playback. groupId = {0}, userId = {1}, domainId = {2}, domainRecordingId = {3}, recording = {4}, recordingStatus = {5}",
                        m_nGroupID, userId, domainId, domainRecordingId, recording.Id, recording.RecordingStatus);
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.RecordingStatusNotValid, "Recording status is not valid");
                    return response;
                }

                // get the epg
                List<EPGChannelProgrammeObject> epgs = Utils.GetEpgsByIds(m_nGroupID, new List<long>() { recording.EpgId });
                if (epgs == null || epgs.Count == 0)
                {
                    log.ErrorFormat("Failed to get EPG for the recording. groupId = {0}, userId = {1}, domainId = {2}, domainRecordingId = {3}, epgId = {4}, recordingId",
                        m_nGroupID, userId, domainId, domainRecordingId, recording.EpgId, recording.Id);
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ProgramDoesntExist, "Program does not exist");
                    return response;
                }

                EPGChannelProgrammeObject epg = epgs[0];
                int linearMediaId = 0, mediaFileId = 0;
                ConditionalAccess.WS_Catalog.MediaObj epgChannelLinearMedia = null;
                // get epg channel  
                if (Utils.GetLinearMediaInfoByEpgChannelIdAndFileType(m_nGroupID, epg.EPG_CHANNEL_ID, fileType, ref linearMediaId, ref mediaFileId) && linearMediaId > 0 && mediaFileId > 0)
                {
                    epgChannelLinearMedia = Utils.GetMediaById(m_nGroupID, linearMediaId);
                }

                // get TSTV settings
                var tstvSettings = Utils.GetTimeShiftedTvPartnerSettings(m_nGroupID);

                // validate recording channel exists or the settings allow it to not exist
                if (epgChannelLinearMedia == null && (!tstvSettings.IsRecordingPlaybackNonExistingChannelEnabled.HasValue || !tstvSettings.IsRecordingPlaybackNonExistingChannelEnabled.Value))
                {
                    log.ErrorFormat("EPG channel does not exist and TSTV settings do not allow playback in this case. groupId = {0}, userId = {1}, domainId = {2}, domainRecordingId = {3}, channelId = {4}, recordingId = {5}",
                        m_nGroupID, userId, domainId, domainRecordingId, recording.ChannelId, recording.Id);
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.RecordingPlaybackNotAllowedForNonExistingEpgChannel, "Recording playback is not allowed for non existing EPG channel");
                    return response;
                }

                MediaFileItemPricesContainer price = null;
                bool isItemPurchased = false;
                // validate entitlements if needed 
                if ((epgChannelLinearMedia != null && !epgChannelLinearMedia.EnableRecordingPlaybackNonEntitledChannel))
                {
                    MediaFileItemPricesContainer[] prices = GetItemsPrices(new int[] { mediaFileId }, userId, true, string.Empty, string.Empty, udid);
                    if (prices == null || prices.Length == 0 || prices[0] == null)
                    {
                        log.ErrorFormat("No prices were found for the requested file IDs. groupId = {0}, userId = {1}, domainId = {2}, domainRecordingId = {3}, epgId = {4}, recordingId = {5}",
                        m_nGroupID, userId, domainId, domainRecordingId, recording.EpgId, recording.Id);
                        return response;
                    }

                    price = prices[0];                       
                    isItemPurchased = IsItemPurchased(price);                    
                    if (!isItemPurchased && !IsFreeItem(price))
                    {
                        log.DebugFormat("User is not entitled for the EPG and TSTV settings do not allow playback. groupId = {0}, userId = {1}, domainId = {2}, domainRecordingId = {3}, epgId = {4}, recordingId = {5}",
                        m_nGroupID, userId, domainId, domainRecordingId, recording.EpgId, recording.Id);
                        response.Status = new ApiObjects.Response.Status((int)eResponseStatus.RecordingPlaybackNotAllowedForNotEntitledEpgChannel, "Recording playback is not allowed for not entitled EPG channel");
                        return response;
                    }

                    List<int> lRuleIDS = null;
                    int householdId = (int)domainId;
                    DomainResponseStatus mediaConcurrencyResponse = CheckMediaConcurrency(userId, mediaFileId, udid, prices, linearMediaId, userIp, ref lRuleIDS, ref householdId);
                    if (mediaConcurrencyResponse != DomainResponseStatus.OK)
                    {
                        log.Debug("GetRecordingLicensedLink - " + string.Format("{0}, user:{1}, MFID:{2}", mediaConcurrencyResponse.ToString(), userId, mediaFileId));
                        response = new LicensedLinkResponse(string.Empty, string.Empty, mediaConcurrencyResponse.ToString());
                        response.Status = ConcurrencyResponseToResponseStatus(mediaConcurrencyResponse);
                        return response;
                    }
                }

                // if we got here we everything is ok with the entitlements and settings - so get the link
                // TODO: cache?
                int adapterId = ConditionalAccessDAL.GetTimeShiftedTVAdapterId(m_nGroupID);
                CDVRAdapter cdvrAdapter = ConditionalAccessDAL.GetCDVRAdapter(m_nGroupID, adapterId);
                RecordingLink recordingLink = null;
                if (cdvrAdapter != null && cdvrAdapter.DynamicLinksSupport)
                {
                    // get the link from the CDVR adapter
                    string externalChannelId = Tvinci.Core.DAL.CatalogDAL.GetEPGChannelCDVRId(m_nGroupID, recording.ChannelId);

                    RecordResult recordResult = CdvrAdapterController.GetInstance().GetRecordingLinks(m_nGroupID, externalChannelId, recording.ExternalRecordingId, cdvrAdapter.ID);

                    if (recordResult == null || recordResult.Links == null || recordResult.Links.Count == 0)
                    {
                        log.ErrorFormat("Failed to get recording links dynamically from CDVR adapter. adapterId = {0}, groupId = {1}, userId = {2}, domainId = {3}, domainRecordingId = {4}, externalRecordingId = {5}, recordingId = {6}",
                            cdvrAdapter.ID, m_nGroupID, userId, domainId, domainRecordingId, recording.ExternalRecordingId, recording.Id);
                        return response;
                    }

                    recordingLink = recordResult.Links.Where(rl => rl.FileType == fileType).FirstOrDefault();
                }
                else
                {
                    // get the link for the recording with the given udid brand
                    recordingLink = RecordingsDAL.GetRecordingLinkByFileType(m_nGroupID, recording.Id, fileType);
                }

                if (recordingLink == null || string.IsNullOrEmpty(recordingLink.Url))
                {
                    log.ErrorFormat("Recording link was not found for fileType = {0}. groupId = {1}, userId = {2}, domainId = {3}, domainRecordingId = {4}, udid = {5}, recordingId = {6}",
                        fileType, m_nGroupID, userId, domainId, domainRecordingId, udid, recording.Id);
                    return response;
                }

                // get adapter
                bool isDefaultAdapter = false;
                var adapterResponse = Utils.GetRelevantCDN(m_nGroupID, 0, eAssetTypes.NPVR, ref isDefaultAdapter);

                if (adapterResponse == null || adapterResponse.Adapter == null || adapterResponse.Status.Code != (int)eResponseStatus.OK || string.IsNullOrEmpty(adapterResponse.Adapter.AdapterUrl))
                {
                    log.ErrorFormat("failed to get CDN adapter for recordings for groupId = {0}. userId = {1}, domainId = {2}, domainRecordingId = {3}, recordingId = {4}",
                        m_nGroupID, userId, domainId, domainRecordingId, recording.Id);
                    return response;
                }

                // main url
                var link = CDNAdapterController.GetInstance().GetRecordingLink(m_nGroupID, adapterResponse.Adapter.ID, userId, recordingLink.Url, fileType, domainRecordingId.ToString(), userIp);

                if (link == null || string.IsNullOrEmpty(link.Url))
                {
                    log.ErrorFormat("failed to get link response from CDN adapter. adapterId = {0}, groupId = {1}. userId = {2}, domainId = {3}, domainRecordingId = {4}, recordingId = {5}",
                        adapterResponse.Adapter.ID, m_nGroupID, userId, domainId, domainRecordingId, recording.Id);
                    return response;
                }

                if (isItemPurchased)
                {
                    PlayUsesManager.HandlePlayUses(this, price, userId, mediaFileId, userIp, string.Empty, string.Empty, udid, string.Empty, domainId, m_nGroupID);
                }

                response.mainUrl = link.Url;
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
            }
            catch (Exception ex)
            {
                log.Error(string.Format("Error in GetRecordingLicensedLink. userId = {0}, domainRecordingId = {1}, udid = {2}, fileType = {3}", userId, domainRecordingId, udid, fileType), ex);
            }
            return response;
        }

        public bool CheckRecordingDuplicateCrids(int groupID, long recordingId)
        {
            try
            {
                return RecordingsManager.Instance.CheckRecordingDuplicateCrids(groupID, recordingId);
            }
            catch (Exception ex)
            {
                log.ErrorFormat(string.Format("Failed RecordingsManager.Instance.CheckRecordingDuplicateCrids for groupId: {0}, recordingId: {1}", groupID, recordingId), ex);
                return false;
            }
        }

        public ApiObjects.Response.Status HandleUserTask(int domainId, string userId, UserTaskType actionType)
        {
            ApiObjects.Response.Status result = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());

            Domain domain;
            ApiObjects.Response.Status status = Utils.ValidateDomain(m_nGroupID, domainId, out domain);
            if (status == null)
            {
                log.ErrorFormat("Failed to validate domain = {0}", domainId);
                return result;
            }
            if (status.Code != (int)eResponseStatus.OK)
            {
                log.ErrorFormat("Failed to validate domain = {0}, code = {1}, message = {2}", domainId, status.Code, status.Message);
                return status;
            }

            switch (actionType)
            {
                case UserTaskType.Delete:
                    {
                        if (domain != null && domain.m_masterGUIDs != null && domain.m_masterGUIDs.Count > 0)
                        {
                            if (Utils.UpdateDomainSeriesRecordingsUserToMaster(m_nGroupID, domainId, userId, domain.m_masterGUIDs[0].ToString()) &&
                                Utils.UpdateScheduledRecordingsUserToMaster(m_nGroupID, domainId, userId, domain.m_masterGUIDs[0].ToString()))
                                result = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                        }
                        else
                        {
                            log.ErrorFormat("domain without master user. DomainId = {0}", domainId);
                        }
                    }
                    break;
            }

            return result;
        }

        public ApiObjects.KeyValuePair GetSeriesIdAndSeasonNumberByEpgId(long epgId)
        {
            List<EPGChannelProgrammeObject> epgs = Utils.GetEpgsByIds(m_nGroupID, new List<long>() { epgId });
            if (epgs == null || epgs.Count != 1)
            {
                log.DebugFormat("Failed Getting EPG from Catalog, groupId: {0}, EpgId: {1}", m_nGroupID, epgId);
                return new ApiObjects.KeyValuePair();
            }

            EPGChannelProgrammeObject epg = epgs.First();
            Dictionary<string, string> epgFieldMappings = Utils.GetEpgFieldTypeEntitys(m_nGroupID, epg, RecordingType.Series);
            if (epgFieldMappings == null || epgFieldMappings.Count == 0)
            {
                log.ErrorFormat("failed GetEpgFieldTypeEntitys, groupId: {0}, epgId: {1}", m_nGroupID, epg.EPG_ID);
                return new ApiObjects.KeyValuePair();
            }

            string seriesId = epgFieldMappings[Utils.SERIES_ID];
            int epgSeasonNumber = 0;

            if (epgFieldMappings.ContainsKey(Utils.SEASON_NUMBER) && !int.TryParse(epgFieldMappings[Utils.SEASON_NUMBER], out epgSeasonNumber))
            {
                log.ErrorFormat("failed parsing SEASON_NUMBER, groupId: {0}, epgId: {1}", m_nGroupID, epg.EPG_ID);
                return new ApiObjects.KeyValuePair();
            }

            return new ApiObjects.KeyValuePair(seriesId, epgSeasonNumber.ToString());
        }

        public SearchableRecording[] GetDomainSearchableRecordings(int groupID, long domainId)
        {
            SearchableRecording[] result = new SearchableRecording[0];
            List<TstvRecordingStatus> recordingStatuses = new List<TstvRecordingStatus>() { TstvRecordingStatus.Recorded };

            try
            {
                Dictionary<long, Recording> domainRecordingIdToRecordingMap = Utils.GetDomainRecordingsByTstvRecordingStatuses(m_nGroupID, domainId, recordingStatuses);

                if (domainRecordingIdToRecordingMap != null && domainRecordingIdToRecordingMap.Count > 0)
                {
                    result = domainRecordingIdToRecordingMap.Select(x => new SearchableRecording(x.Key, x.Value.Id, x.Value.EpgId)).ToArray();
                }
            }
            catch (Exception ex)
            {
                log.ErrorFormat("GetDomainSearchableRecordings - exception occurred. groupId = {0}, domainId = {1}, ex = {2}", groupID, domainId, ex);
                result = null;
            }

            return result;
        }

        public string BulkRecoveryForRenewSubscriptions(DateTime endDateStartRange, DateTime endDateEndRange)
        {
            int totalSubscriptionsToRenew = 0;
            int totalRenewTransactionsAdded = 0;
            DataTable dt = ConditionalAccessDAL.GetRenewSubscriptionsToRecover(m_nGroupID, endDateStartRange, endDateEndRange);
            if (dt != null && dt.Rows != null && dt.Rows.Count > 0)
            {
                totalSubscriptionsToRenew = dt.Rows.Count;
                foreach (DataRow dr in dt.Rows)
                {
                    long purchaseId = ODBCWrapper.Utils.GetLongSafeVal(dr, "ID");
                    string siteGuid = ODBCWrapper.Utils.GetSafeStr(dr, "SITE_USER_GUID");
                    int groupId = ODBCWrapper.Utils.GetIntSafeVal(dr, "GROUP_ID");
                    DateTime? endDate = ODBCWrapper.Utils.GetNullableDateSafeVal(dr, "END_DATE");
                    string billingGuid = ODBCWrapper.Utils.GetSafeStr(dr, "BILLING_GUID");
                    int renewalStartMin = ODBCWrapper.Utils.GetIntSafeVal(dr, "RENEWAL_START_MINUTES");

                    //billing guid is already validated on the stored procedure
                    if (purchaseId > 0 && !string.IsNullOrEmpty(siteGuid) && endDate.HasValue)
                    {
                        DateTime nextRenewalDate = endDate.Value.AddMinutes(renewalStartMin);
                        // enqueue renew transaction
                        RenewTransactionsQueue queue = new RenewTransactionsQueue();

                        RenewTransactionData data = new RenewTransactionData(groupId, siteGuid, purchaseId, billingGuid,
                                                        TVinciShared.DateUtils.DateTimeToUnixTimestamp(endDate.Value), nextRenewalDate);
                        bool enqueueSuccessful = queue.Enqueue(data, string.Format(ROUTING_KEY_PROCESS_RENEW_SUBSCRIPTION, groupId));
                        if (enqueueSuccessful)
                        {
                            totalRenewTransactionsAdded++;
                            log.DebugFormat("New task created for renew recovery. next renewal date: {0}, data: {1}", nextRenewalDate, data);
                        }
                        else
                        {
                            log.ErrorFormat("Failed enqueue recovery of renew transaction {0}", data);
                        }
                    }
                }
            }

            return string.Format("Found {0} subscriptions to renew, {1} added to queue successfully", totalSubscriptionsToRenew, totalRenewTransactionsAdded);
        }


        public void RemoveHouseholdEntitlements(int householdId)
        {
            int deleted = DAL.ConditionalAccessDAL.DeleteHouseholdSubscriptions(householdId, (int)SubscriptionPurchaseStatus.HouseholdCancel);
            if (deleted >= 0)
            {
                log.DebugFormat("Deleted {0} subscriptions for householdId = {1}", deleted, householdId);
            }
            else
            {
                log.ErrorFormat("Failed to delete subscriptions for householdId = {0}", householdId);
            }

            //deleted = DAL.ConditionalAccessDAL.DeleteHouseholdPPVs(householdId);
            //{
            //    log.DebugFormat("Deleted {0} PPVs for householdId = {1}", deleted, householdId);
            //}
            //else
            //{
            //    log.DebugFormat("Failed to delete PPVs for householdId = {0}", householdId);
            //}
        }

        public Entitlements UpdateEntitlement(long domainID, Entitlement entitlement)
        {
            Entitlements response = new Entitlements(new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString()));
            try
            {
                if (entitlement == null)
                {
                    log.ErrorFormat("UpdateEntitlement entitlement is null ", "");
                    response.status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
                    return response;
                }
                // 1. validate household
                //---------------------------------               
                Domain domain = null;
                ApiObjects.Response.Status status = Utils.ValidateDomain(m_nGroupID, (int)domainID, out  domain);
                if (status == null || status.Code != (int)eResponseStatus.OK || domain == null)
                {
                    log.ErrorFormat("UpdateEntitlement ValidateUserAndDomain purchaseID = {0} status.Code = {1},  householdId = {2} ", entitlement.purchaseID, status.Code, domainID);
                    response.status = status;
                    return response;
                }

                // get entitelment with the current payment gateway id + current payment method id 
                DataRow dr = ConditionalAccessDAL.GetPurchaseByID(entitlement.purchaseID);
                if (dr == null)
                {
                    log.ErrorFormat("UpdateEntitlement ValidateUserAndDomain purchaseID = {0} status.Code = {1},  householdId = {2} ", entitlement.purchaseID, status.Code, domainID);
                    response.status = new ApiObjects.Response.Status((int)eResponseStatus.InvalidPurchase, eResponseStatus.InvalidPurchase.ToString());
                    return response;
                }

                if (ODBCWrapper.Utils.GetIntSafeVal(dr, "domain_id") != domainID)
                {
                    log.ErrorFormat("UpdateEntitlement purchaseID = {0} not belong to householdId = {1} ", entitlement.purchaseID, domainID);
                    response.status = new ApiObjects.Response.Status((int)eResponseStatus.InvalidPurchase, eResponseStatus.InvalidPurchase.ToString());
                    return response;
                }

                // ask if renewable + subscription related to domain 
                bool isRecurring = ODBCWrapper.Utils.GetIntSafeVal(dr, "is_recurring_status") == 1 ? true : false;
                if (!isRecurring)
                {
                    log.DebugFormat("UpdateEntitlement subscription for purchaseID = {0} is not recurring", entitlement.purchaseID);
                    response.status = new ApiObjects.Response.Status((int)eResponseStatus.SubscriptionNotRenewable, eResponseStatus.SubscriptionNotRenewable.ToString());
                    return response;
                }

                // get latest PaymentDetailsTransaction
                string billingGuid = ODBCWrapper.Utils.GetSafeStr(dr, "billing_guid");

                // move here to Billing WS (write all in billing)
                string wsUserName = string.Empty;
                string wsPass = string.Empty;
                module wsBillingService = null;
                InitializeBillingModule(ref wsBillingService, ref wsUserName, ref wsPass);

                ApiObjects.Response.Status changeStatus = wsBillingService.ChangePaymentDetails(wsUserName, wsPass, billingGuid, domainID, entitlement.paymentGatewayId, entitlement.paymentMethodId);

                // comlete entitelment details 
                if (changeStatus.Code == (int)eResponseStatus.OK)
                {
                    Entitlement subscriptionEntitlement = CreateSubscriptionEntitelment(dr, false, null);
                    subscriptionEntitlement.paymentGatewayId = entitlement.paymentGatewayId;
                    subscriptionEntitlement.paymentMethodId = entitlement.paymentMethodId;
                    response.entitelments.Add(subscriptionEntitlement);
                }
                response.status = changeStatus;

            }
            catch (Exception ex)
            {
                log.ErrorFormat("UpdateEntitlement failed ex={0}, GroupID={1}, domainID={2}, purchaseID={3}, paymentGatewayId={4}, paymentMethodId={5} ", ex, m_nGroupID, domainID,
                    entitlement.purchaseID, entitlement.paymentGatewayId, entitlement.paymentMethodId);
                response.status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }
            return response;
        }

        public ApiObjects.Response.Status SwapSubscription(string userId, int oldSubscriptionCode, int newSubscriptionCode, string ip, string udid, bool history)
        {
            ApiObjects.Response.Status response = new ApiObjects.Response.Status();
            try
            {
                //check if user exists
                DomainSuspentionStatus suspendStatus = DomainSuspentionStatus.OK;
                int domainID = 0;

                if (!Utils.IsUserValid(userId, m_nGroupID, ref domainID, ref suspendStatus))
                {
                    log.Debug("SwapSubscription - User with siteGuid: " + userId + " does not exist. Subscription was not changed");
                    response = new ApiObjects.Response.Status((int)eResponseStatus.UserDoesNotExist, eResponseStatus.UserDoesNotExist.ToString());
                    return response;
                }

                if (suspendStatus == DomainSuspentionStatus.Suspended)
                {
                    log.Debug("SwapSubscription - User with siteGuid: " + userId + " Suspended. Subscription was not changed");
                    response = new ApiObjects.Response.Status((int)eResponseStatus.UserSuspended, eResponseStatus.UserSuspended.ToString());
                    return response;
                }

                PermittedSubscriptionContainer[] userSubsArray = GetUserPermittedSubscriptions(userId);//get all the valid subscriptions that this user has
                Subscription userSubNew = null;
                PermittedSubscriptionContainer userSubOld = new PermittedSubscriptionContainer();
                //check if old sub exists
                if (userSubsArray != null)
                {
                    userSubOld = userSubsArray.Where(x => x.m_sSubscriptionCode == oldSubscriptionCode.ToString()).FirstOrDefault();
                    if (userSubOld == null)
                    {
                        response = new ApiObjects.Response.Status((int)eResponseStatus.Error, string.Format(ERROR_SUBSCRIPTION_NOT_EXSITS, oldSubscriptionCode));
                        return response;
                    }
                }
                //check if the Subscription has autorenewal  
                if (!userSubOld.m_bRecurringStatus)
                {
                    log.Debug("SwapSubscription - Previous Subscription ID: " + oldSubscriptionCode + " is not renewable. Subscription was not changed");
                    response = new ApiObjects.Response.Status((int)eResponseStatus.SubscriptionNotRenewable, string.Format(ERROR_SUBSCRIPTION_NOT_RENEWABLE, oldSubscriptionCode));
                    return response;
                }

                //check if new subscsription already exists for this user
                PermittedSubscriptionContainer userNewSub = userSubsArray.Where(x => x.m_sSubscriptionCode == newSubscriptionCode.ToString()).FirstOrDefault();
                if (userNewSub != null)
                {
                    log.Debug("SwapSubscription - New Subscription ID: " + newSubscriptionCode + " is already attached to this user. Subscription was not changed");
                    response = new ApiObjects.Response.Status((int)eResponseStatus.UnableToPurchaseSubscriptionPurchased, string.Format(ERROR_SUBSCRIPTION_ALREADY_PURCHASED, newSubscriptionCode));
                    return response;
                }

                Subscription s = null;
                string pricingUsername = string.Empty, pricingPassword = string.Empty;
                using (mdoule m = new mdoule())
                {
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref pricingUsername, ref pricingPassword);
                    s = m.GetSubscriptionData(pricingUsername, pricingPassword, newSubscriptionCode.ToString(), string.Empty, string.Empty, string.Empty, false);
                    if (s == null || string.IsNullOrEmpty(s.m_SubscriptionCode))
                    {
                        log.Debug("SwapSubscription - New Subscription ID: " + newSubscriptionCode + " was not found. Subscription was not changed");
                        response = new ApiObjects.Response.Status((int)eResponseStatus.Error, string.Format(ERROR_SUBSCRIPTION_NOT_EXSITS, newSubscriptionCode));
                        return response;
                    }
                    userSubNew = TVinciShared.ObjectCopier.Clone<Subscription>((Subscription)(s));
                }
                if (!userSubNew.m_bIsRecurring)
                {
                    log.Debug("SwapSubscription - New Subscription ID: " + newSubscriptionCode + " is not renewable. Subscription was not changed");
                    response = new ApiObjects.Response.Status((int)eResponseStatus.SubscriptionNotRenewable, string.Format(ERROR_SUBSCRIPTION_NOT_RENEWABLE, newSubscriptionCode));
                    return response;
                }

                // check overlapping DLM or Quota in any of subscriptions (except old one)
                List<string> subCodes = userSubsArray.Where(x => x.m_sSubscriptionCode != oldSubscriptionCode.ToString()).Select(y=>y.m_sSubscriptionCode).ToList();

                if (subCodes.Count > 0)
                {
                    response = CheckSubscriptionOverlap(userSubNew, userId, subCodes);

                    if (response.Code != (int)eResponseStatus.OK)
                    {
                        log.Debug("SwapSubscription - CheckExistsDlmAndQuota: fail" + response.Message);
                        return response;
                    }
                }
                //set new subscprion
                response = SetSubscriptionSwap(userId, domainID, userSubNew, userSubOld, ip, udid, history);
            }
            catch (Exception exc)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception at SwapSubscription. ");
                sb.Append(String.Concat(" Ex Msg: ", exc.Message));
                sb.Append(String.Concat(" Site Guid: ", userId));
                sb.Append(String.Concat(" New Sub: ", newSubscriptionCode));
                sb.Append(String.Concat(" Old Sub: ", oldSubscriptionCode));
                sb.Append(String.Concat(" this is: ", this.GetType().Name));
                sb.Append(String.Concat(" Ex Type: ", exc.GetType().Name));
                sb.Append(String.Concat(" ST: ", exc.StackTrace));
                log.Error("Exception - " + sb.ToString(), exc);
                #endregion
            } 
            return response;
        }

        //the new subscription is 
        //the previous  subscription is cancled and its end date is set to 'now' with new status 
        private ApiObjects.Response.Status SetSubscriptionSwap(string userId, int houseHoldID, Subscription newSubscription, PermittedSubscriptionContainer oldSubscription, string userIp, string deviceName, bool history)
        {
            ApiObjects.Response.Status response = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            try
            {
                // update old subscription with end_date = now                
                bool result = DAL.ConditionalAccessDAL.CancelSubscriptionPurchaseTransaction(userId, int.Parse(oldSubscription.m_sSubscriptionCode), houseHoldID, (int)SubscriptionPurchaseStatus.Switched);
                if (!result)
                {
                    response = new ApiObjects.Response.Status((int)eResponseStatus.Error, "CancelSubscriptionPurchaseTransaction fail");
                    return response;
                }

                ApiObjects.Response.Status status = GrantManager.GrantSubscription(this, m_nGroupID, userId, (long)houseHoldID, int.Parse(newSubscription.m_SubscriptionCode), userIp, deviceName, history, 1, null, oldSubscription.m_dEndDate, GrantContext.Swap);
               
                if (status.Code != (int)eResponseStatus.OK)
                {
                    response = new ApiObjects.Response.Status((int)eResponseStatus.Error, "GrantEntitlements fail");
                    return response;
                }
            }
            catch (Exception ex)
            {
                #region Logging
                StringBuilder sb = new StringBuilder("Exception in SetSubscriptionSwap. ");
                sb.Append(String.Concat("Ex Msg: ", ex.Message));
                sb.Append(String.Concat(" Site Guid: ", userId));
                sb.Append(String.Concat(" Stack Trace: ", ex.StackTrace));
                log.Error("SetSubscriptionSwap - " + sb.ToString(), ex);
                #endregion
                response = new ApiObjects.Response.Status((int)eResponseStatus.Error, string.Format("fail to swap subscription {0} to {1}", oldSubscription.m_sSubscriptionCode, newSubscription.m_SubscriptionCode)); //status = ChangeSubscriptionStatus.Error;
            }
           
            response = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString()); 
            return response;
        }

        internal ApiObjects.Response.Status CheckSubscriptionOverlap(Subscription subscription, string userId, List<string> SubCodes = null)
        {
            ApiObjects.Response.Status status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
            try
            {
                List<Subscription> permittedSubscriptions = null;

                bool npvrCheck = false;
                bool dlmCheck = subscription.m_nDomainLimitationModule > 0 ? true : false;

                // if subscription for grant contain DLM \ Quota ==> than check overlapping  DLM or Quota in any of subscriptions  in permitted subscription 
                if (subscription.m_lServices != null && subscription.m_lServices.Select(x => x.ID == (long)eService.NPVR).Count() > 0)
                {
                    npvrCheck = true;
                }

                if (!npvrCheck && !dlmCheck)
                {
                    return status;
                }

                // need to check other subscriptions 
                //get all permitted subscription (if didn't get) 
                if (SubCodes == null || SubCodes.Count == 0)
                {
                    PermittedSubscriptionContainer[] userSubsArray = GetUserPermittedSubscriptions(userId);
                    if (userSubsArray == null || userSubsArray.Count() == 0)
                    {
                        return status;
                    }
                    SubCodes = userSubsArray.Select(x => x.m_sSubscriptionCode).ToList();

                    if (SubCodes == null && SubCodes.Count == 0)
                    {
                        return status;
                    }
                }          

                string pricingUsername = string.Empty, pricingPassword = string.Empty;
                using (mdoule m = new mdoule())
                {
                    Utils.GetWSCredentials(m_nGroupID, eWSModules.PRICING, ref pricingUsername, ref pricingPassword);

                    SubscriptionsResponse subscriptionsResponse = m.GetSubscriptions(pricingUsername, pricingPassword, SubCodes.ToArray(), string.Empty, string.Empty, string.Empty);
                    if (subscriptionsResponse != null && subscriptionsResponse.Status.Code == (int)eResponseStatus.OK && subscriptionsResponse.Subscriptions != null && subscriptionsResponse.Subscriptions.Count() > 0)
                    {
                        permittedSubscriptions = subscriptionsResponse.Subscriptions.ToList();
                    }
                }

                if (npvrCheck)
                {
                    if (permittedSubscriptions.Select(x => x.m_lServices != null && x.m_lServices.Select(y => y.ID == (long)eService.NPVR).Count() > 0 ).Count() > 0)
                    {
                        status = new ApiObjects.Response.Status((int)eResponseStatus.ServiceAlreadyExists, eResponseStatus.ServiceAlreadyExists.ToString());
                        return status;
                    }
                }

                if (dlmCheck)
                {
                    if (permittedSubscriptions.Select(x => x.m_nDomainLimitationModule > 0).Count() > 0)
                    {
                        status = new ApiObjects.Response.Status((int)eResponseStatus.DlmExist, eResponseStatus.DlmExist.ToString());
                        return status;
                    }
                }
            }
            catch
            {
                status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }
            return status;
        }

        public PlaybackContextResponse GetPlaybackContext(string userId, string assetId, eAssetTypes assetType, List<long> fileIds, StreamerType? streamerType, string mediaProtocol,
            PlayContextType context, string ip, string udid, out MediaFileItemPricesContainer filePrice)
        {
            // TODO: add cache

            PlaybackContextResponse response = new PlaybackContextResponse()
            {
                Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString())
            };

            filePrice = null;

            try
            {
                Domain domain = null;
                long domainId = 0;

                if (assetType == eAssetTypes.NPVR || assetType == eAssetTypes.EPG)
                {
                    ApiObjects.Response.Status validationStatus = Utils.ValidateUserAndDomain(m_nGroupID, userId, ref domainId, out domain);

                    if (validationStatus.Code != (int)eResponseStatus.OK)
                    {
                        log.DebugFormat("User or domain not valid, groupId = {0}, userId: {1}, domainId = {2}", m_nGroupID, userId, domainId);
                        response.Status = new ApiObjects.Response.Status(validationStatus.Code, validationStatus.Message);
                        return response;
                    }
                }

                // EPG
                if (assetType == eAssetTypes.EPG)
                {
                    // services
                    PlayContextType? allowedContext = FilterNotAllowedServices(domainId, context);
                    if (!allowedContext.HasValue)
                    {
                        log.DebugFormat("Service for domainId = {0}", domainId);
                        response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ServiceNotAllowed, "Service not allowed");
                        return response;
                    }
                }

                if (assetType == eAssetTypes.NPVR && !IsServiceAllowed((int)domainId, eService.NPVR))
                {
                    log.DebugFormat("Premium Service not allowed, DomainID: {0}, UserID: {1}, Service: {2}", domainId, userId, eService.NPVR.ToString());
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.ServiceNotAllowed, "Service not allowed");
                    return response;
                }
                
                long mediaId;
                Recording recording = null;
                EPGChannelProgrammeObject program = null;
                response.Status = Utils.GetMediaIdForAsset(m_nGroupID, assetId, assetType, userId, domain, udid, out mediaId, out  recording, out program);
                if (response.Status.Code != (int)eResponseStatus.OK)
                {
                    return response;
                }

                ConditionalAccess.WS_Catalog.MediaObj epgChannelLinearMedia = null;
                // Recording
                if (assetType == eAssetTypes.NPVR)
                {
                    long longAssetId = 0;
                    long.TryParse(assetId, out longAssetId);
                    response.Status = Utils.ValidateRecording(m_nGroupID, domain, udid, userId, longAssetId, ref recording);
                    if (response.Status.Code != (int)eResponseStatus.OK)
                    {
                        return response;
                    }
                   
                    epgChannelLinearMedia = Utils.GetMediaById(m_nGroupID, (int)mediaId);

                    // get TSTV settings
                    var tstvSettings = Utils.GetTimeShiftedTvPartnerSettings(m_nGroupID);

                    // validate recording channel exists or the settings allow it to not exist
                    if (epgChannelLinearMedia == null && (!tstvSettings.IsRecordingPlaybackNonExistingChannelEnabled.HasValue || !tstvSettings.IsRecordingPlaybackNonExistingChannelEnabled.Value))
                    {
                        log.ErrorFormat("EPG channel does not exist and TSTV settings do not allow playback in this case. groupId = {0}, userId = {1}, domainId = {2}, domainRecordingId = {3}, channelId = {4}, recordingId = {5}",
                            m_nGroupID, userId, domainId, assetId, recording.ChannelId, recording.Id);
                        response.Status = new ApiObjects.Response.Status((int)eResponseStatus.RecordingPlaybackNotAllowedForNonExistingEpgChannel, "Recording playback is not allowed for non existing EPG channel");
                        return response;
                    }
                }

                List<MediaFile> files = Utils.FilterMediaFilesForAsset(m_nGroupID, assetId, assetType, mediaId, streamerType, mediaProtocol, context, fileIds);
                List<long> assetFileIds = new List<long>();

                if (files != null && files.Count > 0)
                {
                    MediaFileItemPricesContainer[] prices = null;

                    if (assetType == eAssetTypes.NPVR && (epgChannelLinearMedia == null || epgChannelLinearMedia.EnableRecordingPlaybackNonEntitledChannel))
                    {
                        assetFileIds = files.Select(f => f.Id).ToList();
                    }
                    else
                    {
                        prices = GetItemsPrices(files.Select(f => (int)f.Id).ToArray(), userId, true, string.Empty, string.Empty, string.Empty);
                        if (prices != null && prices.Length > 0)
                        {
                            foreach (MediaFileItemPricesContainer price in prices)
                            {
                                if (IsFreeItem(price) || Utils.IsItemPurchased(price))
                                {
                                    assetFileIds.Add(price.m_nMediaFileID);
                                }

                                filePrice = price;
                            }
                        }
                    }

                    if (assetFileIds.Count > 0)
                    {
                        int domainID = 0;
                        List<int> ruleIds = new List<int>();
                        DomainResponseStatus mediaConcurrencyResponse = CheckMediaConcurrency(userId, (int)assetFileIds[0], udid, prices, int.Parse(assetId), ip, ref ruleIds, ref domainID);
                        if (mediaConcurrencyResponse != DomainResponseStatus.OK)
                        {
                            response.Status = ConcurrencyResponseToResponseStatus(mediaConcurrencyResponse);
                            return response;
                        }

                        response.Files = files.Where(f => assetFileIds.Contains(f.Id)).ToList();
                    }
                    else if (assetType == eAssetTypes.NPVR)
                    {
                        log.DebugFormat("User is not entitled for the EPG and TSTV settings do not allow playback. groupId = {0}, userId = {1}, domainId = {2}, domainRecordingId = {3}, epgId = {4}, recordingId = {5}",
                        m_nGroupID, userId, domainId, assetId, recording.EpgId, recording.Id);
                        response.Status = new ApiObjects.Response.Status((int)eResponseStatus.RecordingPlaybackNotAllowedForNotEntitledEpgChannel, "Recording playback is not allowed for not entitled EPG channel");
                        return response;
                    }
                    else
                    {
                        log.DebugFormat("User is not entitled. groupId = {0}, userId = {1}, domainId = {2}, assetId = {3}, assetType = {4}",
                        m_nGroupID, userId, domainId, assetId, assetType);
                        response.Status = new ApiObjects.Response.Status((int)eResponseStatus.NotEntitled, "Not entitled");
                        return response;
                    }
                }
                else
                {
                    log.DebugFormat("No files found for asset assetId = {0}, assetType = {1}, streamerType = {2}, protocols = {3}", userId, assetId, assetType, streamerType, mediaProtocol);
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.NoFilesFound, "No files found");
                    return response;
                }
            }
            catch (Exception ex)
            {
                log.Error(string.Format("Failed to GetPlaybackContext for userId = {0}, assetId = {1}, assetType = {2}", userId, assetId, assetType), ex);
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }
            return response;
        }

        public PlayContextType? FilterNotAllowedServices(long domainId, PlayContextType context)
        {
            // check if the service allowed for domain  
            eService service = Utils.GetServiceByPlayContextType(context);
            if (service == eService.Unknown || IsServiceAllowed((int)domainId, service))
            {
                return context;
            }
            else
            {
                log.DebugFormat("service is not allowed for domain = {0}, service = {1}", domainId, service);
                return null;
            }
        }

        public PlayManifestResponse GetPlayManifest(string userId, string assetId, eAssetTypes assetType, long fileId, string ip, string udid, PlayContextType playContextType)
        {
            PlayManifestResponse response = new PlayManifestResponse() { Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString()) };
            try
            {
                long mediaId;
                Recording recording = null;
                EPGChannelProgrammeObject program = null;
                Domain domain = null;
                long domainId = 0;

                ApiObjects.Response.Status validationStatus = Utils.ValidateUserAndDomain(m_nGroupID, userId, ref domainId, out domain);

                if (assetType != eAssetTypes.MEDIA && validationStatus.Code != (int)eResponseStatus.OK)
                {
                    log.DebugFormat("User or domain not valid, groupId = {0}, userId: {1}, domainId = {2}", m_nGroupID, userId, domainId);
                    response.Status = new ApiObjects.Response.Status(validationStatus.Code, validationStatus.Message);
                    return response;
                }

                response.Status = Utils.GetMediaIdForAsset(m_nGroupID, assetId, assetType, userId, domain, udid, out mediaId, out  recording, out program);
                if (response.Status.Code != (int)eResponseStatus.OK)
                {
                    log.ErrorFormat("Failed to get media ID for assetId = {0}, assetType = {1}", assetId, assetType);
                    return response;
                }

                List<MediaFile> files = Utils.FilterMediaFilesForAsset(m_nGroupID, assetId, assetType, mediaId, null, null, playContextType, new List<long>() { fileId }, true);

                if (files == null || files.Count == 0)
                {
                    log.ErrorFormat("Failed to get files for assetId = {0}, assetType = {1}, mediaId = {2}", assetId, assetType, mediaId);
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.NoFilesFound, "No files found");
                    return response;
                }

                MediaFile file = files[0];
                MediaFileItemPricesContainer price;
                PlaybackContextResponse playbackContextResponse = GetPlaybackContext(userId, assetId, assetType, new List<long>() { fileId }, file.StreamerType.Value,
                    file.Url.Substring(0, file.Url.IndexOf(':')), playContextType, ip, udid, out price);
                if (playbackContextResponse.Status.Code != (int)eResponseStatus.OK)
                {
                    response.Status = playbackContextResponse.Status;
                    return response;
                }

                // get adapter
                bool isDefaultAdapter = false;
                CDNAdapterResponse adapterResponse = Utils.GetRelevantCDN(m_nGroupID, file.CdnId, assetType, ref isDefaultAdapter);

                int assetIdInt = int.Parse(assetId);

                switch (assetType)
                {
                    case eAssetTypes.EPG:
                        response = GetEpgLicensedLink(userId, program, file, udid, ip, adapterResponse, playContextType);
                        break;
                    case eAssetTypes.NPVR:
                        response = GetRecordingLicensedLink(userId, recording, file, udid, ip, adapterResponse);
                        break;
                    case eAssetTypes.MEDIA:
                        response = GetMediaLicensedLink(userId, file, udid, ip, adapterResponse);
                        break;
                    default:
                        break;
                }

                if (response.Status.Code == (int)eResponseStatus.OK)
                {
                    // HandlePlayUses
                    if (domainId > 0 && Utils.IsItemPurchased(price))
                    {
                        PlayUsesManager.HandlePlayUses(this, price, userId, (int)file.Id, ip, string.Empty, string.Empty, udid, string.Empty, domainId, m_nGroupID);
                    }
                }
            }
            catch (Exception ex)
            {
                log.Error(string.Format("Error in get GetAssetLicensedLink, userId = {0}, fileId = {1}, assetId = {2}, assetType = {3}", userId, fileId, assetId, assetType), ex);
                response.Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString());
            }

            return response;
        }

        public PlayManifestResponse GetMediaLicensedLink(string userId, MediaFile file, string udid, string ip, CDNAdapterResponse adapterResponse)
        {
            PlayManifestResponse response = new PlayManifestResponse() { Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString()) };

            try
            {
                if (adapterResponse.Adapter != null && !string.IsNullOrEmpty(adapterResponse.Adapter.AdapterUrl))
                {
                    var link = CDNAdapterController.GetInstance().GetVodLink(m_nGroupID, adapterResponse.Adapter.ID, userId, file.Url, file.Type, (int)file.MediaId, (int)file.Id, ip);
                    response.Url = link != null ? link.Url : string.Empty;
                }
                else
                {
                    Dictionary<string, string> licensedLinkParams = Utils.GetLicensedLinkParamsDict(userId, file.Id.ToString(), file.Url, ip, string.Empty, string.Empty, udid, string.Empty);
                    response.Url = GetLicensedLink(file.CdnId, licensedLinkParams);
                }

                if (!string.IsNullOrEmpty(response.Url))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                }
            }
            catch (Exception ex)
            {
                log.Error(string.Format("Failed to GetMediaLicensedLink for fileId = {0}, userId = {1}", file.Id, userId), ex);
            }
            return response;
        }

        public PlayManifestResponse GetRecordingLicensedLink(string userId, Recording recording, MediaFile file, string udid, string ip, CDNAdapterResponse adapterResponse)
        {
            PlayManifestResponse response = new PlayManifestResponse() { Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString()) };

            try
            {
                int adapterId = ConditionalAccessDAL.GetTimeShiftedTVAdapterId(m_nGroupID);
                CDVRAdapter cdvrAdapter = ConditionalAccessDAL.GetCDVRAdapter(m_nGroupID, adapterId);
                RecordingLink recordingLink = null;
                if (cdvrAdapter != null && cdvrAdapter.DynamicLinksSupport)
                {
                    // get the link from the CDVR adapter
                    string externalChannelId = Tvinci.Core.DAL.CatalogDAL.GetEPGChannelCDVRId(m_nGroupID, recording.ChannelId);

                    RecordResult recordResult = CdvrAdapterController.GetInstance().GetRecordingLinks(m_nGroupID, externalChannelId, recording.ExternalRecordingId, cdvrAdapter.ID);

                    if (recordResult == null || recordResult.Links == null || recordResult.Links.Count == 0)
                    {
                        log.ErrorFormat("Failed to get recording links dynamically from CDVR adapter. adapterId = {0}, groupId = {1}, userId = {2}, domainRecordingId = {3}, externalRecordingId = {4}, recordingId = {5}",
                            cdvrAdapter.ID, m_nGroupID, userId, recording.Id, recording.ExternalRecordingId, recording.Id);
                        return response;
                    }

                    recordingLink = recordResult.Links.Where(rl => rl.FileType == file.Type).FirstOrDefault();
                }
                else
                {
                    // get the link for the recording with the given udid brand
                    recordingLink = RecordingsDAL.GetRecordingLinkByFileType(m_nGroupID, recording.Id, file.Type);
                }

                if (recordingLink == null || string.IsNullOrEmpty(recordingLink.Url))
                {
                    log.ErrorFormat("Recording link was not found for fileType = {0}. groupId = {1}, userId = {2}, domainRecordingId = {3}, udid = {4}, recordingId = {5}",
                        file.Type, m_nGroupID, userId, recording.Id, udid, recording.Id);
                    return response;
                }

                if (adapterResponse == null || adapterResponse.Adapter == null || adapterResponse.Status.Code != (int)eResponseStatus.OK || string.IsNullOrEmpty(adapterResponse.Adapter.AdapterUrl))
                {
                    log.ErrorFormat("failed to get CDN adapter for recordings for groupId = {0}. userId = {1}, domainRecordingId = {2}, recordingId = {3}",
                        m_nGroupID, userId, recording.Id, recording.Id);
                    return response;
                }

                // main url
                var link = CDNAdapterController.GetInstance().GetRecordingLink(m_nGroupID, adapterResponse.Adapter.ID, userId, recordingLink.Url, file.Type, recording.ExternalRecordingId, ip);

                if (link != null && !string.IsNullOrEmpty(link.Url))
                {
                    response.Url = link.Url;
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                }
            }
            catch (Exception ex)
            {
                log.Error(string.Format("Failed to GetRecordingLicensedLink for fileId = {0}, userId = {1}", file.Id, userId), ex);
            }

            return response;
        }

        public PlayManifestResponse GetEpgLicensedLink(string userId, EPGChannelProgrammeObject program, MediaFile file, string udid, string ip, CDNAdapterResponse adapterResponse, PlayContextType context)
        {
            PlayManifestResponse response = new PlayManifestResponse() { Status = new ApiObjects.Response.Status((int)eResponseStatus.Error, eResponseStatus.Error.ToString()) };

            try
            {
                DateTime programEndTime = DateTime.ParseExact(program.END_DATE, "dd/MM/yyyy HH:mm:ss", null);
                DateTime programStartTime = DateTime.ParseExact(program.START_DATE, "dd/MM/yyyy HH:mm:ss", null);

                eEPGFormatType formatType = Utils.GetEpgFormatTypeByPlayContextType(context);

                // if adapter response is not null and is adapter (has an adapter url) - call the adapter
                if (adapterResponse.Adapter != null && !string.IsNullOrEmpty(adapterResponse.Adapter.AdapterUrl))
                {
                    int actionType = Utils.MapActionTypeForAdapter(formatType);

                    // main url
                    var link = CDNAdapterController.GetInstance().GetEpgLink(m_nGroupID, adapterResponse.Adapter.ID, userId, file.Url, file.Type, (int)program.EPG_ID, (int)file.MediaId, (int)file.Id,
                        TVinciShared.DateUtils.DateTimeToUnixTimestamp(programStartTime), actionType, ip);
                    response.Url = link != null ? link.Url : null;
                }
                else
                {
                    Dictionary<string, object> dURLParams = new Dictionary<string, object>();
                    dURLParams.Add(ApiObjects.Epg.EpgLinkConstants.PROGRAM_END, programEndTime);
                    dURLParams.Add(ApiObjects.Epg.EpgLinkConstants.EPG_FORMAT_TYPE, formatType);
                    if (formatType == eEPGFormatType.Catchup || formatType == eEPGFormatType.StartOver)
                    {
                        dURLParams.Add(ApiObjects.Epg.EpgLinkConstants.PROGRAM_START, programStartTime);
                    }
                    string CdnStrID = string.Empty;
                    bool bIsDynamic = Utils.GetStreamingUrlType(file.CdnId, ref CdnStrID);
                    dURLParams.Add(ApiObjects.Epg.EpgLinkConstants.IS_DYNAMIC, bIsDynamic);
                    dURLParams.Add(ApiObjects.Epg.EpgLinkConstants.BASIC_LINK, file.Url);

                    StreamingProvider.ILSProvider provider = StreamingProvider.LSProviderFactory.GetLSProvidernstance(CdnStrID);
                    if (provider != null)
                    {
                        string liveUrl = provider.GenerateEPGLink(dURLParams);
                        response.Url = !string.IsNullOrEmpty(liveUrl) ? liveUrl : null;
                    }
                }

                if (!string.IsNullOrEmpty(response.Url))
                {
                    response.Status = new ApiObjects.Response.Status((int)eResponseStatus.OK, eResponseStatus.OK.ToString());
                }
            }
            catch (Exception ex)
            {
                log.Error(string.Format("Failed to GetEpgLicensedLink for fileId = {0}, userId = {1}", file.Id, userId), ex);
            }

            return response;
        }
    }
}
