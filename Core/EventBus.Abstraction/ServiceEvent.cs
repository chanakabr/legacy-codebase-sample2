using KLogMonitor;
using Newtonsoft.Json;
using System;
using System.Reflection;

namespace EventBus.Abstraction
{

    public class ServiceEventRoutingKeyOverrideAttribute : Attribute
    {
        public string RoutingKey { get; set; }

        public ServiceEventRoutingKeyOverrideAttribute(string name)
        {
            RoutingKey = name;
        }
    }

    public abstract class ServiceEvent
    {
        public ServiceEvent()
        {
            this.RequestId = KLogger.GetRequestId();
        }

        [JsonProperty("group_id")]
        public int GroupId { get; set; }

        [JsonProperty("req_id")]
        public string RequestId { get; set; }
        
        // in some cases service events will have keys to identify the messgae
        // e.g when sending event via kafka every  message has a key
        [JsonIgnore]
        public virtual string EventKey { get; }


        private long _UserId;

        [JsonProperty("user_id")]
        public virtual long UserId
        {
            get => _UserId;
            set => _UserId = value;
        }

        [JsonProperty("site_guid")]
        public virtual string SiteGuid
        {
            get => _UserId.ToString();
            set => _UserId = long.Parse(value);
        }


        public static string GetEventRoutingKey(Type eventType)
        {
            var routingKeyOverride = eventType.GetCustomAttribute<ServiceEventRoutingKeyOverrideAttribute>();
            if (routingKeyOverride != null)
            {
                return routingKeyOverride.RoutingKey;
            }


            // if no override found the routing is generated by the event type fully qulified name;
            return $"{eventType.Namespace}.{eventType.Name}";
        }

        public static string GetEventRoutingKey(ServiceEvent e) => GetEventRoutingKey(e.GetType());

        public override string ToString()
        {
            try
            {
                return $"groupId {GroupId} requestId {RequestId} eventName: {GetEventRoutingKey(this.GetType())}";
            }
            catch
            {
                return base.ToString();
            }
        }

        public virtual string Serialize()
        {
            return JsonConvert.SerializeObject(this);
        }
    }
}
